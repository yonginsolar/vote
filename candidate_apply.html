<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í›„ë³´ì ë“±ë¡ ì‹ ì²­</title>
    <link rel="stylesheet" href="style.css">
<style>
    :root {
        --primary-color: #2563eb; /* ì‹ ë¢°ì˜ ë¸”ë£¨ */
        --primary-hover: #1d4ed8;
        --bg-color: #f8fafc;
        --card-bg: #ffffff;
        --text-main: #1e293b;
        --text-sub: #64748b;
        --border-color: #e2e8f0;
        --error-color: #ef4444;
        --success-color: #10b981;
        --radius: 12px;
    }

    /* 1. ê¸°ë³¸ íƒ€ì´í¬ê·¸ë˜í”¼ ë° ë¦¬ì…‹ */
    * { box-sizing: border-box; }
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Pretendard", Roboto, "Noto Sans KR", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        line-height: 1.6;
        display: flex;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
    }

    /* 2. ë©”ì¸ ì»¨í…Œì´ë„ˆ (ì¹´ë“œ ìŠ¤íƒ€ì¼) */
    .container {
        background: var(--card-bg);
        width: 100%;
        max-width: 600px;
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
    }

    h1 {
        font-size: 1.75rem;
        font-weight: 800;
        text-align: center;
        margin-bottom: 2rem;
        color: #0f172a;
    }
    
    h3 {
        font-size: 1.25rem;
        font-weight: 700;
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: #334155;
    }/* [ìˆ˜ì •] ì½ê¸° ì „ìš© ì¸í’‹ ìŠ¤íƒ€ì¼ */
    .readonly-input {
        background-color: #f1f5f9 !important; /* íšŒìƒ‰ ë°°ê²½ */
        color: #64748b;
        cursor: default;
        border: 1px solid transparent;
    }
    .readonly-input:focus {
        box-shadow: none;
        border-color: transparent;
    }

    /* [ì‹ ê·œ] ì„¸ë ¨ëœ íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ */
    .file-upload-wrapper {
        position: relative;
        margin-bottom: 10px;
    }
    
    /* ëª»ìƒê¸´ ê¸°ë³¸ ì¸í’‹ ìˆ¨ê¸°ê¸° */
    .file-upload-input {
        display: none; 
    }
    
    /* ë²„íŠ¼ì²˜ëŸ¼ ìƒê¸´ ë¼ë²¨ */
    .file-custom-label {
        display: inline-block;
        width: 100%;
        padding: 14px;
        background-color: white;
        border: 1px dashed var(--primary-color); /* ì ì„  í…Œë‘ë¦¬ */
        border-radius: var(--radius);
        color: var(--primary-color);
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .file-custom-label:hover {
        background-color: #eff6ff;
    }
    
    .file-custom-label i { margin-right: 8px; } /* ì•„ì´ì½˜ìš© */

    /* íŒŒì¼ ì„ íƒ í›„ íŒŒì¼ëª… í‘œì‹œ */
    .file-name-display {
        font-size: 0.85rem;
        color: var(--text-sub);
        margin-top: 5px;
        margin-left: 5px;
        display: block;
    }

    /* 3. ì…ë ¥ í¼ ë””ìì¸ (ëª¨ë˜í•¨ì˜ í•µì‹¬) */
    label {
        display: block;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        color: var(--text-main);
    }

    input[type="text"], 
    select, 
    textarea,
    input[type="file"] {
        width: 100%;
        padding: 14px;
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        background-color: #fff;
        transition: all 0.2s ease;
        font-family: inherit;
        outline: none;
        appearance: none; /* ë¸Œë¼ìš°ì € ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
    }

    /* í¬ì»¤ìŠ¤ ì‹œ ë¶€ë“œëŸ¬ìš´ ê¸€ë¡œìš° íš¨ê³¼ */
    input:focus, select:focus, textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* íŒŒì¼ ì—…ë¡œë“œ ì»¤ìŠ¤í…€ ëŠë‚Œ */
    input[type="file"] {
        padding: 10px;
        background: #f1f5f9;
        cursor: pointer;
    }

    textarea { resize: vertical; }

    /* 4. ë²„íŠ¼ ë””ìì¸ (ê·¸ë¼ë°ì´ì…˜ & ê·¸ë¦¼ì) */
    button {
        width: 100%;
        padding: 16px;
        font-size: 1rem;
        font-weight: 700;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.2s;
    }

    button:active { transform: scale(0.98); }

    .btn-submit, .btn-check {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
    }
    
    .btn-submit:hover, .btn-check:hover {
        background: var(--primary-hover);
        box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.4);
    }

    .btn-check:disabled, .btn-submit:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        box-shadow: none;
    }

    /* 5. ì •ë³´ ë°•ìŠ¤ ë° ì•½ê´€ */
    .info-box {
        background-color: #eff6ff; /* ì•„ì£¼ ì—°í•œ ë¸”ë£¨ */
        border: 1px solid #dbeafe;
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .consent-box {
        background-color: #f8fafc;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 1.25rem;
        margin-bottom: 1rem;
    }
    
    .terms-text {
        width: 100%;
        height: 120px;
        padding: 1rem;
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--text-sub);
        margin-bottom: 10px;
        line-height: 1.5;
    }

    /* 6. ìƒíƒœ ë©”ì‹œì§€ (Alert) */
    .status-alert {
        padding: 1rem 1.5rem;
        border-radius: var(--radius);
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .status-rejected { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .status-pending { background-color: #fffbeb; color: #b45309; border: 1px solid #fde68a; }

    /* 7. ëª¨ë‹¬ (SweetAlert ìŠ¤íƒ€ì¼) */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px); /* ë¸”ëŸ¬ íš¨ê³¼ */
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popUp {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .modal-buttons { margin-top: 1.5rem; display: flex; gap: 10px; justify-content: center; }
    .btn-modal { padding: 10px 20px; font-size: 0.95rem; border-radius: 8px; }
    .btn-confirm { background: var(--primary-color); color: white; flex: 1; }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    @media (max-width: 480px) {
        .container { padding: 1.5rem; border-radius: 0; box-shadow: none; min-height: 100vh; }
        h1 { font-size: 1.5rem; }
    }
    /* [ì‹ ê·œ] í”„ë¦¬ë·° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ë‚´ìš© í™•ì¸ìš©) */
    .preview-list {
        text-align: left;
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        font-size: 0.9rem;
        max-height: 300px;
        overflow-y: auto;
    }
    .preview-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 4px;
    }
    .preview-label { color: #64748b; font-weight: 500; }
    .preview-val { font-weight: 700; color: #334155; text-align: right; max-width: 60%; }
    /* [ì‹ ê·œ] íŒŒì¼ ìš©ëŸ‰ ë° ì•ˆë‚´ ë¬¸êµ¬ ìŠ¤íƒ€ì¼ */
.file-info-text {
    font-size: 0.8rem;
    color: #94a3b8;
    margin-left: 8px;
    font-weight: 400;
}
</style>
</head>
<body>
    <div class="container active">
        <h1 id="page-title">ğŸ™‹â€â™€ï¸ í›„ë³´ì ì¶œë§ˆ ì‹ ì²­</h1>
        
        <div id="selection-section" class="selection-box">
            <h3 style="margin-top:0;">ì¶œë§ˆí•  ì„ ê±°ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
            <div id="loading-msg">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            
            <div id="select-area" style="display:none;">
                <select id="election-select">
                    <option value="">ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                </select>
                <button id="btn-check-qual" class="btn-check">ë‚´ ì„ ê±°êµ¬ í™•ì¸ ë° ì‹ ì²­ë‚´ì—­ ì¡°íšŒ</button>
            </div>
            <p id="no-election-msg" style="display:none; color:#666;">í˜„ì¬ í›„ë³´ ë“±ë¡ ê¸°ê°„ì¸ ì„ ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
 
<form id="apply-form" style="display:none; margin-top:2rem;">
            
            <div id="status-message-area"></div>
            
            <div class="info-box">
                <h4 style="margin:0 0 10px 0; color:#0f172a;">ğŸ“… ì„ ê±° ë° ì„ê¸° ì •ë³´</h4>
                <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                    <span style="color:#64748b; font-weight:600;">ì„ ê±°êµ¬:</span>
                    <strong><span id="display-district-name"></span></strong>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                    <span style="color:#64748b; font-weight:600;">ë“±ë¡ ê¸°ê°„:</span>
                    <span id="display-period"></span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:#64748b; font-weight:600;">ë‹¹ì„ ì¸ ì„ê¸°:</span>
                    <span style="color:#2563eb;">2026.02.23 ~ 2028.02.22 (2ë…„)</span>
                </div>
            </div>

            <input type="hidden" id="district-id">
            <input type="hidden" id="election-id">
            <input type="hidden" id="candidate-id">

            <h3 style="border-bottom:2px solid #333; padding-bottom:10px; margin-top:30px;">1. ê¸°ë³¸ ì¸ì ì‚¬í•­</h3>
            <div style="background:#fff7ed; padding:10px; border-radius:6px; font-size:0.85rem; color:#c2410c; margin-bottom:15px;">
                âš ï¸ ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆë‹¤ë©´ <strong><a href="/admin/members" target="_blank" style="text-decoration:underline; color:#c2410c;">[ì¡°í•©ì› ê´€ë¦¬]</a></strong> í˜ì´ì§€ì—ì„œ ë¨¼ì € ìˆ˜ì •í•´ì£¼ì„¸ìš”.
            </div>
            
            <div style="margin-bottom:1rem;">
                <label>ì´ë¦„</label>
                <input type="text" id="user-name" readonly class="readonly-input">
            </div>
            <div style="margin-bottom:1rem;">
                <label>ìƒë…„ì›”ì¼ / ì„±ë³„</label>
                <input type="text" id="user-birth-display" readonly class="readonly-input">
                <input type="hidden" id="user-birth-raw"> 
            </div>
            <div style="margin-bottom:1rem;">
                <label>ì—°ë½ì²˜</label>
                <input type="text" id="user-contact" readonly class="readonly-input">
            </div>
            <div style="margin-bottom:1rem;">
                <label>ì£¼ì†Œ</label>
                <input type="text" id="user-address" readonly class="readonly-input">
            </div>

            <h3 style="border-bottom:2px solid #333; padding-bottom:10px; margin-top:30px;">2. í›„ë³´ì ìƒì„¸ ì •ë³´</h3>

<div style="margin-bottom:1rem;">
    <label><strong>í›„ë³´ì ëª… (íˆ¬í‘œ í™”ë©´ í‘œê¸°ìš©)</strong></label>
    <input type="text" id="cand-name" required placeholder="ì˜ˆ: í™ê¸¸ë™">
</div>

<div style="margin-bottom:1.5rem; display:none;">
    <label>
        <strong>í”„ë¡œí•„ ì‚¬ì§„ (ê³µê°œ) [í•„ìˆ˜]</strong>
        <span class="file-info-text">* ìµœëŒ€ 10MB</span>
    </label>
    
    <div id="current-photo-area" style="display:none; margin-bottom:10px;">
        <img id="preview-photo" src="" style="width:80px; height:80px; object-fit:cover; border-radius:50%; border:2px solid #ddd;">
    </div>

    <div class="file-upload-wrapper">
        <input type="file" id="cand-photo" accept="image/*" class="file-upload-input">
        <label for="cand-photo" class="file-custom-label">
            ğŸ“· ì‚¬ì§„ íŒŒì¼ ì„ íƒí•˜ê¸°
        </label>
        <span id="photo-file-name" class="file-name-display">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
    </div>
</div>

<div style="margin-bottom:1rem;">
    <label><strong>ëŒ€í‘œ ì´ë ¥ [í•„ìˆ˜]</strong></label>
    <textarea id="cand-career" rows="3" required placeholder="ëŒ€í‘œ ê²½ë ¥ í•˜ë‚˜ ì…ë ¥í•˜ì„¸ìš”"></textarea>
</div>

<div style="margin-bottom:1.5rem; display:none;">
    <label>
        <strong>ì´ë ¥ ì¦ë¹™ ì„œë¥˜ (ë¹„ê³µê°œ) [í•„ìˆ˜]</strong>
        <span class="file-info-text">* ìµœëŒ€ 10MB</span>
    </label>

    <div id="current-proof-area" style="display:none; margin-bottom:5px; color:green; font-size:0.9rem;">
        âœ… ì €ì¥ëœ ì¦ë¹™ì„œë¥˜ê°€ ìˆìŠµë‹ˆë‹¤.
    </div>

    <div class="file-upload-wrapper">
        <input type="file" id="cand-proof" accept=".pdf,image/*" class="file-upload-input">
        <label for="cand-proof" class="file-custom-label" style="border-color:#64748b; color:#64748b;">
            ğŸ“‚ ì¦ë¹™ íŒŒì¼ ì„ íƒí•˜ê¸°
        </label>
        <span id="proof-file-name" class="file-name-display">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
    </div>
</div>

<div style="margin-bottom:1rem; display:none;"> <label><strong>ê³µì•½ ë° ì¶œë§ˆì˜ ë³€</strong></label>
    <textarea id="cand-manifesto" rows="5" placeholder="ì¡°í•©ì›ë“¤ì—ê²Œ ì „í•  ë©”ì‹œì§€"></textarea>
</div>

            <h3 style="border-bottom:2px solid #333; padding-bottom:10px; margin-top:30px;">3. í•„ìˆ˜ ë™ì˜</h3>
<div class="consent-box">
                <label><strong>ì‚¬ì‹¤ í™•ì¸ ì„œì•½</strong></label>
                <textarea class="terms-text" readonly>
âœ…ìœ„ ê¸°ì¬ ë‚´ìš©ì€ ì‚¬ì‹¤ê³¼ í‹€ë¦¼ì´ ì—†ìŒì„ í™•ì¸í•©ë‹ˆë‹¤.
ë§Œì•½ ê¸°ì¬ ë‚´ìš©ì´ ì‚¬ì‹¤ê³¼ ë‹¤ë¥¼ ê²½ìš° í›„ë³´ ìê²© ë°•íƒˆ ë° ë‹¹ì„  í›„ë¼ë„ ì¦‰ì‹œ ëŒ€ì˜ì› ìê²© ì •ì§€ ë° ì¡°í•©ì—ì„œ ì œëª…ë  ìˆ˜ ìˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤.                
                </textarea>
                <label style="cursor:pointer;">
                    <input type="checkbox" id="agree-privacy" required> ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.
                </label>
            </div>
    
    
            <div class="consent-box">
                <label><strong>ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜</strong></label>
                <textarea class="terms-text" readonly>
âœ… 1) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ì„œ (ëŒ€ì˜ì› ì¶œë§ˆììš©)

[ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜]
ë³¸ì¸ì€ ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©í˜‘ë™ì¡°í•©(ì´í•˜ â€œì¡°í•©â€)ì˜ ëŒ€ì˜ì› ì„ ê±° ì¶œë§ˆìë¡œì„œ, ì¡°í•©ì´ ì•„ë˜ ëª©ì ì„ ìœ„í•´ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘Â·ì´ìš©í•˜ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.
1. ìˆ˜ì§‘Â·ì´ìš© ëª©ì 
ëŒ€ì˜ì› ì„ ê±° ì¶œë§ˆ ì ‘ìˆ˜ ë° í›„ë³´ì ìê²© í™•ì¸
ì„ ê±° ê´€ë ¨ ì•ˆë‚´(ì¼ì •, ì„œë¥˜ë³´ì™„ ìš”ì²­, ê³µì§€ ë“±) ë° ì—°ë½
í›„ë³´ì ì •ë³´ì˜ ì¡°í•©ì› ê³µì§€(í›„ë³´ì ì†Œê°œ, ì´ë ¥, ê³µì•½ ë“±)
ì„ ê±° ì§„í–‰ ë° ê²°ê³¼ ì²˜ë¦¬, ì´ì˜ì‹ ì²­ ì²˜ë¦¬
ì„ ê±° ê´€ë ¨ ë¶„ìŸ ì˜ˆë°© ë° ëŒ€ì‘ì„ ìœ„í•œ ê¸°ë¡ ë³´ê´€
2. ìˆ˜ì§‘ í•­ëª©
í•„ìˆ˜: ì„±ëª…, ìƒë…„ì›”ì¼, íœ´ëŒ€ì „í™”ë²ˆí˜¸, ì£¼ì†Œ(ì„ ê±°êµ¬ í™•ì¸ìš©), ì¡°í•©ì› ë²ˆí˜¸
ì„ íƒ: í›„ë³´ì ì†Œê°œê¸€, ê²½ë ¥/ì´ë ¥, ì‚¬ì§„, ê³µì•½(ì„ ê±°í™ë³´ë¬¼ ë‚´ìš© í¬í•¨)
3. ë³´ìœ  ë° ì´ìš© ê¸°ê°„
ì„ ê±° ì¢…ë£Œì¼ë¡œë¶€í„° 2ë…„ê¹Œì§€ ë³´ê´€ í›„ íŒŒê¸°
(ë‹¨, ê´€ë ¨ ë²•ë ¹ ë˜ëŠ” ë¶„ìŸÂ·ë¯¼ì› ì²˜ë¦¬ í•„ìš” ì‹œ í•´ë‹¹ ì¢…ë£Œ ì‹œê¹Œì§€ ë³´ê´€)
4. ë™ì˜ ê±°ë¶€ ê¶Œë¦¬ ë° ë¶ˆì´ìµ
ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ëŒ€í•œ ë™ì˜ë¥¼ ê±°ë¶€í•  ìˆ˜ ìˆìœ¼ë‚˜, í•„ìˆ˜ í•­ëª© ë™ì˜ ê±°ë¶€ ì‹œ í›„ë³´ ë“±ë¡ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
âœ… 2) ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜ (í›„ë³´ì ê³µê°œìš©)
[ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜]
ë³¸ì¸ì€ ì¡°í•©ì´ ëŒ€ì˜ì› ì„ ê±° ì§„í–‰ì„ ìœ„í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ê°œì¸ì •ë³´ë¥¼ ì¡°í•©ì›ì—ê²Œ ì œê³µ(ê³µê°œ í¬í•¨)í•˜ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.
1. ì œê³µë°›ëŠ” ì
ì¡°í•©ì›(ì„ ê±°ê¶Œì) ë° ì„ ê±°ê´€ë¦¬ ê´€ë ¨ ì—…ë¬´ ìˆ˜í–‰ì
2. ì œê³µ ëª©ì 
í›„ë³´ì ì •ë³´ ê³µê°œ ë° ì„ ê±°ê¶Œìì˜ í•©ë¦¬ì  íŒë‹¨ ì§€ì›
í›„ë³´ì ê³µì•½ ë° ì´ë ¥ í™•ì¸
3. ì œê³µ í•­ëª©
í•„ìˆ˜ ê³µê°œ: ì„±ëª…(ë˜ëŠ” í›„ë³´ìëª…), ì„ ê±°êµ¬, í›„ë³´ì ì†Œê°œ/ê³µì•½
ì„ íƒ ê³µê°œ: ì‚¬ì§„, ì£¼ìš” ê²½ë ¥, ì¡°í•© í™œë™ ì´ë ¥
â€» ì—°ë½ì²˜(íœ´ëŒ€ì „í™”/ì´ë©”ì¼), ì£¼ì†Œ ì „ì²´ ë“± ë¯¼ê°í•œ ì •ë³´ëŠ” ê³µê°œí•˜ì§€ ì•ŠìŒ(ì›ì¹™)
4. ë³´ìœ  ë° ì´ìš© ê¸°ê°„
ì„ ê±° ì¢…ë£Œì¼ê¹Œì§€(ë˜ëŠ” ì„ ê±° ê´€ë ¨ ê³µì§€ ê²Œì‹œ ì¢…ë£Œì¼ê¹Œì§€)
5. ë™ì˜ ê±°ë¶€ ê¶Œë¦¬ ë° ë¶ˆì´ìµ
ë™ì˜ë¥¼ ê±°ë¶€í•  ìˆ˜ ìˆìœ¼ë‚˜, í›„ë³´ì ì •ë³´ ê³µê°œê°€ ë¶ˆê°€í•˜ì—¬ ì„ ê±° ì§„í–‰ì— ì œí•œì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </textarea>
                <label style="cursor:pointer;">
                    <input type="checkbox" id="agree-privacy" required> ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.
                </label>
            </div>

            <div class="consent-box">
                <label><strong>ì´í•´ì¶©ëŒ ë°©ì§€ ì„œì•½</strong></label>
                <textarea class="terms-text" readonly>
âœ… ì´í•´ì¶©ëŒ ë°©ì§€ ë° ê²¸ì§Â·ê±°ë˜ ì œí•œ ë™ì˜ì„œ
[ì´í•´ì¶©ëŒ ë°©ì§€ ë° ê³µì •ì„± ì¤€ìˆ˜ ë™ì˜]
ë³¸ì¸ì€ ëŒ€ì˜ì› ì„ ê±° ì¶œë§ˆìë¡œì„œ, ì¡°í•©ì˜ ê³µì •í•œ ìš´ì˜ê³¼ ì¡°í•©ì› ê¶Œìµ ë³´í˜¸ë¥¼ ìœ„í•´ ì•„ë˜ ì‚¬í•­ì„ ìˆ™ì§€í•˜ê³  ì„±ì‹¤íˆ ì¤€ìˆ˜í•  ê²ƒì„ ë™ì˜í•©ë‹ˆë‹¤.
1. ì´í•´ì¶©ëŒ ë°œìƒ ê°€ëŠ¥ì„± ì‹ ê³ 
ë³¸ì¸ì€ ì•„ë˜ ì‚¬ìœ ì— í•´ë‹¹í•˜ëŠ” ì´í•´ì¶©ëŒ ìƒí™©ì´ ë°œìƒí•˜ê±°ë‚˜ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìˆëŠ” ê²½ìš°, ì¡°í•©ì— ì¦‰ì‹œ ì„œë©´(ë˜ëŠ” ì „ìë¬¸ì„œ)ìœ¼ë¡œ ì‹ ê³ í•˜ê² ìŠµë‹ˆë‹¤.
ë³¸ì¸ ë˜ëŠ” ê°€ì¡±Â·íŠ¹ìˆ˜ê´€ê³„ì¸ì´ ì¡°í•©ê³¼ ê±°ë˜(ê³„ì•½/ìš©ì—­/ë‚©í’ˆ/ì„ëŒ€ì°¨ ë“±)ë¥¼ í•˜ê±°ë‚˜ ì˜ˆì •ì¸ ê²½ìš°
ë³¸ì¸ì´ ì†í•œ ì—…ì²´Â·ë‹¨ì²´ê°€ ì¡°í•©ê³¼ ê±°ë˜ê´€ê³„ì— ìˆëŠ” ê²½ìš°
ì¡°í•© ì˜ì‚¬ê²°ì •ì´ ë³¸ì¸ ë˜ëŠ” íŠ¹ìˆ˜ê´€ê³„ì¸ì˜ ê²½ì œì  ì´ìµì— ì§ì ‘ ì˜í–¥ì„ ì¤„ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ê²½ìš°
2. ì˜ì‚¬ê²°ì • ì°¸ì—¬ ì œí•œ(íšŒí”¼)
ì´í•´ì¶©ëŒ ìƒí™©ì´ ìˆëŠ” ì•ˆê±´ì— ëŒ€í•´ì„œëŠ” ì‹¬ì˜Â·ì˜ê²° ê³¼ì •ì—ì„œ ìì§„ íšŒí”¼í•˜ê³ , ê´€ë ¨ ì •ë³´ ì ‘ê·¼ ë° ì˜í–¥ë ¥ í–‰ì‚¬ë¥¼ í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤.
3. ë¶€ë‹¹ì´ìµ ìˆ˜ìˆ˜ ë° ì˜í–¥ë ¥ í–‰ì‚¬ ê¸ˆì§€
ë³¸ì¸ì€ ëŒ€ì˜ì› ì„ ê±° ë° ì¡°í•© ìš´ì˜ê³¼ ê´€ë ¨í•˜ì—¬ ë‹¤ìŒ í–‰ìœ„ë¥¼ í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤.
ê¸ˆí’ˆÂ·í–¥ì‘Â·í¸ì˜ ì œê³µ ë˜ëŠ” ìˆ˜ìˆ˜
ì§ìœ„ ë˜ëŠ” ì˜í–¥ë ¥ì„ ì´ìš©í•œ ë¶€ë‹¹í•œ ì²­íƒÂ·ì••ë ¥
ì¡°í•© ìê¸ˆ/ìì‚°/ì •ë³´ë¥¼ ê°œì¸ ë˜ëŠ” ì œ3ìì˜ ì´ìµì„ ìœ„í•´ ì‚¬ìš©í•˜ëŠ” í–‰ìœ„
4. ê°œì¸ì •ë³´ ë° ë‚´ë¶€ì •ë³´ ë³´í˜¸
ë³¸ì¸ì€ ì„ ê±° ë° ì¡°í•© í™œë™ ì¤‘ ì•Œê²Œ ëœ ê°œì¸ì •ë³´ ë° ë‚´ë¶€ì •ë³´ë¥¼ ëª©ì  ì™¸ ì‚¬ìš©Â·ì œ3ì ì œê³µÂ·ì™¸ë¶€ ìœ ì¶œí•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤.
5. ìœ„ë°˜ ì‹œ ì¡°ì¹˜ ë™ì˜
ë³¸ì¸ì€ ìœ„ ì‚¬í•­ ìœ„ë°˜ ì‹œ ì¡°í•©ì˜ ì •ê´€Â·ê·œì • ë° ê´€ê³„ ë²•ë ¹ì— ë”°ë¼ ì•„ë˜ ì¡°ì¹˜ê°€ ê°€ëŠ¥í•¨ì„ ì´í•´í•˜ê³  ë™ì˜í•©ë‹ˆë‹¤.
í›„ë³´ì ë“±ë¡ ì œí•œ ë˜ëŠ” ë‹¹ì„  ë¬´íš¨ ì²˜ë¦¬(ì„ ê±°ê´€ë¦¬ ê·œì •ì— ë”°ë¦„)
ì§•ê³„, ì†í•´ë°°ìƒ ì²­êµ¬, ìˆ˜ì‚¬ê¸°ê´€ ì‹ ê³  ë“± í•„ìš”í•œ ì¡°ì¹˜
[í›„ë³´ì ìœ¤ë¦¬ì„œì•½]
ë³¸ì¸ì€ ì¡°í•©ì˜ ë¯¼ì£¼ì  ìš´ì˜ê³¼ ì¡°í•©ì› ì‹ ë¢°ë¥¼ ì§€í‚¤ê¸° ìœ„í•´, ì„ ê±° ê³¼ì • ë° ë‹¹ì„  í›„ í™œë™ì—ì„œ ê³µì •ì„±Â·íˆ¬ëª…ì„±Â·ì´í•´ì¶©ëŒ ë°©ì§€ ì›ì¹™ì„ ì¤€ìˆ˜í•˜ê³  ìœ„ë°˜ ì‹œ ì±…ì„ì„ ë¶€ë‹´í•  ê²ƒì„ ì„œì•½í•©ë‹ˆë‹¤.
                </textarea>
                <label style="cursor:pointer;">
                    <input type="checkbox" id="agree-conflict" required> ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.
                </label>
            </div>

            <div style="display:flex; gap:10px; margin-top:2rem;">
                <button type="button" onclick="location.reload()" class="btn-modal" style="flex:1; background:#94a3b8; color:white;">ì·¨ì†Œ</button>
                <button type="button" id="btn-pre-check" class="btn-submit" style="flex:2;">ì‹ ì²­ì„œ ì œì¶œ</button>
            </div>

        </form> 
<div id="confirm-modal" class="modal-overlay">
            <div class="modal-content" style="max-width:500px;">
                <h3>ğŸ“ ì œì¶œ ì „ í™•ì¸í•´ì£¼ì„¸ìš”</h3>
                <p style="color:#666;">ì œì¶œ í›„ì—ëŠ” ê´€ë¦¬ì ìŠ¹ì¸ ì „ê¹Œì§€ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                
                <div class="preview-list" id="preview-content">
                    </div>

                <div class="modal-buttons">
                    <button class="btn-modal" onclick="closeConfirmModal()" style="background:#cbd5e1;">ì·¨ì†Œ</button>
                    <button class="btn-modal btn-confirm" id="btn-final-submit">í™•ì¸ ë° ì œì¶œ</button>
                </div>
            </div>
        </div>

        <div id="completed-view" style="display:none; text-align:center; padding:3rem;">
            <h2 style="color:#10b981;">ğŸ‰ í›„ë³´ ë“±ë¡ ì™„ë£Œ</h2>
            <p>ê·€í•˜ëŠ” <strong><span id="comp-election-name"></span></strong>ì˜ í›„ë³´ìë¡œ<br>ì •ìƒ ë“±ë¡(ìŠ¹ì¸)ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button onclick="location.reload()" class="btn-modal">í™•ì¸</button>
        </div>
    </div> <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">ì•Œë¦¼</h3>
            <p id="modal-msg" style="white-space: pre-wrap; line-height:1.5;"></p>
            <div class="modal-buttons" id="modal-btn-area">
                <button class="btn-modal btn-confirm">í™•ì¸</button>
            </div>
        </div>
    </div>

        <script type="module">
    import { ElectionService, supabase } from './ElectionService.js';

    const service = new ElectionService();

    // --- ì „ì—­ ë³€ìˆ˜ ---
    let currentUser = null;
    let selectedDistrict = null;
    
    // [DOM ìºì‹±] ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ
    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalMsg = document.getElementById('modal-msg');
    const modalBtnArea = document.getElementById('modal-btn-area');

    // --- [1] ìœ í‹¸: ì£¼ë¯¼ë²ˆí˜¸ íŒŒì‹± ---
    function formatRRN(rrn) {
        if (!rrn || rrn.length < 8) return rrn || '';
        const parts = rrn.split('-');
        if (parts.length < 2) return rrn;
        const front = parts[0]; 
        const backChar = parts[1].charAt(0);
        let yearPrefix, gender;
        if (['1', '2'].includes(backChar)) {
            yearPrefix = '19'; gender = (backChar === '1') ? 'ë‚¨' : 'ì—¬';
        } else if (['3', '4'].includes(backChar)) {
            yearPrefix = '20'; gender = (backChar === '3') ? 'ë‚¨' : 'ì—¬';
        } else { return rrn; }
        return `${yearPrefix}${front.substring(0, 2)}ë…„ ${front.substring(2, 4)}ì›” ${front.substring(4, 6)}ì¼ (${gender})`;
    }

    // --- [2] ìœ í‹¸: ì»¤ìŠ¤í…€ ëª¨ë‹¬ (ê¸°ì¡´ ë””ìì¸ ìœ ì§€) ---
    function showModal(title, msg, onOk = null) {
        modalTitle.innerText = title;
        modalMsg.innerText = msg;
        modalBtnArea.innerHTML = `<button class="btn-modal btn-confirm">í™•ì¸</button>`;
        modalBtnArea.querySelector('button').onclick = () => {
            modalOverlay.style.display = 'none';
            if (onOk) onOk();
        };
        modalOverlay.style.display = 'flex';
    }

// [ìˆ˜ì •] ì´ˆê¸°í™” í•¨ìˆ˜: URLì˜ id íŒŒë¼ë¯¸í„°ë¥¼ ê°ì§€í•˜ì—¬ ìë™ ì‹¤í–‰
    async function init() {
        try {
            // 1. ì„¸ì…˜ ì²˜ë¦¬
            const params = new URLSearchParams(window.location.search);
            const at = params.get('at');
            const rt = params.get('rt');
            const targetElectionId = params.get('id'); // URLì—ì„œ ID í™•ì¸

            if (at && rt) {
                const { error } = await supabase.auth.setSession({ access_token: at, refresh_token: rt });
                if (!error) {
                    // ID íŒŒë¼ë¯¸í„°ëŠ” ìœ ì§€, í† í°ë§Œ ì •ë¦¬
                    const newUrl = window.location.pathname + (targetElectionId ? `?id=${targetElectionId}` : '');
                    window.history.replaceState({}, document.title, newUrl);
                }
            }

            // 2. ë¡œê·¸ì¸ í™•ì¸
            currentUser = await service.initialize();
            
            if (!currentUser) { 
                showModal('ì•Œë¦¼', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\nì„ ê±° í¬í„¸ì—ì„œ ë‹¤ì‹œ ì ‘ì†í•´ì£¼ì„¸ìš”.', () => {
                    window.location.href = 'vote_login.html'; 
                });
                return; 
            }

            // 3. ì‚¬ìš©ì ì •ë³´ ë³´ê°•
            const { data: memberInfo } = await supabase.from('coop_members').select('*').eq('id', currentUser.id).maybeSingle();
            if (memberInfo) currentUser = { ...currentUser, ...memberInfo };

            // 4. ì„ ê±° ëª©ë¡ ë¡œë“œ
            const { data: elections } = await supabase.from('elections')
                .select('*')
                .eq('status', 'NOMINATION')
                .order('created_at', { ascending: false });

            document.getElementById('loading-msg').style.display = 'none';
            
            if (!elections || elections.length === 0) {
                document.getElementById('no-election-msg').style.display = 'block';
                return;
            }

            // 5. Select Box êµ¬ì„± ë° ìë™ ì„ íƒ ë¡œì§
            const selectEl = document.getElementById('election-select');
            let isTargetValid = false;

            elections.forEach(el => {
                const option = document.createElement('option');
                option.value = el.id;
                option.innerText = el.title;
                option.dataset.start = el.candidacy_start_at || '-';
                option.dataset.end = el.candidacy_end_at || '-';
                selectEl.appendChild(option);

                // URLì˜ IDì™€ ì¼ì¹˜í•˜ëŠ” ì„ ê±°ê°€ ìˆëŠ”ì§€ í™•ì¸
                if (targetElectionId && el.id === targetElectionId) {
                    isTargetValid = true;
                }
            });

            document.getElementById('select-area').style.display = 'block';

            // [í•µì‹¬] URLì— IDê°€ ìˆê³  ìœ íš¨í•˜ë‹¤ë©´ -> ìë™ ì‹¤í–‰
            if (isTargetValid) {
                selectEl.value = targetElectionId; // ì„ íƒê°’ ì„¸íŒ…
                checkQualification(targetElectionId); // ë°”ë¡œ ìê²© í™•ì¸ ì‹œì‘
            }

        } catch (e) { 
            console.error(e); 
            showModal('ì˜¤ë¥˜', 'ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message); 
        }
    }
            // [ì‹ ê·œ] ìê²© í™•ì¸ ë¡œì§ í•¨ìˆ˜í™” (ë²„íŠ¼ í´ë¦­ & ìë™ ì‹¤í–‰ ê³µìš©)
    async function checkQualification(electionId) {
        if (!electionId) return showModal('ì•Œë¦¼', 'ì¶œë§ˆí•  ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');

        const selectEl = document.getElementById('election-select');
        // ìˆ˜ë™ ì„ íƒì´ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê°’ ë™ê¸°í™”
        if (selectEl.value !== electionId) selectEl.value = electionId;

        // ê¸°ê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        const option = selectEl.options[selectEl.selectedIndex];
        const sDate = option.dataset.start !== '-' ? new Date(option.dataset.start).toLocaleDateString() : '-';
        const eDate = option.dataset.end !== '-' ? new Date(option.dataset.end).toLocaleDateString() : '-';
        
        const periodEl = document.getElementById('display-period');
        if(periodEl) periodEl.innerText = `${sDate} ~ ${eDate}`;

        const btn = document.getElementById('btn-check-qual');
        btn.disabled = true; btn.innerText = 'ìê²© í™•ì¸ ë° ë°ì´í„° ë¡œë”© ì¤‘...';

        try {
            // 1. ì„ ê±°ì¸ ëª…ë¶€ ì²´í¬
            const { data: voterRows } = await supabase.from('election_voters').select('district_id').eq('election_id', electionId).eq('member_uuid', currentUser.id);
            if (!voterRows || !voterRows.length) throw new Error('ì„ ê±°ì¸ ëª…ë¶€ì— ê·€í•˜ì˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\n(í•´ë‹¹ ì„ ê±°ì˜ ìœ ê¶Œìê°€ ì•„ë‹™ë‹ˆë‹¤)');

            // 2. ì§€ì—­êµ¬ ì²´í¬
            const districtIds = voterRows.map(r => r.district_id);
            const { data: districtData } = await supabase.from('districts').select('*').in('id', districtIds).eq('is_common', false).limit(1).maybeSingle();

            if (!districtData) throw new Error('ì¶œë§ˆ ê°€ëŠ¥í•œ ì§€ì—­ ì„ ê±°êµ¬ê°€ í™•ì¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n(ë¹„ë¡€ëŒ€í‘œ íˆ¬í‘œê¶Œë§Œ ìˆê±°ë‚˜ ì„ ê±°êµ¬ ë°ì´í„° ì˜¤ë¥˜)');
            if (districtData.vote_type === 'BINARY') throw new Error('ì„ íƒí•˜ì‹  ì§€ì—­êµ¬ëŠ” ì°¬ë°˜ íˆ¬í‘œ ëŒ€ìƒì´ë¯€ë¡œ\ní›„ë³´ì ë“±ë¡ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤.');

            selectedDistrict = districtData;

            // 3. ê¸°ì¡´ ì‹ ì²­ ë‚´ì—­ ì²´í¬
            const { data: existingApp } = await supabase.from('candidates').select('*').eq('election_id', electionId).eq('member_uuid', currentUser.id).maybeSingle();

            // ì„±ê³µ ì‹œ ì„ íƒ ì„¹ì…˜ ìˆ¨ê¹€ (ìì—°ìŠ¤ëŸ¬ìš´ ì „í™˜)
            document.getElementById('selection-section').style.display = 'none';

            if (existingApp && existingApp.status === 'APPROVED') {
                document.getElementById('comp-election-name').innerText = option.innerText;
                document.getElementById('completed-view').style.display = 'block';
            } else {
                openForm(!!existingApp, existingApp);
            }
        } catch (e) {
            showModal('ì•Œë¦¼', e.message);
            // ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ ì„ íƒì°½ ë³´ì—¬ì¤Œ
            document.getElementById('selection-section').style.display = 'block';
        } finally {
            btn.disabled = false; btn.innerText = 'ë‚´ ì„ ê±°êµ¬ í™•ì¸ ë° ì‹ ì²­ë‚´ì—­ ì¡°íšŒ';
        }
    }

// [ìˆ˜ì •] ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ìœ„ì—ì„œ ë§Œë“  í•¨ìˆ˜ í˜¸ì¶œ
    document.getElementById('btn-check-qual').addEventListener('click', () => {
        const id = document.getElementById('election-select').value;
        checkQualification(id);
    });

    // --- [5] í¼ ì—´ê¸° ---
    function openForm(isEdit, data) {
        document.getElementById('apply-form').style.display = 'block';

        const distNameEl = document.getElementById('display-district-name');
        if(distNameEl) distNameEl.innerText = selectedDistrict.name;

        document.getElementById('district-id').value = selectedDistrict.id;
        document.getElementById('election-id').value = document.getElementById('election-select').value;

        // ì½ê¸° ì „ìš© ë°ì´í„° ë°”ì¸ë”©
        document.getElementById('user-name').value = currentUser.name || '';
        const rrnRaw = currentUser.rrn_display || '';
        document.getElementById('user-birth-display').value = formatRRN(rrnRaw);
        document.getElementById('user-birth-raw').value = rrnRaw;
        document.getElementById('user-contact').value = currentUser.contact || currentUser.phone || '';
        document.getElementById('user-address').value = currentUser.address || '';

        // ìˆ˜ì • ëª¨ë“œ ë°ì´í„° ì±„ìš°ê¸°
        if (isEdit && data) {
            document.getElementById('candidate-id').value = data.id;
            document.getElementById('cand-name').value = data.name;
            document.getElementById('cand-career').value = data.career || '';
            document.getElementById('cand-manifesto').value = data.manifesto;
            document.getElementById('agree-privacy').checked = true;
            document.getElementById('agree-conflict').checked = true;
            if (data.photo_url) {
                document.getElementById('current-photo-area').style.display = 'block';
                document.getElementById('preview-photo').src = data.photo_url;
            }
            if (data.proof_url) {
                document.getElementById('current-proof-area').style.display = 'block';
            }
            
            // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
            const statusArea = document.getElementById('status-message-area');
            if(statusArea) {
                if (data.status === 'REJECTED') {
                    statusArea.innerHTML = `<div class="status-alert status-rejected">â›” ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${data.rejection_reason || 'í™•ì¸ í•„ìš”'}<br>ë‚´ìš©ì„ ìˆ˜ì •í•˜ì—¬ ë‹¤ì‹œ ì œì¶œí•´ì£¼ì„¸ìš”.</div>`;
                    document.getElementById('btn-pre-check').innerText = 'ìˆ˜ì •í•´ì„œ ë‹¤ì‹œ ì œì¶œ';
                } else {
                    statusArea.innerHTML = `<div class="status-alert status-pending">â³ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.<br>ë‚´ìš©ì„ ìˆ˜ì •í•˜ë©´ ê´€ë¦¬ìê°€ ë‹¤ì‹œ ê²€í† í•©ë‹ˆë‹¤.</div>`;
                    document.getElementById('btn-pre-check').innerText = 'ìˆ˜ì • ë‚´ìš© ì €ì¥';
                }
            }
        } else {
            document.getElementById('cand-name').value = currentUser.name || '';
        }
    }

    // --- [6] íŒŒì¼ ì„ íƒ UX ---
    function handleFileSelect(inputId, displayId) {
        const input = document.getElementById(inputId);
        input.addEventListener('change', function() {
            const fileName = this.files[0] ? this.files[0].name : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            document.getElementById(displayId).innerText = fileName;
            if (inputId === 'cand-photo' && this.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('preview-photo').src = e.target.result;
                    document.getElementById('current-photo-area').style.display = 'block';
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
    }
    handleFileSelect('cand-photo', 'photo-file-name');
    handleFileSelect('cand-proof', 'proof-file-name');

    // --- [7] í”„ë¦¬ë·° ëª¨ë‹¬ (Submit ëŒ€ì²´) ---
    document.getElementById('btn-pre-check').addEventListener('click', () => {
        const form = document.getElementById('apply-form');
        if (!form.reportValidity()) return; 

        const name = document.getElementById('cand-name').value;
        const photoFile = document.getElementById('cand-photo').files[0];
        const proofFile = document.getElementById('cand-proof').files[0];
        const career = document.getElementById('cand-career').value;

        const hasPhoto = photoFile ? 'ìƒˆ íŒŒì¼' : (document.getElementById('preview-photo').src ? 'ê¸°ì¡´ ìœ ì§€' : 'ì—†ìŒ');
        const hasProof = proofFile ? 'ìƒˆ íŒŒì¼' : (document.getElementById('current-proof-area').style.display !== 'none' ? 'ê¸°ì¡´ ìœ ì§€' : 'ì—†ìŒ');

        const html = `
            <div class="preview-item"><span class="preview-label">í›„ë³´ìëª…</span> <span class="preview-val">${name}</span></div>
            <div class="preview-item"><span class="preview-label">ì‚¬ì§„</span> <span class="preview-val">${hasPhoto}</span></div>
            <div class="preview-item"><span class="preview-label">ì¦ë¹™ì„œë¥˜</span> <span class="preview-val">${hasProof}</span></div>
            <div class="preview-item"><span class="preview-label">ê²½ë ¥</span> <span class="preview-val" style="font-weight:400;text-align:right;">${career.substring(0,15)}...</span></div>
        `;
        document.getElementById('preview-content').innerHTML = html;
        document.getElementById('confirm-modal').style.display = 'flex';
    });

    window.closeConfirmModal = () => document.getElementById('confirm-modal').style.display = 'none';

// --- [8] ìµœì¢… ì œì¶œ (ìˆ˜ì •ëœ ë²„ì „) ---
// --- [8] ìµœì¢… ì œì¶œ (ìˆ˜ì •ëœ ë²„ì „) ---
    document.getElementById('btn-final-submit').addEventListener('click', async () => {
        closeConfirmModal();
        const btn = document.getElementById('btn-pre-check');
        btn.disabled = true; 
        btn.innerText = 'ì œì¶œ ì¤‘...';

        try {
            const userId = currentUser.id;
            const candId = document.getElementById('candidate-id').value; // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ID
            const photoFile = document.getElementById('cand-photo').files[0];
            const proofFile = document.getElementById('cand-proof').files[0];

            // [ì„¤ì •] íŒŒì¼ ìš©ëŸ‰ ì œí•œ (10MB)
            const MAX_SIZE = 10 * 1024 * 1024; 

            // 1. í•„ìˆ˜ê°’ ê²€ì¦ (ìˆ˜ì •: ì‚¬ì§„ ë° ì¦ë¹™ì„œë¥˜ í•„ìˆ˜ ì²´í¬ ë¡œì§ ì œê±°)
            /* [ê¸°ì¡´ ì½”ë“œ ì£¼ì„ ì²˜ë¦¬]
            ìš”ì²­ì— ì˜í•´ ì‚¬ì§„ê³¼ ì¦ë¹™ì„œë¥˜ê°€ ì—†ì–´ë„ ë“±ë¡ ê°€ëŠ¥í•˜ë„ë¡ ê²€ì¦ ë¡œì§ì„ ë¹„í™œì„±í™”í•¨.
            if (!candId) {
                if (!photoFile) throw new Error('í”„ë¡œí•„ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                if (!proofFile) throw new Error('ì¦ë¹™ ì„œë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
            */

            // 2. ìš©ëŸ‰ ê²€ì¦ (íŒŒì¼ì´ ì¡´ì¬í•  ë•Œë§Œ ê²€ì‚¬)
            if (photoFile && photoFile.size > MAX_SIZE) throw new Error('í”„ë¡œí•„ ì‚¬ì§„ì€ 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            if (proofFile && proofFile.size > MAX_SIZE) throw new Error('ì¦ë¹™ ì„œë¥˜ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            // 3. íŒŒì¼ ì—…ë¡œë“œ (Service ìœ„ì„)
            // íŒŒì¼ì´ ì—†ìœ¼ë©´ null ë°˜í™˜ -> DBì—ë„ null í˜¹ì€ ê¸°ì¡´ ê°’ ìœ ì§€
            let photoUrl = null;
            let proofUrl = null;
            
            if (photoFile) photoUrl = await service.uploadCandidatePhoto(photoFile, userId);
            if (proofFile) proofUrl = await service.uploadProofDoc(proofFile, userId);

            // 4. DB ì €ì¥ ë°ì´í„° êµ¬ì„±
            const candidateObj = {
                election_id: document.getElementById('election-id').value,
                district_id: document.getElementById('district-id').value,
                member_uuid: userId,
                name: document.getElementById('cand-name').value,
                birth_date: document.getElementById('user-birth-raw').value, 
                contact: document.getElementById('user-contact').value,
                address: document.getElementById('user-address').value,
                career: document.getElementById('cand-career').value,
                manifesto: document.getElementById('cand-manifesto').value, 
                agreed: true,
                status: 'PENDING',
                created_at: new Date().toISOString() // ì£¼ì˜: Update ì‹œì—ëŠ” ì´ í•„ë“œë¥¼ ì œì™¸í•˜ê±°ë‚˜ DB íŠ¸ë¦¬ê±° í™•ì¸ í•„ìš”
            };

            // íŒŒì¼ì´ ìƒˆë¡œ ì—…ë¡œë“œëœ ê²½ìš°ì—ë§Œ URL ì—…ë°ì´íŠ¸
            if (photoUrl) candidateObj.photo_url = photoUrl;
            if (proofUrl) candidateObj.proof_url = proofUrl;

            // 5. Insert ë˜ëŠ” Update ì‹¤í–‰
            let result;
            if (candId) {
                // ìˆ˜ì •: IDë¡œ ì—…ë°ì´íŠ¸ (created_at ë“± ë¶ˆí•„ìš”í•œ í•„ë“œëŠ” ì œì™¸í•˜ëŠ” ê²ƒì´ ì •ì„ì´ë‚˜, í¸ì˜ìƒ ìœ ì§€í•¨)
                result = await supabase.from('candidates').update(candidateObj).eq('id', candId);
            } else {
                // ì‹ ê·œ: ì‚½ì…
                result = await supabase.from('candidates').insert(candidateObj);
            }
            
            if (result.error) throw result.error;

            showModal('ì„±ê³µ', 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', () => location.reload());

        } catch (err) {
            console.error(err);
            showModal('ì œì¶œ ì‹¤íŒ¨', err.message);
            btn.disabled = false; 
            btn.innerText = 'ì‹ ì²­ì„œ ì œì¶œ';
        }
    });
    // End of btn-final-submit event listener
    // End of btn-final-submit event listener

    init();
    </script>
</body>
</html>
