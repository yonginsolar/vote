<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í›„ë³´ì ë“±ë¡ ì‹ ì²­</title>
    <link rel="stylesheet" href="style.css">
<style>
    :root {
        --primary-color: #2563eb; /* ì‹ ë¢°ì˜ ë¸”ë£¨ */
        --primary-hover: #1d4ed8;
        --bg-color: #f8fafc;
        --card-bg: #ffffff;
        --text-main: #1e293b;
        --text-sub: #64748b;
        --border-color: #e2e8f0;
        --error-color: #ef4444;
        --success-color: #10b981;
        --radius: 12px;
    }

    /* 1. ê¸°ë³¸ íƒ€ì´í¬ê·¸ë˜í”¼ ë° ë¦¬ì…‹ */
    * { box-sizing: border-box; }
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Pretendard", Roboto, "Noto Sans KR", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        line-height: 1.6;
        display: flex;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
    }

    /* 2. ë©”ì¸ ì»¨í…Œì´ë„ˆ (ì¹´ë“œ ìŠ¤íƒ€ì¼) */
    .container {
        background: var(--card-bg);
        width: 100%;
        max-width: 600px;
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
    }

    h1 {
        font-size: 1.75rem;
        font-weight: 800;
        text-align: center;
        margin-bottom: 2rem;
        color: #0f172a;
    }
    
    h3 {
        font-size: 1.25rem;
        font-weight: 700;
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: #334155;
    }

    /* 3. ì…ë ¥ í¼ ë””ìì¸ (ëª¨ë˜í•¨ì˜ í•µì‹¬) */
    label {
        display: block;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        color: var(--text-main);
    }

    input[type="text"], 
    select, 
    textarea,
    input[type="file"] {
        width: 100%;
        padding: 14px;
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        background-color: #fff;
        transition: all 0.2s ease;
        font-family: inherit;
        outline: none;
        appearance: none; /* ë¸Œë¼ìš°ì € ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
    }

    /* í¬ì»¤ìŠ¤ ì‹œ ë¶€ë“œëŸ¬ìš´ ê¸€ë¡œìš° íš¨ê³¼ */
    input:focus, select:focus, textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* íŒŒì¼ ì—…ë¡œë“œ ì»¤ìŠ¤í…€ ëŠë‚Œ */
    input[type="file"] {
        padding: 10px;
        background: #f1f5f9;
        cursor: pointer;
    }

    textarea { resize: vertical; }

    /* 4. ë²„íŠ¼ ë””ìì¸ (ê·¸ë¼ë°ì´ì…˜ & ê·¸ë¦¼ì) */
    button {
        width: 100%;
        padding: 16px;
        font-size: 1rem;
        font-weight: 700;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.2s;
    }

    button:active { transform: scale(0.98); }

    .btn-submit, .btn-check {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
    }
    
    .btn-submit:hover, .btn-check:hover {
        background: var(--primary-hover);
        box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.4);
    }

    .btn-check:disabled, .btn-submit:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        box-shadow: none;
    }

    /* 5. ì •ë³´ ë°•ìŠ¤ ë° ì•½ê´€ */
    .info-box {
        background-color: #eff6ff; /* ì•„ì£¼ ì—°í•œ ë¸”ë£¨ */
        border: 1px solid #dbeafe;
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .consent-box {
        background-color: #f8fafc;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 1.25rem;
        margin-bottom: 1rem;
    }
    
    .terms-text {
        width: 100%;
        height: 120px;
        padding: 1rem;
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--text-sub);
        margin-bottom: 10px;
        line-height: 1.5;
    }

    /* 6. ìƒíƒœ ë©”ì‹œì§€ (Alert) */
    .status-alert {
        padding: 1rem 1.5rem;
        border-radius: var(--radius);
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .status-rejected { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .status-pending { background-color: #fffbeb; color: #b45309; border: 1px solid #fde68a; }

    /* 7. ëª¨ë‹¬ (SweetAlert ìŠ¤íƒ€ì¼) */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px); /* ë¸”ëŸ¬ íš¨ê³¼ */
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popUp {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .modal-buttons { margin-top: 1.5rem; display: flex; gap: 10px; justify-content: center; }
    .btn-modal { padding: 10px 20px; font-size: 0.95rem; border-radius: 8px; }
    .btn-confirm { background: var(--primary-color); color: white; flex: 1; }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    @media (max-width: 480px) {
        .container { padding: 1.5rem; border-radius: 0; box-shadow: none; min-height: 100vh; }
        h1 { font-size: 1.5rem; }
    }
</style>
</head>
<body>
    <div class="container active">
        <h1 id="page-title">ğŸ™‹â€â™€ï¸ í›„ë³´ì ì¶œë§ˆ ì‹ ì²­</h1>
        
        <div id="selection-section" class="selection-box">
            <h3 style="margin-top:0;">ì¶œë§ˆí•  ì„ ê±°ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
            <div id="loading-msg">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            
            <div id="select-area" style="display:none;">
                <select id="election-select">
                    <option value="">ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                </select>
                <button id="btn-check-qual" class="btn-check">ë‚´ ì„ ê±°êµ¬ í™•ì¸ ë° ì‹ ì²­ë‚´ì—­ ì¡°íšŒ</button>
            </div>
            <p id="no-election-msg" style="display:none; color:#666;">í˜„ì¬ í›„ë³´ ë“±ë¡ ê¸°ê°„ì¸ ì„ ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
 
        <form id="apply-form" style="display:none; margin-top:2rem;">
            
            <div id="status-message-area"></div>

            <div class="info-box">
                <h4 style="margin:0 0 10px 0; color:#0f172a;">ğŸ“… ì„ ê±° ë° ì„ê¸° ì •ë³´</h4>
                <div class="info-row">
                    <span class="label-text">ì„ ê±°êµ¬:</span>
                    <strong><span id="display-district-name"></span></strong>
                </div>
                <div class="info-row">
                    <span class="label-text">ë“±ë¡ ê¸°ê°„:</span>
                    <span id="display-period"></span>
                </div>
                <div class="info-row">
                    <span class="label-text">ë‹¹ì„ ì¸ ì„ê¸°:</span>
                    <span style="color:#2563eb;">2026.02.23 ~ 2028.02.22 (2ë…„)</span>
                </div>
            </div>

            <input type="hidden" id="district-id">
            <input type="hidden" id="election-id">
            <input type="hidden" id="candidate-id"> <h3 style="border-bottom:2px solid #333; padding-bottom:10px; margin-top:30px;">1. ê¸°ë³¸ ì¸ì ì‚¬í•­</h3>
            <p style="font-size:0.8rem; color:#666;">* ìˆ˜ì • ì‹œ íšŒì› ì •ë³´ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
            
            <div style="margin-bottom:1rem;">
                <label>ì´ë¦„</label>
                <input type="text" id="user-name" required placeholder="ì´ë¦„" style="width:100%; padding:0.5rem;">
            </div>
            <div style="margin-bottom:1rem;">
                <label>ìƒë…„ì›”ì¼ (YYYY-MM-DD)</label>
                <input type="text" id="user-birth" required placeholder="ì˜ˆ: 1980-01-01" style="width:100%; padding:0.5rem;">
            </div>
            <div style="margin-bottom:1rem;">
                <label>ì—°ë½ì²˜</label>
                <input type="text" id="user-contact" required placeholder="010-0000-0000" style="width:100%; padding:0.5rem;">
            </div>
            <div style="margin-bottom:1rem;">
                <label>ì£¼ì†Œ</label>
                <input type="text" id="user-address" required placeholder="ë„ë¡œëª… ì£¼ì†Œ ì „ì²´ ì…ë ¥" style="width:100%; padding:0.5rem;">
            </div>

            <h3 style="border-bottom:2px solid #333; padding-bottom:10px; margin-top:30px;">2. í›„ë³´ì ìƒì„¸ ì •ë³´</h3>
            
            <div style="margin-bottom:1rem;">
                <label><strong>í›„ë³´ì ëª… (íˆ¬í‘œ í™”ë©´ í‘œê¸°ìš©)</strong></label>
                <input type="text" id="cand-name" required placeholder="ì˜ˆ: í™ê¸¸ë™" style="width:100%; padding:0.5rem;">
            </div>

            <div style="margin-bottom:1rem;">
                <label><strong>í”„ë¡œí•„ ì‚¬ì§„ (ê³µê°œ)</strong></label>
                <div id="current-photo-area" style="display:none; margin-bottom:5px;">
                    <img id="preview-photo" src="" style="width:100px; height:100px; object-fit:cover; border-radius:4px; border:1px solid #ccc;">
                    <p style="font-size:0.8rem; margin:0;">í˜„ì¬ ë“±ë¡ëœ ì‚¬ì§„ (ë³€ê²½í•˜ë ¤ë©´ ì•„ë˜ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”)</p>
                </div>
                <input type="file" id="cand-photo" accept="image/*" style="width:100%;">
            </div>

            <div style="margin-bottom:1rem;">
                <label><strong>ëŒ€í‘œ ì´ë ¥ (ì£¼ìš” ê²½ë ¥)</strong></label>
                <textarea id="cand-career" rows="3" required placeholder="ì˜ˆ: OOë…¸ë™ì¡°í•© ìœ„ì›ì¥ (2020~2022)" style="width:100%; padding:0.5rem;"></textarea>
            </div>

            <div style="margin-bottom:1rem;">
                <label><strong>ì´ë ¥ ì¦ë¹™ ì„œë¥˜ (ë¹„ê³µê°œ)</strong></label>
                <p style="font-size:0.8rem; color:#666; margin-top:0;">* ì¬ì§ì¦ëª…ì„œ ë“±ì„ í•˜ë‚˜ë¡œ í•©ì³ PDF/ì´ë¯¸ì§€ë¡œ ì²¨ë¶€ (ê´€ë¦¬ìë§Œ ì—´ëŒ ê°€ëŠ¥)</p>
                <div id="current-proof-area" style="display:none; margin-bottom:5px;">
                    <span style="color:green;">âœ… ì¦ë¹™ì„œë¥˜ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</span>
                </div>
                <input type="file" id="cand-proof" accept=".pdf,image/*" style="width:100%;">
            </div>

            <div style="margin-bottom:1rem;">
                <label><strong>ê³µì•½ ë° ì¶œë§ˆì˜ ë³€</strong></label>
                <textarea id="cand-manifesto" rows="5" required placeholder="ì¡°í•©ì›ë“¤ì—ê²Œ ì „í•  ë©”ì‹œì§€" style="width:100%; padding:0.5rem;"></textarea>
            </div>

            <h3 style="border-bottom:2px solid #333; padding-bottom:10px; margin-top:30px;">3. í•„ìˆ˜ ë™ì˜</h3>
            
            <div class="consent-box">
                <label><strong>ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜</strong></label>
                <textarea class="terms-text" readonly>
1. ìˆ˜ì§‘ í•­ëª©: ì´ë¦„, ìƒë…„ì›”ì¼, ì—°ë½ì²˜, ì£¼ì†Œ, ì‚¬ì§„, ì´ë ¥, ì¦ë¹™ì„œë¥˜
2. ìˆ˜ì§‘ ëª©ì : í›„ë³´ì ìê²© ì‹¬ì‚¬, ì„ ê±°ì¸ ëª…ë¶€ ëŒ€ì¡°, íˆ¬í‘œ í™”ë©´ í‘œì¶œ
3. ë³´ìœ  ê¸°ê°„: ì„ê¸° ë§Œë£Œ í›„ íŒŒê¸° (ë‹¨, ë²•ë ¹ì— ë”°ë¦„)
â€» ë™ì˜ë¥¼ ê±°ë¶€í•  ê¶Œë¦¬ê°€ ìˆìœ¼ë‚˜, ê±°ë¶€ ì‹œ í›„ë³´ ë“±ë¡ì´ ì œí•œë©ë‹ˆë‹¤.
                </textarea>
                <label style="cursor:pointer;">
                    <input type="checkbox" id="agree-privacy" required> ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.
                </label>
            </div>

            <div class="consent-box">
                <label><strong>ì´í•´ì¶©ëŒ ë°©ì§€ ì„œì•½</strong></label>
                <textarea class="terms-text" readonly>
ë³¸ì¸ì€ í›„ë³´ìë¡œì„œ ê³µì •í•œ ì„ ê±° ìš´ë™ì„ ì§„í–‰í•˜ë©°, 
ë‹¹ì„  ì‹œ ì¡°í•©ì›ì˜ ê¶Œìµì„ ìœ„í•´ í—Œì‹ í•˜ê³  ì‚¬ì  ì´ìµì„ ì¶”êµ¬í•˜ì§€ ì•Šì„ ê²ƒì„ ì„œì•½í•©ë‹ˆë‹¤.
í—ˆìœ„ ì‚¬ì‹¤ ê¸°ì¬ ì‹œ ë‹¹ì„ ì´ ë¬´íš¨ ì²˜ë¦¬ë  ìˆ˜ ìˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤.
                </textarea>
                <label style="cursor:pointer;">
                    <input type="checkbox" id="agree-conflict" required> ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.
                </label>
            </div>

            <div style="display:flex; gap:10px; margin-top:2rem;">
                <button type="button" onclick="location.reload()" class="btn-modal" style="flex:1; background:#999; color:white;">ì·¨ì†Œ</button>
                <button type="submit" id="btn-submit" class="btn-submit" style="flex:2;">ì‹ ì²­ì„œ ì œì¶œ</button>
            </div>
        </form>

        <div id="completed-view" style="display:none; text-align:center; padding:3rem;">
            <h2 style="color:#10b981;">ğŸ‰ í›„ë³´ ë“±ë¡ ì™„ë£Œ</h2>
            <p>ê·€í•˜ëŠ” <strong><span id="comp-election-name"></span></strong>ì˜ í›„ë³´ìë¡œ<br>ì •ìƒ ë“±ë¡(ìŠ¹ì¸)ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button onclick="location.reload()" class="btn-modal">í™•ì¸</button>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">ì•Œë¦¼</h3>
            <p id="modal-msg" style="white-space: pre-wrap; line-height:1.5;"></p>
            <div class="modal-buttons" id="modal-btn-area">
                <button class="btn-modal btn-confirm">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { ElectionService, supabase } from './ElectionService.js';
        
        // --- ElectionService í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸ (Private ì—…ë¡œë“œ ê¸°ëŠ¥ ì¶”ê°€) ---
        // ì›ë˜ëŠ” íŒŒì¼ ë¶„ë¦¬ê°€ ë§ìœ¼ë‚˜, í¸ì˜ìƒ ì—¬ê¸° Override ë¡œì§ì„ í¬í•¨í•˜ê±°ë‚˜ 
        // ê¸°ì¡´ ElectionService.js íŒŒì¼ì— ì•„ë˜ ë©”ì„œë“œë¥¼ ë°˜ë“œì‹œ ì¶”ê°€í•´ì•¼ í•¨.
        /* [ElectionService.js ì— ì¶”ê°€í•  í•¨ìˆ˜]
           async uploadProofDoc(file, userId) {
                // ...Private Bucket ì—…ë¡œë“œ ë¡œì§...
           }
        */

        const service = new ElectionService();
        
        // DOM ìš”ì†Œ
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMsg = document.getElementById('modal-msg');
        const modalBtnArea = document.getElementById('modal-btn-area');

        let currentUser = null;
        let selectedDistrict = null; // ì„ íƒëœ ì„ ê±°êµ¬ ì •ë³´

        async function init() {
            try {
                // 1. ìœ ì € ì •ë³´ + Member í…Œì´ë¸” ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                currentUser = await service.initialize(); 
                if (!currentUser) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    location.href = '/login.html';
                    return;
                }

                // 2. NOMINATION ìƒíƒœì¸ ì„ ê±° ëª©ë¡
                const { data: elections, error } = await supabase
                    .from('elections')
                    .select('*') // ê¸°ê°„ ì •ë³´ í•„ìš”í•˜ë¯€ë¡œ ì „ì²´ select
                    .eq('status', 'NOMINATION')
                    .order('created_at', { ascending: false });

                document.getElementById('loading-msg').style.display = 'none';

                if (!elections || elections.length === 0) {
                    document.getElementById('no-election-msg').style.display = 'block';
                    return;
                }

                const selectEl = document.getElementById('election-select');
                elections.forEach(el => {
                    const option = document.createElement('option');
                    option.value = el.id;
                    option.innerText = el.title;
                    // ê¸°ê°„ ì •ë³´ ë“±ì„ data ì†ì„±ì— ì €ì¥
                    option.dataset.start = el.candidacy_start_at || '-';
                    option.dataset.end = el.candidacy_end_at || '-';
                    selectEl.appendChild(option);
                });

                document.getElementById('select-area').style.display = 'block';

            } catch (e) {
                showModal('ì˜¤ë¥˜', 'ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message);
            }
        }

        // [ì´ë²¤íŠ¸] í™•ì¸ ë²„íŠ¼ (ìê²© ì²´í¬ + ê¸°ì¡´ ì‹ ì²­ ë‚´ì—­ í™•ì¸)
        document.getElementById('btn-check-qual').addEventListener('click', async () => {
            const selectEl = document.getElementById('election-select');
            const electionId = selectEl.value;
            if (!electionId) return showModal('ì•Œë¦¼', 'ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');

            const option = selectEl.options[selectEl.selectedIndex];
            // ë“±ë¡ ê¸°ê°„ í‘œì‹œ
            const periodStr = `${new Date(option.dataset.start).toLocaleDateString()} ~ ${new Date(option.dataset.end).toLocaleDateString()}`;
            document.getElementById('display-period').innerText = periodStr;

            const btn = document.getElementById('btn-check-qual');
            btn.disabled = true;
            btn.innerText = 'ì¡°íšŒ ì¤‘...';

            try {
                // 1. ì„ ê±°êµ¬ ì°¾ê¸° (ì´ì „ ìˆ˜ì • ì½”ë“œ ì ìš©)
                const { data: voterRows } = await supabase.from('election_voters').select('district_id').eq('election_id', electionId).eq('member_uuid', currentUser.id);
                if (!voterRows || voterRows.length === 0) throw new Error('ì„ ê±°ì¸ ëª…ë¶€ì— ê·€í•˜ì˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                
                const districtIds = voterRows.map(r => r.district_id);
                const { data: districtData } = await supabase.from('districts').select('*').in('id', districtIds).eq('is_common', false).limit(1).maybeSingle();
                
                if (!districtData) throw new Error('ì¶œë§ˆ ê°€ëŠ¥í•œ ì§€ì—­ ì„ ê±°êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤. (ë¹„ë¡€ëŒ€í‘œ ê¶Œí•œë§Œ ë³´ìœ )');
                if (districtData.vote_type === 'BINARY') throw new Error('ì°¬ë°˜ íˆ¬í‘œ ì§€ì—­ì€ í›„ë³´ ë“±ë¡ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');

                selectedDistrict = districtData; // ì „ì—­ ì €ì¥

                // 2. ê¸°ì¡´ ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ (ìƒíƒœ í™•ì¸ìš©)
                const { data: existingApp } = await supabase
                    .from('candidates')
                    .select('*')
                    .eq('election_id', electionId)
                    .eq('member_uuid', currentUser.id)
                    .maybeSingle();

                // 3. UI ë¶„ê¸° ì²˜ë¦¬
                document.getElementById('selection-section').style.display = 'none';
                
                if (existingApp) {
                    if (existingApp.status === 'APPROVED') {
                        // ìŠ¹ì¸ë¨ -> ì™„ë£Œ í™”ë©´
                        document.getElementById('comp-election-name').innerText = option.innerText;
                        document.getElementById('completed-view').style.display = 'block';
                    } else {
                        // ëŒ€ê¸°(PENDING) ë˜ëŠ” ë°˜ë ¤(REJECTED) -> ìˆ˜ì • í¼ ì—´ê¸°
                        openForm(true, existingApp);
                    }
                } else {
                    // ì‹ ê·œ ì‹ ì²­
                    openForm(false, null);
                }

            } catch (e) {
                showModal('ë¶ˆê°€', e.message);
                document.getElementById('selection-section').style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerText = 'ë‚´ ì„ ê±°êµ¬ í™•ì¸ ë° ì‹ ì²­ë‚´ì—­ ì¡°íšŒ';
            }
        });

        // í¼ ì—´ê¸° í•¨ìˆ˜ (mode: isEdit)
        function openForm(isEdit, data) {
            const form = document.getElementById('apply-form');
            form.style.display = 'block';

            // ê¸°ë³¸ ë°ì´í„° ì„¸íŒ…
            document.getElementById('display-district-name').innerText = selectedDistrict.name;
            document.getElementById('district-id').value = selectedDistrict.id;
            document.getElementById('election-id').value = document.getElementById('election-select').value;
            
            // 1. ì¸ì ì‚¬í•­ ì±„ìš°ê¸° (Members í…Œì´ë¸” ì •ë³´ or ê¸°ì¡´ ì‹ ì²­ ì •ë³´)
            // currentUserì— member ì •ë³´ê°€ ìˆë‹¤ê³  ê°€ì • (init í•¨ìˆ˜ ì°¸ì¡°)
            document.getElementById('user-name').value = currentUser.name || '';
            document.getElementById('user-birth').value = currentUser.birth_date || ''; // DBì¹¼ëŸ¼ëª… í™•ì¸ í•„ìš”
            document.getElementById('user-contact').value = currentUser.contact || currentUser.phone || '';
            document.getElementById('user-address').value = currentUser.address || '';

            // 2. ìƒíƒœë³„ ë©”ì‹œì§€ ë° ë°ì´í„° ë°”ì¸ë”©
            const statusArea = document.getElementById('status-message-area');
            statusArea.innerHTML = '';
            
            if (isEdit && data) {
                document.getElementById('candidate-id').value = data.id;
                document.getElementById('cand-name').value = data.name;
                document.getElementById('cand-career').value = data.career || '';
                document.getElementById('cand-manifesto').value = data.manifesto;
                document.getElementById('agree-privacy').checked = true; // ìˆ˜ì • ì‹œì—” ì´ë¯¸ ë™ì˜í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼ ê°€ëŠ¥
                document.getElementById('agree-conflict').checked = true;

                // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
                if (data.photo_url) {
                    document.getElementById('current-photo-area').style.display = 'block';
                    document.getElementById('preview-photo').src = data.photo_url;
                }
                // ì¦ë¹™ í™•ì¸
                if (data.proof_url) {
                    document.getElementById('current-proof-area').style.display = 'block';
                }

                if (data.status === 'REJECTED') {
                    statusArea.innerHTML = `<div class="status-alert status-rejected">
                        â›” ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì‚¬ìœ : ${data.rejection_reason || 'ê´€ë¦¬ì ë¬¸ì˜ í•„ìš”'}<br>ë‚´ìš©ì„ ìˆ˜ì •í•˜ì—¬ ë‹¤ì‹œ ì œì¶œí•´ì£¼ì„¸ìš”.
                    </div>`;
                    document.getElementById('btn-submit').innerText = 'ìˆ˜ì •í•´ì„œ ë‹¤ì‹œ ì œì¶œ';
                } else {
                    statusArea.innerHTML = `<div class="status-alert status-pending">
                        â³ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.<br>ë‚´ìš©ì„ ìˆ˜ì •í•˜ë©´ ê´€ë¦¬ìê°€ ë‹¤ì‹œ ê²€í† í•©ë‹ˆë‹¤.
                    </div>`;
                    document.getElementById('btn-submit').innerText = 'ìˆ˜ì • ë‚´ìš© ì €ì¥';
                }
            } else {
                // ì‹ ê·œ
                document.getElementById('cand-name').value = currentUser.name || '';
                document.getElementById('btn-submit').innerText = 'ì‹ ì²­ì„œ ì œì¶œ';
            }
        }

        // [ì´ë²¤íŠ¸] í¼ ì œì¶œ
        document.getElementById('apply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = 'ì²˜ë¦¬ ì¤‘...';

            try {
                const userId = currentUser.id;
                const candId = document.getElementById('candidate-id').value; // ìˆìœ¼ë©´ ìˆ˜ì •
                
                // 1. íŒŒì¼ ì—…ë¡œë“œ
                const photoFile = document.getElementById('cand-photo').files[0];
                const proofFile = document.getElementById('cand-proof').files[0];

                let photoUrl = null;
                let proofUrl = null;

                // ì‹ ê·œì¸ë° ì‚¬ì§„ ì•ˆ ì˜¬ë¦¼ ì²´í¬
                if (!candId && !photoFile) throw new Error('í”„ë¡œí•„ ì‚¬ì§„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                // ì‹ ê·œì¸ë° ì¦ë¹™ ì•ˆ ì˜¬ë¦¼ ì²´í¬
                if (!candId && !proofFile) throw new Error('ì´ë ¥ ì¦ë¹™ ì„œë¥˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');

                // ì—…ë¡œë“œ ìˆ˜í–‰ (Serviceì— í•¨ìˆ˜ ì¶”ê°€ í•„ìš”)
                if (photoFile) photoUrl = await service.uploadCandidatePhoto(photoFile, userId);
                if (proofFile) proofUrl = await service.uploadProofDoc(proofFile, userId); // ì‹ ê·œ ì¶”ê°€ í•¨ìˆ˜ í˜¸ì¶œ

                // 2. Member ì •ë³´ ì—…ë°ì´íŠ¸ (ì—°ë½ì²˜, ì£¼ì†Œ ë“± í˜„í–‰í™”)
                const updateMemberObj = {
                    name: document.getElementById('user-name').value,
                    birth_date: document.getElementById('user-birth').value,
                    contact: document.getElementById('user-contact').value,
                    address: document.getElementById('user-address').value
                };
                
                const { error: memError } = await supabase.from('members').update(updateMemberObj).eq('id', userId);
                if (memError) console.warn('íšŒì› ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨(ê¶Œí•œ ë¬¸ì œ ê°€ëŠ¥ì„±):', memError);

                // 3. Candidate Upsert (Insert or Update)
                const candidateObj = {
                    election_id: document.getElementById('election-id').value,
                    district_id: document.getElementById('district-id').value,
                    member_uuid: userId,
                    name: document.getElementById('cand-name').value,
                    career: document.getElementById('cand-career').value,
                    manifesto: document.getElementById('cand-manifesto').value,
                    agreed: true, // ë™ì˜í•¨
                    status: 'PENDING', // ìˆ˜ì •/ì œì¶œ ì‹œ ë¬´ì¡°ê±´ ëŒ€ê¸° ìƒíƒœë¡œ ë¦¬ì…‹
                    created_at: new Date().toISOString() // created_at ê°±ì‹  or updated_at ë³„ë„ ê´€ë¦¬
                };

                // íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ í•„ë“œ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ URL ìœ ì§€)
                if (photoUrl) candidateObj.photo_url = photoUrl;
                if (proofUrl) candidateObj.proof_url = proofUrl;

                // ìˆ˜ì •(Update) vs ì‹ ê·œ(Insert)
                let result;
                if (candId) {
                    result = await supabase.from('candidates').update(candidateObj).eq('id', candId);
                } else {
                    result = await supabase.from('candidates').insert(candidateObj);
                }

                if (result.error) throw result.error;

                showModal('ì™„ë£Œ', 'ì •ìƒì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', () => location.reload());

            } catch (err) {
                console.error(err);
                showModal('ì‹¤íŒ¨', err.message);
                btn.disabled = false;
                btn.innerText = 'ë‹¤ì‹œ ì œì¶œ';
            }
        });

        // --- ìœ í‹¸ ---
        function showModal(title, msg, onOk) {
            modalTitle.innerText = title;
            modalMsg.innerText = msg;
            modalBtnArea.innerHTML = `<button class="btn-modal btn-confirm">í™•ì¸</button>`;
            modalBtnArea.querySelector('button').onclick = () => {
                modalOverlay.style.display = 'none';
                if (onOk) onOk();
            };
            modalOverlay.style.display = 'flex';
        }
        
        init();
    </script>
</body>
</html>
