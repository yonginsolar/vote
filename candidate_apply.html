<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í›„ë³´ì ë“±ë¡ ì‹ ì²­</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ì¶”ê°€ ìŠ¤íƒ€ì¼: ì„ ê±° ì„ íƒ ì„¹ì…˜ */
        .selection-box {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .selection-box select {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn-check {
            background-color: var(--primary-color, #10b981);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
        }
        .btn-check:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container active">
        <h1>ğŸ™‹â€â™€ï¸ í›„ë³´ì ì¶œë§ˆ ì‹ ì²­</h1>
        
        <div id="selection-section" class="selection-box">
            <h3 style="margin-top:0;">ì¶œë§ˆí•  ì„ ê±°ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
            <div id="loading-msg">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            
            <div id="select-area" style="display:none;">
                <select id="election-select">
                    <option value="">ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                </select>
                <button id="btn-check-qual" class="btn-check">ë‚´ ì„ ê±°êµ¬ í™•ì¸í•˜ê¸°</button>
            </div>
            <p id="no-election-msg" style="display:none; color:#666;">í˜„ì¬ í›„ë³´ ë“±ë¡ ê¸°ê°„ì¸ ì„ ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <form id="apply-form" style="display:none; margin-top:2rem;">
            <div style="background:#f0f9ff; padding:1rem; border-radius:6px; margin-bottom:1.5rem; border:1px solid #bae6fd;">
                <h3 style="margin:0 0 0.5rem 0; color:#0369a1;">ğŸ“ ì†Œì† ì„ ê±°êµ¬ í™•ì¸</h3>
                <p style="margin:0; color:#0c4a6e;">
                    ê·€í•˜ëŠ” <strong><span id="display-district-name" style="font-size:1.1rem; text-decoration:underline;"></span></strong> ì„ ê±°êµ¬ì— ì¶œë§ˆí•©ë‹ˆë‹¤.
                </p>
            </div>

            <input type="hidden" id="district-id">
            <input type="hidden" id="election-id">

            <div style="margin-bottom:1rem;">
                <label><strong>í›„ë³´ì ëª… (í‘œê¸°ìš©)</strong></label>
                <input type="text" id="cand-name" required placeholder="ì˜ˆ: í™ê¸¸ë™"
                       style="width:100%; padding:0.5rem; margin-top:0.5rem;">
            </div>

            <div style="margin-bottom:1rem;">
                <label><strong>í”„ë¡œí•„ ì‚¬ì§„</strong></label>
                <input type="file" id="cand-photo" accept="image/*" required
                       style="width:100%; margin-top:0.5rem;">
                <p style="font-size:0.8rem; color:#666;">* ì •ì‚¬ê°í˜• ë¹„ìœ¨ ê¶Œì¥ (5MB ì´í•˜)</p>
            </div>

            <div style="margin-bottom:1rem;">
                <label><strong>ê³µì•½ ë° ì†Œê°œ</strong></label>
                <textarea id="cand-manifesto" rows="5" required placeholder="ì¡°í•©ì›ë“¤ì—ê²Œ ì „í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
                          style="width:100%; padding:0.5rem; margin-top:0.5rem;"></textarea>
            </div>

            <div style="display:flex; gap:10px;">
                <button type="button" onclick="location.reload()" class="btn-modal" style="flex:1; background:#999; color:white;">ì²˜ìŒìœ¼ë¡œ</button>
                <button type="submit" id="btn-submit" class="btn-submit" style="flex:2;">ì‹ ì²­ì„œ ì œì¶œ</button>
            </div>
        </form>

        <div id="already-applied" style="display:none; text-align:center; padding:2rem;">
            <h3>âœ… ì´ë¯¸ ì‹ ì²­í•˜ì…¨ìŠµë‹ˆë‹¤.</h3>
            <p>ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            <button onclick="window.history.back()" class="btn-modal">ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">ì•Œë¦¼</h3>
            <p id="modal-msg" style="white-space: pre-wrap; line-height:1.5;"></p>
            <div class="modal-buttons" id="modal-btn-area">
                <button id="modal-btn-ok" class="btn-modal btn-confirm">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { ElectionService, supabase } from './ElectionService.js';
        const service = new ElectionService();
        
        // DOM ìš”ì†Œ ìºì‹±
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMsg = document.getElementById('modal-msg');
        const modalBtnArea = document.getElementById('modal-btn-area');

        let currentUser = null;

        async function init() {
            try {
                // 1. ë¡œê·¸ì¸ ì²´í¬ (Service í™œìš©)
                currentUser = await service.initialize();
                if (!currentUser) {
                    showModal('ì•Œë¦¼', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', () => location.href = '/login.html');
                    return;
                }

                // 2. NOMINATION ìƒíƒœì¸ ì„ ê±° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const { data: elections, error } = await supabase
                    .from('elections')
                    .select('id, title')
                    .eq('status', 'NOMINATION')
                    .order('created_at', { ascending: false });

                document.getElementById('loading-msg').style.display = 'none';

                if (error) throw error;

                if (!elections || elections.length === 0) {
                    document.getElementById('no-election-msg').style.display = 'block';
                    return;
                }

                // 3. ë“œë¡­ë‹¤ìš´ ë Œë”ë§
                const selectEl = document.getElementById('election-select');
                elections.forEach(el => {
                    const option = document.createElement('option');
                    option.value = el.id;
                    option.innerText = el.title;
                    selectEl.appendChild(option);
                });

                document.getElementById('select-area').style.display = 'block';

            } catch (e) {
                showModal('ì˜¤ë¥˜', 'ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
            }
        }

        // [ì´ë²¤íŠ¸] ìê²© í™•ì¸ ë²„íŠ¼ í´ë¦­
        document.getElementById('btn-check-qual').addEventListener('click', async () => {
            const electionId = document.getElementById('election-select').value;
            if (!electionId) {
                showModal('ì•Œë¦¼', 'ì¶œë§ˆí•  ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = document.getElementById('btn-check-qual');
            btn.disabled = true;
            btn.innerText = 'í™•ì¸ ì¤‘...';

            try {
                // 1. ì´ë¯¸ í›„ë³´ ë“±ë¡ í–ˆëŠ”ì§€ ì²´í¬
                const { data: existing } = await supabase
                    .from('candidates')
                    .select('id')
                    .eq('election_id', electionId)
                    .eq('member_uuid', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    document.getElementById('selection-section').style.display = 'none';
                    document.getElementById('already-applied').style.display = 'block';
                    return;
                }

                // 2. ì„ ê±°ì¸ ëª…ë¶€(election_voters)ì—ì„œ ë‚´ ì„ ê±°êµ¬ ì¡°íšŒ
                // (ì¶”ì¸¡ ê¸ˆì§€: election_id, member_uuid ì‚¬ìš©)
                const { data: voterData, error: voterError } = await supabase
                    .from('election_voters')
                    .select('district_id')
                    .eq('election_id', electionId)
                    .eq('member_uuid', currentUser.id)
                    .maybeSingle();

                if (voterError) throw voterError;

                if (!voterData) {
                    showModal('ìê²© ì—†ìŒ', 'ê·€í•˜ëŠ” ì„ íƒí•˜ì‹  ì„ ê±°ì˜ ì„ ê±°ì¸ ëª…ë¶€ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n(ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”)');
                    btn.disabled = false;
                    btn.innerText = 'ë‚´ ì„ ê±°êµ¬ í™•ì¸í•˜ê¸°';
                    return;
                }

                // 3. ì„ ê±°êµ¬ ì´ë¦„ ì¡°íšŒ (districts í…Œì´ë¸”)
                // (ì•ˆì „í•˜ê²Œ ë³„ë„ ì¿¼ë¦¬ë¡œ ì¡°íšŒ)
                const { data: districtData, error: distError } = await supabase
                    .from('districts')
                    .select('name, vote_type')
                    .eq('id', voterData.district_id)
                    .single();

                if (distError) throw new Error('ì„ ê±°êµ¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                // 4. ì°¬ë°˜ íˆ¬í‘œ ì§€ì—­ì¸ì§€ ì²´í¬ (ì°¬ë°˜ì€ í›„ë³´ ë“±ë¡ ë¶ˆê°€)
                if (districtData.vote_type === 'BINARY') {
                    showModal('ì•Œë¦¼', `ê·€í•˜ì˜ ì„ ê±°êµ¬[${districtData.name}]ëŠ” ì°¬ë°˜ íˆ¬í‘œ ëŒ€ìƒ ì§€ì—­ì´ë¯€ë¡œ\ní›„ë³´ì ë“±ë¡ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                    btn.disabled = false;
                    btn.innerText = 'ë‚´ ì„ ê±°êµ¬ í™•ì¸í•˜ê¸°';
                    return;
                }

                // 5. ìµœì¢… í™•ì¸ ëª¨ë‹¬ ë„ìš°ê¸°
                showConfirmModal(
                    'ì„ ê±°êµ¬ í™•ì¸', 
                    `ê·€í•˜ì˜ ì†Œì† ì„ ê±°êµ¬ëŠ”\n[ ${districtData.name} ] ì…ë‹ˆë‹¤.\n\ní•´ë‹¹ ì„ ê±°êµ¬ë¡œ í›„ë³´ ë“±ë¡ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    () => {
                        // [YES] í¼ ë³´ì—¬ì£¼ê¸°
                        document.getElementById('selection-section').style.display = 'none';
                        document.getElementById('apply-form').style.display = 'block';
                        
                        // ë°ì´í„° ì„¸íŒ…
                        document.getElementById('display-district-name').innerText = districtData.name;
                        document.getElementById('district-id').value = voterData.district_id;
                        document.getElementById('election-id').value = electionId;
                        document.getElementById('cand-name').value = currentUser.name || '';
                    }
                );
                
                // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬ (ëª¨ë‹¬ ì·¨ì†Œ ì‹œ ëŒ€ë¹„)
                btn.disabled = false;
                btn.innerText = 'ë‚´ ì„ ê±°êµ¬ í™•ì¸í•˜ê¸°';

            } catch (e) {
                showModal('ì˜¤ë¥˜', 'í™•ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
                btn.disabled = false;
                btn.innerText = 'ë‚´ ì„ ê±°êµ¬ í™•ì¸í•˜ê¸°';
            }
        });

        // [ì´ë²¤íŠ¸] í¼ ì œì¶œ
        document.getElementById('apply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = 'ì œì¶œ ì¤‘...';

            try {
                const formObj = {
                    electionId: document.getElementById('election-id').value,
                    districtId: document.getElementById('district-id').value,
                    name: document.getElementById('cand-name').value,
                    photoFile: document.getElementById('cand-photo').files[0],
                    manifesto: document.getElementById('cand-manifesto').value
                };

                // Serviceì˜ applyCandidate í•¨ìˆ˜ ì¬í™œìš©
                await service.applyCandidate(formObj);

                showModal('ì™„ë£Œ', 'í›„ë³´ ë“±ë¡ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ë°˜ì˜ë©ë‹ˆë‹¤.', () => location.reload());

            } catch (e) {
                showModal('ì‹¤íŒ¨', 'ì‹ ì²­ ì‹¤íŒ¨: ' + e.message);
                btn.disabled = false;
                btn.innerText = 'ì‹ ì²­ì„œ ì œì¶œ';
            }
        });

        // --- ëª¨ë‹¬ ìœ í‹¸ë¦¬í‹° ---

        function showModal(title, msg, onOk = null) {
            modalTitle.innerText = title;
            modalMsg.innerText = msg;
            modalBtnArea.innerHTML = '';
            
            const okBtn = document.createElement('button');
            okBtn.className = 'btn-modal btn-confirm';
            okBtn.innerText = 'í™•ì¸';
            okBtn.onclick = () => {
                modalOverlay.style.display = 'none';
                if (onOk) onOk();
            };
            modalBtnArea.appendChild(okBtn);
            modalOverlay.style.display = 'flex';
        }

        function showConfirmModal(title, msg, onYes) {
            modalTitle.innerText = title;
            modalMsg.innerText = msg;
            modalBtnArea.innerHTML = '';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn-modal';
            cancelBtn.style.background = '#ccc';
            cancelBtn.style.marginRight = '10px';
            cancelBtn.innerText = 'ì·¨ì†Œ';
            cancelBtn.onclick = () => modalOverlay.style.display = 'none';

            const okBtn = document.createElement('button');
            okBtn.className = 'btn-modal btn-confirm';
            okBtn.innerText = 'ë“±ë¡ ì§„í–‰';
            okBtn.onclick = () => {
                modalOverlay.style.display = 'none';
                if (onYes) onYes();
            };

            modalBtnArea.appendChild(cancelBtn);
            modalBtnArea.appendChild(okBtn);
            modalOverlay.style.display = 'flex';
        }

        init();
    </script>
</body>
</html>
