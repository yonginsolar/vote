<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•© ì¡°í•©ì› íˆ¬í‘œì†Œ</title>
    <link rel="stylesheet" href="style.css">
   <style>
/* =========================================
   1. ê¸°ë³¸ ì„¤ì • (Variables & Reset)
   ========================================= */
:root {
    --primary-color: #2563eb;
    --primary-hover: #1d4ed8;
    --success-color: #059669;
    --danger-color: #dc2626;
    --bg-light: #f3f4f6;
    --text-dark: #1f2937;
    --text-gray: #6b7280;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --radius-lg: 0.75rem;
}

* { box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: var(--bg-light);
    color: var(--text-dark);
    line-height: 1.5;
}

header { text-align: center; margin-bottom: 2.5rem; }
h1 { margin: 0 0 0.5rem 0; font-size: 1.8rem; color: var(--text-dark); }
#district-name-box { 
    display: inline-block; background: #e0f2fe; color: #0369a1; 
    padding: 0.5rem 1.5rem; border-radius: 2rem; font-weight: 600; margin-top: 1rem; 
}

/* ì»¨í…Œì´ë„ˆ */
.container {
    max-width: 800px;
    margin: 0 auto;
    background: #fff;
    padding: 2rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    display: none;
}
.container.active { display: block; animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }


/* =========================================
   2. í›„ë³´ì ë¦¬ìŠ¤íŠ¸ & ì¹´ë“œ ë””ìì¸
   ========================================= */
.candidate-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.candidate-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
}

.candidate-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15); 
    transform: translateY(-3px);
}

.candidate-card.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
}

.candidate-img {
    width: 100%;
    height: 280px;
    object-fit: contain;
    background-color: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}

.card-content { 
    padding: 1.5rem; text-align: center; flex-grow: 1; 
    display: flex; flex-direction: column; 
}
.card-content h3 { margin: 0.5rem 0; font-size: 1.3rem; }
.card-content p { color: var(--text-gray); margin-bottom: 1rem; }


/* =========================================
   3. ë²„íŠ¼ ìŠ¤íƒ€ì¼ (Buttons)
   ========================================= */
/* ê³µì•½ ë³´ê¸° ë²„íŠ¼ */
.btn-manifesto {
    margin-top: auto;
    background: #fff;
    border: 1px solid var(--text-gray);
    color: var(--text-dark);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: background 0.2s;
    width: 100%;
    font-weight: 500;
}
.btn-manifesto:hover { background: var(--bg-light); }

/* ì°¬ë°˜ íˆ¬í‘œ ë²„íŠ¼ */
.binary-options { display: flex; gap: 1rem; margin: 2rem 0; }
.btn-binary {
    flex: 1; padding: 1.5rem; font-size: 1.2rem; border: 2px solid #e5e7eb;
    background: #fff; border-radius: var(--radius-lg); cursor: pointer; font-weight: bold; transition: all 0.2s;
    color: var(--text-gray);
}
.btn-binary.btn-yes.selected { background: #ecfdf5; border-color: var(--success-color); color: var(--success-color); }
.btn-binary.btn-no.selected { background: #fef2f2; border-color: var(--danger-color); color: var(--danger-color); }

/* í•˜ë‹¨ ì•¡ì…˜ ì˜ì—­ */
.action-area {
    margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;
    display: flex; justify-content: center; align-items: center; width: 100%;
}

/* íˆ¬í‘œí•˜ê¸° ë²„íŠ¼ */
.btn-submit {
    width: 100%; max-width: 100%; margin: 0 auto; display: block;
    background: var(--primary-color); color: white; border: none; padding: 1rem 3rem;
    font-size: 1.1rem; border-radius: 2rem; cursor: pointer; font-weight: bold;
    box-shadow: var(--shadow-md); transition: background 0.2s;
}
.btn-submit:hover { background: var(--primary-hover); }
.btn-submit:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }

/* ë¬´íˆ¬í‘œ ë‹¹ì„  ë²„íŠ¼ */
.btn-uncontested {
    background: linear-gradient(135deg, #10b981 0%, #047857 100%);
    color: white; border: none; padding: 1rem 2rem; font-size: 1.1rem;
    border-radius: 50px; cursor: pointer; font-weight: 800;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    transition: all 0.2s ease;
    width: 100%; max-width: 400px; display: block; margin: 0 auto;
}
.btn-uncontested:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5); filter: brightness(1.1); }
.btn-uncontested:active { transform: translateY(1px); box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3); }
.manifesto-title {
    font-size: 1.1rem; font-weight: 800; color: #2563eb;
    margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0;
    display: flex; align-items: center; gap: 8px;
}

.manifesto-text {
    font-size: 0.95rem; line-height: 1.7; color: #334155;
    white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
}

@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

       /* =================================================================
   [ì œë¡œë² ì´ìŠ¤ ë¦¬ë‰´ì–¼] ê³µì•½ ë³´ê¸° ëª¨ë‹¬ ì „ìš© ìŠ¤íƒ€ì¼
   ================================================================= */

/* 1. ëª¨ë‹¬ ë°°ê²½ (Overlay) */
.modal-overlay {
    display: none; /* JSë¡œ ì œì–´ */
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* ì§™ì€ ë°˜íˆ¬ëª… */
    backdrop-filter: blur(4px); /* ë°°ê²½ ë¸”ëŸ¬ ì²˜ë¦¬ */
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

/* 2. ëª¨ë‹¬ ì»¨í…ì¸  ë°•ìŠ¤ (ë¼ˆëŒ€) */
.modal-content {
    background: #fff;
    width: 90%;
    max-width: 600px; /* ê³µì•½ ë³´ê¸°ëŠ” ë„“ê²Œ */
    height: 85vh;     /* í™”ë©´ ë†’ì´ì˜ 85% ì°¨ì§€ */
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    display: flex;    /* Flexboxë¡œ ìƒ/ì¤‘/í•˜ ë¶„ë¦¬ */
    flex-direction: column;
    overflow: hidden; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ìœ ì§€ */
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* 3. [ìƒë‹¨] í—¤ë” (ê³ ì •) */
.modal-header {
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    z-index: 10;
}
.modal-header h3 { margin: 0; font-size: 1.25rem; color: #1f2937; font-weight: 700; }
.btn-close-icon {
    background: none; border: none; font-size: 1.5rem; color: #9ca3af;
    cursor: pointer; transition: color 0.2s; padding: 0; line-height: 1;
}
.btn-close-icon:hover { color: #dc2626; }

/* 4. [ì¤‘ë‹¨] ë³¸ë¬¸ (ìŠ¤í¬ë¡¤ ì˜ì—­) */
.modal-body-scroll {
    flex: 1;              /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
    overflow-y: auto;     /* ë‚´ìš© ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ */
    padding: 1.5rem;
    background-color: #fff;
}

/* 5. [í•˜ë‹¨] í‘¸í„° (ê³ ì •) */
.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
    background-color: #f9fafb;
    text-align: right;
}
.btn-close-modal {
    background-color: #fff;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 0.6rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-close-modal:hover { background-color: #f3f4f6; border-color: #9ca3af; }


/* =================================================================
   [ë‚´ë¶€ ë””ìì¸] í”„ë¡œí•„ í…Œì´ë¸” & ê³µì•½ ë°•ìŠ¤
   ================================================================= */

/* í”„ë¡œí•„ í…Œì´ë¸” */
.profile-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 2rem;
    font-size: 0.95rem;
}
.profile-table th {
    text-align: left;
    padding: 12px 8px;
    color: #6b7280;
    font-weight: 600;
    width: 80px;
    border-bottom: 1px solid #f3f4f6;
}
.profile-table td {
    padding: 12px 8px;
    color: #111827;
    font-weight: 500;
    border-bottom: 1px solid #f3f4f6;
}

/* ê³µì•½ ë°•ìŠ¤ (Manifesto Box) */
.manifesto-box {
    background-color: #f8fafc; /* ì•„ì£¼ ì—°í•œ ë¸”ë£¨ê·¸ë ˆì´ */
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    position: relative;
}

/* ë°•ìŠ¤ ì œëª© (Badge ìŠ¤íƒ€ì¼) */
.manifesto-badge {
    display: inline-block;
    background-color: #2563eb;
    color: white;
    font-size: 0.9rem;
    font-weight: 700;
    padding: 6px 12px;
    border-radius: 20px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

/* ê³µì•½ ë‚´ìš© í…ìŠ¤íŠ¸ */
.manifesto-content-text {
    font-size: 1rem;
    line-height: 1.75;
    color: #334155;
    white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
}

/* ê³µì•½ ì´ë¯¸ì§€ */
.manifesto-img {
    width: 100%;
    height: auto;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    display: block;
}
</style>
</head>
<body>

    <div id="loading-screen" style="text-align: center; margin-top: 20vh;">
        <h2>íˆ¬í‘œì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</h2>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <div id="vote-container" class="container">
        <header>
            <h1 id="election-title">ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•© ì¡°í•©ì› íˆ¬í‘œì†Œ</h1>
            <p id="voter-info" style="color: #666; text-align: center;">íšŒì› í™•ì¸ì¤‘...</p>
            <div style="background: #f0fdf4; color: #166534; padding: 0.5rem; text-align: center; border-radius: 4px; margin-top: 0.5rem;">
                <strong id="district-name">ì„ ê±°êµ¬ í™•ì¸ì¤‘</strong>
            </div>
        </header>

        <form id="vote-form">
            <div id="ballot-area"></div>

            <div class="action-area">
                <button type="button" id="btn-vote" class="btn-submit" disabled>íˆ¬í‘œí•˜ê¸°</button>
            </div>
        </form>
    </div>

<div id="complete-container" class="container" style="text-align: center;">
    <h1 style="color: var(--primary-color);">íˆ¬í‘œ ì™„ë£Œ</h1>
    <p>ì†Œì¤‘í•œ í•œ í‘œë¥¼ í–‰ì‚¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
    <p style="color: #888; font-size: 0.9rem;">íˆ¬í‘œ ê²°ê³¼ëŠ” ë§ˆê° í›„ ê³µê°œë©ë‹ˆë‹¤.</p>
    <button id="btn-close-final" class="btn-modal">ì°½ ë‹«ê¸°</button>
</div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">ì•Œë¦¼</h3>
            <p id="modal-msg">ë‚´ìš©</p>
            <div class="modal-buttons">
                <button id="modal-btn-cancel" class="btn-modal">ì·¨ì†Œ</button>
                <button id="modal-btn-ok" class="btn-modal btn-confirm">í™•ì¸</button>
            </div>
        </div>
    </div>

<div id="manifesto-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manifesto-title">í›„ë³´ì ì •ë³´</h3>
                <button onclick="closeManifestoModal()" class="btn-close-icon">&times;</button>
            </div>

            <div id="manifesto-body" class="modal-body-scroll">
                </div>

            <div class="modal-footer">
                <button onclick="closeManifestoModal()" class="btn-close-modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

<script type="module">
    import { ElectionService, supabase } from './ElectionService.js';
    // [ì‹ ê·œ] ê¸°ë³¸ í”„ë¡œí•„ ì´ë¯¸ì§€ ìƒìˆ˜ (íšŒìƒ‰ ì‚¬ëŒ ì‹¤ë£¨ì—£)
    const DEFAULT_PROFILE_IMG = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzk5OTk5OSI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==";
    
    const service = new ElectionService();
    
    // ìƒíƒœ ë³€ìˆ˜
    let currentElection = null;
    let pendingBallots = []; // ì•„ì§ íˆ¬í‘œ ì•ˆ í•œ ìš©ì§€ ëª©ë¡
    let currentBallot = null; // í˜„ì¬ í™”ë©´ì— í‘œì‹œ ì¤‘ì¸ ìš©ì§€
    let selectedValue = null; 

    // DOM ìš”ì†Œ (ê¸°ì¡´ê³¼ ë™ì¼)
    const loadingScreen = document.getElementById('loading-screen');
    const voteContainer = document.getElementById('vote-container');
    const completeContainer = document.getElementById('complete-container');
    const ballotArea = document.getElementById('ballot-area');
    const voteBtn = document.getElementById('btn-vote');
    const titleElem = document.getElementById('election-title');

    async function initPage() {
        try {
            const user = await service.initialize();
            if (!user) {
                alertAndClose('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            document.getElementById('voter-info').innerText = `${user.name} ì¡°í•©ì›ë‹˜ (${user.member_id})`;

            const elections = await service.getActiveElections();
            if (!elections || elections.length === 0) {
                alertAndClose('í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì„ ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            loadingScreen.style.display = 'none';
            voteContainer.classList.add('active');

            // ë¬´ì¡°ê±´ ì„ ê±° ëª©ë¡ ë¨¼ì € ë³´ì—¬ì£¼ê¸°
            renderElectionList(elections);

        } catch (error) {
            alertAndClose('ì˜¤ë¥˜: ' + error.message);
        }
    }

    // ì„ ê±° ëª©ë¡ ë Œë”ë§ (ê¸°ì¡´ê³¼ ë™ì¼)
    function renderElectionList(elections) {
        titleElem.innerText = "ì°¸ì—¬í•  ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”";
        document.getElementById('district-name').style.display = 'none';
        voteBtn.style.display = 'none';
        ballotArea.innerHTML = '';
        
        const listDiv = document.createElement('div');
        listDiv.style.display = 'flex';
        listDiv.style.flexDirection = 'column';
        listDiv.style.gap = '10px';

        elections.forEach(election => {
            const btn = document.createElement('button');
            btn.className = 'candidate-card';
            btn.style.textAlign = 'left';
            btn.style.cursor = 'pointer';
            
            // ìƒíƒœ ë±ƒì§€
            const statusBadge = election.status === 'NOMINATION' 
                ? '<span style="color:orange;">[í›„ë³´ë“±ë¡ê¸°ê°„]</span>' 
                : '<span style="color:green;">[íˆ¬í‘œì§„í–‰ì¤‘]</span>';

            btn.innerHTML = `
                <h3 style="margin:0;">${election.title}</h3>
                <p style="margin:0.5rem 0 0 0; color:#666;">${statusBadge}</p>
            `;
            btn.onclick = () => loadElection(election);
            listDiv.appendChild(btn);
        });
        ballotArea.appendChild(listDiv);
    }

async function loadElection(election) {
        currentElection = election;
        titleElem.innerText = election.title;
        // ë¡œë”© ì¤‘ í‘œì‹œ
        ballotArea.innerHTML = '<div style="text-align:center; padding:2rem;">íˆ¬í‘œ ê¸°ë¡ì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>';

        try {
            // 1. ëª¨ë“  íˆ¬í‘œìš©ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const allBallots = await service.getMyBallotList(election.id);

            // 2. 'ì•„ì§ íˆ¬í‘œí•˜ì§€ ì•Šì€' ìš©ì§€ ëª©ë¡ë§Œ í•„í„°ë§
            pendingBallots = allBallots.filter(b => !b.hasVoted);

            // [í•µì‹¬ ìˆ˜ì •] ë‚¨ì€ íˆ¬í‘œê°€ ì—†ë‹¤ë©´(ì´ë¯¸ ë‹¤ í–ˆë‹¤ë©´) -> ì¦‰ì‹œ í‡´ì¥ ì¡°ì¹˜
            if (pendingBallots.length === 0) {
                // ë” ì´ìƒ ë³´ì—¬ì¤„ í™”ë©´ ì—†ì´ ë°”ë¡œ ì•Œë¦¼ì°½ ë„ìš°ê³  ì¢…ë£Œ
                alertAndClose('ì´ë¯¸ ëª¨ë“  íˆ¬í‘œë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.\níˆ¬í‘œì†Œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.');
                return; 
            }

            // 3. íˆ¬í‘œí•  ê²Œ ë‚¨ì•„ìˆë‹¤ë©´ ì²« ë²ˆì§¸ ìš©ì§€ ë¡œë“œ
            loadNextBallot();

        } catch (error) {
            console.error(error);
            if (error.message.includes('ë°°ì •ë˜ì§€')) {
                // ê¶Œí•œ ì—†ëŠ” ê²½ìš°ë„ ì¦‰ì‹œ í‡´ì¥
                 alertAndClose(`[${election.title}]ì—ëŠ” íˆ¬í‘œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.`);
            } else {
                alertAndClose('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
        }
    }

    // [ì‹ ê·œ] ë‹¤ìŒ íˆ¬í‘œìš©ì§€ë¥¼ í™”ë©´ì— ê·¸ë¦¬ê¸°
function loadNextBallot() {
        if (pendingBallots.length === 0) {
            showCompleteScreen();
            return;
        }

        currentBallot = pendingBallots[0];
        selectedValue = null;

        document.getElementById('district-name').style.display = 'block';
        document.getElementById('district-name').innerText = currentBallot.district.name;
        
        voteBtn.style.display = 'block';

        // [ë””ìì¸ ìˆ˜ì •] ë²„íŠ¼ ìŠ¤íƒ€ì¼ êµì²´ ë¡œì§
        if (currentBallot.isUncontested) {
            // ë¬´íˆ¬í‘œ ë‹¹ì„ : ì˜ˆìœ ì´ˆë¡ìƒ‰ ê·¸ë¼ë°ì´ì…˜ ë²„íŠ¼ ì ìš©
            voteBtn.innerText = 'í™•ì¸ (ë¬´íˆ¬í‘œ ë‹¹ì„ )';
            voteBtn.disabled = false;
            voteBtn.className = 'btn-uncontested'; // CSSì—ì„œ ë§Œë“  í´ë˜ìŠ¤ ì ìš©
        } else {
            // ì¼ë°˜ íˆ¬í‘œ: ê¸°ë³¸ íŒŒë€ìƒ‰ ë²„íŠ¼ ì ìš©
            voteBtn.innerText = 'íˆ¬í‘œí•˜ê¸°';
            voteBtn.disabled = true;
            voteBtn.className = 'btn-submit'; // ê¸°ì¡´ í´ë˜ìŠ¤ ë³µêµ¬
        }

        // ë‚¨ì€ íˆ¬í‘œ ìˆ˜ í‘œì‹œ
        if (pendingBallots.length > 1) {
             titleElem.innerText = `${currentElection.title} (${pendingBallots.length}ê±´ ë‚¨ìŒ)`;
        } else {
             titleElem.innerText = currentElection.title;
        }

        renderBallotContent(currentBallot);
    }

// [ìˆ˜ì •] íˆ¬í‘œìš©ì§€ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ê¸°ë³¸ ì´ë¯¸ì§€ ë° URL ë³€í™˜ ë¡œì§ ì ìš©)
    function renderBallotContent(info) {
        ballotArea.innerHTML = ''; 

        // 1. ë¬´íˆ¬í‘œ ë‹¹ì„  ì•ˆë‚´ ë©”ì‹œì§€
        if (info.isUncontested) {
            const noticeDiv = document.createElement('div');
            noticeDiv.style.cssText = 'background:#f0fdf4; padding:1rem; margin-bottom:1rem; border-radius:8px; text-align:center; color:#166534; border:1px solid #bbf7d0;';
            noticeDiv.innerHTML = `<strong style="font-size:1.1rem;">ğŸ‰ ë¬´íˆ¬í‘œ ë‹¹ì„  ì•ˆë‚´</strong><br><span style="font-size:0.9rem; color:#374151;">í›„ë³´ì ìˆ˜(${info.candidates.length}ëª…)ê°€ ì„ ì¶œ ì¸ì›(${info.district.quota}ëª…) ì´ë‚´ì´ë¯€ë¡œ<br>íˆ¬í‘œ ì ˆì°¨ ì—†ì´ ë‹¹ì„ ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì•„ë˜ í›„ë³´ìë¥¼ í™•ì¸í•˜ì‹œê³  <strong>[í™•ì¸]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span>`;
            ballotArea.appendChild(noticeDiv);
        }

        if (info.district.vote_type === 'CANDIDATE') {
            const listDiv = document.createElement('div');
            listDiv.className = 'candidate-list';

            if (!info.candidates || info.candidates.length === 0) {
                ballotArea.innerHTML += '<div style="text-align:center; padding:3rem; color:#666;">ë“±ë¡ëœ í›„ë³´ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            info.candidates.forEach(cand => {
                const card = document.createElement('div');
                card.className = 'candidate-card';
                
                // ë¬´íˆ¬í‘œì¼ ê²½ìš° ì„ íƒ íš¨ê³¼ ì œê±° (ë³´ê¸° ì „ìš©)
                if (info.isUncontested) {
                    card.style.cursor = 'default';
                    card.style.borderColor = '#22c55e';
                    card.style.backgroundColor = '#f0fdf4';
                    card.style.boxShadow = 'none';
                }

                // -----------------------------------------------------------
                // [í•µì‹¬ ìˆ˜ì •] ì‚¬ì§„ URL ì²˜ë¦¬ ë¡œì§ (ê¸°ë³¸ ì´ë¯¸ì§€ ì ìš©)
                // -----------------------------------------------------------
                let photoSrc = DEFAULT_PROFILE_IMG;

                if (cand.photo_url) {
                    if (cand.photo_url.startsWith('http')) {
                        photoSrc = cand.photo_url;
                    } else {
                        // Supabase Storage ê²½ë¡œì¸ ê²½ìš° Public URL ê°€ì ¸ì˜¤ê¸°
                        // (ë²„í‚·ëª…ì´ 'candidate_proofs'ì¸ì§€ 'candidate_photos'ì¸ì§€ í™•ì¸ í•„ìš”, ì—¬ê¸°ì„  ê¸°ì¡´ ê·œì¹™ ë”°ë¦„)
                        const { data } = supabase.storage.from('candidate_proofs').getPublicUrl(cand.photo_url);
                        if (data) photoSrc = data.publicUrl;
                    }
                }
                // -----------------------------------------------------------

                // [ì¹´ë“œ HTML êµ¬ì¡°] - ê³µì•½ ë³´ê¸° ë²„íŠ¼ ì‚­ì œë¨
                card.innerHTML = `
                    <img src="${photoSrc}" 
                         class="candidate-img" 
                         alt="${cand.name}"
                         onerror="this.src='${DEFAULT_PROFILE_IMG}'"
                         style="background-color: #f3f4f6;">
                    <div class="card-content">
                        <h3>${cand.name}</h3>
                        <p>ê¸°í˜¸ ${cand.symbol || '-'}ë²ˆ</p>
                        </div>
                `;
                
                // [ì‚­ì œë¨] ì•„ë˜ ê³µì•½ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²° ì½”ë“œë„ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì‚­ì œ
                /*
                const manifestoBtn = card.querySelector('.btn-manifesto');
                manifestoBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    showManifesto(cand);
                };
                */

                // ì¼ë°˜ íˆ¬í‘œì¼ ë•Œë§Œ ì„ íƒ ì´ë²¤íŠ¸ ì—°ê²°
                if (!info.isUncontested) {
                    card.addEventListener('click', (e) => {
                        // if(e.target === manifestoBtn) return; // [ì‚­ì œ] ë²„íŠ¼ì´ ì—†ìœ¼ë‹ˆ ì´ ì˜ˆì™¸ì²˜ë¦¬ë„ í•„ìš” ì—†ìŒ
                        document.querySelectorAll('.candidate-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        selectedValue = cand.id;
                        voteBtn.disabled = false;
                        voteBtn.innerText = `'${cand.name}' ì„ íƒì™„ë£Œ`;
                    });
                }
                
                listDiv.appendChild(card);
            });
            ballotArea.appendChild(listDiv);

        } else {
            // ì°¬ë°˜ íˆ¬í‘œ (ê¸°ì¡´ ìœ ì§€)
             ballotArea.innerHTML = `
                <div class="binary-options">
                    <button type="button" class="btn-binary btn-yes" data-val="AGREE">ì°¬ì„± (O)</button>
                    <button type="button" class="btn-binary btn-no" data-val="DISAGREE">ë°˜ëŒ€ (X)</button>
                </div>
                <p style="text-align:center; margin-top:1rem; color:#666;">ì•ˆê±´ì— ëŒ€í•œ ì°¬ì„±/ë°˜ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            `;
            ballotArea.querySelectorAll('.btn-binary').forEach(btn => {
                btn.addEventListener('click', () => {
                    ballotArea.querySelectorAll('.btn-binary').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedValue = btn.dataset.val;
                    voteBtn.disabled = false;
                    voteBtn.innerText = (selectedValue === 'AGREE' ? 'ì°¬ì„±' : 'ë°˜ëŒ€') + ' ì„ íƒì™„ë£Œ';
                });
            });
        }
    }

    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
voteBtn.addEventListener('click', () => {
        // [ìˆ˜ì •] 1. ë¬´íˆ¬í‘œ ë‹¹ì„ ì¸ ê²½ìš°: DB ì œì¶œ ì—†ì´ ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
        if (currentBallot && currentBallot.isUncontested) {
            pendingBallots.shift(); // í˜„ì¬ íˆ¬í‘œìš©ì§€ ì œê±°
            loadNextBallot();       // ë‹¤ìŒ íˆ¬í‘œìš©ì§€ ë¡œë“œ
            return;                 // í•¨ìˆ˜ ì¢…ë£Œ
        }

        // [ê¸°ì¡´ ë¡œì§] 2. ì¼ë°˜ íˆ¬í‘œì¸ ê²½ìš°
        if (!selectedValue) return;

        const isCandidateVote = currentBallot.district.vote_type === 'CANDIDATE';
        const isLastVote = pendingBallots.length === 1;
        
        const confirmMsg = isLastVote 
            ? "ì •ë§ íˆ¬í‘œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? íˆ¬í‘œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." 
            : "ì´ íˆ¬í‘œë¥¼ ì œì¶œí•˜ê³  'ë‹¤ìŒ íˆ¬í‘œ'ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

        showConfirm(confirmMsg, async () => {
            try {
                voteBtn.innerText = 'ì²˜ë¦¬ì¤‘...';
                voteBtn.disabled = true;

                const payload = {
                    electionId: currentElection.id,
                    districtId: currentBallot.district_id,
                    round: currentElection.current_round || 1,
                    candidateId: isCandidateVote ? selectedValue : null,
                    choice: !isCandidateVote ? selectedValue : null
                };

                await service.submitVote(payload);

                pendingBallots.shift(); 
                loadNextBallot(); 

            } catch (e) {
                showModal('ì˜¤ë¥˜', e.message);
                voteBtn.disabled = false;
                voteBtn.innerText = 'íˆ¬í‘œí•˜ê¸°';
            }
        });
    }); // End of voteBtn Event Listener



// [ìˆ˜ì •ëœ íˆ¬í‘œí•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸]
    voteBtn.addEventListener('click', () => {
        if (!selectedValue) return;

        // ballotInfo -> currentBallot ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•¨ (ì—¬ê¸°ê°€ ì˜¤ë¥˜ ì›ì¸)
        const isCandidateVote = currentBallot.district.vote_type === 'CANDIDATE';

        const isLastVote = pendingBallots.length === 1;
        const confirmMsg = isLastVote 
            ? "ì •ë§ íˆ¬í‘œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? íˆ¬í‘œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." 
            : "ì´ íˆ¬í‘œë¥¼ ì œì¶œí•˜ê³  'ë‹¤ìŒ íˆ¬í‘œ'ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

        showConfirm(confirmMsg, async () => {
            try {
                voteBtn.innerText = 'ì²˜ë¦¬ì¤‘...';
                voteBtn.disabled = true;

                const payload = {
                    electionId: currentElection.id,
                    districtId: currentBallot.district_id, // ì—¬ê¸°ë„ currentBallot ì‚¬ìš©
                    round: currentElection.current_round || 1,
                    candidateId: isCandidateVote ? selectedValue : null,
                    choice: !isCandidateVote ? selectedValue : null
                };

                // íˆ¬í‘œ ì œì¶œ
                await service.submitVote(payload);

                // ì„±ê³µ ì‹œ ëª©ë¡ì—ì„œ ì œê±°í•˜ê³  ë‹¤ìŒìœ¼ë¡œ ì´ë™
                pendingBallots.shift(); 
                loadNextBallot(); 

            } catch (e) {
                showModal('ì˜¤ë¥˜', e.message);
                voteBtn.disabled = false;
                voteBtn.innerText = 'íˆ¬í‘œí•˜ê¸°';
            }
        });
    });

        function showCompleteScreen() {
            loadingScreen.style.display = 'none';
            voteContainer.style.display = 'none';
            completeContainer.classList.add('active');
        }

        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMsg = document.getElementById('modal-msg');
        const btnOk = document.getElementById('modal-btn-ok');
        const btnCancel = document.getElementById('modal-btn-cancel');

        function showModal(title, msg, onOk = null) {
            modalTitle.innerText = title;
            modalMsg.innerText = msg;
            btnCancel.style.display = 'none';
            btnOk.innerText = 'í™•ì¸';
            modalOverlay.style.display = 'flex';
            btnOk.onclick = () => {
                modalOverlay.style.display = 'none';
                if (onOk) onOk();
            };
        }

        function showConfirm(msg, onConfirm) {
            modalTitle.innerText = 'íˆ¬í‘œ í™•ì¸';
            modalMsg.innerText = msg;
            btnCancel.style.display = 'inline-block';
            btnOk.innerText = 'ë„¤, íˆ¬í‘œí•©ë‹ˆë‹¤';
            modalOverlay.style.display = 'flex';
            btnOk.onclick = () => {
                modalOverlay.style.display = 'none';
                onConfirm();
            };
            btnCancel.onclick = () => {
                modalOverlay.style.display = 'none';
            };
        }

// [ìˆ˜ì •]
    function alertAndClose(msg) {
        loadingScreen.style.display = 'none';
        showModal('ì•Œë¦¼', msg, () => {
            tryCloseWindow(); // window.close() ëŒ€ì‹  ì‚¬ìš©
        });
    }
// [1] ë§Œ ë‚˜ì´ ê³„ì‚° í•¨ìˆ˜ (YYMMDD-1... í˜•ì‹ íŒŒì‹±)
    function getKoreanAge(birthDateStr) {
        if (!birthDateStr || birthDateStr.length < 6) return '-';
        
        // 1. ìƒë…„ì›”ì¼ íŒŒì‹±
        const yy = parseInt(birthDateStr.substring(0, 2));
        const mm = parseInt(birthDateStr.substring(2, 4)) - 1; // ì›”ì€ 0ë¶€í„° ì‹œì‘
        const dd = parseInt(birthDateStr.substring(4, 6));
        
        // 2. ì„±ë³„ì½”ë“œ(7ë²ˆì§¸ ìë¦¬)ë¡œ 1900ë…„ëŒ€/2000ë…„ëŒ€ êµ¬ë¶„
        // (í•˜ì´í”ˆì´ ìˆê±°ë‚˜ ì—†ê±°ë‚˜ ëŒ€ì‘)
        const genderChar = birthDateStr.includes('-') 
            ? birthDateStr.split('-')[1].charAt(0) 
            : birthDateStr.charAt(6);
            
        const century = (genderChar === '1' || genderChar === '2') ? 1900 : 2000;
        const fullYear = century + yy;

        // 3. ë§Œ ë‚˜ì´ ê³„ì‚°
        const today = new Date();
        let age = today.getFullYear() - fullYear;
        
        const currentMonth = today.getMonth();
        const currentDate = today.getDate();

        // ìƒì¼ì´ ì•ˆ ì§€ë‚¬ìœ¼ë©´ 1ì‚´ ì°¨ê°
        if (currentMonth < mm || (currentMonth === mm && currentDate < dd)) {
            age--;
        }
        
        return `ë§Œ ${age}ì„¸`;
    }

    // [2] ì£¼ì†Œ í¬ë§·íŒ… í•¨ìˆ˜ (ì/ë©´/ë™/ê°€ ê¹Œì§€ë§Œ í‘œì‹œ)
    function formatAddress(addr) {
        if (!addr) return 'ì •ë³´ ì—†ìŒ';
        
        // ì •ê·œì‹: 'ë¬´ìŠ¨ë™', 'ë¬´ìŠ¨ì', 'ë¬´ìŠ¨ë©´', 'ë¬´ìŠ¨ê°€' íŒ¨í„´ì„ ì°¾ìŒ
        const match = addr.match(/.*?(ì|ë©´|ë™|ê°€)(\s|$)/);
        
        if (match) {
            // ì°¾ì•˜ìœ¼ë©´ ê±°ê¸°ê¹Œì§€ë§Œ ë³´ì—¬ì¤Œ (ì˜ˆ: ê²½ê¸° ìš©ì¸ì‹œ ì²˜ì¸êµ¬ í¬ê³¡ì)
            return match[0].trim();
        }
        
        // ëª» ì°¾ì•˜ìœ¼ë©´(ë„ë¡œëª… ë“±) ë’¤ì— ìˆ«ìë“¤ì„ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ (ì˜ˆ: í¬ê³¡ë¡œ 123 -> í¬ê³¡ë¡œ ***)
        return addr.replace(/[0-9]/g, '*');
    }

// [1] ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ (Window ì „ì—­ ë“±ë¡)
    window.closeManifestoModal = function() {
        document.getElementById('manifesto-modal').style.display = 'none';
    };

    // [2] ê³µì•½ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜ (ë¦¬ë‰´ì–¼ ë””ìì¸ ì ìš©)
    window.showManifesto = function(cand) { // windowì— ë“±ë¡í•˜ì—¬ ì•ˆì „í•˜ê²Œ í˜¸ì¶œ
        const modal = document.getElementById('manifesto-modal');
        const title = document.getElementById('manifesto-title');
        const body = document.getElementById('manifesto-body');

        // 1. í—¤ë” ì œëª© ì„¤ì •
        title.innerText = `${cand.name} í›„ë³´ ìƒì„¸ì •ë³´`;
        
        // 2. ë°ì´í„° ê°€ê³µ
        const age = getKoreanAge(cand.birth_date);
        const shortAddress = formatAddress(cand.address);

        // 3. ë‚´ìš© êµ¬ì„± (í”„ë¡œí•„ í…Œì´ë¸” + ê³µì•½ ì¹´ë“œ)
        let contentHtml = '';

        // (A) í”„ë¡œí•„ ì„¹ì…˜
        contentHtml += `
            <table class="profile-table">
                <colgroup>
                    <col style="width: 30%;">
                    <col style="width: 70%;">
                </colgroup>
                <tr>
                    <th>ë‚˜ì´</th>
                    <td>${age}</td>
                </tr>
                <tr>
                    <th>ì£¼ì†Œ</th>
                    <td>${shortAddress}</td>
                </tr>
                <tr>
                    <th>ì£¼ìš”ê²½ë ¥</th>
                    <td>${cand.career ? cand.career.replace(/\n/g, '<br>') : '-'}</td>
                </tr>
            </table>
        `;

        // (B) ê³µì•½ ì„¹ì…˜ (ì¹´ë“œ ë””ìì¸)
        const manifestoText = cand.manifesto;
        let innerContent = '';

        if (manifestoText && (manifestoText.startsWith('http') || manifestoText.startsWith('/'))) {
             // ì´ë¯¸ì§€ì¸ ê²½ìš°
             innerContent = `<img src="${manifestoText}" class="manifesto-img" alt="ê³µì•½ ì´ë¯¸ì§€">`;
        } else {
             // í…ìŠ¤íŠ¸ì¸ ê²½ìš°
             innerContent = `<div class="manifesto-content-text">${manifestoText || "ë“±ë¡ëœ ê³µì•½ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}</div>`;
        }

        contentHtml += `
            <div class="manifesto-box">
                <div class="manifesto-badge">ğŸ“¢ ì¶œë§ˆì˜ ë³€ ë° ê³µì•½</div>
                ${innerContent}
            </div>
        `;

        // 4. ë Œë”ë§ ë° ëª¨ë‹¬ ì—´ê¸°
        body.innerHTML = contentHtml;
        modal.style.display = 'flex';
    };
    // [ì‹ ê·œ] ê°•ë ¥í•œ ì°½ ë‹«ê¸° ì‹œë„ ë° ì‹¤íŒ¨ ì‹œ ì•ˆë‚´ í™”ë©´ ì²˜ë¦¬
    function tryCloseWindow() {
        // 1. ì°½ ë‹«ê¸° ì‹œë„
        window.close();
        
        // 2. ìœ„ ì½”ë“œê°€ ë³´ì•ˆìƒ ë§‰í˜”ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ 0.1ì´ˆ ë’¤ ì•ˆë‚´ í™”ë©´ìœ¼ë¡œ ì „í™˜
        setTimeout(() => {
            // í™”ë©´ ë‚´ìš©ì„ ì‹¹ ì§€ìš°ê³  ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
            document.body.innerHTML = `
                <div style="
                    display: flex; 
                    flex-direction: column; 
                    justify-content: center; 
                    align-items: center; 
                    height: 100vh; 
                    text-align: center; 
                    background: #f3f4f6; 
                    font-family: sans-serif;
                ">
                    <div style="background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 90%;">
                        <h2 style="color: #2563eb; margin: 0 0 1rem 0;">íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
                        <p style="color: #4b5563; line-height: 1.6; margin-bottom: 2rem;">
                            ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì°½ì´ ìë™ìœ¼ë¡œ ë‹«íˆì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
                            ìƒë‹¨ì˜ <strong>X</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì°½ì„ ë‹«ì•„ì£¼ì„¸ìš”.
                        </p>
                        <button onclick="history.back()" style="
                            padding: 0.8rem 1.5rem; 
                            background: #e5e7eb; 
                            border: none; 
                            border-radius: 8px; 
                            cursor: pointer; 
                            font-weight: bold; 
                            color: #374151;
                        ">
                            ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                </div>
            `;
        }, 100);
    }

    // [ì¶”ê°€] ì™„ë£Œ í™”ë©´ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    document.getElementById('btn-close-final').addEventListener('click', () => {
        tryCloseWindow();
    });
        initPage();
    </script>
</body>
</html>
