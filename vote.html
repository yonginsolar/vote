<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•© ì¡°í•©ì› íˆ¬í‘œì†Œ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        
        :root {
    --primary-color: #2563eb; /* ëª¨ë˜í•œ ë¸”ë£¨ */
    --primary-hover: #1d4ed8;
    --success-color: #059669; /* ì„¸ë ¨ëœ ê·¸ë¦° */
    --danger-color: #dc2626;
    --bg-light: #f3f4f6;
    --text-dark: #1f2937;
    --text-gray: #6b7280;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
}

* { box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: var(--bg-light);
    color: var(--text-dark);
    line-height: 1.5;
}

/* ì»¨í…Œì´ë„ˆ ë””ìì¸ ê°œì„  */
.container {
    max-width: 800px;
    margin: 0 auto;
    background: #fff;
    padding: 2rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    display: none; /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
}
.container.active { display: block; animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

header { text-align: center; margin-bottom: 2.5rem; }
h1 { margin: 0 0 0.5rem 0; font-size: 1.8rem; color: var(--text-dark); }
#district-name-box { display: inline-block; background: #e0f2fe; color: #0369a1; padding: 0.5rem 1.5rem; border-radius: 2rem; font-weight: 600; margin-top: 1rem; }

/* í›„ë³´ì ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ */
.candidate-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ */
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* í›„ë³´ì ì¹´ë“œ ëª¨ë˜ ë””ìì¸ */
.candidate-card {
    background: #fff;
    border: 2px solid transparent;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
}
.candidate-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
.candidate-card.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2); /* ê°•ì¡° íš¨ê³¼ */
}

/* [ì¤‘ìš”] ì‚¬ì§„ ì›ë³¸ ë¹„ìœ¨ ìœ ì§€ ë° í¬ê¸° í™•ëŒ€ */
.candidate-img {
    width: 100%;
    height: 280px; /* ì‚¬ì§„ ì˜ì—­ ë†’ì´ ê³ ì • */
    object-fit: contain; /* ì‚¬ì§„ì´ ì˜ë¦¬ì§€ ì•Šê³  ì „ì²´ê°€ ë‹¤ ë³´ì´ë„ë¡ ì„¤ì • */
    background-color: #f9fafb; /* ë¹ˆ ê³µê°„ì€ ì—°í•œ íšŒìƒ‰ ì²˜ë¦¬ */
    border-bottom: 1px solid #e5e7eb;
}

.card-content { padding: 1.5rem; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
.card-content h3 { margin: 0.5rem 0; font-size: 1.3rem; }
.card-content p { color: var(--text-gray); margin-bottom: 1rem; }

/* ê³µì•½ ë³´ê¸° ë²„íŠ¼ */
.btn-manifesto {
    margin-top: auto; /* ì¹´ë“œ í•˜ë‹¨ìœ¼ë¡œ ë°€ê¸° */
    background: #fff;
    border: 1px solid var(--text-gray);
    color: var(--text-dark);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: background 0.2s;
    width: 100%;
    font-weight: 500;
}
.btn-manifesto:hover { background: var(--bg-light); }

/* ì°¬ë°˜ íˆ¬í‘œ ë²„íŠ¼ */
.binary-options { display: flex; gap: 1rem; margin: 2rem 0; }
.btn-binary {
    flex: 1; padding: 1.5rem; font-size: 1.2rem; border: 2px solid #e5e7eb;
    background: #fff; border-radius: var(--radius-lg); cursor: pointer; font-weight: bold; transition: all 0.2s;
    color: var(--text-gray);
}
.btn-binary.btn-yes.selected { background: #ecfdf5; border-color: var(--success-color); color: var(--success-color); }
.btn-binary.btn-no.selected { background: #fef2f2; border-color: var(--danger-color); color: var(--danger-color); }

/* í•˜ë‹¨ ì•¡ì…˜ ì˜ì—­ */
.action-area { text-align: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; }
.btn-submit {
    background: var(--primary-color); color: white; border: none; padding: 1rem 3rem;
    font-size: 1.1rem; border-radius: 2rem; cursor: pointer; font-weight: bold;
    box-shadow: var(--shadow-md); transition: background 0.2s; width: 100%; max-width: 400px;
}
.btn-submit:hover { background: var(--primary-hover); }
.btn-submit:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }

/* ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ */
.modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); /* ë°°ê²½ ë¸”ëŸ¬ íš¨ê³¼ */
    justify-content: center; align-items: center; z-index: 1000;
}
.modal-content {
    background: white; padding: 0; border-radius: var(--radius-lg);
    width: 90%; max-width: 500px; box-shadow: var(--shadow-lg); overflow: hidden;
    animation: slideUp 0.3s ease-out;
}
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
.modal-header h3 { margin: 0; font-size: 1.2rem; }
.btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-gray); }
.modal-body { padding: 1.5rem; max-height: 60vh; overflow-y: auto; line-height: 1.7; color: var(--text-dark); white-space: pre-wrap; }
.modal-footer { padding: 1rem 1.5rem; background: var(--bg-light); text-align: right; border-top: 1px solid #e5e7eb; }

.btn-modal {
    padding: 0.7rem 1.5rem; border: 1px solid #d1d5db; background: white;
    border-radius: var(--radius-md); cursor: pointer; font-weight: 500; transition: background 0.2s;
}
.btn-modal:hover { background: var(--bg-light); }
.btn-confirm { background: var(--primary-color); color: white; border: none; margin-left: 0.5rem; }
.btn-confirm:hover { background: var(--primary-hover); }

/* ê³µì•½ ëª¨ë‹¬ íŠ¹í™” */
.manifesto-content { max-width: 700px; } /* ê³µì•½ ëª¨ë‹¬ì€ ì¢€ ë” ë„“ê²Œ */
#manifesto-body img { max-width: 100%; height: auto; border-radius: var(--radius-md); }
    </style>
</head>
<body>

    <div id="loading-screen" style="text-align: center; margin-top: 20vh;">
        <h2>íˆ¬í‘œì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</h2>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <div id="vote-container" class="container">
        <header>
            <h1 id="election-title">ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•© ì¡°í•©ì› íˆ¬í‘œì†Œ</h1>
            <p id="voter-info" style="color: #666; text-align: center;">íšŒì› í™•ì¸ì¤‘...</p>
            <div style="background: #f0fdf4; color: #166534; padding: 0.5rem; text-align: center; border-radius: 4px; margin-top: 0.5rem;">
                <strong id="district-name">ì„ ê±°êµ¬ í™•ì¸ì¤‘</strong>
            </div>
        </header>

        <form id="vote-form">
            <div id="ballot-area"></div>

            <div class="action-area">
                <button type="button" id="btn-vote" class="btn-submit" disabled>íˆ¬í‘œí•˜ê¸°</button>
            </div>
        </form>
    </div>

    <div id="complete-container" class="container" style="text-align: center;">
        <h1 style="color: var(--primary-color);">íˆ¬í‘œ ì™„ë£Œ</h1>
        <p>ì†Œì¤‘í•œ í•œ í‘œë¥¼ í–‰ì‚¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
        <p style="color: #888; font-size: 0.9rem;">íˆ¬í‘œ ê²°ê³¼ëŠ” ë§ˆê° í›„ ê³µê°œë©ë‹ˆë‹¤.</p>
        <button onclick="window.close()" class="btn-modal">ì°½ ë‹«ê¸°</button>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">ì•Œë¦¼</h3>
            <p id="modal-msg">ë‚´ìš©</p>
            <div class="modal-buttons">
                <button id="modal-btn-cancel" class="btn-modal">ì·¨ì†Œ</button>
                <button id="modal-btn-ok" class="btn-modal btn-confirm">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="manifesto-modal" class="modal-overlay" style="z-index: 2000;">
        <div class="modal-content" style="width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3 id="manifesto-title">ê³µì•½ ë³´ê¸°</h3>
            <div id="manifesto-body" style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.6;"></div>
            <div style="margin-top: 1.5rem; text-align: center;">
                <button onclick="document.getElementById('manifesto-modal').style.display='none'" class="btn-modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    <div id="manifesto-modal" class="modal-overlay" style="z-index: 2000;">
        <div class="modal-content manifesto-content">
            <div class="modal-header">
                <h3 id="manifesto-title">ê³µì•½ ë³´ê¸°</h3>
                <button onclick="document.getElementById('manifesto-modal').style.display='none'" class="btn-close">&times;</button>
            </div>
            <div id="manifesto-body" class="modal-body">
                </div>
             <div class="modal-footer">
                <button onclick="document.getElementById('manifesto-modal').style.display='none'" class="btn-modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

<script type="module">
// ... ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ...

<script type="module">
    import { ElectionService, supabase } from './ElectionService.js';
    
    const service = new ElectionService();
    
    // ìƒíƒœ ë³€ìˆ˜
    let currentElection = null;
    let pendingBallots = []; // ì•„ì§ íˆ¬í‘œ ì•ˆ í•œ ìš©ì§€ ëª©ë¡
    let currentBallot = null; // í˜„ì¬ í™”ë©´ì— í‘œì‹œ ì¤‘ì¸ ìš©ì§€
    let selectedValue = null; 

    // DOM ìš”ì†Œ (ê¸°ì¡´ê³¼ ë™ì¼)
    const loadingScreen = document.getElementById('loading-screen');
    const voteContainer = document.getElementById('vote-container');
    const completeContainer = document.getElementById('complete-container');
    const ballotArea = document.getElementById('ballot-area');
    const voteBtn = document.getElementById('btn-vote');
    const titleElem = document.getElementById('election-title');

    async function initPage() {
        try {
            const user = await service.initialize();
            if (!user) {
                alertAndClose('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            document.getElementById('voter-info').innerText = `${user.name} ì¡°í•©ì›ë‹˜ (${user.member_id})`;

            const elections = await service.getActiveElections();
            if (!elections || elections.length === 0) {
                alertAndClose('í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì„ ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            loadingScreen.style.display = 'none';
            voteContainer.classList.add('active');

            // ë¬´ì¡°ê±´ ì„ ê±° ëª©ë¡ ë¨¼ì € ë³´ì—¬ì£¼ê¸°
            renderElectionList(elections);

        } catch (error) {
            alertAndClose('ì˜¤ë¥˜: ' + error.message);
        }
    }

    // ì„ ê±° ëª©ë¡ ë Œë”ë§ (ê¸°ì¡´ê³¼ ë™ì¼)
    function renderElectionList(elections) {
        titleElem.innerText = "ì°¸ì—¬í•  ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”";
        document.getElementById('district-name').style.display = 'none';
        voteBtn.style.display = 'none';
        ballotArea.innerHTML = '';
        
        const listDiv = document.createElement('div');
        listDiv.style.display = 'flex';
        listDiv.style.flexDirection = 'column';
        listDiv.style.gap = '10px';

        elections.forEach(election => {
            const btn = document.createElement('button');
            btn.className = 'candidate-card';
            btn.style.textAlign = 'left';
            btn.style.cursor = 'pointer';
            
            // ìƒíƒœ ë±ƒì§€
            const statusBadge = election.status === 'NOMINATION' 
                ? '<span style="color:orange;">[í›„ë³´ë“±ë¡ê¸°ê°„]</span>' 
                : '<span style="color:green;">[íˆ¬í‘œì§„í–‰ì¤‘]</span>';

            btn.innerHTML = `
                <h3 style="margin:0;">${election.title}</h3>
                <p style="margin:0.5rem 0 0 0; color:#666;">${statusBadge}</p>
            `;
            btn.onclick = () => loadElection(election);
            listDiv.appendChild(btn);
        });
        ballotArea.appendChild(listDiv);
    }

async function loadElection(election) {
        currentElection = election;
        titleElem.innerText = election.title;
        ballotArea.innerHTML = '<div style="text-align:center; padding:2rem;">íˆ¬í‘œìš©ì§€ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>';

        try {
            // 1. ëª¨ë“  íˆ¬í‘œìš©ì§€ ê°€ì ¸ì˜¤ê¸° (ElectionServiceì—ì„œ ì´ë¯¸ ì§€ì—­êµ¬->ë¹„ë¡€ ìˆœìœ¼ë¡œ ì •ë ¬ë¨)
            const allBallots = await service.getMyBallotList(election.id);

            // [ìˆ˜ì •] í•„í„°ë§ ì¡°ê±´ ë³€ê²½:
            // ê¸°ì¡´: ì´ë¯¸ íˆ¬í‘œí•œ ê²ƒ OR ë¬´íˆ¬í‘œì¸ ê²ƒ ì œì™¸
            // ë³€ê²½: ì˜¤ì§ 'ì´ë¯¸ íˆ¬í‘œí•œ ê²ƒ(hasVoted)'ë§Œ ì œì™¸ (ë¬´íˆ¬í‘œë„ í™”ë©´ì— ë³´ì—¬ì£¼ê¸° ìœ„í•¨)
            pendingBallots = allBallots.filter(b => !b.hasVoted);

            if (pendingBallots.length === 0) {
                showModal('ì•Œë¦¼', 'ì´ë¯¸ ëª¨ë“  íˆ¬í‘œë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.', () => {
                    showCompleteScreen();
                });
                return;
            }

            // ì²« ë²ˆì§¸ íˆ¬í‘œìš©ì§€ ë¡œë“œ
            loadNextBallot();

        } catch (error) {
            console.error(error);
            if (error.message.includes('ë°°ì •ë˜ì§€')) {
                 showModal('ì•Œë¦¼', `[${election.title}]ì—ëŠ” íˆ¬í‘œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.`, () => initPage());
            } else {
                alertAndClose(error.message);
            }
        }
    } // End of loadElection

    // [ì‹ ê·œ] ë‹¤ìŒ íˆ¬í‘œìš©ì§€ë¥¼ í™”ë©´ì— ê·¸ë¦¬ê¸°
function loadNextBallot() {
        if (pendingBallots.length === 0) {
            showCompleteScreen();
            return;
        }

        currentBallot = pendingBallots[0];
        selectedValue = null; // ì„ íƒê°’ ì´ˆê¸°í™”

        // UI ì„¤ì •
        document.getElementById('district-name').style.display = 'block';
        document.getElementById('district-name').innerText = currentBallot.district.name;
        
        voteBtn.style.display = 'block';

        // [ìˆ˜ì •] ë¬´íˆ¬í‘œ ë‹¹ì„  ì—¬ë¶€ì— ë”°ë¥¸ ë²„íŠ¼ ìƒíƒœ ë¶„ê¸° ì²˜ë¦¬
        if (currentBallot.isUncontested) {
            // Case A: ë¬´íˆ¬í‘œ ë‹¹ì„ ì¸ ê²½ìš°
            voteBtn.innerText = 'í™•ì¸ (ë¬´íˆ¬í‘œ ë‹¹ì„ )';
            voteBtn.disabled = false; // ì„ íƒ ì—†ì´ë„ ëˆ„ë¥¼ ìˆ˜ ìˆì–´ì•¼ í•¨
            voteBtn.classList.remove('btn-submit'); // ìŠ¤íƒ€ì¼ ë³€ê²½ (ì„ íƒì‚¬í•­)
            voteBtn.style.backgroundColor = '#6b7280'; // íšŒìƒ‰ ê³„ì—´ë¡œ ì°¨ë³„í™”
        } else {
            // Case B: ì¼ë°˜ íˆ¬í‘œì¸ ê²½ìš°
            voteBtn.innerText = 'íˆ¬í‘œí•˜ê¸°';
            voteBtn.disabled = true; // ì„ íƒ ì „ì—ëŠ” ë¹„í™œì„±í™”
            voteBtn.classList.add('btn-submit');
            voteBtn.style.backgroundColor = ''; // ì›ë˜ ìƒ‰ìƒ ë³µêµ¬
        }

        // ë‚¨ì€ íˆ¬í‘œ ìˆ˜ í‘œì‹œ
        if (pendingBallots.length > 1) {
             titleElem.innerText = `${currentElection.title} (${pendingBallots.length}ê±´ ë‚¨ìŒ)`;
        } else {
             titleElem.innerText = currentElection.title;
        }

        renderBallotContent(currentBallot);
    } // End of loadNextBallot

    // íˆ¬í‘œìš©ì§€ ë‚´ìš© ê·¸ë¦¬ê¸° (renderBallot -> renderBallotContentë¡œ ì´ë¦„ ë³€ê²½)
// [ìˆ˜ì •ëœ í•¨ìˆ˜] ê³µì•½ ë³´ê¸° ëª¨ë‹¬ ì ìš© ë° ì¹´ë“œ êµ¬ì¡° ë³€ê²½
    function renderBallotContent(info) {
        ballotArea.innerHTML = ''; 

        // ë¬´íˆ¬í‘œ ë‹¹ì„  ì•ˆë‚´ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        if (info.isUncontested) {
            // ... (ì´ì „ ë‹¨ê³„ì—ì„œ ë“œë¦° ë¬´íˆ¬í‘œ ì•ˆë‚´ HTML ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€) ...
            const noticeDiv = document.createElement('div');
            noticeDiv.style.cssText = 'background:#f0fdf4; padding:1rem; margin-bottom:1rem; border-radius:8px; text-align:center; color:#166534; border:1px solid #bbf7d0;';
            noticeDiv.innerHTML = `<strong style="font-size:1.1rem;">ğŸ‰ ë¬´íˆ¬í‘œ ë‹¹ì„  ì•ˆë‚´</strong><br><span style="font-size:0.9rem; color:#374151;">í›„ë³´ì ìˆ˜(${info.candidates.length}ëª…)ê°€ ì„ ì¶œ ì¸ì›(${info.district.quota}ëª…) ì´ë‚´ì´ë¯€ë¡œ<br>íˆ¬í‘œ ì ˆì°¨ ì—†ì´ ë‹¹ì„ ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì•„ë˜ í›„ë³´ìë¥¼ í™•ì¸í•˜ì‹œê³  <strong>[í™•ì¸]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span>`;
            ballotArea.appendChild(noticeDiv);
        }

        if (info.district.vote_type === 'CANDIDATE') {
            const listDiv = document.createElement('div');
            listDiv.className = 'candidate-list';

            if (!info.candidates || info.candidates.length === 0) {
                ballotArea.innerHTML += '<div style="text-align:center; padding:3rem; color:#666;">ë“±ë¡ëœ í›„ë³´ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            info.candidates.forEach(cand => {
                const card = document.createElement('div');
                card.className = 'candidate-card';
                
                if (info.isUncontested) {
                    card.style.cursor = 'default';
                    card.style.borderColor = '#22c55e';
                    card.style.backgroundColor = '#f0fdf4';
                    card.style.boxShadow = 'none';
                }

                const imgUrl = cand.photo_url || 'https://via.placeholder.com/150?text=No+Image';
                
                // [HTML êµ¬ì¡° ë³€ê²½] ì‚¬ì§„ê³¼ ë‚´ìš©ì„ ë¶„ë¦¬í•˜ê³  ê³µì•½ ë²„íŠ¼ì— í´ë˜ìŠ¤ ì¶”ê°€
                card.innerHTML = `
                    <img src="${imgUrl}" class="candidate-img" alt="${cand.name}">
                    <div class="card-content">
                        <h3>${cand.name}</h3>
                        <p>ê¸°í˜¸ ${cand.symbol || '-'}ë²ˆ</p>
                        <button type="button" class="btn-manifesto">ê³µì•½ ë³´ê¸°</button>
                    </div>
                `;
                
                // [ì¤‘ìš” ë³€ê²½ì ] ê³µì•½ ë³´ê¸° í´ë¦­ ì‹œ ëª¨ë‹¬ ë„ìš°ê¸°
                const manifestoBtn = card.querySelector('.btn-manifesto');
                manifestoBtn.onclick = (e) => {
                    e.stopPropagation(); // ì¹´ë“œ ì„ íƒ ë°©ì§€
                    showManifesto(cand.name, cand.manifesto); // ëª¨ë‹¬ í˜¸ì¶œ í•¨ìˆ˜ ì‹¤í–‰
                };

                if (!info.isUncontested) {
                    card.addEventListener('click', (e) => {
                        if(e.target === manifestoBtn) return;
                        document.querySelectorAll('.candidate-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        selectedValue = cand.id;
                        voteBtn.disabled = false;
                        voteBtn.innerText = `'${cand.name}' ì„ íƒì™„ë£Œ`;
                    });
                }
                
                listDiv.appendChild(card);
            });
            ballotArea.appendChild(listDiv);

        } else {
            // (ì°¬ë°˜ íˆ¬í‘œ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼)
             ballotArea.innerHTML = `
                <div class="binary-options">
                    <button type="button" class="btn-binary btn-yes" data-val="AGREE">ì°¬ì„± (O)</button>
                    <button type="button" class="btn-binary btn-no" data-val="DISAGREE">ë°˜ëŒ€ (X)</button>
                </div>
                <p style="text-align:center; margin-top:1rem; color:#666;">ì•ˆê±´ì— ëŒ€í•œ ì°¬ì„±/ë°˜ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            `;
            ballotArea.querySelectorAll('.btn-binary').forEach(btn => {
                btn.addEventListener('click', () => {
                    ballotArea.querySelectorAll('.btn-binary').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedValue = btn.dataset.val;
                    voteBtn.disabled = false;
                    voteBtn.innerText = (selectedValue === 'AGREE' ? 'ì°¬ì„±' : 'ë°˜ëŒ€') + ' ì„ íƒì™„ë£Œ';
                });
            });
        }
    }

    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
voteBtn.addEventListener('click', () => {
        // [ìˆ˜ì •] 1. ë¬´íˆ¬í‘œ ë‹¹ì„ ì¸ ê²½ìš°: DB ì œì¶œ ì—†ì´ ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
        if (currentBallot && currentBallot.isUncontested) {
            pendingBallots.shift(); // í˜„ì¬ íˆ¬í‘œìš©ì§€ ì œê±°
            loadNextBallot();       // ë‹¤ìŒ íˆ¬í‘œìš©ì§€ ë¡œë“œ
            return;                 // í•¨ìˆ˜ ì¢…ë£Œ
        }

        // [ê¸°ì¡´ ë¡œì§] 2. ì¼ë°˜ íˆ¬í‘œì¸ ê²½ìš°
        if (!selectedValue) return;

        const isCandidateVote = currentBallot.district.vote_type === 'CANDIDATE';
        const isLastVote = pendingBallots.length === 1;
        
        const confirmMsg = isLastVote 
            ? "ì •ë§ íˆ¬í‘œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? íˆ¬í‘œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." 
            : "ì´ íˆ¬í‘œë¥¼ ì œì¶œí•˜ê³  'ë‹¤ìŒ íˆ¬í‘œ'ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

        showConfirm(confirmMsg, async () => {
            try {
                voteBtn.innerText = 'ì²˜ë¦¬ì¤‘...';
                voteBtn.disabled = true;

                const payload = {
                    electionId: currentElection.id,
                    districtId: currentBallot.district_id,
                    round: currentElection.current_round || 1,
                    candidateId: isCandidateVote ? selectedValue : null,
                    choice: !isCandidateVote ? selectedValue : null
                };

                await service.submitVote(payload);

                pendingBallots.shift(); 
                loadNextBallot(); 

            } catch (e) {
                showModal('ì˜¤ë¥˜', e.message);
                voteBtn.disabled = false;
                voteBtn.innerText = 'íˆ¬í‘œí•˜ê¸°';
            }
        });
    }); // End of voteBtn Event Listener

        // [ì´í•˜ renderBallot, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ, ëª¨ë‹¬ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš©]
        function renderBallot(info) {
            document.getElementById('district-name').innerText = info.district.name;
            ballotArea.innerHTML = ''; 

            if (info.district.vote_type === 'CANDIDATE') {
                const listDiv = document.createElement('div');
                listDiv.className = 'candidate-list';

                info.candidates.forEach(cand => {
                    const card = document.createElement('div');
                    card.className = 'candidate-card';
                    const imgUrl = cand.photo_url || 'https://via.placeholder.com/150?text=No+Image';
                    
                    card.innerHTML = `
                        <img src="${imgUrl}" class="candidate-img" alt="${cand.name}">
                        <h3>${cand.name}</h3>
                        <p style="font-size:0.9rem; color:#666;">ê¸°í˜¸ ${cand.id.substring(0,4)}...</p>
                        <button type="button" onclick="window.open('${cand.manifesto || '#'}')" style="margin-top:0.5rem; padding:0.2rem 0.5rem;">ê³µì•½ ë³´ê¸°</button>
                    `;
                    
                    card.addEventListener('click', (e) => {
                        if(e.target.tagName === 'BUTTON') return;
                        document.querySelectorAll('.candidate-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        selectedValue = cand.id;
                        voteBtn.disabled = false;
                        voteBtn.innerText = `'${cand.name}' í›„ë³´ ì„ íƒì™„ë£Œ`;
                    });

                    listDiv.appendChild(card);
                });
                ballotArea.appendChild(listDiv);

            } else {
                ballotArea.innerHTML = `
                    <div class="binary-options">
                        <button type="button" class="btn-binary btn-yes" data-val="AGREE">ì°¬ì„± (O)</button>
                        <button type="button" class="btn-binary btn-no" data-val="DISAGREE">ë°˜ëŒ€ (X)</button>
                    </div>
                    <p style="text-align:center; margin-top:1rem; color:#666;">ì•ˆê±´ì— ëŒ€í•œ ì°¬ì„±/ë°˜ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                `;
                ballotArea.querySelectorAll('.btn-binary').forEach(btn => {
                    btn.addEventListener('click', () => {
                        ballotArea.querySelectorAll('.btn-binary').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedValue = btn.dataset.val;
                        voteBtn.disabled = false;
                        voteBtn.innerText = (selectedValue === 'AGREE' ? 'ì°¬ì„±' : 'ë°˜ëŒ€') + ' ì„ íƒì™„ë£Œ';
                    });
                });
            }
        }

// [ìˆ˜ì •ëœ íˆ¬í‘œí•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸]
    voteBtn.addEventListener('click', () => {
        if (!selectedValue) return;

        // ballotInfo -> currentBallot ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•¨ (ì—¬ê¸°ê°€ ì˜¤ë¥˜ ì›ì¸)
        const isCandidateVote = currentBallot.district.vote_type === 'CANDIDATE';

        const isLastVote = pendingBallots.length === 1;
        const confirmMsg = isLastVote 
            ? "ì •ë§ íˆ¬í‘œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? íˆ¬í‘œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." 
            : "ì´ íˆ¬í‘œë¥¼ ì œì¶œí•˜ê³  'ë‹¤ìŒ íˆ¬í‘œ'ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

        showConfirm(confirmMsg, async () => {
            try {
                voteBtn.innerText = 'ì²˜ë¦¬ì¤‘...';
                voteBtn.disabled = true;

                const payload = {
                    electionId: currentElection.id,
                    districtId: currentBallot.district_id, // ì—¬ê¸°ë„ currentBallot ì‚¬ìš©
                    round: currentElection.current_round || 1,
                    candidateId: isCandidateVote ? selectedValue : null,
                    choice: !isCandidateVote ? selectedValue : null
                };

                // íˆ¬í‘œ ì œì¶œ
                await service.submitVote(payload);

                // ì„±ê³µ ì‹œ ëª©ë¡ì—ì„œ ì œê±°í•˜ê³  ë‹¤ìŒìœ¼ë¡œ ì´ë™
                pendingBallots.shift(); 
                loadNextBallot(); 

            } catch (e) {
                showModal('ì˜¤ë¥˜', e.message);
                voteBtn.disabled = false;
                voteBtn.innerText = 'íˆ¬í‘œí•˜ê¸°';
            }
        });
    });

        function showCompleteScreen() {
            loadingScreen.style.display = 'none';
            voteContainer.style.display = 'none';
            completeContainer.classList.add('active');
        }

        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMsg = document.getElementById('modal-msg');
        const btnOk = document.getElementById('modal-btn-ok');
        const btnCancel = document.getElementById('modal-btn-cancel');

        function showModal(title, msg, onOk = null) {
            modalTitle.innerText = title;
            modalMsg.innerText = msg;
            btnCancel.style.display = 'none';
            btnOk.innerText = 'í™•ì¸';
            modalOverlay.style.display = 'flex';
            btnOk.onclick = () => {
                modalOverlay.style.display = 'none';
                if (onOk) onOk();
            };
        }

        function showConfirm(msg, onConfirm) {
            modalTitle.innerText = 'íˆ¬í‘œ í™•ì¸';
            modalMsg.innerText = msg;
            btnCancel.style.display = 'inline-block';
            btnOk.innerText = 'ë„¤, íˆ¬í‘œí•©ë‹ˆë‹¤';
            modalOverlay.style.display = 'flex';
            btnOk.onclick = () => {
                modalOverlay.style.display = 'none';
                onConfirm();
            };
            btnCancel.onclick = () => {
                modalOverlay.style.display = 'none';
            };
        }

        function alertAndClose(msg) {
            loadingScreen.style.display = 'none';
            showModal('ì•Œë¦¼', msg, () => {
                window.close(); 
            });
        }
        
        initPage();
    </script>
</body>
</html>
