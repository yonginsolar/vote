<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„ ê±° ì„¤ì • ë° ëª…ë¶€ ì—…ë¡œë“œ (ê´€ë¦¬ì)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container active" style="max-width:800px;">
        
        <div id="login-section" style="text-align:center; padding: 2rem;">
            <h1>ğŸ”’ ê´€ë¦¬ì ì¸ì¦ í•„ìš”</h1>
            <p>ì„ ê±°ë¥¼ ìƒì„±í•˜ë ¤ë©´ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <input type="email" id="admin-email" placeholder="admin@example.com" 
                   style="padding:0.5rem; width:250px; margin-right:0.5rem;">
            <button onclick="handleLogin()" class="btn-submit" style="width:auto; display:inline-block;">ë§¤ì§ë§í¬ ë³´ë‚´ê¸°</button>
            <p style="font-size:0.8rem; color:#666; margin-top:1rem;">
                * ì´ë©”ì¼ì„ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥¸ ë’¤, ë©”ì¼í•¨ì˜ ë§í¬ë¥¼ í´ë¦­í•˜ê³  ëŒì•„ì˜¤ì„¸ìš”.
            </p>
        </div>

        <div id="setup-section" style="display:none;">
            <h1>âš™ï¸ ì„ ê±° ì´ˆê¸° ì„¤ì •</h1>
            <p style="color:red; font-size:0.9rem;">* ì£¼ì˜: ì´ ì‘ì—…ì€ ì„ ê±°ë‹¹ 1íšŒë§Œ ìˆ˜í–‰í•˜ì„¸ìš”.</p>
            <p id="login-info" style="text-align:right; font-size:0.9rem; color:blue;"></p>

            <div class="admin-panel" style="margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 1. ì„ ê±° ìƒì„±</h3>
                <input type="text" id="election-title" placeholder="ì„ ê±°ëª… (ì˜ˆ: 2026ë…„ ì •ê¸° ëŒ€ì˜ì› ì„ ê±°)" style="width:100%; padding:0.5rem; margin-bottom:0.5rem;">
                <div style="display:flex; gap:1rem;">
                    <input type="datetime-local" id="start-at" style="flex:1; padding:0.5rem;">
                    <input type="datetime-local" id="end-at" style="flex:1; padding:0.5rem;">
                </div>
                <button onclick="createElection()" class="btn-submit" style="margin-top:1rem;">ì„ ê±° ìƒì„±í•˜ê¸°</button>
            </div>

<div id="step-2" style="display:none; margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 2. ì„ ê±°êµ¬ ë“±ë¡</h3>
                <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                    <input type="text" id="dist-name" placeholder="ì´ë¦„ (ì˜ˆ: ì„œìš¸ì§€êµ¬)" style="flex:2;">
                    <input type="text" id="dist-code" placeholder="ì½”ë“œ (ì˜ˆ: SEOUL)" style="flex:1;">
                    <select id="dist-type" style="flex:1;">
                        <option value="CANDIDATE">ì¸ë¬¼íˆ¬í‘œ</option>
                        <option value="BINARY">ì°¬ë°˜íˆ¬í‘œ</option>
                    </select>
                    <button onclick="addDistrict()" style="padding:0.5rem;">ì¶”ê°€</button>
                </div>
                
                <p id="district-warning" style="color:red; font-weight:bold; font-size:0.9rem; margin-bottom:0.5rem;">
                    âš ï¸ ì„ ê±°êµ¬ëŠ” ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ 0ê°œ)
                </p>

                <ul id="district-list" style="background:#f9f9f9; padding:1rem; list-style:none;"></ul>
            </div>

<div id="step-3" style="display:none; margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 3. ì„ ê±°ì¸ ëª…ë¶€ ì—‘ì…€ ì—…ë¡œë“œ</h3>
                
                <div style="margin-bottom: 1rem;">
                    <button onclick="downloadSample()" style="background-color:#6b7280; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; font-size:0.9rem; cursor:pointer;">
                        â¬‡ï¸ ëª…ë¶€ ì‘ì„±ìš© ìƒ˜í”Œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>

                <p style="font-size:0.8rem;">* ì—‘ì…€ ì¹¼ëŸ¼: <code>member_id</code> (í•„ìˆ˜), <code>district_code</code> (í•„ìˆ˜)</p>
                <input type="file" id="excel-file" accept=".xlsx, .xls">
                <button onclick="uploadVoters()" class="btn-submit" style="margin-top:1rem; background-color:#166534;">ëª…ë¶€ ë“±ë¡ ë° ì„¤ì • ì™„ë£Œ</button>
                <div id="upload-log" style="margin-top:1rem; font-size:0.8rem; color:blue;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase, ElectionService } from './ElectionService.js';
        
        let newElectionId = null;
        let createdDistricts = {};

        // [ì´ˆê¸°í™”] í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                // ë¡œê·¸ì¸ ë˜ì–´ ìˆìœ¼ë©´ ì„¤ì • í™”ë©´ í‘œì‹œ
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('setup-section').style.display = 'block';
                document.getElementById('login-info').innerText = `${session.user.email} ë‹˜ ì ‘ì†ì¤‘`;
            } else {
                // ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€
                console.log("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        }

        // [ë¡œê·¸ì¸] ë§¤ì§ë§í¬ ë°œì†¡
window.handleLogin = async () => {
    const email = document.getElementById('admin-email').value;
    if (!email) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');

    const { error } = await supabase.auth.signInWithOtp({ 
        email,
        options: {
            // ğŸš¨ í•µì‹¬: ë¡œê·¸ì¸ ë§í¬ í´ë¦­ ì‹œ, í˜„ì¬ í˜ì´ì§€(admin_setup.html)ë¡œ ë‹¤ì‹œ ëŒì•„ì˜¤ê²Œ í•¨
            emailRedirectTo: window.location.href 
        }
    });

    if (error) alert('ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
    else alert('ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.\në©”ì¼í•¨ì„ í™•ì¸í•˜ê³  ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.');
};

        // [Step 1] ì„ ê±° ìƒì„±
        window.createElection = async () => {
            const title = document.getElementById('election-title').value;
            const start = document.getElementById('start-at').value;
            const end = document.getElementById('end-at').value;

            if(!title || !start || !end) return alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

            const { data, error } = await supabase.from('elections').insert({
                title, start_at: start, end_at: end, status: 'PREPARE'
            }).select().single();

            if(error) return alert('ìƒì„± ì‹¤íŒ¨: ' + error.message);

            newElectionId = data.id;
            alert('ì„ ê±°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ì„ ê±°êµ¬ë¥¼ ë“±ë¡í•˜ì„¸ìš”.');
            document.getElementById('step-2').style.display = 'block';
        };

// [Step 2] ì„ ê±°êµ¬ ì¶”ê°€ (ìˆ˜ì •ë¨)
        window.addDistrict = async () => {
            if(!newElectionId) return;
            const name = document.getElementById('dist-name').value.trim(); // ê³µë°± ì œê±°
            const code = document.getElementById('dist-code').value.trim(); // ê³µë°± ì œê±°
            const type = document.getElementById('dist-type').value;

            // [ìˆ˜ì •] ë¹ˆ ê°’ ë°©ì§€ ë¡œì§ ì¶”ê°€
            if (!name || !code) {
                return alert('ì„ ê±°êµ¬ ì´ë¦„ê³¼ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: ì´ë¦„(ì„œìš¸ì§€êµ¬), ì½”ë“œ(SEOUL)');
            }

            // [ìˆ˜ì •] ì¤‘ë³µ ì½”ë“œ ë°©ì§€ (UXìƒ ì¶”ê°€)
            if (createdDistricts[code]) {
                return alert('ì´ë¯¸ ë“±ë¡ëœ ì„ ê±°êµ¬ ì½”ë“œì…ë‹ˆë‹¤.');
            }

            const { data, error } = await supabase.from('districts').insert({
                election_id: newElectionId, name, code, vote_type: type
            }).select().single();

            if(error) return alert('ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);

            createdDistricts[code] = data.id;
            
            // UI ì—…ë°ì´íŠ¸
            const li = document.createElement('li');
            li.innerText = `${name} (${code}) - ${type}`;
            document.getElementById('district-list').appendChild(li);
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('dist-name').value = '';
            document.getElementById('dist-code').value = '';

            // [ì¶”ê°€] ê°œìˆ˜ ì²´í¬ ë° ê²½ê³  ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            const count = Object.keys(createdDistricts).length;
            const warningEl = document.getElementById('district-warning');
            
            if (count < 3) {
                warningEl.style.color = 'red';
                warningEl.innerText = `âš ï¸ ì„ ê±°êµ¬ëŠ” ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${count}ê°œ)`;
                document.getElementById('step-3').style.display = 'none'; // 3ê°œ ì•ˆë˜ë©´ ì—…ë¡œë“œ ëª»í•˜ê²Œ ìˆ¨ê¹€
            } else {
                warningEl.style.color = 'green';
                warningEl.innerText = `âœ… ìµœì†Œ ì¡°ê±´ ë§Œì¡± (í˜„ì¬ ${count}ê°œ ë“±ë¡ë¨)`;
                document.getElementById('step-3').style.display = 'block'; // 3ê°œ ì´ìƒì¼ ë•Œë§Œ ë‹¤ìŒ ë‹¨ê³„ ë…¸ì¶œ
            }
        };

        // [Step 3] ì—‘ì…€ ì—…ë¡œë“œ
        window.uploadVoters = async () => {
            const fileInput = document.getElementById('excel-file');
            if(fileInput.files.length === 0) return alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                log(`ì—‘ì…€ ì½ê¸° ì„±ê³µ: ì´ ${rows.length}ëª… ë°ì´í„°`);
                log('ì¡°í•©ì› DB ëŒ€ì¡° ì¤‘...');
                
                const { data: members, error: memError } = await supabase
                    .from('coop_members')
                    .select('id, member_id');
                
                if(memError) return alert('ì¡°í•©ì› DB ë¡œë“œ ì‹¤íŒ¨');

                const memberMap = new Map();
                members.forEach(m => memberMap.set(m.member_id, m.id));

                const payload = [];
                let failCount = 0;

                for(const row of rows) {
                    const memUuid = memberMap.get(String(row.member_id));
                    const distId = createdDistricts[row.district_code];

                    if(memUuid && distId) {
                        payload.push({
                            election_id: newElectionId,
                            district_id: distId,
                            member_uuid: memUuid,
                            member_no: String(row.member_id)
                        });
                    } else {
                        console.warn('ë§¤ì¹­ ì‹¤íŒ¨:', row);
                        failCount++;
                    }
                }

                log(`ë§¤ì¹­ ì™„ë£Œ: ì„±ê³µ ${payload.length}ê±´ / ì‹¤íŒ¨ ${failCount}ê±´`);

                if(payload.length > 0) {
                    const { error: insError } = await supabase
                        .from('election_voters')
                        .insert(payload);
                    
                    if(insError) return alert('DB ì €ì¥ ì‹¤íŒ¨: ' + insError.message);
                    
                    alert('ëª…ë¶€ ë“±ë¡ ì™„ë£Œ! ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.href = 'admin.html';
                } else {
                    alert('ë“±ë¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // [ì¶”ê°€] ì—‘ì…€ ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        window.downloadSample = () => {
            // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
            const ws_data = [
                ["member_id", "district_code", "ë¹„ê³ (ì…ë ¥X)"], // í—¤ë”
                ["2025-24-0001", "SEOUL", "ì˜ˆì‹œ ë°ì´í„°ì…ë‹ˆë‹¤."],
                ["2025-24-0002", "BUSAN", "district_codeëŠ” ìœ„ì—ì„œ ë“±ë¡í•œ ì½”ë“œì™€ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤."]
            ];
            
            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "ì„ ê±°ì¸ëª…ë¶€_ìƒ˜í”Œ");
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
            XLSX.writeFile(wb, "ì„ ê±°ì¸ëª…ë¶€_ì—…ë¡œë“œì–‘ì‹.xlsx");
        };

        // [Step 3] ì—‘ì…€ ì—…ë¡œë“œ (ìˆ˜ì •ë¨)
        window.uploadVoters = async () => {
            // [ì¶”ê°€] ìµœì¢… ë°©ì–´ ë¡œì§: ì„ ê±°êµ¬ 3ê°œ ë¯¸ë§Œì´ë©´ ì—…ë¡œë“œ ì°¨ë‹¨
            if (Object.keys(createdDistricts).length < 3) {
                return alert('ì„ ê±°êµ¬ê°€ ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡ë˜ì–´ì•¼ ëª…ë¶€ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            const fileInput = document.getElementById('excel-file');
            if(fileInput.files.length === 0) return alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                log(`ì—‘ì…€ ì½ê¸° ì„±ê³µ: ì´ ${rows.length}ëª… ë°ì´í„°`);
                log('ì¡°í•©ì› DB ëŒ€ì¡° ì¤‘...');
                
                const { data: members, error: memError } = await supabase
                    .from('coop_members')
                    .select('id, member_id');
                
                if(memError) return alert('ì¡°í•©ì› DB ë¡œë“œ ì‹¤íŒ¨');

                const memberMap = new Map();
                members.forEach(m => memberMap.set(m.member_id, m.id));

                const payload = [];
                let failCount = 0;

                for(const row of rows) {
                    // ì—‘ì…€ì˜ member_idë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                    const memIdStr = String(row.member_id || '').trim();
                    const distCodeStr = String(row.district_code || '').trim();

                    const memUuid = memberMap.get(memIdStr);
                    const distId = createdDistricts[distCodeStr];

                    if(memUuid && distId) {
                        payload.push({
                            election_id: newElectionId,
                            district_id: distId,
                            member_uuid: memUuid,
                            member_no: memIdStr
                        });
                    } else {
                        // ì‹¤íŒ¨ ë¡œê·¸ ìƒì„¸í™”
                        console.warn(`ë§¤ì¹­ ì‹¤íŒ¨: ID(${memIdStr}) / Code(${distCodeStr}) - í•´ë‹¹ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì½”ë“œê°€ í‹€ë¦¼`);
                        failCount++;
                    }
                }

                log(`ë§¤ì¹­ ì™„ë£Œ: ì„±ê³µ ${payload.length}ê±´ / ì‹¤íŒ¨ ${failCount}ê±´`);

                if(payload.length > 0) {
                    const { error: insError } = await supabase
                        .from('election_voters')
                        .insert(payload);
                    
                    if(insError) return alert('DB ì €ì¥ ì‹¤íŒ¨: ' + insError.message);
                    
                    alert('ëª…ë¶€ ë“±ë¡ ì™„ë£Œ! ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.href = 'admin.html';
                } else {
                    alert('ë“±ë¡í•  ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ì˜ ë‚´ìš©ê³¼ ì„ ê±°êµ¬ ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        function log(msg) {
            document.getElementById('upload-log').innerText += msg + '\n';
        }

        

        // ì‹¤í–‰
        init();
    </script>
</body>
</html>
