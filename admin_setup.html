<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„ ê±° ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* [1] í—¤ë” ìŠ¤íƒ€ì¼ ìˆ˜ì • (ë‚˜ê°€ê¸° ë²„íŠ¼ ìš°ì¸¡ ì •ë ¬) */
        header {
            display: flex; 
            justify-content: space-between; /* ì–‘ìª½ ëìœ¼ë¡œ ë°°ì¹˜ */
            align-items: center;
            padding: 1rem 2rem;
            background: white;
            border-bottom: 1px solid #ddd;
        }
        
        /* [2] ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .active-election-card {
            border: 2px solid var(--color-primary); /* ë…¹ìƒ‰ í…Œë‘ë¦¬ */
            background: #fdfdfd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .active-election-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* [3] ì—°í˜(Timeline) ìŠ¤íƒ€ì¼ */
        .timeline-container { margin-top: 20px; }
        .timeline-item {
            padding: 0 0 20px 20px;
            border-left: 2px solid #e0e0e0;
            position: relative;
            cursor: pointer;
        }
        .timeline-item::before {
            content: "";
            position: absolute;
            width: 14px; height: 14px;
            border-radius: 50px;
            left: -8px; top: 0;
            background: #fff;
            border: 2px solid var(--color-primary);
        }
        /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì  ìƒ‰ìƒ ë³€ê²½ */
        .timeline-item:hover::before {
            background: var(--color-secondary);
            border-color: var(--color-secondary);
        }
        .timeline-date {
            font-size: 14px; color: var(--color-secondary); font-weight: 700; margin-bottom: 5px;
        }
        .timeline-content h4 {
            font-size: 16px; font-weight: 600; margin: 0 0 5px 0;
        }
        .timeline-content p {
            font-size: 14px; color: #666; margin: 0;
        }

        /* [4] ëª¨ë‹¬ ë° í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        
        .preview-table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .preview-table th { background-color: #f3f4f6; font-weight: bold; }
        .preview-district-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem; border-left: 4px solid var(--primary-color); padding-left: 10px; }
        .btn-delete { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; padding: 2px 8px; border-radius: 4px; cursor: pointer; }
        .btn-delete:hover { background: #dc2626; color: white; }
    </style>
</head>

<body>
    <header>
        <h1 style="margin:0; font-family:'GmarketSans'; color:var(--color-primary);">ğŸ›¡ï¸ ì„ ê±° ê´€ë¦¬ì</h1>
        
        <div id="user-info-area" style="display:none; align-items:center; gap:15px;">
            <span id="login-info" style="font-weight:bold; color:#333;">ê´€ë¦¬ìë‹˜</span>
            <button onclick="handleLogout()" style="background:#fff; border:1px solid #ddd; padding:5px 10px; border-radius:4px; cursor:pointer;">
                ë‚˜ê°€ê¸°
            </button>
        </div>
    </header>
<div class="container active" style="max-width:800px; margin-top: 2rem;">
        
        <div id="login-section" style="text-align:center; padding: 2rem;">
            <h1>ğŸ”’ ê´€ë¦¬ì ì¸ì¦ í•„ìš”</h1>
            <p>ì„ ê±°ë¥¼ ìƒì„±í•˜ë ¤ë©´ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <input type="email" id="admin-email" placeholder="admin@example.com" 
                   style="padding:0.5rem; width:250px; margin-right:0.5rem;">
            <button onclick="handleLogin()" class="btn-submit" style="width:auto; display:inline-block;">ë§¤ì§ë§í¬ ë³´ë‚´ê¸°</button>
            <p style="font-size:0.8rem; color:#666; margin-top:1rem;">
                * ì´ë©”ì¼ì„ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥¸ ë’¤, ë©”ì¼í•¨ì˜ ë§í¬ë¥¼ í´ë¦­í•˜ê³  ëŒì•„ì˜¤ì„¸ìš”.
            </p>
        </div>

        <div id="dashboard-section" style="display:none; padding: 1rem 0;">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>ğŸ“Š ì„ ê±° í˜„í™©íŒ</h2>
                <button onclick="showCreateForm()" style="background:var(--color-primary); color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">
                    + ìƒˆ ì„ ê±° ë§Œë“¤ê¸°
                </button>
            </div>

            <div class="admin-panel" style="margin-bottom: 2rem;">
                <h3 style="border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;">ğŸ”¥ ì§„í–‰ ì¤‘ì¸ ì„ ê±°</h3>
                <div id="active-list">
                    <p style="color:#666; padding:1rem;">ë°ì´í„° ë¡œë”© ì¤‘...</p>
                </div>
            </div>

            <div class="admin-panel">
                <h3 style="border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;">ğŸ“œ ì§€ë‚œ ì„ ê±° ì´ë ¥</h3>
                <div id="history-timeline" class="timeline-container">
                    </div>
            </div>
        </div>

        <div id="setup-section" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1 style="margin-bottom:0;">âš™ï¸ ì„ ê±° ìƒì„± ë§ˆë²•ì‚¬</h1>
                <button onclick="location.reload()" style="font-size:0.9rem; border:1px solid #ddd; background:#fff; padding:5px 10px; border-radius:4px; cursor:pointer;">â† ëŒ€ì‹œë³´ë“œë¡œ</button>
            </div>
            
            <p style="color:red; font-size:0.9rem; margin-bottom: 1rem; margin-top:10px;">* ì£¼ì˜: ìƒˆë¡œìš´ ì„ ê±°ë¥¼ ìƒì„±í•˜ë©´ ê¸°ì¡´ ì„ ê±° ì„¤ì •ê³¼ ì„ì´ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”.</p>

            <div class="admin-panel" style="margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 1. ì„ ê±° ìƒì„±</h3>
                <input type="text" id="election-title" placeholder="ì„ ê±°ëª… (ì˜ˆ: 2026ë…„ ì •ê¸° ëŒ€ì˜ì› ì„ ê±°)" style="width:100%; padding:0.5rem; margin-bottom:0.5rem;">
                <div style="display:flex; gap:1rem;">
                    <input type="datetime-local" id="start-at" style="flex:1; padding:0.5rem;">
                    <input type="datetime-local" id="end-at" style="flex:1; padding:0.5rem;">
                </div>
                <button onclick="createElection()" class="btn-submit" style="margin-top:1rem;">ì„ ê±° ìƒì„±í•˜ê¸°</button>
            </div>

            <div id="step-2" style="display:none; margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 2. ì„ ê±°êµ¬ ë“±ë¡</h3>
                <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                    <input type="text" id="dist-name" placeholder="ì´ë¦„ (ì˜ˆ: ì„œìš¸ì§€êµ¬)" style="flex:2;">
                    <input type="text" id="dist-code" placeholder="ì½”ë“œ (ì˜ˆ: SEOUL)" style="flex:1;">
                    <select id="dist-type" style="flex:1;">
                        <option value="CANDIDATE">ì¸ë¬¼íˆ¬í‘œ</option>
                        <option value="BINARY">ì°¬ë°˜íˆ¬í‘œ</option>
                    </select>
                    <button onclick="addDistrict()" style="padding:0.5rem;">ì¶”ê°€</button>
                </div>
                
                <p id="district-warning" style="color:red; font-weight:bold; font-size:0.9rem; margin-bottom:0.5rem;">
                    âš ï¸ ì„ ê±°êµ¬ëŠ” ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ 0ê°œ)
                </p>

                <ul id="district-list" style="background:#f9f9f9; padding:1rem; list-style:none;"></ul>
            </div>

            <div id="step-3" style="display:none; margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 3. ì„ ê±°ì¸ ëª…ë¶€ ì—‘ì…€ ì—…ë¡œë“œ</h3>
                
                <div style="margin-bottom: 1rem;">
                    <button onclick="downloadSample()" style="background-color:#6b7280; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; font-size:0.9rem; cursor:pointer;">
                        â¬‡ï¸ ëª…ë¶€ ì‘ì„±ìš© ìƒ˜í”Œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>

                <p style="font-size:0.8rem;">* ì—‘ì…€ ì¹¼ëŸ¼: <code>member_id</code> (í•„ìˆ˜), <code>district_code</code> (í•„ìˆ˜)</p>
                <input type="file" id="excel-file" accept=".xlsx, .xls">
                <button onclick="uploadVoters()" class="btn-submit" style="margin-top:1rem; background-color:#166534;">ëª…ë¶€ ë“±ë¡ ë° ì„¤ì • ì™„ë£Œ</button>
                <div id="upload-log" style="margin-top:1rem; font-size:0.8rem; color:blue;"></div>
            </div>
        </div>

    </div> <div id="preview-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; text-align: left;">
            <h2 style="text-align: center;">ğŸ“‹ ëª…ë¶€ ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°</h2>
            <p style="text-align: center; color: #666; margin-bottom: 1rem;">
                ë°ì´í„°ê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.<br>
                ì˜ëª»ëœ ë°ì´í„°ëŠ” <strong>[ì‚­ì œ]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì œì™¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            
            <div id="preview-list">
                </div>

            <div class="modal-buttons" style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">
                <button onclick="closePreview()" class="btn-modal" style="background-color: #aaa; color: white;">ì·¨ì†Œ (ë‹¤ì‹œ ì˜¬ë¦¬ê¸°)</button>
                <button onclick="confirmUpload()" class="btn-modal btn-confirm" style="font-size: 1.1rem; padding: 0.8rem 2rem;">âœ… ì´ìƒ ì—†ìŒ, ìµœì¢… ë“±ë¡</button>
            </div>
        </div>
    </div>
    
    <div id="history-modal" class="center-modal" style="display:none;">
        <div class="modal-contents" style="max-width:400px; text-align:left;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="modal-title" style="margin:0; color:var(--color-primary);">ì„ ê±° ì œëª©</h3>
                <button onclick="closeHistoryModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
            
            <div class="detail-row">
                <span>ê¸°ê°„</span>
                <span id="modal-period" style="font-weight:bold; font-size:0.9rem;">-</span>
            </div>
            <div class="detail-row">
                <span>ì´ ìœ ê¶Œì</span>
                <span><strong id="modal-total">0</strong>ëª…</span>
            </div>
            <div class="detail-row">
                <span>íˆ¬í‘œ ì°¸ì—¬</span>
                <span><strong id="modal-current" style="color:var(--color-primary);">0</strong>ëª… (<span id="modal-rate">0</span>%)</span>
            </div>

            <div style="margin-top:20px; text-align:center;">
                <button id="btn-go-result" style="width:100%; padding:12px; background:var(--color-secondary); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                    ìƒì„¸ ê²°ê³¼ ë³´ê¸° >
                </button>
            </div>
        </div>
    </div>
<script type="module">
        import { AdminService } from './AdminService.js';
        import { supabase } from './ElectionService.js';
        
        let newElectionId = null;
        let createdDistricts = {};

        // [ì¤‘ìš”] ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ëŠ” í•œ ë²ˆë§Œ ì„ ì–¸í•©ë‹ˆë‹¤.
        const adminService = new AdminService();

        // [ì´ˆê¸°í™”]
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                // ë¡œê·¸ì¸ UI ì²˜ë¦¬
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('user-info-area').style.display = 'flex';
                document.getElementById('login-info').innerText = session.user.email;
                
                // [ë³€ê²½] ë°”ë¡œ ì„¤ì •í™”ë©´(setup-section)ì´ ì•„ë‹ˆë¼ ëŒ€ì‹œë³´ë“œ(dashboard-section)ë¥¼ ë„ì›€
                document.getElementById('dashboard-section').style.display = 'block';
                document.getElementById('setup-section').style.display = 'none'; 
                
                // ë°ì´í„° ë¡œë“œ
                loadDashboard(); 

            } else {
                console.log("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        }

        // [ëŒ€ì‹œë³´ë“œ] ë°ì´í„° ë¡œë“œ (ìƒˆë¡œ ì¶”ê°€ëœ í•¨ìˆ˜)
        async function loadDashboard() {
            const elections = await adminService.getAllElections();
            const activeContainer = document.getElementById('active-list');
            const timelineContainer = document.getElementById('history-timeline');
            
            activeContainer.innerHTML = '';
            timelineContainer.innerHTML = '';

            if (elections.length === 0) {
                activeContainer.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const activeStatuses = ['PREPARE', 'NOMINATION', 'READY', 'OPEN', 'PAUSED'];

            elections.forEach(el => {
                if (activeStatuses.includes(el.status)) {
                    // [ì§„í–‰ ì¤‘] ì¹´ë“œ ë Œë”ë§
                    const card = document.createElement('div');
                    card.className = 'active-election-card';
                    card.onclick = () => {
                        localStorage.setItem('target_election_id', el.id);
                        window.location.href = `admin.html?id=${el.id}`;
                    };
                    card.innerHTML = `
                        <div>
                            <span style="background:${el.status === 'OPEN' ? 'var(--color-primary)' : '#999'}; color:white; padding:2px 8px; border-radius:12px; font-size:0.8rem;">
                                ${el.status}
                            </span>
                            <h4 style="margin:5px 0 0 0; font-size:1.1rem;">${el.title}</h4>
                        </div>
                        <div style="font-size:1.5rem; color:var(--color-primary);">âœ</div>
                    `;
                    activeContainer.appendChild(card);
                } else {
                    // [ì§€ë‚œ ì„ ê±°] íƒ€ì„ë¼ì¸ ë Œë”ë§
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    item.onclick = () => openHistoryModal(el);

                    item.innerHTML = `
                        <div class="timeline-date">${new Date(el.end_at).toLocaleDateString()} ì¢…ë£Œ</div>
                        <div class="timeline-content">
                            <h4>${el.title}</h4>
                            <p>ìƒíƒœ: ${el.status}</p>
                        </div>
                    `;
                    timelineContainer.appendChild(item);
                }
            });
        }

        // [ê¸°ëŠ¥] ìƒˆ ì„ ê±° ë§Œë“¤ê¸° í¼ í† ê¸€
        window.showCreateForm = () => {
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('setup-section').style.display = 'block';
        };

        // [ëª¨ë‹¬] ì§€ë‚œ ì„ ê±° ìƒì„¸ ì—´ê¸°
        window.openHistoryModal = async (el) => {
            const modal = document.getElementById('history-modal');
            document.getElementById('modal-title').innerText = el.title;
            document.getElementById('modal-period').innerText = `${new Date(el.start_at).toLocaleDateString()} ~ ${new Date(el.end_at).toLocaleDateString()}`;
            
            // íˆ¬í‘œìœ¨ ë¡œë“œ (ì—ëŸ¬ ì˜ˆì™¸ì²˜ë¦¬ í¬í•¨)
            try {
                const stats = await adminService.getTurnoutStats(el.id);
                document.getElementById('modal-total').innerText = stats.total;
                document.getElementById('modal-current').innerText = stats.current;
                document.getElementById('modal-rate').innerText = stats.percent;
            } catch(e) { console.error(e); }

            // ê²°ê³¼ í˜ì´ì§€ ì´ë™
            document.getElementById('btn-go-result').onclick = () => {
                window.open(`monitor.html?id=${el.id}`, '_blank');
            };

            modal.style.display = 'flex';
        };

        window.closeHistoryModal = () => {
            document.getElementById('history-modal').style.display = 'none';
        };

        // [ë¡œê·¸ì•„ì›ƒ]
        window.handleLogout = async () => {
            await supabase.auth.signOut();
            window.location.reload();
        };

        // [ë¡œê·¸ì¸]
        window.handleLogin = async () => {
            const email = document.getElementById('admin-email').value;
            if (!email) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');

            const { error } = await supabase.auth.signInWithOtp({ 
                email,
                options: { emailRedirectTo: window.location.href }
            });

            if (error) alert('ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
            else alert('ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.\në©”ì¼í•¨ì„ í™•ì¸í•˜ê³  ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.');
        };

        // [Step 1] ì„ ê±° ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.createElection = async () => {
            const title = document.getElementById('election-title').value;
            const start = document.getElementById('start-at').value;
            const end = document.getElementById('end-at').value;

            if(!title || !start || !end) return alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

            const { data, error } = await supabase.from('elections').insert({
                title, start_at: start, end_at: end, status: 'PREPARE'
            }).select().single();

            if(error) return alert('ìƒì„± ì‹¤íŒ¨: ' + error.message);

            newElectionId = data.id;
            alert('ì„ ê±°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ì„ ê±°êµ¬ë¥¼ ë“±ë¡í•˜ì„¸ìš”.');
            document.getElementById('step-2').style.display = 'block';
        };

        // [Step 2] ì„ ê±°êµ¬ ì¶”ê°€ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.addDistrict = async () => {
            if(!newElectionId) return;
            const name = document.getElementById('dist-name').value.trim();
            const code = document.getElementById('dist-code').value.trim();
            const type = document.getElementById('dist-type').value;

            if (!name || !code) {
                return alert('ì„ ê±°êµ¬ ì´ë¦„ê³¼ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: ì´ë¦„(ì„œìš¸ì§€êµ¬), ì½”ë“œ(SEOUL)');
            }
            if (createdDistricts[code]) {
                return alert('ì´ë¯¸ ë“±ë¡ëœ ì„ ê±°êµ¬ ì½”ë“œì…ë‹ˆë‹¤.');
            }

            const { data, error } = await supabase.from('districts').insert({
                election_id: newElectionId, name, code, vote_type: type
            }).select().single();

            if(error) return alert('ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);

            createdDistricts[code] = data.id;
            
            const li = document.createElement('li');
            li.innerText = `${name} (${code}) - ${type}`;
            document.getElementById('district-list').appendChild(li);
            
            document.getElementById('dist-name').value = '';
            document.getElementById('dist-code').value = '';

            const count = Object.keys(createdDistricts).length;
            const warningEl = document.getElementById('district-warning');
            
            if (count < 3) {
                warningEl.style.color = 'red';
                warningEl.innerText = `âš ï¸ ì„ ê±°êµ¬ëŠ” ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${count}ê°œ)`;
                document.getElementById('step-3').style.display = 'none';
            } else {
                warningEl.style.color = 'green';
                warningEl.innerText = `âœ… ìµœì†Œ ì¡°ê±´ ë§Œì¡± (í˜„ì¬ ${count}ê°œ ë“±ë¡ë¨)`;
                document.getElementById('step-3').style.display = 'block';
            }
        };

        // [Step 3] ì—‘ì…€ ì—…ë¡œë“œ ë° ë¯¸ë¦¬ë³´ê¸° (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.uploadVoters = async () => {
            if (Object.keys(createdDistricts).length < 3) {
                return alert('ì„ ê±°êµ¬ê°€ ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡ë˜ì–´ì•¼ ëª…ë¶€ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            const fileInput = document.getElementById('excel-file');
            if(fileInput.files.length === 0) return alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                // í™•ì¸ìš©ìœ¼ë¡œ name, phone ì¶”ê°€ ì¡°íšŒ
                const { data: members, error: memError } = await supabase
                    .from('coop_members')
                    .select('id, member_id, name, phone');
                
                if(memError) return alert('ì¡°í•©ì› DB ë¡œë“œ ì‹¤íŒ¨');

                const memberMap = new Map();
                members.forEach(m => memberMap.set(m.member_id, m));

                const tempPayload = [];
                let failCount = 0;

                for(const row of rows) {
                    const memIdStr = String(row.member_id || '').trim();
                    const distCodeStr = String(row.district_code || '').trim();

                    const memberInfo = memberMap.get(memIdStr);
                    const distId = createdDistricts[distCodeStr];

                    if(memberInfo && distId) {
                        tempPayload.push({
                            election_id: newElectionId,
                            district_id: distId,
                            member_uuid: memberInfo.id,
                            member_no: memIdStr,
                            _view_name: memberInfo.name,
                            _view_phone: memberInfo.phone,
                            _view_dist_code: distCodeStr
                        });
                    } else {
                        console.warn(`ë§¤ì¹­ ì‹¤íŒ¨: ID(${memIdStr}) / Code(${distCodeStr})`);
                        failCount++;
                    }
                }

                if(tempPayload.length > 0) {
                    renderPreview(tempPayload);
                } else {
                    alert('ë“±ë¡í•  ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // [ê¸°ëŠ¥] ì—‘ì…€ ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.downloadSample = () => {
            const ws_data = [
                ["member_id", "district_code", "ë¹„ê³ (ì…ë ¥X)"],
                ["2025-24-0001", "SEOUL", "ì˜ˆì‹œ ë°ì´í„°ì…ë‹ˆë‹¤."],
                ["2025-24-0002", "BUSAN", "district_codeëŠ” ìœ„ì—ì„œ ë“±ë¡í•œ ì½”ë“œì™€ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤."]
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "ì„ ê±°ì¸ëª…ë¶€_ìƒ˜í”Œ");
            
            XLSX.writeFile(wb, "ì„ ê±°ì¸ëª…ë¶€_ì—…ë¡œë“œì–‘ì‹.xlsx");
        };

        // [ë¯¸ë¦¬ë³´ê¸° ê´€ë ¨ í•¨ìˆ˜ë“¤] (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        let pendingVoters = [];

        window.renderPreview = (dataList) => {
            pendingVoters = [...dataList];
            updatePreviewTable_Safe();
            document.getElementById('preview-modal').style.display = 'flex';
        };

        window.closePreview = () => {
            if(confirm('ì—…ë¡œë“œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('preview-modal').style.display = 'none';
                pendingVoters = [];
            }
        };

        // ì•ˆì „í•œ í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        function updatePreviewTable_Safe() {
            const container = document.getElementById('preview-list');
            container.innerHTML = '';
            
            if (pendingVoters.length === 0) {
                container.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const grouped = {};
            pendingVoters.forEach((item, index) => {
                const code = item._view_dist_code;
                if (!grouped[code]) grouped[code] = [];
                grouped[code].push({ ...item, realIndex: index }); 
            });

            for (const [code, items] of Object.entries(grouped)) {
                const distDiv = document.createElement('div');
                distDiv.innerHTML = `<div class="preview-district-title">ğŸ“ ì„ ê±°êµ¬: ${code} (${items.length}ëª…)</div>`;

                const table = document.createElement('table');
                table.className = 'preview-table';
                table.innerHTML = `
                    <thead><tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th><th>ê´€ë¦¬</th></tr></thead>
                    <tbody>
                        ${items.map(p => `
                            <tr>
                                <td>${p.member_no}</td>
                                <td>${p._view_name}</td>
                                <td>${p._view_phone}</td>
                                <td>
                                    <button onclick="removeRow(${p.realIndex})" class="btn-delete">ì‚­ì œ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                distDiv.appendChild(table);
                container.appendChild(distDiv);
            }
        }

        // ê°œë³„ í–‰ ì‚­ì œ
        window.removeRow = (idxToDel) => {
            pendingVoters.splice(idxToDel, 1);
            updatePreviewTable_Safe(); 
        };

        // [ìµœì¢… DB ì €ì¥] (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.confirmUpload = async () => {
            if (pendingVoters.length === 0) return alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            if(!confirm(`ì´ ${pendingVoters.length}ëª…ì˜ ëª…ë¶€ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const finalPayload = pendingVoters.map(item => ({
                election_id: item.election_id,
                district_id: item.district_id,
                member_uuid: item.member_uuid,
                member_no: item.member_no
            }));

            const { error: insError } = await supabase
                .from('election_voters')
                .upsert(finalPayload, { onConflict: 'election_id, member_uuid' });
            
            if(insError) return alert('DB ì €ì¥ ì‹¤íŒ¨: ' + insError.message);
            
            alert('âœ… ëª…ë¶€ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            window.location.href = 'admin.html';
        };

        // ì‹¤í–‰
        init();
    </script>
</body>
</html>
