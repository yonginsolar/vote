<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„ ê±° ì„¤ì • ë° ëª…ë¶€ ì—…ë¡œë“œ (ê´€ë¦¬ì)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container active" style="max-width:800px;">
        
        <div id="login-section" style="text-align:center; padding: 2rem;">
            <h1>ğŸ”’ ê´€ë¦¬ì ì¸ì¦ í•„ìš”</h1>
            <p>ì„ ê±°ë¥¼ ìƒì„±í•˜ë ¤ë©´ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <input type="email" id="admin-email" placeholder="admin@example.com" 
                   style="padding:0.5rem; width:250px; margin-right:0.5rem;">
            <button onclick="handleLogin()" class="btn-submit" style="width:auto; display:inline-block;">ë§¤ì§ë§í¬ ë³´ë‚´ê¸°</button>
            <p style="font-size:0.8rem; color:#666; margin-top:1rem;">
                * ì´ë©”ì¼ì„ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥¸ ë’¤, ë©”ì¼í•¨ì˜ ë§í¬ë¥¼ í´ë¦­í•˜ê³  ëŒì•„ì˜¤ì„¸ìš”.
            </p>
        </div>

        <div id="setup-section" style="display:none;">
            <h1>âš™ï¸ ì„ ê±° ì´ˆê¸° ì„¤ì •</h1>
            <p style="color:red; font-size:0.9rem;">* ì£¼ì˜: ì´ ì‘ì—…ì€ ì„ ê±°ë‹¹ 1íšŒë§Œ ìˆ˜í–‰í•˜ì„¸ìš”.</p>
            <p id="login-info" style="text-align:right; font-size:0.9rem; color:blue;"></p>

            <div class="admin-panel" style="margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 1. ì„ ê±° ìƒì„±</h3>
                <input type="text" id="election-title" placeholder="ì„ ê±°ëª… (ì˜ˆ: 2026ë…„ ì •ê¸° ëŒ€ì˜ì› ì„ ê±°)" style="width:100%; padding:0.5rem; margin-bottom:0.5rem;">
                <div style="display:flex; gap:1rem;">
                    <input type="datetime-local" id="start-at" style="flex:1; padding:0.5rem;">
                    <input type="datetime-local" id="end-at" style="flex:1; padding:0.5rem;">
                </div>
                <button onclick="createElection()" class="btn-submit" style="margin-top:1rem;">ì„ ê±° ìƒì„±í•˜ê¸°</button>
            </div>

<div id="step-2" style="display:none; margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 2. ì„ ê±°êµ¬ ë“±ë¡</h3>
                <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                    <input type="text" id="dist-name" placeholder="ì´ë¦„ (ì˜ˆ: ì„œìš¸ì§€êµ¬)" style="flex:2;">
                    <input type="text" id="dist-code" placeholder="ì½”ë“œ (ì˜ˆ: SEOUL)" style="flex:1;">
                    <select id="dist-type" style="flex:1;">
                        <option value="CANDIDATE">ì¸ë¬¼íˆ¬í‘œ</option>
                        <option value="BINARY">ì°¬ë°˜íˆ¬í‘œ</option>
                    </select>
                    <button onclick="addDistrict()" style="padding:0.5rem;">ì¶”ê°€</button>
                </div>
                
                <p id="district-warning" style="color:red; font-weight:bold; font-size:0.9rem; margin-bottom:0.5rem;">
                    âš ï¸ ì„ ê±°êµ¬ëŠ” ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ 0ê°œ)
                </p>

                <ul id="district-list" style="background:#f9f9f9; padding:1rem; list-style:none;"></ul>
            </div>

<div id="step-3" style="display:none; margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 3. ì„ ê±°ì¸ ëª…ë¶€ ì—‘ì…€ ì—…ë¡œë“œ</h3>
                
                <div style="margin-bottom: 1rem;">
                    <button onclick="downloadSample()" style="background-color:#6b7280; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; font-size:0.9rem; cursor:pointer;">
                        â¬‡ï¸ ëª…ë¶€ ì‘ì„±ìš© ìƒ˜í”Œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>

                <p style="font-size:0.8rem;">* ì—‘ì…€ ì¹¼ëŸ¼: <code>member_id</code> (í•„ìˆ˜), <code>district_code</code> (í•„ìˆ˜)</p>
                <input type="file" id="excel-file" accept=".xlsx, .xls">
                <button onclick="uploadVoters()" class="btn-submit" style="margin-top:1rem; background-color:#166534;">ëª…ë¶€ ë“±ë¡ ë° ì„¤ì • ì™„ë£Œ</button>
                <div id="upload-log" style="margin-top:1rem; font-size:0.8rem; color:blue;"></div>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; text-align: left;">
            <h2 style="text-align: center;">ğŸ“‹ ëª…ë¶€ ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°</h2>
            <p style="text-align: center; color: #666; margin-bottom: 1rem;">
                ë°ì´í„°ê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.<br>
                ì˜ëª»ëœ ë°ì´í„°ëŠ” <strong>[ì‚­ì œ]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì œì™¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            
            <div id="preview-list">
                </div>

            <div class="modal-buttons" style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">
                <button onclick="closePreview()" class="btn-modal" style="background-color: #aaa; color: white;">ì·¨ì†Œ (ë‹¤ì‹œ ì˜¬ë¦¬ê¸°)</button>
                <button onclick="confirmUpload()" class="btn-modal btn-confirm" style="font-size: 1.1rem; padding: 0.8rem 2rem;">âœ… ì´ìƒ ì—†ìŒ, ìµœì¢… ë“±ë¡</button>
            </div>
        </div>
    </div>
    
    <style>
        /* ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .preview-table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .preview-table th { background-color: #f3f4f6; font-weight: bold; }
        .preview-district-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem; border-left: 4px solid var(--primary-color); padding-left: 10px; }
        .btn-delete { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; padding: 2px 8px; border-radius: 4px; cursor: pointer; }
        .btn-delete:hover { background: #dc2626; color: white; }
    </style>

    <script type="module">
        import { supabase, ElectionService } from './ElectionService.js';
        
        let newElectionId = null;
        let createdDistricts = {};

        // [ì´ˆê¸°í™”] í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                // ë¡œê·¸ì¸ ë˜ì–´ ìˆìœ¼ë©´ ì„¤ì • í™”ë©´ í‘œì‹œ
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('setup-section').style.display = 'block';
                document.getElementById('login-info').innerText = `${session.user.email} ë‹˜ ì ‘ì†ì¤‘`;
            } else {
                // ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€
                console.log("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        }

        // [ë¡œê·¸ì¸] ë§¤ì§ë§í¬ ë°œì†¡
window.handleLogin = async () => {
    const email = document.getElementById('admin-email').value;
    if (!email) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');

    const { error } = await supabase.auth.signInWithOtp({ 
        email,
        options: {
            // ğŸš¨ í•µì‹¬: ë¡œê·¸ì¸ ë§í¬ í´ë¦­ ì‹œ, í˜„ì¬ í˜ì´ì§€(admin_setup.html)ë¡œ ë‹¤ì‹œ ëŒì•„ì˜¤ê²Œ í•¨
            emailRedirectTo: window.location.href 
        }
    });

    if (error) alert('ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
    else alert('ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.\në©”ì¼í•¨ì„ í™•ì¸í•˜ê³  ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.');
};

        // [Step 1] ì„ ê±° ìƒì„±
        window.createElection = async () => {
            const title = document.getElementById('election-title').value;
            const start = document.getElementById('start-at').value;
            const end = document.getElementById('end-at').value;

            if(!title || !start || !end) return alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

            const { data, error } = await supabase.from('elections').insert({
                title, start_at: start, end_at: end, status: 'PREPARE'
            }).select().single();

            if(error) return alert('ìƒì„± ì‹¤íŒ¨: ' + error.message);

            newElectionId = data.id;
            alert('ì„ ê±°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ì„ ê±°êµ¬ë¥¼ ë“±ë¡í•˜ì„¸ìš”.');
            document.getElementById('step-2').style.display = 'block';
        };

// [Step 2] ì„ ê±°êµ¬ ì¶”ê°€ (ìˆ˜ì •ë¨)
        window.addDistrict = async () => {
            if(!newElectionId) return;
            const name = document.getElementById('dist-name').value.trim(); // ê³µë°± ì œê±°
            const code = document.getElementById('dist-code').value.trim(); // ê³µë°± ì œê±°
            const type = document.getElementById('dist-type').value;

            // [ìˆ˜ì •] ë¹ˆ ê°’ ë°©ì§€ ë¡œì§ ì¶”ê°€
            if (!name || !code) {
                return alert('ì„ ê±°êµ¬ ì´ë¦„ê³¼ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: ì´ë¦„(ì„œìš¸ì§€êµ¬), ì½”ë“œ(SEOUL)');
            }

            // [ìˆ˜ì •] ì¤‘ë³µ ì½”ë“œ ë°©ì§€ (UXìƒ ì¶”ê°€)
            if (createdDistricts[code]) {
                return alert('ì´ë¯¸ ë“±ë¡ëœ ì„ ê±°êµ¬ ì½”ë“œì…ë‹ˆë‹¤.');
            }

            const { data, error } = await supabase.from('districts').insert({
                election_id: newElectionId, name, code, vote_type: type
            }).select().single();

            if(error) return alert('ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);

            createdDistricts[code] = data.id;
            
            // UI ì—…ë°ì´íŠ¸
            const li = document.createElement('li');
            li.innerText = `${name} (${code}) - ${type}`;
            document.getElementById('district-list').appendChild(li);
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('dist-name').value = '';
            document.getElementById('dist-code').value = '';

            // [ì¶”ê°€] ê°œìˆ˜ ì²´í¬ ë° ê²½ê³  ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            const count = Object.keys(createdDistricts).length;
            const warningEl = document.getElementById('district-warning');
            
            if (count < 3) {
                warningEl.style.color = 'red';
                warningEl.innerText = `âš ï¸ ì„ ê±°êµ¬ëŠ” ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${count}ê°œ)`;
                document.getElementById('step-3').style.display = 'none'; // 3ê°œ ì•ˆë˜ë©´ ì—…ë¡œë“œ ëª»í•˜ê²Œ ìˆ¨ê¹€
            } else {
                warningEl.style.color = 'green';
                warningEl.innerText = `âœ… ìµœì†Œ ì¡°ê±´ ë§Œì¡± (í˜„ì¬ ${count}ê°œ ë“±ë¡ë¨)`;
                document.getElementById('step-3').style.display = 'block'; // 3ê°œ ì´ìƒì¼ ë•Œë§Œ ë‹¤ìŒ ë‹¨ê³„ ë…¸ì¶œ
            }
        };

// [Step 3] ì—‘ì…€ ì—…ë¡œë“œ (ìˆ˜ì •ë³¸: ì €ì¥ ë¡œì§ ì œê±°ë¨)
        window.uploadVoters = async () => {
            // ìµœì¢… ë°©ì–´ ë¡œì§
            if (Object.keys(createdDistricts).length < 3) {
                return alert('ì„ ê±°êµ¬ê°€ ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡ë˜ì–´ì•¼ ëª…ë¶€ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            const fileInput = document.getElementById('excel-file');
            if(fileInput.files.length === 0) return alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                log(`ì—‘ì…€ ì½ê¸° ì„±ê³µ: ì´ ${rows.length}ëª… ë°ì´í„°`);
                log('ì¡°í•©ì› ì •ë³´ ìƒì„¸ ëŒ€ì¡° ì¤‘...'); 
                
                // í™•ì¸ìš©ìœ¼ë¡œ name, phone ì¶”ê°€ ì¡°íšŒ
                const { data: members, error: memError } = await supabase
                    .from('coop_members')
                    .select('id, member_id, name, phone');
                
                if(memError) return alert('ì¡°í•©ì› DB ë¡œë“œ ì‹¤íŒ¨');

                const memberMap = new Map();
                members.forEach(m => memberMap.set(m.member_id, m));

                const tempPayload = [];
                let failCount = 0;

                for(const row of rows) {
                    const memIdStr = String(row.member_id || '').trim();
                    const distCodeStr = String(row.district_code || '').trim();

                    const memberInfo = memberMap.get(memIdStr);
                    const distId = createdDistricts[distCodeStr];

                    if(memberInfo && distId) {
                        tempPayload.push({
                            election_id: newElectionId,
                            district_id: distId,
                            member_uuid: memberInfo.id,
                            member_no: memIdStr,
                            // ë¯¸ë¦¬ë³´ê¸°ìš© ë°ì´í„°
                            _view_name: memberInfo.name,
                            _view_phone: memberInfo.phone,
                            _view_dist_code: distCodeStr
                        });
                    } else {
                        console.warn(`ë§¤ì¹­ ì‹¤íŒ¨: ID(${memIdStr}) / Code(${distCodeStr})`);
                        failCount++;
                    }
                }

                log(`1ì°¨ ë¶„ì„ ì™„ë£Œ: ìœ íš¨ ë°ì´í„° ${tempPayload.length}ê±´ / ë§¤ì¹­ ì‹¤íŒ¨ ${failCount}ê±´`);

                if(tempPayload.length > 0) {
                    // ğŸš¨ í•µì‹¬: ì—¬ê¸°ì„œ ë°”ë¡œ DBì— ë„£ìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤!
                    // insert/upsert ì½”ë“œ ì—†ìŒ -> renderPreview í˜¸ì¶œë§Œ í•¨
                    renderPreview(tempPayload);
                } else {
                    alert('ë“±ë¡í•  ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // [ì¶”ê°€] ì—‘ì…€ ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        window.downloadSample = () => {
            // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
            const ws_data = [
                ["member_id", "district_code", "ë¹„ê³ (ì…ë ¥X)"], // í—¤ë”
                ["2025-24-0001", "SEOUL", "ì˜ˆì‹œ ë°ì´í„°ì…ë‹ˆë‹¤."],
                ["2025-24-0002", "BUSAN", "district_codeëŠ” ìœ„ì—ì„œ ë“±ë¡í•œ ì½”ë“œì™€ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤."]
            ];
            
            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "ì„ ê±°ì¸ëª…ë¶€_ìƒ˜í”Œ");
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
            XLSX.writeFile(wb, "ì„ ê±°ì¸ëª…ë¶€_ì—…ë¡œë“œì–‘ì‹.xlsx");
        };

// [Step 3] ì—‘ì…€ ì—…ë¡œë“œ ë° ë¯¸ë¦¬ë³´ê¸° (ìˆ˜ì •ë¨)
        window.uploadVoters = async () => {
            // ìµœì¢… ë°©ì–´ ë¡œì§
            if (Object.keys(createdDistricts).length < 3) {
                return alert('ì„ ê±°êµ¬ê°€ ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡ë˜ì–´ì•¼ ëª…ë¶€ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            const fileInput = document.getElementById('excel-file');
            if(fileInput.files.length === 0) return alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                log(`ì—‘ì…€ ì½ê¸° ì„±ê³µ: ì´ ${rows.length}ëª… ë°ì´í„°`);
                log('ì¡°í•©ì› ì •ë³´ ìƒì„¸ ëŒ€ì¡° ì¤‘...'); // ì´ë¦„, ì „í™”ë²ˆí˜¸ê¹Œì§€ ê°€ì ¸ì˜´
                
                // [ìˆ˜ì •] í™•ì¸ìš©ìœ¼ë¡œ name, phone ì¶”ê°€ ì¡°íšŒ
                const { data: members, error: memError } = await supabase
                    .from('coop_members')
                    .select('id, member_id, name, phone');
                
                if(memError) return alert('ì¡°í•©ì› DB ë¡œë“œ ì‹¤íŒ¨');

                // Map ìƒì„± (ê²€ìƒ‰ìš©)
                const memberMap = new Map();
                members.forEach(m => memberMap.set(m.member_id, m)); // ê°ì²´ ì „ì²´ ì €ì¥

                // ì„ ê±°êµ¬ ì´ë¦„ ë§¤í•‘ìš© (Code -> Name)
                // createdDistrictsëŠ” { 'SEOUL': 'uuid...' } í˜•íƒœë¼ ì´ë¦„ì„ ëª¨ë¦„.
                // í™”ë©´ì˜ li íƒœê·¸ë‚˜ ë³„ë„ ë¡œì§ìœ¼ë¡œ ì´ë¦„ì„ ì°¾ì•„ì•¼ í•˜ëŠ”ë°, 
                // í¸ì˜ìƒ Step 2ì—ì„œ ì…ë ¥í•œ ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìœ¼ë‹ˆ DB í•œë²ˆ ë” ì¡°íšŒí•˜ê±°ë‚˜, 
                // ì—¬ê¸°ì„œëŠ” "ì½”ë“œ"ë¡œë§Œ ë³´ì—¬ì£¼ê³  ë„˜ì–´ê°€ë„ ë˜ì§€ë§Œ, ì‚¬ìš©ì í¸ì˜ë¥¼ ìœ„í•´ UIì—ì„œ ì°¾ìŠµë‹ˆë‹¤.
                // (MVP ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ Previewì—ëŠ” 'ì„ ê±°êµ¬ ì½”ë“œ'ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.)

                const tempPayload = [];
                let failCount = 0;

                for(const row of rows) {
                    const memIdStr = String(row.member_id || '').trim();
                    const distCodeStr = String(row.district_code || '').trim();

                    const memberInfo = memberMap.get(memIdStr); // ì¡°í•©ì› ì •ë³´
                    const distId = createdDistricts[distCodeStr]; // ì„ ê±°êµ¬ UUID

                    if(memberInfo && distId) {
                        tempPayload.push({
                            // DB ì €ì¥ìš© ë°ì´í„°
                            election_id: newElectionId,
                            district_id: distId,
                            member_uuid: memberInfo.id,
                            member_no: memIdStr,
                            
                            // [ì¶”ê°€] ë¯¸ë¦¬ë³´ê¸° í‘œì‹œìš© ë°ì´í„° (DBì—” ì•ˆ ë“¤ì–´ê°)
                            _view_name: memberInfo.name,
                            _view_phone: memberInfo.phone,
                            _view_dist_code: distCodeStr
                        });
                    } else {
                        console.warn(`ë§¤ì¹­ ì‹¤íŒ¨: ID(${memIdStr}) / Code(${distCodeStr})`);
                        failCount++;
                    }
                }

                log(`1ì°¨ ë¶„ì„ ì™„ë£Œ: ìœ íš¨ ë°ì´í„° ${tempPayload.length}ê±´ / ë§¤ì¹­ ì‹¤íŒ¨ ${failCount}ê±´`);

                if(tempPayload.length > 0) {
                    // ë°”ë¡œ ì €ì¥í•˜ì§€ ì•Šê³  ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
                    renderPreview(tempPayload);
                } else {
                    alert('ë“±ë¡í•  ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        function log(msg) {
            document.getElementById('upload-log').innerText += msg + '\n';
        }

        // [ì „ì—­ ë³€ìˆ˜] ìµœì¢… ì €ì¥ ì „ ì„ì‹œ ë°ì´í„° ë‹´ì„ ê³³
        let pendingVoters = [];

        // [ì¶”ê°€] ë¯¸ë¦¬ë³´ê¸° í™”ë©´ ë Œë”ë§
        window.renderPreview = (dataList) => {
            pendingVoters = [...dataList]; // ë°ì´í„° ë³µì‚¬
            updatePreviewTable();
            document.getElementById('preview-modal').style.display = 'flex';
        };

        // [ì¶”ê°€] í…Œì´ë¸” ê·¸ë¦¬ê¸° (ì‚­ì œ í›„ ì¬ë Œë”ë§ ë•Œë„ ì“°ì„)
        function updatePreviewTable() {
            const container = document.getElementById('preview-list');
            container.innerHTML = '';

            if (pendingVoters.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:1rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ì„ ê±°êµ¬ë³„ ê·¸ë£¹í™” (Grouping)
            const grouped = {};
            pendingVoters.forEach((item, index) => {
                const code = item._view_dist_code;
                if (!grouped[code]) grouped[code] = [];
                // indexë¥¼ ê°™ì´ ì €ì¥í•´ ë‚˜ì¤‘ì— ì‚­ì œ ì‹œ ì‚¬ìš©
                grouped[code].push({ ...item, originalIndex: index }); 
            });

            // ê·¸ë£¹ë³„ í…Œì´ë¸” ìƒì„±
            for (const [code, items] of Object.entries(grouped)) {
                const distDiv = document.createElement('div');
                distDiv.innerHTML = `<div class="preview-district-title">ğŸ“ ì„ ê±°êµ¬: ${code} (${items.length}ëª…)</div>`;

                const table = document.createElement('table');
                table.className = 'preview-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>ë²ˆí˜¸</th>
                            <th>ì´ë¦„</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(p => `
                            <tr>
                                <td>${p.member_no}</td>
                                <td>${p._view_name}</td>
                                <td>${p._view_phone}</td>
                                <td>
                                    <button onclick="removeRow(${p.originalIndex})" class="btn-delete">ì‚­ì œ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                distDiv.appendChild(table);
                container.appendChild(distDiv);
            }
        }

        // [ì¶”ê°€] ê°œë³„ í–‰ ì‚­ì œ
        window.removeRow = (originalIndex) => {
            // í•´ë‹¹ ì¸ë±ìŠ¤ ë°ì´í„°ë¥¼ ì œì™¸í•˜ê³  ë‹¤ì‹œ ë°°ì—´ ìƒì„± (ê°„ë‹¨í•œ ë°©ì‹)
            // originalIndexëŠ” ì²˜ìŒì— ë³µì‚¬í•´ë‘” ì¸ë±ìŠ¤ì´ë¯€ë¡œ, filterë¡œ ì²˜ë¦¬í•˜ë ¤ë©´ 
            // pendingVoters ì•ˆì˜ ê°ì²´ ì°¸ì¡°ë¥¼ ì´ìš©í•˜ëŠ” ê²Œ ì•ˆì „í•˜ì§€ë§Œ, 
            // ì—¬ê¸°ì„  ê°„ë‹¨íˆ ë Œë”ë§ ì‹œì ì˜ ê°’ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            
            // ë” ì•ˆì „í•œ ë°©ë²•: filterë¡œ ì œì™¸
            const targetItem = pendingVoters[originalIndex]; // (ì´ ë°©ì‹ì€ ë°°ì—´ì´ ì¤„ì–´ë“¤ë©´ ì¸ë±ìŠ¤ê°€ ê¼¬ì„)
            
            // ìˆ˜ì •ëœ ì‚­ì œ ë¡œì§:
            // renderPreview í•  ë•Œ í• ë‹¹í•œ originalIndexëŠ” ë°°ì—´ì´ ë³€í•˜ë©´ ì•ˆ ë§ìŒ.
            // ë”°ë¼ì„œ UIì—ì„œ ë°”ë¡œ ì§€ìš°ê¸°ë³´ë‹¤ ê°’ì„ nullë¡œ ë§Œë“¤ê³  í•„í„°ë§í•˜ê±°ë‚˜,
            // ë§¤ë²ˆ ìƒˆë¡œ ê·¸ë¦¬ëŠ” ê²Œ ë‚«ìŠµë‹ˆë‹¤. 
            
            // ì—¬ê¸°ì„œëŠ” MVPë¡œ ê°€ì¥ ì‰¬ìš´ "splice" ë°©ì‹ì„ ì“°ë˜,
            // updatePreviewTable()ì—ì„œ originalIndexë¥¼ ì“°ì§€ ì•Šê³  
            // í™”ë©´ ê°±ì‹  ì‹œ pendingVotersë¥¼ ë‹¤ì‹œ ìˆœíšŒí•˜ë„ë¡ ë¡œì§ì„ ë°”ê¿‰ë‹ˆë‹¤.

            pendingVoters.splice(originalIndex, 1); // ì‚­ì œ
            
            // ì¬ê·€ì  ê°±ì‹ : ë°°ì—´ì´ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ, ì¸ë±ìŠ¤ë¥¼ ë‹¤ì‹œ ë§¤ê¸°ê¸° ìœ„í•´ 
            // renderPreviewëŠ” í˜¸ì¶œí•˜ì§€ ì•Šê³  (ëª¨ë‹¬ ë„ë‹ˆê¹Œ), 
            // í…Œì´ë¸” ê·¸ë¦¬ëŠ” ë¡œì§ ë‚´ë¶€ì—ì„œ ì¸ë±ìŠ¤ ê´€ë¦¬ê°€ í•„ìš”í•¨.
            
            // **ê°€ì¥ ì‰¬ìš´ í•´ê²°ì±…:** ê·¸ëƒ¥ pendingVotersë¥¼ ë‹¤ì‹œ renderPreview ë£¨í‹´ì— íƒœìš°ì§€ ë§ê³ 
            // ì—¬ê¸°ì„œ ì§ì ‘ DOMì„ ì§€ìš°ê±°ë‚˜, ë³µì¡í•˜ë©´ ê·¸ëƒ¥ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
            
            // ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì¸ë±ìŠ¤ ì¬ì •ë ¬ë¨)
            // ì£¼ì˜: spliceë¥¼ ì“°ë©´ ë’¤ìª½ ì¸ë±ìŠ¤ê°€ ë‹¹ê²¨ì§€ë¯€ë¡œ, originalIndex ë°©ì‹ì€ ìœ„í—˜í•¨.
            // í•´ê²°: item ìì²´ì— IDë¥¼ ë¶€ì—¬í•˜ê±°ë‚˜, filterë¡œ ì²˜ë¦¬.
        };
        
        // **[ì¬ìˆ˜ì •] removeRow ë¡œì§ ì•ˆì „í•˜ê²Œ ë³€ê²½**
        window.removeRow = (idxToDel) => {
            // ë Œë”ë§ ì‹œì ì˜ ì¸ë±ìŠ¤ê°€ ì•„ë‹ˆë¼, í˜„ì¬ ë°°ì—´ ë‚´ì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ì•¼ í•¨.
            // í•˜ì§€ë§Œ ë³µì¡í•˜ë¯€ë¡œ, renderPreview ì‹œì ì— itemì— ê³ ìœ  IDë¥¼ ì•ˆ ë„£ì—ˆë‹¤ë©´,
            // ê°„ë‹¨í•˜ê²Œ: pendingVoters[idxToDel] ë°©ì‹ì„ ì“°ë ¤ë©´
            // ë§¤ë²ˆ ë Œë”ë§ í•  ë•Œë§ˆë‹¤ pendingVotersë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ data-attrì— ë°•ì•„ì•¼ í•¨.

            // --> ì½”ë“œë¥¼ ê°„ë‹¨í•˜ê²Œ í•˜ê¸° ìœ„í•´ updatePreviewTableì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
            // ì•„ë˜ ì½”ë“œë¥¼ ì“°ì„¸ìš”.
            
            pendingVoters.splice(idxToDel, 1); // ë°°ì—´ì—ì„œ ì‚­ì œ
            
            // UI ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì¸ë±ìŠ¤ ì¬ê³„ì‚°)
            updatePreviewTable_Safe(); 
        };

        // ì•ˆì „í•œ í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (renderPreview ëŒ€ì²´)
        function updatePreviewTable_Safe() {
            const container = document.getElementById('preview-list');
            container.innerHTML = '';
            
            if (pendingVoters.length === 0) {
                container.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const grouped = {};
            // ì—¬ê¸°ì„œ indexëŠ” í˜„ì¬ pendingVotersì˜ ì‹¤ì‹œê°„ ì¸ë±ìŠ¤ì…ë‹ˆë‹¤.
            pendingVoters.forEach((item, index) => {
                const code = item._view_dist_code;
                if (!grouped[code]) grouped[code] = [];
                grouped[code].push({ ...item, realIndex: index }); 
            });

            for (const [code, items] of Object.entries(grouped)) {
                const distDiv = document.createElement('div');
                distDiv.innerHTML = `<div class="preview-district-title">ğŸ“ ì„ ê±°êµ¬: ${code} (${items.length}ëª…)</div>`;

                const table = document.createElement('table');
                table.className = 'preview-table';
                table.innerHTML = `
                    <thead><tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th><th>ê´€ë¦¬</th></tr></thead>
                    <tbody>
                        ${items.map(p => `
                            <tr>
                                <td>${p.member_no}</td>
                                <td>${p._view_name}</td>
                                <td>${p._view_phone}</td>
                                <td>
                                    <button onclick="removeRow(${p.realIndex})" class="btn-delete">ì‚­ì œ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                distDiv.appendChild(table);
                container.appendChild(distDiv);
            }
        }
        
        // window.renderPreviewë„ ì´ê±¸ ì“°ê²Œ ì—°ê²°
        window.renderPreview = (dataList) => {
            pendingVoters = [...dataList];
            updatePreviewTable_Safe();
            document.getElementById('preview-modal').style.display = 'flex';
        };

        // [ì¶”ê°€] ëª¨ë‹¬ ë‹«ê¸°
        window.closePreview = () => {
            if(confirm('ì—…ë¡œë“œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('preview-modal').style.display = 'none';
                pendingVoters = []; // ì´ˆê¸°í™”
            }
        };

        // [ì¶”ê°€] ìµœì¢… DB ì €ì¥ (Upsert)
        window.confirmUpload = async () => {
            if (pendingVoters.length === 0) return alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            
            if(!confirm(`ì´ ${pendingVoters.length}ëª…ì˜ ëª…ë¶€ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            // í‘œì‹œìš© ì†ì„±(_view_...) ì œê±°í•˜ê³  ìˆœìˆ˜ ë°ì´í„°ë§Œ ì¶”ì¶œ
            const finalPayload = pendingVoters.map(item => ({
                election_id: item.election_id,
                district_id: item.district_id,
                member_uuid: item.member_uuid,
                member_no: item.member_no
            }));

            const { error: insError } = await supabase
                .from('election_voters')
                .upsert(finalPayload, { onConflict: 'election_id, member_uuid' });
            
            if(insError) return alert('DB ì €ì¥ ì‹¤íŒ¨: ' + insError.message);
            
            alert('âœ… ëª…ë¶€ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            window.location.href = 'admin.html';
        };

        // ì‹¤í–‰
        init();
    </script>
</body>
</html>
