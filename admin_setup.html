<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„ ê±° ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
<style>
    /* [ê¸°ë³¸ ë³€ìˆ˜] */
    :root {
        --color-primary: #10b981; /* ë…¹ìƒ‰ ê³„ì—´ */
        --color-secondary: #3b82f6; /* íŒŒë€ìƒ‰ ê³„ì—´ */
        --color-danger: #ef4444; /* ë¶‰ì€ìƒ‰ */
        --bg-overlay: rgba(0, 0, 0, 0.5);
    }

   /* [ê¸°ë³¸ ë¦¬ì…‹] */
    body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; }

    /* [í—¤ë”] ìƒë‹¨ ê³ ì • ë° ì¢Œìš° ì •ë ¬ */
    header {
        position: fixed; /* ìŠ¤í¬ë¡¤ í•´ë„ ìœ„ì— ë¶™ì–´ìˆìŒ */
        top: 0; 
        left: 0;
        width: 100%; /* í™”ë©´ ì „ì²´ ë„ˆë¹„ */
        height: 60px; /* ë†’ì´ ê³ ì • */
        
        display: flex; 
        justify-content: space-between; /* ì–‘ìª½ ëìœ¼ë¡œ ë°€ì–´ë‚´ê¸° */
        align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        
        padding: 0 2rem; /* ì¢Œìš° ì—¬ë°± */
        box-sizing: border-box; /* padding í¬í•¨ ë„ˆë¹„ ê³„ì‚° */
        
        background: white;
        border-bottom: 1px solid #ddd;
        z-index: 1000; /* ëª¨ë‹¬ ë‹¤ìŒìœ¼ë¡œ ë†’ì€ ìš°ì„ ìˆœìœ„ */
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }

    /* ë¡œê³  ìŠ¤íƒ€ì¼ */
    .header-logo span {
        font-size: 1.3rem; 
        font-weight: 800; 
        color: var(--color-primary);
        letter-spacing: -0.5px;
    }

    /* ìœ ì € ì •ë³´ ì˜ì—­ */
    #user-info-area {
        display: flex; 
        align-items: center; 
        gap: 15px;
    }

    /* [ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ] í—¤ë”ì— ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ ìœ„ìª½ ì—¬ë°± ì¶”ê°€ */
    .container {
        max-width: 800px;
        margin: 0 auto; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
        margin-top: 100px !important; /* í—¤ë” ë†’ì´(60px) + ì—¬ìœ ê³µê°„(40px) */
        padding: 0 1rem;
    }

    /* [ëŒ€ì‹œë³´ë“œ ì¹´ë“œ] ë²„íŠ¼ ì˜ì—­ ì¶”ê°€ */
    .active-election-card {
        border: 1px solid #e5e7eb;
        border-left: 5px solid var(--color-primary);
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative; /* ë²„íŠ¼ ë°°ì¹˜ë¥¼ ìœ„í•´ */
    }
    .active-election-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    /* ìƒíƒœ ì œì–´ ë²„íŠ¼ ê·¸ë£¹ */
    .card-actions {
        display: flex;
        gap: 8px;
        margin-left: 20px;
    }
    .btn-control {
        padding: 6px 12px;
        border-radius: 4px;
        border: none;
        font-size: 0.85rem;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-pause { background: #f59e0b; color: white; } /* ì£¼í™© */
    .btn-pause:hover { background: #d97706; }
    .btn-stop { background: #ef4444; color: white; } /* ë¹¨ê°• */
    .btn-stop:hover { background: #dc2626; }
    .btn-resume { background: var(--color-primary); color: white; } /* ë…¹ìƒ‰ */

    /* [ëª¨ë‹¬ ê³µí†µ] ì¤‘ì•™ ì •ë ¬ ê°•ì œ (ìˆ˜ì • í•µì‹¬) */
    .modal-overlay {
        position: fixed; /* í™”ë©´ ê³ ì • */
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: var(--bg-overlay);
        z-index: 9999; /* ìµœìƒë‹¨ */
        display: none; /* JSë¡œ í† ê¸€ */
        justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ */
        align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ */
        backdrop-filter: blur(2px); /* ë°°ê²½ ë¸”ëŸ¬ íš¨ê³¼ */
    }
    
    .modal-content, .modal-contents {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        max-width: 500px;
        width: 90%;
        animation: modalFadeIn 0.3s;
        position: relative; /* ë‚´ë¶€ ìš”ì†Œ ë°°ì¹˜ ê¸°ì¤€ */
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ì•ŒëŸ¿/ì»¨íŒ ì „ìš© ìŠ¤íƒ€ì¼ */
    .alert-actions {
        display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;
    }
    .btn-modal { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
    .btn-confirm { background: var(--color-primary); color: white; }
    .btn-cancel { background: #e5e7eb; color: #333; }

    /* [ê¸°íƒ€] ì—°í˜ ë° í…Œì´ë¸” ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ ìœ ì§€ */
    .timeline-container { margin-top: 20px; }
    .timeline-item { padding: 0 0 20px 20px; border-left: 2px solid #e0e0e0; position: relative; cursor: pointer; }
    .timeline-item::before { content: ""; position: absolute; width: 14px; height: 14px; border-radius: 50%; left: -8px; top: 0; background: #fff; border: 2px solid var(--color-primary); }
    .timeline-date { font-size: 14px; color: #666; font-weight: 700; margin-bottom: 5px; }
    .preview-table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; font-size: 0.9rem; }
    .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
</style>
</head>

<body>
<header>
        <div class="header-logo">
            <span>ğŸ›¡ï¸ Election Admin</span>
        </div>
        
        <div id="user-info-area" style="display:none;">
            <span id="login-info" style="font-weight:bold; color:#555; font-size:0.9rem;">ê´€ë¦¬ìë‹˜</span>
            <button onclick="handleLogout()" style="background:#fff; border:1px solid #ddd; padding:6px 14px; border-radius:20px; cursor:pointer; font-size:0.8rem; font-weight:bold; color:#444;">
                ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </header>

<div class="container active">
        <div id="login-section" style="text-align:center; padding: 4rem 1rem;">
             </div>

        <div id="dashboard-section" style="display:none;">
             </div>

        <div id="setup-section" style="display:none;">
             </div>
    </div>  
        <div id="login-section" style="text-align:center; padding: 4rem 1rem;">
            <h2 style="color:#333;">ğŸ” ê´€ë¦¬ì ì¸ì¦</h2>
            <p style="color:#666; margin-bottom:2rem;">ë³´ì•ˆì„ ìœ„í•´ ê´€ë¦¬ì ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <input type="email" id="admin-email" placeholder="admin@example.com" 
                   style="padding:0.8rem; width:250px; border:1px solid #ddd; border-radius:6px;">
            <button onclick="handleLogin()" style="padding:0.8rem 1.5rem; background:var(--color-primary); color:white; border:none; border-radius:6px; cursor:pointer;">
                ì¸ì¦ ë©”ì¼ ë°œì†¡
            </button>
        </div>

        <div id="dashboard-section" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ“Š ì„ ê±° í˜„í™©</h2>
                <button onclick="showCreateForm()" style="background:var(--color-primary); color:white; border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer;">
                    + ìƒˆ ì„ ê±° ìƒì„±
                </button>
            </div>

            <div class="admin-panel" style="margin-bottom: 2rem;">
                <h4 style="color:#666; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">ì§„í–‰ ì¤‘ì¸ ì„ ê±°</h4>
                <div id="active-list">
                    </div>
            </div>

            <div class="admin-panel">
                <h4 style="color:#666; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">ì§€ë‚œ ì„ ê±° ì´ë ¥</h4>
                <div id="history-timeline" class="timeline-container"></div>
            </div>
        </div>

        <div id="setup-section" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                <h2 style="margin:0;">âš™ï¸ ì„ ê±° ìƒì„±</h2>
                <button onclick="location.reload()" style="border:1px solid #ddd; background:#fff; padding:6px 12px; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
            </div>
            <div class="admin-panel" style="padding:1.5rem; border:1px solid #ccc; border-radius:8px; margin-bottom:10px;">
                <h3>Step 1. ê¸°ë³¸ ì •ë³´</h3>
                <input type="text" id="election-title" placeholder="ì„ ê±°ëª…" style="width:100%; padding:0.5rem; margin-bottom:0.5rem;">
                <div style="display:flex; gap:1rem;">
                    <input type="datetime-local" id="start-at" style="flex:1; padding:0.5rem;">
                    <input type="datetime-local" id="end-at" style="flex:1; padding:0.5rem;">
                </div>
                <button onclick="createElection()" style="margin-top:1rem; padding:10px; background:var(--color-primary); color:white; border:none; width:100%; cursor:pointer;">ìƒì„±í•˜ê¸°</button>
            </div>
            
            <div id="step-2" style="display:none; margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                 <h3>Step 2. ì„ ê±°êµ¬ ì„¤ì •</h3>
                 <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                    <input type="text" id="dist-name" placeholder="ì´ë¦„ (ì˜ˆ: ì„œìš¸)" style="flex:2;">
                    <input type="text" id="dist-code" placeholder="ì½”ë“œ (ì˜ˆ: SEOUL)" style="flex:1;">
                    <select id="dist-type" style="flex:1;">
                        <option value="CANDIDATE">ì¸ë¬¼</option>
                        <option value="BINARY">ì°¬ë°˜</option>
                    </select>
                    <button onclick="addDistrict()" style="padding:0.5rem;">ì¶”ê°€</button>
                </div>
                <ul id="district-list"></ul>
            </div>

            <div id="step-3" style="display:none; margin-top:1rem; padding:1.5rem; border:1px solid #ccc; border-radius:8px;">
                <h3>Step 3. ëª…ë¶€ ì—…ë¡œë“œ</h3>
                <input type="file" id="excel-file" accept=".xlsx, .xls">
                <button onclick="uploadVoters()" style="margin-top:1rem; width:100%; padding:10px; background:#166534; color:white; border:none; cursor:pointer;">ëª…ë¶€ ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </div>

    </div> 
    <div id="preview-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top:0;">ğŸ“‹ ë°ì´í„° í™•ì¸</h3>
            <div id="preview-list"></div>
            <div class="alert-actions">
                <button onclick="closePreview()" class="btn-modal btn-cancel">ì·¨ì†Œ</button>
                <button onclick="confirmUpload()" class="btn-modal btn-confirm">ìµœì¢… ë“±ë¡</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="modal-title" style="margin:0; color:var(--color-primary);">ì„ ê±° ì œëª©</h3>
                <button onclick="closeHistoryModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
            <div class="detail-row"><span>ê¸°ê°„</span> <span id="modal-period">-</span></div>
            <div class="detail-row"><span>ì´ ìœ ê¶Œì</span> <span><strong id="modal-total">0</strong>ëª…</span></div>
            <div class="detail-row"><span>íˆ¬í‘œ ì°¸ì—¬</span> <span><strong id="modal-current">0</strong>ëª… (<span id="modal-rate">0</span>%)</span></div>
            <div style="margin-top:20px; text-align:center;">
                <button id="btn-go-result" class="btn-modal btn-confirm" style="width:100%;">ìƒì„¸ ê²°ê³¼ ë³´ê¸° ></button>
            </div>
        </div>
    </div>

    <div id="common-alert-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:350px; text-align:center;">
            <p id="common-alert-msg" style="margin: 20px 0; font-size:1.05rem; color:#333; line-height:1.5;"></p>
            <div id="common-alert-btns" class="alert-actions" style="justify-content:center;">
                </div>
        </div>
    </div>

</body>
<script type="module">
        import { AdminService } from './AdminService.js';
        import { supabase } from './ElectionService.js';
        
        let newElectionId = null;
        let createdDistricts = {};

        // [ì¤‘ìš”] ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ëŠ” í•œ ë²ˆë§Œ ì„ ì–¸í•©ë‹ˆë‹¤.
        const adminService = new AdminService();

        // [ì´ˆê¸°í™”]
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                // ë¡œê·¸ì¸ UI ì²˜ë¦¬
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('user-info-area').style.display = 'flex';
                document.getElementById('login-info').innerText = session.user.email;
                
                // [ë³€ê²½] ë°”ë¡œ ì„¤ì •í™”ë©´(setup-section)ì´ ì•„ë‹ˆë¼ ëŒ€ì‹œë³´ë“œ(dashboard-section)ë¥¼ ë„ì›€
                document.getElementById('dashboard-section').style.display = 'block';
                document.getElementById('setup-section').style.display = 'none'; 
                
                // ë°ì´í„° ë¡œë“œ
                loadDashboard(); 

            } else {
                console.log("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        }

async function loadDashboard() {
        const elections = await adminService.getAllElections();
        const activeContainer = document.getElementById('active-list');
        const timelineContainer = document.getElementById('history-timeline');
        
        activeContainer.innerHTML = '';
        timelineContainer.innerHTML = '';

        if (elections.length === 0) {
            activeContainer.innerHTML = '<p style="padding:1rem; color:#666;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const activeStatuses = ['PREPARE', 'NOMINATION', 'READY', 'OPEN', 'PAUSED'];

        elections.forEach(el => {
            if (activeStatuses.includes(el.status)) {
                // [ì§„í–‰ ì¤‘] ì¹´ë“œ ë Œë”ë§
                const card = document.createElement('div');
                card.className = 'active-election-card';
                
                // ì¹´ë“œ ì „ì²´ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì´ë™
                card.onclick = () => {
                    localStorage.setItem('target_election_id', el.id);
                    window.location.href = `admin.html?id=${el.id}`;
                };

                // ìƒíƒœì— ë”°ë¥¸ ì œì–´ ë²„íŠ¼ ê²°ì •
                let controlButtons = '';
                if (el.status === 'OPEN' || el.status === 'NOMINATION') {
                    // ì§„í–‰ ì¤‘ì¼ ë•Œ -> [ì¼ì‹œì •ì§€] [ì¢…ë£Œ]
                    controlButtons = `
                        <button class="btn-control btn-pause" onclick="handleStatusChange(event, '${el.id}', 'PAUSED')">â¸ ì¼ì‹œì •ì§€</button>
                        <button class="btn-control btn-stop" onclick="handleStatusChange(event, '${el.id}', 'ENDED')">â¹ ì¢…ë£Œ</button>
                    `;
                } else if (el.status === 'PAUSED') {
                    // ì¼ì‹œì •ì§€ì¼ ë•Œ -> [ì¬ê°œ]
                    controlButtons = `
                        <button class="btn-control btn-resume" onclick="handleStatusChange(event, '${el.id}', 'OPEN')">â–¶ï¸ íˆ¬í‘œ ì¬ê°œ</button>
                        <button class="btn-control btn-stop" onclick="handleStatusChange(event, '${el.id}', 'ENDED')">â¹ ì¢…ë£Œ</button>
                    `;
                } else if (el.status === 'PREPARE') {
                    // ì¤€ë¹„ ì¤‘ì¼ ë•Œ -> ì‚­ì œ ë“± (ì—¬ê¸°ì„œëŠ” ìƒëµ)
                    controlButtons = `<span style="font-size:0.8rem; color:#999;">ì¤€ë¹„ ì¤‘</span>`;
                }

                card.innerHTML = `
                    <div style="flex:1;">
                        <span style="background:${el.status === 'OPEN' ? 'var(--color-primary)' : '#6b7280'}; color:white; padding:2px 8px; border-radius:12px; font-size:0.75rem; font-weight:bold;">
                            ${el.status}
                        </span>
                        <h4 style="margin:8px 0 0 0; font-size:1.1rem; color:#1f2937;">${el.title}</h4>
                    </div>
                    
                    <div class="card-actions">
                        ${controlButtons}
                    </div>
                `;
                activeContainer.appendChild(card);

            } else {
                // [ì§€ë‚œ ì„ ê±°] íƒ€ì„ë¼ì¸
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.onclick = () => window.openHistoryModal(el);
                item.innerHTML = `
                    <div class="timeline-date">${new Date(el.end_at).toLocaleDateString()} ì¢…ë£Œ</div>
                    <div class="timeline-content">
                        <h4>${el.title}</h4>
                        <p style="font-size:0.85rem; color:#666;">ìµœì¢… ìƒíƒœ: ${el.status}</p>
                    </div>
                `;
                timelineContainer.appendChild(item);
            }
        });
    }

    // [ìƒíƒœ ë³€ê²½ í•¸ë“¤ëŸ¬]
    window.handleStatusChange = async (event, electionId, newStatus) => {
        // ë¶€ëª¨(ì¹´ë“œ) í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
        event.stopPropagation();

        let warning = '';
        if(newStatus === 'ENDED') warning = 'ì •ë§ ì„ ê±°ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì¢…ë£Œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        else if(newStatus === 'PAUSED') warning = 'ì„ ê±°ë¥¼ ì¼ì‹œì •ì§€ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níˆ¬í‘œê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤.';
        else if(newStatus === 'OPEN') warning = 'íˆ¬í‘œë¥¼ ì¬ê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

        window.showConfirm(warning, async () => {
            const { error } = await supabase
                .from('elections')
                .update({ status: newStatus })
                .eq('id', electionId);

            if(error) window.showAlert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            else {
                window.showAlert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDashboard(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            }
        });
    };

        // [ê¸°ëŠ¥] ìƒˆ ì„ ê±° ë§Œë“¤ê¸° í¼ í† ê¸€
        window.showCreateForm = () => {
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('setup-section').style.display = 'block';
        };

        // [ëª¨ë‹¬] ì§€ë‚œ ì„ ê±° ìƒì„¸ ì—´ê¸°
        window.openHistoryModal = async (el) => {
            const modal = document.getElementById('history-modal');
            document.getElementById('modal-title').innerText = el.title;
            document.getElementById('modal-period').innerText = `${new Date(el.start_at).toLocaleDateString()} ~ ${new Date(el.end_at).toLocaleDateString()}`;
            
            // íˆ¬í‘œìœ¨ ë¡œë“œ (ì—ëŸ¬ ì˜ˆì™¸ì²˜ë¦¬ í¬í•¨)
            try {
                const stats = await adminService.getTurnoutStats(el.id);
                document.getElementById('modal-total').innerText = stats.total;
                document.getElementById('modal-current').innerText = stats.current;
                document.getElementById('modal-rate').innerText = stats.percent;
            } catch(e) { console.error(e); }

            // ê²°ê³¼ í˜ì´ì§€ ì´ë™
            document.getElementById('btn-go-result').onclick = () => {
                window.open(`monitor.html?id=${el.id}`, '_blank');
            };

            modal.style.display = 'flex';
        };

        window.closeHistoryModal = () => {
            document.getElementById('history-modal').style.display = 'none';
        };

        // [ë¡œê·¸ì•„ì›ƒ]
        window.handleLogout = async () => {
            await supabase.auth.signOut();
            window.location.reload();
        };

        // [ë¡œê·¸ì¸]
        window.handleLogin = async () => {
            const email = document.getElementById('admin-email').value;
            if (!email) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');

            const { error } = await supabase.auth.signInWithOtp({ 
                email,
                options: { emailRedirectTo: window.location.href }
            });

            if (error) alert('ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
            else alert('ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.\në©”ì¼í•¨ì„ í™•ì¸í•˜ê³  ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.');
        };

        // [Step 1] ì„ ê±° ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.createElection = async () => {
            const title = document.getElementById('election-title').value;
            const start = document.getElementById('start-at').value;
            const end = document.getElementById('end-at').value;

            if(!title || !start || !end) return alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

            const { data, error } = await supabase.from('elections').insert({
                title, start_at: start, end_at: end, status: 'PREPARE'
            }).select().single();

            if(error) return alert('ìƒì„± ì‹¤íŒ¨: ' + error.message);

            newElectionId = data.id;
            alert('ì„ ê±°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ì„ ê±°êµ¬ë¥¼ ë“±ë¡í•˜ì„¸ìš”.');
            document.getElementById('step-2').style.display = 'block';
        };

        // [Step 2] ì„ ê±°êµ¬ ì¶”ê°€ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.addDistrict = async () => {
            if(!newElectionId) return;
            const name = document.getElementById('dist-name').value.trim();
            const code = document.getElementById('dist-code').value.trim();
            const type = document.getElementById('dist-type').value;

            if (!name || !code) {
                return alert('ì„ ê±°êµ¬ ì´ë¦„ê³¼ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: ì´ë¦„(ì„œìš¸ì§€êµ¬), ì½”ë“œ(SEOUL)');
            }
            if (createdDistricts[code]) {
                return alert('ì´ë¯¸ ë“±ë¡ëœ ì„ ê±°êµ¬ ì½”ë“œì…ë‹ˆë‹¤.');
            }

            const { data, error } = await supabase.from('districts').insert({
                election_id: newElectionId, name, code, vote_type: type
            }).select().single();

            if(error) return alert('ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);

            createdDistricts[code] = data.id;
            
            const li = document.createElement('li');
            li.innerText = `${name} (${code}) - ${type}`;
            document.getElementById('district-list').appendChild(li);
            
            document.getElementById('dist-name').value = '';
            document.getElementById('dist-code').value = '';

            const count = Object.keys(createdDistricts).length;
            const warningEl = document.getElementById('district-warning');
            
            if (count < 3) {
                warningEl.style.color = 'red';
                warningEl.innerText = `âš ï¸ ì„ ê±°êµ¬ëŠ” ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${count}ê°œ)`;
                document.getElementById('step-3').style.display = 'none';
            } else {
                warningEl.style.color = 'green';
                warningEl.innerText = `âœ… ìµœì†Œ ì¡°ê±´ ë§Œì¡± (í˜„ì¬ ${count}ê°œ ë“±ë¡ë¨)`;
                document.getElementById('step-3').style.display = 'block';
            }
        };

        // [Step 3] ì—‘ì…€ ì—…ë¡œë“œ ë° ë¯¸ë¦¬ë³´ê¸° (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.uploadVoters = async () => {
            if (Object.keys(createdDistricts).length < 3) {
                return alert('ì„ ê±°êµ¬ê°€ ìµœì†Œ 3ê°œ ì´ìƒ ë“±ë¡ë˜ì–´ì•¼ ëª…ë¶€ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            const fileInput = document.getElementById('excel-file');
            if(fileInput.files.length === 0) return alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                // í™•ì¸ìš©ìœ¼ë¡œ name, phone ì¶”ê°€ ì¡°íšŒ
                const { data: members, error: memError } = await supabase
                    .from('coop_members')
                    .select('id, member_id, name, phone');
                
                if(memError) return alert('ì¡°í•©ì› DB ë¡œë“œ ì‹¤íŒ¨');

                const memberMap = new Map();
                members.forEach(m => memberMap.set(m.member_id, m));

                const tempPayload = [];
                let failCount = 0;

                for(const row of rows) {
                    const memIdStr = String(row.member_id || '').trim();
                    const distCodeStr = String(row.district_code || '').trim();

                    const memberInfo = memberMap.get(memIdStr);
                    const distId = createdDistricts[distCodeStr];

                    if(memberInfo && distId) {
                        tempPayload.push({
                            election_id: newElectionId,
                            district_id: distId,
                            member_uuid: memberInfo.id,
                            member_no: memIdStr,
                            _view_name: memberInfo.name,
                            _view_phone: memberInfo.phone,
                            _view_dist_code: distCodeStr
                        });
                    } else {
                        console.warn(`ë§¤ì¹­ ì‹¤íŒ¨: ID(${memIdStr}) / Code(${distCodeStr})`);
                        failCount++;
                    }
                }

                if(tempPayload.length > 0) {
                    renderPreview(tempPayload);
                } else {
                    alert('ë“±ë¡í•  ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // [ê¸°ëŠ¥] ì—‘ì…€ ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.downloadSample = () => {
            const ws_data = [
                ["member_id", "district_code", "ë¹„ê³ (ì…ë ¥X)"],
                ["2025-24-0001", "SEOUL", "ì˜ˆì‹œ ë°ì´í„°ì…ë‹ˆë‹¤."],
                ["2025-24-0002", "BUSAN", "district_codeëŠ” ìœ„ì—ì„œ ë“±ë¡í•œ ì½”ë“œì™€ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤."]
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "ì„ ê±°ì¸ëª…ë¶€_ìƒ˜í”Œ");
            
            XLSX.writeFile(wb, "ì„ ê±°ì¸ëª…ë¶€_ì—…ë¡œë“œì–‘ì‹.xlsx");
        };

        // [ë¯¸ë¦¬ë³´ê¸° ê´€ë ¨ í•¨ìˆ˜ë“¤] (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        let pendingVoters = [];

        window.renderPreview = (dataList) => {
            pendingVoters = [...dataList];
            updatePreviewTable_Safe();
            document.getElementById('preview-modal').style.display = 'flex';
        };

        window.closePreview = () => {
            if(confirm('ì—…ë¡œë“œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('preview-modal').style.display = 'none';
                pendingVoters = [];
            }
        };

        // ì•ˆì „í•œ í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        function updatePreviewTable_Safe() {
            const container = document.getElementById('preview-list');
            container.innerHTML = '';
            
            if (pendingVoters.length === 0) {
                container.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const grouped = {};
            pendingVoters.forEach((item, index) => {
                const code = item._view_dist_code;
                if (!grouped[code]) grouped[code] = [];
                grouped[code].push({ ...item, realIndex: index }); 
            });

            for (const [code, items] of Object.entries(grouped)) {
                const distDiv = document.createElement('div');
                distDiv.innerHTML = `<div class="preview-district-title">ğŸ“ ì„ ê±°êµ¬: ${code} (${items.length}ëª…)</div>`;

                const table = document.createElement('table');
                table.className = 'preview-table';
                table.innerHTML = `
                    <thead><tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th><th>ê´€ë¦¬</th></tr></thead>
                    <tbody>
                        ${items.map(p => `
                            <tr>
                                <td>${p.member_no}</td>
                                <td>${p._view_name}</td>
                                <td>${p._view_phone}</td>
                                <td>
                                    <button onclick="removeRow(${p.realIndex})" class="btn-delete">ì‚­ì œ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                distDiv.appendChild(table);
                container.appendChild(distDiv);
            }
        }

        // ê°œë³„ í–‰ ì‚­ì œ
        window.removeRow = (idxToDel) => {
            pendingVoters.splice(idxToDel, 1);
            updatePreviewTable_Safe(); 
        };

        // [ìµœì¢… DB ì €ì¥] (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.confirmUpload = async () => {
            if (pendingVoters.length === 0) return alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            if(!confirm(`ì´ ${pendingVoters.length}ëª…ì˜ ëª…ë¶€ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const finalPayload = pendingVoters.map(item => ({
                election_id: item.election_id,
                district_id: item.district_id,
                member_uuid: item.member_uuid,
                member_no: item.member_no
            }));

            const { error: insError } = await supabase
                .from('election_voters')
                .upsert(finalPayload, { onConflict: 'election_id, member_uuid' });
            
            if(insError) return alert('DB ì €ì¥ ì‹¤íŒ¨: ' + insError.message);
            
            alert('âœ… ëª…ë¶€ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            window.location.href = 'admin.html';
        };

        // ì‹¤í–‰
        init();
    </script>
</body>
</html>
