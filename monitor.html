<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ê°œí‘œ ìƒí™©ì‹¤</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-card { background: white; padding: 2rem; margin-bottom: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .progress-bg { background: #e5e7eb; height: 30px; border-radius: 15px; overflow: hidden; margin-top: 1rem; }
        .progress-bar { background: var(--primary-color); height: 100%; width: 0%; transition: width 1s ease-in-out; display: flex; align-items: center; justify-content: flex-end; color: white; padding-right: 10px; font-weight: bold; }
        
        /* ê²°ê³¼ ë§‰ëŒ€ ê·¸ë˜í”„ */
        .result-row { margin-bottom: 1rem; }
        .result-bar-bg { background: #f3f4f6; height: 40px; border-radius: 4px; position: relative; margin-top: 5px; }
        .result-bar-fill { background: #3b82f6; height: 100%; border-radius: 4px; opacity: 0.8; width: 0%; transition: width 1s; }
        .result-text { position: absolute; top: 0; left: 10px; height: 100%; display: flex; align-items: center; font-weight: bold; color: #111; z-index: 10; }
        .result-count { position: absolute; top: 0; right: 10px; height: 100%; display: flex; align-items: center; font-weight: bold; }
        .winner .result-bar-fill { background: #ef4444; } /* ë‹¹ì„ ì ê°•ì¡° */
    </style>
        <script src="ElectionService.js"></script>
    <script src="AdminService.js"></script>
</head>
<body style="display:block; padding: 2rem;">

    <div style="max-width: 900px; margin: 0 auto;">
        <header style="text-align: center; margin-bottom: 3rem;">
            <h1>ğŸ“Š ì‹¤ì‹œê°„ íˆ¬í‘œ í˜„í™©íŒ</h1>
            <h2 id="election-title" style="color:#666;">ë°ì´í„° ë¡œë”©ì¤‘...</h2>
            <div id="status-indicator" style="margin-top:1rem; font-weight:bold;"></div>
        </header>

        <div class="dashboard-card">
            <h3>ğŸ—³ï¸ í˜„ì¬ íˆ¬í‘œìœ¨</h3>
            <div class="progress-bg">
                <div id="turnout-bar" class="progress-bar">0%</div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:0.5rem; color:#666;">
                <span>ì°¸ì—¬: <strong id="voted-count">0</strong>ëª…</span>
                <span>ì´ì›: <strong id="total-count">0</strong>ëª…</span>
            </div>
        </div>

        <div id="result-section" class="dashboard-card" style="display:none;">
            <h3>ğŸ† ê°œí‘œ ê²°ê³¼</h3>
            <div id="result-container">
                </div>
        </div>
    </div>

    <script type="module">
        import { AdminService } from 'AdminService.js';
        const service = new AdminService();
        let electionId = null;

        async function init() {
            // 1. ì„ ê±° ì •ë³´ ë¡œë“œ
            const election = await service.getElectionInfo();
            if (!election) {
                document.getElementById('election-title').innerText = "ì§„í–‰ ì¤‘ì¸ ì„ ê±° ì—†ìŒ";
                return;
            }

            electionId = election.id;
            document.getElementById('election-title').innerText = election.title;
            
            // ìƒíƒœ í‘œì‹œ
            const statusEl = document.getElementById('status-indicator');
            statusEl.innerText = `í˜„ì¬ ìƒíƒœ: ${election.status}`;
            
            // 2. íˆ¬í‘œìœ¨ ì—…ë°ì´íŠ¸ (ì¦‰ì‹œ ì‹¤í–‰)
            updateTurnout();
            
            // 3. ê²°ê³¼ ê³µê°œ ìƒíƒœë¼ë©´ ê²°ê³¼ ë¡œë“œ
            if (election.status === 'PUBLISHED') {
                document.getElementById('result-section').style.display = 'block';
                loadResults();
            } else if (election.status === 'OPEN') {
                // íˆ¬í‘œ ì¤‘ì´ë©´ 5ì´ˆë§ˆë‹¤ íˆ¬í‘œìœ¨ ê°±ì‹  (í´ë§)
                setInterval(updateTurnout, 5000);
            }
        }

        // íˆ¬í‘œìœ¨ ê°±ì‹ 
        async function updateTurnout() {
            if (!electionId) return;
            const stats = await service.getTurnoutStats(electionId);
            
            document.getElementById('voted-count').innerText = stats.current;
            document.getElementById('total-count').innerText = stats.total;
            
            const bar = document.getElementById('turnout-bar');
            bar.style.width = `${stats.percent}%`;
            bar.innerText = `${stats.percent}%`;
        }

        // ê²°ê³¼ ë¡œë“œ ë° ë Œë”ë§ (í•˜ë“œì½”ë”©ëœ ë¡œì§ - ì‹¤ì œë¡  DB ì§‘ê³„ ê¶Œì¥)
        async function loadResults() {
            const ballots = await service.getResults(electionId);
            const container = document.getElementById('result-container');
            
            // ë°ì´í„° ê°€ê³µ: ì„ ê±°êµ¬ë³„ -> í›„ë³´ë³„ ì§‘ê³„
            const grouped = {}; // { 'Aì„ ê±°êµ¬': [ {name:'í™ê¸¸ë™', count:10}, ... ] }

            ballots.forEach(b => {
                const districtName = b.districts.name;
                if (!grouped[districtName]) grouped[districtName] = {};
                
                // í›„ë³´ ì´ë¦„ ë˜ëŠ” ì°¬/ë°˜ ê²°ì •
                let key = '';
                let label = '';
                
                if (b.districts.vote_type === 'CANDIDATE') {
                    key = b.candidate_id;
                    label = b.candidates ? b.candidates.name : 'ë¬´íš¨';
                } else {
                    key = b.choice;
                    label = b.choice === 'AGREE' ? 'ì°¬ì„±' : (b.choice === 'DISAGREE' ? 'ë°˜ëŒ€' : 'ê¸°ê¶Œ');
                }

                if (!grouped[districtName][key]) grouped[districtName][key] = { label, count: 0 };
                grouped[districtName][key].count++;
            });

            // ë Œë”ë§
            container.innerHTML = '';
            for (const [district, candidates] of Object.entries(grouped)) {
                const distDiv = document.createElement('div');
                distDiv.innerHTML = `<h4 style="margin-top:2rem; border-bottom:2px solid #333; padding-bottom:0.5rem;">${district}</h4>`;
                
                // ì •ë ¬ (ë“í‘œìˆœ)
                const sorted = Object.values(candidates).sort((a, b) => b.count - a.count);
                const maxVote = sorted[0].count; // 1ë“± ë“í‘œìˆ˜ (ê·¸ë˜í”„ 100% ê¸°ì¤€)

                sorted.forEach((c, index) => {
                    // ë‹¨ìˆœ ë‹¹ì„  ë¡œì§: 1ë“±ì—ê²Œ winner í´ë˜ìŠ¤ (ë™ì ì ì²˜ë¦¬ëŠ” MVP ìƒëµ)
                    const isWinner = index === 0; 
                    const percent = ballots.length > 0 ? ((c.count / ballots.length) * 100 * 5) : 0; // ë¹„ìœ¨(ì‹œê°ìš©)
                    // *ì£¼: ìœ„ percent ê³„ì‚°ì€ ì „ì²´ í‘œ ê¸°ì¤€ì´ë¼ ì‹œê°ì ìœ¼ë¡œ ì‘ê²Œ ë³´ì¼ ìˆ˜ ìˆìŒ. maxVote ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½ ê¶Œì¥.
                    const widthPercent = (c.count / maxVote) * 100;

                    distDiv.innerHTML += `
                        <div class="result-row ${isWinner ? 'winner' : ''}">
                            <div class="result-bar-bg">
                                <div class="result-bar-fill" style="width: ${widthPercent}%"></div>
                                <span class="result-text">${c.label} ${isWinner ? 'ğŸ¥‡' : ''}</span>
                                <span class="result-count">${c.count}í‘œ</span>
                            </div>
                        </div>
                    `;
                });
                container.appendChild(distDiv);
            }
        }

        init();
    </script>
</body>
</html>
