<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í†µí•© ì„ ê±° ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        /* [í†¤ì•¤ë§¤ë„ˆ] ìƒ‰ìƒ ë³€ìˆ˜ */
        :root {
            --admin-bg: #f8f9fa;
            --card-bg: #ffffff;
            --primary-blue: #2563eb;
            --primary-light: #eff6ff;
            --success-green: #16a34a;
            --warning-yellow: #ca8a04;
            --danger-red: #dc2626;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --border-color: #e5e7eb;
        }

        body { 
            background-color: var(--admin-bg); 
            color: var(--text-dark); 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-center h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-blue);
            font-weight: 800;
        }

        /* ë ˆì´ì•„ì›ƒ */
        .admin-container { 
            max-width: 1400px; /* ë„“ê²Œ í™•ì¥ */
            margin: 0 auto; 
            padding: 2rem; 
            display: grid; 
            grid-template-columns: 3fr 1fr; /* ë©”ì¸ 3 : ì‚¬ì´ë“œ 1 */
            gap: 2rem; 
        }
        @media (max-width: 900px) { .admin-container { grid-template-columns: 1fr; } }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            border: 1px solid var(--border-color); 
        }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .wizard-steps { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; }
        .step-item { 
            flex: 1; text-align: center; padding: 1rem; cursor: pointer; 
            color: var(--text-gray); font-weight: 600; 
            border-bottom: 3px solid transparent; 
            transition: all 0.2s;
        }
        .step-item.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); background: var(--primary-light); }
        .step-item:hover { background-color: #f9fafb; }

        /* ìƒíƒœ ë±ƒì§€ */
        .status-badge { padding: 6px 14px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.85rem; letter-spacing: 0.5px; }
        
        /* ë¡œê·¸ ì°½ */
        .log-window { height: 300px; overflow-y: auto; background: #1e293b; color: #10b981; padding: 1rem; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.85rem; }
        .log-entry { margin-bottom: 0.5rem; border-bottom: 1px solid #334155; padding-bottom: 0.2rem; }
        .log-time { color: #94a3b8; margin-right: 0.5rem; }

        /* ìœ ê¶Œì ë¦¬ìŠ¤íŠ¸ (ì‚¬ì´ë“œë°”) */
        .voter-group-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;
        }
        .voter-group-item:hover { background-color: #f3f4f6; }
        .voter-count-badge { background: #e5e7eb; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }

        /* í…Œì´ë¸” */
        .cand-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .cand-table th { background: #f3f4f6; color: var(--text-dark); font-weight: 600; text-align: left; padding: 1rem; border-bottom: 2px solid var(--border-color); }
        .cand-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .input-symbol { width: 60px; text-align: center; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-weight: bold; font-size: 1rem; }
        
        /* ë²„íŠ¼ ê³µí†µ */
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; font-size: 0.95rem; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-success { background: var(--success-green); color: white; }
        .btn-warning { background: var(--warning-yellow); color: white; }
        .btn-danger { background: var(--danger-red); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-dark); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 4px; }

        /* í†µê³„ ëŒ€ì‹œë³´ë“œ ë°•ìŠ¤ */
        .stats-box {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;
            background: var(--primary-light); padding: 1.5rem; border-radius: 8px; border: 1px solid #bfdbfe;
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary-blue); }
        .stat-label { font-size: 0.9rem; color: var(--text-gray); }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center; max-height: 80vh; overflow-y: auto;
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; display: block;}
        .modal-body { margin-bottom: 2rem; color: #4b5563; line-height: 1.5; text-align: left;}
        .modal-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;}
        
        /* ìœ ê¶Œì ë¯¸ë¦¬ë³´ê¸° ë° ëª…ë‹¨ í…Œì´ë¸” */
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: left; padding: 10px;}
        .voter-card-mock { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem; }
        .mock-symbol { width: 40px; height: 40px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; flex-shrink: 0;}
        
        .voter-list-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .voter-list-table th, .voter-list-table td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <span style="font-weight:bold; color:#4b5563;">ADMIN CONSOLE</span>
    </div>
    <div class="header-center">
        <h2 id="header-election-title">ì„ ê±° ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
    </div>
    <div class="header-right">
        <span id="admin-email" style="font-weight:600; color:#374151; margin-right:15px; font-size:0.9rem;"></span>
        <button class="btn btn-outline btn-sm" onclick="openElectionGateway()">
            ğŸ”„ ë‹¤ë¥¸ ì„ ê±° ì„ íƒ
        </button>
    </div>
</header>

<div class="admin-container">
    
    <div class="main-panel">
        
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.5rem;">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:0.85rem; color:var(--text-gray); margin-bottom:4px;">í˜„ì¬ ê´€ë¦¬ ì¤‘ì¸ ì„ ê±°</span>
                    <h3 id="election-title" style="margin:0; font-size:1.8rem;">ë¡œë”© ì¤‘...</h3>
                </div>
                <span id="election-status" class="status-badge" style="background:#999;">-</span>
            </div>
            <div style="color:var(--text-gray); font-size: 0.95rem;">
                ğŸ“… ì „ì²´ ì¼ì •: <strong id="election-period">-</strong>
            </div>
        </div>

        <div class="card">
            <div class="wizard-steps">
                <div class="step-item" onclick="switchTab('tab-nomination')">1. í›„ë³´ ë“±ë¡/ê¸°í˜¸</div>
                <div class="step-item" onclick="switchTab('tab-ready')">2. í™•ì • ë° ê³µí¬</div>
                <div class="step-item" onclick="switchTab('tab-vote')">3. íˆ¬í‘œ ì§„í–‰</div>
                <div class="step-item" onclick="switchTab('tab-result')">4. ê°œí‘œ ë° ê²°ê³¼</div>
            </div>

            <div id="tab-nomination" class="tab-content">
                <h4>ğŸ“ í›„ë³´ì ë“±ë¡ í˜„í™©</h4>
                <div class="stats-box">
                    <div class="stat-item"><div class="stat-value" id="stat-total">0</div><div class="stat-label">ì „ì²´</div></div>
                    <div class="stat-item"><div class="stat-value" style="color:var(--warning-yellow)" id="stat-pending">0</div><div class="stat-label">ëŒ€ê¸°</div></div>
                    <div class="stat-item"><div class="stat-value" style="color:var(--success-green)" id="stat-approved">0</div><div class="stat-label">ìŠ¹ì¸</div></div>
                    <div class="stat-item"><div class="stat-value" style="color:var(--danger-red)" id="stat-rejected">0</div><div class="stat-label">ë°˜ë ¤</div></div>
                </div>

                <div style="margin-bottom:1rem;">
                    <button onclick="confirmAction('NOMINATION', 'í›„ë³´ ë“±ë¡ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="btn btn-primary">â–¶ í›„ë³´ ë“±ë¡ ì‹œì‘</button>
                </div>
                
                <table class="cand-table">
                    <thead><tr><th>ì„ ê±°êµ¬</th><th>ì´ë¦„</th><th>ìƒíƒœ</th><th>ê¸°í˜¸</th></tr></thead>
                    <tbody id="candidate-list-body"></tbody>
                </table>
                <button onclick="saveSymbols()" class="btn btn-success" style="width:100%; margin-top:1.5rem;">ğŸ’¾ ê¸°í˜¸ ì €ì¥</button>
            </div>

            <div id="tab-ready" class="tab-content" style="display:none;">
                <h4>ğŸ“¢ í›„ë³´ì í™•ì • ë° ê³µí¬</h4>
                <div style="background: #fff3cd; border: 1px solid #ffeeba; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <button onclick="openVoterPreview()" class="btn btn-outline" style="margin-bottom: 1rem;">ğŸ‘ï¸ ìœ ê¶Œì í™”ë©´ ë¯¸ë¦¬ë³´ê¸°</button>
                    <br>
                    <button onclick="confirmAction('READY', 'ì„ ê±° ì¤€ë¹„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="btn btn-warning">ğŸš€ ì„ ê±° ì¤€ë¹„ ì™„ë£Œ (READY)</button>
                </div>
            </div>

            <div id="tab-vote" class="tab-content" style="display:none;">
                <h4>ğŸ—³ï¸ íˆ¬í‘œì†Œ ìš´ì˜</h4>
                <div style="display:flex; gap:1rem; margin-bottom:2rem;">
                    <button onclick="confirmAction('OPEN', 'íˆ¬í‘œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.')" class="btn btn-success" style="flex:1;">â–¶ íˆ¬í‘œ ì‹œì‘</button>
                    <button onclick="confirmAction('PAUSED', 'íˆ¬í‘œë¥¼ ì¼ì‹œ ì •ì§€í•©ë‹ˆë‹¤.')" class="btn btn-warning" style="flex:1;">â¸ ì¼ì‹œ ì •ì§€</button>
                    <button onclick="confirmAction('CLOSED', 'íˆ¬í‘œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.')" class="btn btn-danger" style="flex:1;">â¹ íˆ¬í‘œ ì¢…ë£Œ</button>
                </div>
                
                <div style="background:#f9fafb; padding:2rem; border-radius:12px; border:1px solid #eee; text-align: center;">
                    <h5 style="margin:0; color:#6b7280;">ì‹¤ì‹œê°„ íˆ¬í‘œìœ¨ (5ì´ˆ ì£¼ê¸°)</h5>
                    <h2 id="live-turnout" style="margin: 10px 0; font-size:3.5rem; color:var(--primary-blue); font-weight: 800;">0%</h2>
                    <div style="font-size: 1.1rem; color: #374151;">
                        ì°¸ì—¬ <strong id="live-votes">0</strong>ëª… / ì´ì› <span id="live-total">0</span>ëª…
                    </div>
                </div>
            </div>

            <div id="tab-result" class="tab-content" style="display:none;">
                <h4>ğŸ† ê°œí‘œ ë° ê²°ê³¼</h4>
                <div id="result-control">
                    <button onclick="openBallotBox()" class="btn" style="padding:1rem; background:#374151; color:white; width: 100%;">ğŸ” ê°œí‘œí•¨ ì—´ê¸°</button>
                </div>
                <div id="result-display" style="display:none; margin-top:2rem;">
                    <div id="result-chart" style="padding: 1rem; background: #f3f4f6; border-radius: 8px;"></div>
                    <hr style="margin:2rem 0; border:0; border-top:1px solid #ddd;">
                    <button onclick="confirmAction('PUBLISHED', 'ìµœì¢… ê²°ê³¼ë¥¼ ê³µí¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="btn btn-primary" style="width:100%;">ğŸ“¢ ê²°ê³¼ ìµœì¢… ê³µí¬</button>
                </div>
            </div>
        </div>
    </div>

    <div class="side-panel">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">ğŸ‘¥ ìœ ê¶Œì í˜„í™©</h3>
                <button onclick="loadVoterStats()" class="btn btn-sm btn-outline" style="font-size:0.7rem;">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="voter-stats-list" style="max-height:300px; overflow-y:auto;">
                <p style="color:#999; font-size:0.8rem;">ë¡œë”© ì¤‘...</p>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">ğŸ“œ ìš´ì˜ ë¡œê·¸</h3>
                <button onclick="loadLogs()" class="btn btn-sm btn-outline" style="font-size:0.7rem;">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="audit-log-container" class="log-window">
                <div class="log-entry">ë¡œê·¸ ë¡œë”© ì¤‘...</div>
            </div>
            <p style="font-size:0.7rem; color:#999; margin-top:5px;">* ë¡œê·¸ê°€ ì•ˆ ë³´ì´ë©´ DBì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
    </div>
</div>

<div id="common-modal" class="modal-overlay">
    <div class="modal-content">
        <span id="modal-title" class="modal-title">ì•Œë¦¼</span>
        <div id="modal-body" class="modal-body"></div>
        <div id="modal-actions" class="modal-actions">
            <button onclick="closeModal()" class="btn btn-outline">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script type="module">
    import { AdminService } from './AdminService.js';
    import { supabase } from './ElectionService.js';
    
    const service = new AdminService();
    let currentElectionId = null;
    let currentElectionData = null; // ì„ ê±° ì •ë³´ ìºì‹±
    let cachedDistricts = {}; // ì„ ê±°êµ¬ ì •ë³´ ìºì‹±

    // -----------------------------------------------------------
    // [1] ëª¨ë‹¬ & ìœ í‹¸ë¦¬í‹°
    // -----------------------------------------------------------
    window.showModal = (title, contentHtml, onConfirm = null, showCancel = true) => {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = contentHtml;
        const actionDiv = document.getElementById('modal-actions');
        actionDiv.innerHTML = ''; 

        if (showCancel) {
            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn btn-outline';
            closeBtn.innerText = onConfirm ? 'ì·¨ì†Œ' : 'ë‹«ê¸°';
            closeBtn.onclick = window.closeModal;
            actionDiv.appendChild(closeBtn);
        }

        if (onConfirm) {
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'btn btn-primary';
            confirmBtn.innerText = 'í™•ì¸';
            confirmBtn.onclick = () => { onConfirm(); if(showCancel) window.closeModal(); };
            actionDiv.appendChild(confirmBtn);
        }
        document.getElementById('common-modal').style.display = 'flex';
    };

    window.closeModal = () => { document.getElementById('common-modal').style.display = 'none'; };

    // -----------------------------------------------------------
    // [2] ì´ˆê¸°í™” (Init)
    // -----------------------------------------------------------
    async function init() {
        // 1. ê´€ë¦¬ì ì²´í¬ (ê°•ì œ ì§„ì… ëª¨ë“œ í•´ì œ: ì´ì œ ì •ìƒ ì‘ë™ ê°€ì •)
        try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) throw new Error('No User');
            if (user.email) document.getElementById('admin-email').innerText = user.email;
            
            const isAdmin = await service.isAdmin();
            if (!isAdmin) {
                alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                // window.location.href = 'index.html'; // í•„ìš”ì‹œ ì£¼ì„ í•´ì œ
                return;
            }
        } catch (e) {
            console.error(e);
            return;
        }

        // 2. ID í™•ì¸ ë° ë¡œë“œ
        const urlParams = new URLSearchParams(window.location.search);
        let targetId = urlParams.get('id');

        if (targetId) {
            currentElectionId = targetId;
            await startDashboard();
        } else {
            await openElectionGateway();
        }
    }

    // -----------------------------------------------------------
    // [3] ëŒ€ì‹œë³´ë“œ ë¡œë“œ ë° UI ì œì–´ (í•µì‹¬)
    // -----------------------------------------------------------
    async function startDashboard() {
        localStorage.setItem('target_election_id', currentElectionId);
        try {
            // ìˆœì„œ ì¤‘ìš”: ì„ ê±°êµ¬ ì •ë³´ ë¨¼ì € ë¡œë“œ (ë§¤í•‘ìš©) -> ì„ ê±° ì •ë³´ -> ë‚˜ë¨¸ì§€
            await loadDistrictsMap(); 
            await loadElectionInfo();
            await updateWorkflowUI(); // ìƒíƒœì— ë”°ë¥¸ UI ì ê¸ˆ/í•´ì œ
            
            loadCandidates();
            loadVoterStats(); // ìˆ˜ì •ëœ í•¨ìˆ˜
            loadLogs();

            // 5ì´ˆë§ˆë‹¤ ìë™ ìƒíƒœ ì²´í¬ (ì‹œê°„ ë˜ë©´ ìë™ ì‹œì‘/ì¢…ë£Œ ì²˜ë¦¬)
            setInterval(checkAutoSchedule, 5000); 

        } catch (e) { console.error(e); }
    }

    // [ìˆ˜ì •] ë‚ ì§œ í‘œì‹œ ë¡œì§ ê°•í™”
    async function loadElectionInfo() {
        const data = await service.getElectionInfo(currentElectionId);
        currentElectionData = data; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ìƒíƒœ ì²´í¬ìš©)

        document.getElementById('header-election-title').innerText = data.title;
        document.getElementById('election-title').innerText = data.title;
        
        // ë‚ ì§œ ìš°ì„ ìˆœìœ„ ì²˜ë¦¬ (ì„¸ë¶„í™”ëœ ì¹¼ëŸ¼ ìš°ì„ )
        const startRaw = data.candidacy_start_at || data.start_at;
        const endRaw = data.vote_end_at || data.end_at;

        const startStr = startRaw ? new Date(startRaw).toLocaleDateString() : 'ë¯¸ì •';
        const endStr = endRaw ? new Date(endRaw).toLocaleDateString() : 'ë¯¸ì •';
        const voteStartStr = data.vote_start_at ? new Date(data.vote_start_at).toLocaleString() : '-';

        document.getElementById('election-period').innerHTML = 
            `ğŸ“… ì „ì²´ ì¼ì •: ${startStr} ~ ${endStr} <br><span style="font-size:0.8rem; color:#666;">(ì‹¤íˆ¬í‘œ ì‹œì‘: ${voteStartStr})</span>`;
        
        const statusEl = document.getElementById('election-status');
        statusEl.innerText = translateStatus(data.status);
        setStatusColor(statusEl, data.status);
    }

    // [ì‹ ê·œ] ìƒíƒœë³„ ì›Œí¬í”Œë¡œìš° ì œì–´ (íƒ­ ì ê¸ˆ & ë²„íŠ¼ ì œì–´)
    async function updateWorkflowUI() {
        const status = currentElectionData.status;
        const tabs = ['tab-nomination', 'tab-ready', 'tab-vote', 'tab-result'];
        
        // ëª¨ë“  íƒ­ ë‚´ìš© ìˆ¨ê¹€ ë° ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.step-item').forEach(el => {
            el.classList.remove('active');
            el.style.pointerEvents = 'none'; // ê¸°ë³¸ í´ë¦­ ë°©ì§€
            el.style.opacity = '0.5';
        });

        // ìƒíƒœì— ë”°ë¥¸ í™œì„± íƒ­ ê²°ì •
        let activeTabId = '';
        
        if (['PREPARE', 'NOMINATION'].includes(status)) {
            activeTabId = 'tab-nomination';
        } else if (status === 'READY') {
            activeTabId = 'tab-ready';
        } else if (['OPEN', 'PAUSED'].includes(status)) {
            activeTabId = 'tab-vote';
        } else if (['CLOSED', 'PUBLISHED', 'ENDED'].includes(status)) {
            activeTabId = 'tab-result';
        }

        // í™œì„± íƒ­ í‘œì‹œ
        if (activeTabId) {
            document.getElementById(activeTabId).style.display = 'block';
            const stepIndex = tabs.indexOf(activeTabId);
            const stepEl = document.querySelectorAll('.step-item')[stepIndex];
            stepEl.classList.add('active');
            stepEl.style.opacity = '1';
            stepEl.style.pointerEvents = 'auto'; // í˜„ì¬ ë‹¨ê³„ë§Œ í´ë¦­ ê°€ëŠ¥ (í•„ìš”ì‹œ ì´ì „ ë‹¨ê³„ë„ í’€ ìˆ˜ ìˆìŒ)
        }
    }

    // [ì‹ ê·œ] ìë™ ìŠ¤ì¼€ì¤„ëŸ¬ (ì‹œê°„ ì²´í¬ í›„ ìƒíƒœ ë³€ê²½)
    async function checkAutoSchedule() {
        if (!currentElectionData) return;
        const now = new Date();
        const voteStart = new Date(currentElectionData.vote_start_at);
        const voteEnd = new Date(currentElectionData.vote_end_at);
        const status = currentElectionData.status;

        // 1. ìë™ ì‹œì‘: ìƒíƒœê°€ READYì´ê³ , ì‹œì‘ ì‹œê°„ì´ ì§€ë‚¬ì„ ë•Œ
        if (status === 'READY' && now >= voteStart) {
            console.log("â° íˆ¬í‘œ ì‹œì‘ ì‹œê°„ ë„ë‹¬! ìë™ìœ¼ë¡œ OPEN ì²˜ë¦¬í•©ë‹ˆë‹¤.");
            await service.updateStatus(currentElectionId, 'OPEN');
            await service.logAction(currentElectionId, 'AUTO_START', 'íˆ¬í‘œ ì‹œì‘ ì‹œê°„ ë„ë‹¬ë¡œ ìë™ ê°œì‹œ');
            await loadElectionInfo();
            await updateWorkflowUI();
            window.showModal('ì•Œë¦¼', 'íˆ¬í‘œ ì‹œì‘ ì‹œê°„ì´ ë˜ì–´ ìƒíƒœê°€ [íˆ¬í‘œ ì§„í–‰ ì¤‘]ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', null);
        }

        // 2. ìë™ ì¢…ë£Œ: ìƒíƒœê°€ OPENì´ê³ , ì¢…ë£Œ ì‹œê°„ì´ ì§€ë‚¬ì„ ë•Œ
        if (status === 'OPEN' && now >= voteEnd) {
             console.log("â° íˆ¬í‘œ ì¢…ë£Œ ì‹œê°„ ë„ë‹¬! ìë™ìœ¼ë¡œ CLOSED ì²˜ë¦¬í•©ë‹ˆë‹¤.");
            await service.updateStatus(currentElectionId, 'CLOSED');
            await service.logAction(currentElectionId, 'AUTO_END', 'íˆ¬í‘œ ì¢…ë£Œ ì‹œê°„ ë„ë‹¬ë¡œ ìë™ ë§ˆê°');
            await loadElectionInfo();
            await updateWorkflowUI();
            window.showModal('ì•Œë¦¼', 'íˆ¬í‘œ ì¢…ë£Œ ì‹œê°„ì´ ë˜ì–´ íˆ¬í‘œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.', null);
        }

        // ì‹¤ì‹œê°„ íˆ¬í‘œìœ¨ ì—…ë°ì´íŠ¸ (OPEN ìƒíƒœì¼ ë•Œë§Œ)
        if (status === 'OPEN') {
            updateLiveStats();
        }
    }


    // -----------------------------------------------------------
    // [4] ë°ì´í„° ë¡œë”© í•¨ìˆ˜ë“¤ (ìˆ˜ì •ë¨)
    // -----------------------------------------------------------
    
    // [ìˆ˜ì •] ì„ ê±°êµ¬ ì •ë³´ ë³„ë„ ë¡œë“œ (FK ë¬¸ì œ í•´ê²°)
    async function loadDistrictsMap() {
        const { data } = await supabase.from('districts').select('id, name, code').eq('election_id', currentElectionId);
        if (data) {
            data.forEach(d => cachedDistricts[d.id] = d.name);
        }
    }

    // [ìˆ˜ì •] ìœ ê¶Œì í˜„í™© (ì¡°ì¸ ì œê±°í•˜ê³  JS ë§¤í•‘ ì‚¬ìš©)
    window.loadVoterStats = async () => {
        const container = document.getElementById('voter-stats-list');
        container.innerHTML = '<p style="font-size:0.8rem;">ë°ì´í„° ë¡œë”© ì¤‘...</p>';
        
        try {
            // districts ì¡°ì¸ êµ¬ë¬¸ ì œê±° -> ìˆœìˆ˜ election_votersë§Œ ì¡°íšŒ
            const { data: voters, error } = await supabase
                .from('election_voters')
                .select('member_no, member_uuid, _view_name, _view_phone, district_id')
                .eq('election_id', currentElectionId);

            if(error) throw error;

            const grouped = {};
            voters.forEach(v => {
                // ìºì‹±ëœ ì„ ê±°êµ¬ ì´ë¦„ ì‚¬ìš©
                const dName = cachedDistricts[v.district_id] || 'ì„ ê±°êµ¬ ë¯¸ì§€ì •';
                if(!grouped[dName]) grouped[dName] = [];
                grouped[dName].push(v);
            });

            container.innerHTML = '';
            if(Object.keys(grouped).length === 0) {
                container.innerHTML = '<p style="color:#999; padding:10px;">ë“±ë¡ëœ ìœ ê¶Œìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            for(const [dName, list] of Object.entries(grouped)) {
                const div = document.createElement('div');
                div.className = 'voter-group-item';
                div.onclick = () => showVoterDetail(dName, list);
                div.innerHTML = `
                    <span style="font-weight:600;">${dName}</span>
                    <span class="voter-count-badge">${list.length}ëª…</span>
                `;
                container.appendChild(div);
            }
        } catch(e) {
            console.error("ìœ ê¶Œì ë¡œë“œ ì—ëŸ¬:", e);
            container.innerHTML = `<p style="color:red; font-size:0.8rem;">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</p>`;
        }
    };

    window.showVoterDetail = (dName, list) => {
        let html = `
            <div style="background:#f3f4f6; padding:10px; margin-bottom:10px; border-radius:5px;">
                <strong>${dName}</strong> ì†Œì† (ì´ ${list.length}ëª…)
            </div>
            <div style="max-height:300px; overflow-y:auto;">
                <table class="voter-list-table">
                    <thead><tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th></tr></thead>
                    <tbody>
        `;
        list.forEach(v => {
            html += `<tr><td>${v.member_no}</td><td>${v._view_name}</td><td>${v._view_phone || '-'}</td></tr>`;
        });
        html += '</tbody></table></div>';
        window.showModal('ğŸ“‹ ìœ ê¶Œì ëª…ë¶€ ìƒì„¸', html, null);
    };

    // -----------------------------------------------------------
    // [5] ì•¡ì…˜ í•¸ë“¤ëŸ¬
    // -----------------------------------------------------------
    window.confirmAction = (status, msg) => {
        // ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€
        if (status === 'READY') {
            // ê¸°í˜¸ ì €ì¥ ì—¬ë¶€ ì²´í¬ ë¡œì§ ë“± ì¶”ê°€ ê°€ëŠ¥
        }

        window.showModal('ìƒíƒœ ë³€ê²½', msg, async () => {
            await service.updateStatus(currentElectionId, status);
            await loadElectionInfo();
            await updateWorkflowUI(); // UI ê°±ì‹ 
            loadLogs();
        });
    };

    window.openVoterPreview = () => {
        // ì‹¤ì œ ìœ ê¶Œì í™”ë©´ URLë¡œ ì´ë™ (ìƒˆì°½)
        window.open(`vote_login.html?id=${currentElectionId}`, '_blank');
    };

    // (ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
    async function loadCandidates() {
        const list = await service.getCandidates(currentElectionId);
        // ... (ê¸°ì¡´ í†µê³„ ë¡œì§ ìœ ì§€) ...
        const stats = { total: list.length, pending: 0, approved: 0, rejected: 0 };
        list.forEach(c => {
             if (c.status === 'PENDING') stats.pending++;
             else if (c.status === 'APPROVED') stats.approved++;
             else if (c.status === 'REJECTED') stats.rejected++;
        });
        document.getElementById('stat-total').innerText = stats.total;
        document.getElementById('stat-pending').innerText = stats.pending;
        document.getElementById('stat-approved').innerText = stats.approved;
        document.getElementById('stat-rejected').innerText = stats.rejected;

        const tbody = document.getElementById('candidate-list-body');
        tbody.innerHTML = '';
        list.forEach(c => {
            const dName = c.districts ? c.districts.name : 'ë¯¸í™•ì¸'; // ë°©ì–´ì½”ë“œ
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${dName}</td>
                <td>${c.name}</td>
                <td>
                     ${c.status === 'PENDING' ? 
                      `<button onclick="reviewCand('${c.id}', 'APPROVED', '${c.name}')" class="btn btn-sm btn-outline" style="color:blue;">ìŠ¹ì¸</button> 
                       <button onclick="reviewCand('${c.id}', 'REJECTED', '${c.name}')" class="btn btn-sm btn-outline" style="color:red;">ë°˜ë ¤</button>` 
                      : `<span class="status-badge" style="background:${c.status === 'APPROVED' ? 'green' : 'gray'}">${c.status}</span>`}
                </td>
                <td>${c.status === 'APPROVED' ? `<input type="text" class="input-symbol" data-id="${c.id}" value="${c.symbol || ''}" style="width:50px; text-align:center;">` : '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.reviewCand = async (id, decision, name) => {
        if(confirm(`${name}ë‹˜ì„ ${decision} ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
            await service.reviewCandidate(id, decision);
            await service.logAction(currentElectionId, 'CANDIDATE_REVIEW', `${name} ${decision}`);
            loadCandidates(); loadLogs();
        }
    };

    window.saveSymbols = async () => {
        const inputs = document.querySelectorAll('.input-symbol');
        let count = 0;
        for (const input of inputs) {
            if (input.value) {
                await service.updateSymbol(input.dataset.id, input.value);
                count++;
            }
        }
        alert(`${count}ëª…ì˜ ê¸°í˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        await service.logAction(currentElectionId, 'SYMBOL_UPDATE', 'ê¸°í˜¸ ì¼ê´„ ì €ì¥');
        loadCandidates();
    };

    window.loadLogs = async () => {
        const logs = await service.getLogs(currentElectionId);
        const container = document.getElementById('audit-log-container');
        container.innerHTML = '';
        logs.forEach(log => {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="log-time">${new Date(log.created_at).toLocaleTimeString()}</span> <strong>${log.action_type}</strong> ${log.details}`;
            container.appendChild(div);
        });
    };

    async function updateLiveStats() {
        if(!currentElectionId) return;
        try {
            const stats = await service.getTurnoutStats(currentElectionId);
            document.getElementById('live-turnout').innerText = `${stats.percent}%`;
            document.getElementById('live-votes').innerText = stats.current;
            document.getElementById('live-total').innerText = stats.total;
        } catch(e) {}
    }

    window.openBallotBox = () => {
         const pwd = prompt("ğŸ” ë³´ì•ˆ í™•ì¸: 'ê°œí‘œ' ì…ë ¥");
         if(pwd !== 'ê°œí‘œ') return alert('ì·¨ì†Œ');
         document.getElementById('result-display').style.display = 'block';
         // ê²°ê³¼ ë¡œì§ (ì¶”í›„ êµ¬í˜„)
         alert("ê°œí‘œí•¨ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. (ê²°ê³¼ í™”ë©´ êµ¬í˜„ í•„ìš”)");
    };

    // í—¬í¼
    function translateStatus(s) {
        const map = {
            'PREPARE': 'ì¤€ë¹„ ì¤‘', 'NOMINATION': 'í›„ë³´ ë“±ë¡', 'READY': 'ì¤€ë¹„ ì™„ë£Œ',
            'OPEN': 'íˆ¬í‘œ ì¤‘', 'PAUSED': 'ì¼ì‹œ ì •ì§€', 'CLOSED': 'íˆ¬í‘œ ë§ˆê°', 'PUBLISHED': 'ê²°ê³¼ ê³µí¬'
        };
        return map[s] || s;
    }
    function setStatusColor(el, s) {
        if(s === 'OPEN') el.style.background = 'var(--success-green)';
        else if(s === 'CLOSED') el.style.background = 'var(--danger-red)';
        else if(s === 'READY') el.style.background = 'var(--warning-yellow)';
        else el.style.background = '#999';
    }

    // ì„ ê±° Gateway
    window.openElectionGateway = async () => {
        const elections = await service.getAllElections();
        if(!elections || elections.length === 0) return window.location.href='admin_setup.html';
        let html = '<select id="gateway-select" style="width:100%; padding:10px;">';
        elections.forEach(el => {
            html += `<option value="${el.id}">[${el.status}] ${el.title}</option>`;
        });
        html += '</select>';
        window.showModal('ì„ ê±° ì„ íƒ', html, async () => {
            currentElectionId = document.getElementById('gateway-select').value;
            await startDashboard();
        }, false);
    };

    init();
</script>
</body>
</html>
