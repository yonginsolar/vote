<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í†µí•© ì„ ê±° ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* [í†¤ì•¤ë§¤ë„ˆ] ìƒ‰ìƒ ë³€ìˆ˜ ì„¤ì • */
        :root {
            --admin-bg: #f3f4f6;
            --card-bg: #ffffff;
            --primary-blue: #2563eb;
            --success-green: #16a34a;
            --warning-yellow: #ca8a04;
            --danger-red: #dc2626;
            --text-dark: #1f2937;
            --border-color: #e5e7eb;
        }

        body { background-color: var(--admin-bg); color: var(--text-dark); }
        
        /* ë ˆì´ì•„ì›ƒ */
        .admin-container { max-width: 1200px; margin: 0 auto; padding: 2rem; display: grid; grid-template-columns: 3fr 1fr; gap: 2rem; }
        @media (max-width: 768px) { .admin-container { grid-template-columns: 1fr; } }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        
        /* íƒ­ (ìœ„ì €ë“œ) ìŠ¤íƒ€ì¼ */
        .wizard-steps { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; }
        .step-item { flex: 1; text-align: center; padding: 1rem; cursor: pointer; color: #9ca3af; font-weight: bold; border-bottom: 3px solid transparent; }
        .step-item.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }
        .step-item:hover { background-color: #f9fafb; }

        /* ìƒíƒœ ë±ƒì§€ */
        .status-badge { padding: 4px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.9rem; }
        
        /* ë¡œê·¸ ì°½ */
        .log-window { height: 400px; overflow-y: auto; background: #111827; color: #10b981; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.85rem; }
        .log-entry { margin-bottom: 0.5rem; border-bottom: 1px solid #374151; padding-bottom: 0.2rem; }
        .log-time { color: #6b7280; margin-right: 0.5rem; }

        /* í›„ë³´ì í…Œì´ë¸” */
        .cand-table { width: 100%; border-collapse: collapse; }
        .cand-table th, .cand-table td { padding: 0.8rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        .input-symbol { width: 50px; text-align: center; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

    <header style="background: white; border-bottom: 1px solid #ddd; padding: 1rem 2rem; display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">ğŸ›¡ï¸ ì„ ê±° ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
        <div>
            <span id="admin-email" style="font-weight:bold; margin-right:10px;">ê´€ë¦¬ìë‹˜</span>
            <button onclick="window.close()" style="cursor:pointer;">ë‚˜ê°€ê¸°</button>
        </div>
    </header>

    <div class="admin-container">
        
        <div class="main-panel">
            
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 id="election-title" style="margin:0; font-size:1.5rem;">ì„ ê±° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
                    <span id="election-status" class="status-badge" style="background:#999;">Loading</span>
                </div>
                <div style="margin-top:1rem; color:#666;">
                    ğŸ“… ê¸°ê°„: <span id="election-period">-</span>
                </div>
            </div>

            <div class="card">
                <div class="wizard-steps">
                    <div class="step-item" onclick="switchTab('tab-nomination')">1. í›„ë³´ ë“±ë¡/ê¸°í˜¸</div>
                    <div class="step-item" onclick="switchTab('tab-ready')">2. í™•ì • ë° ê³µí¬</div>
                    <div class="step-item" onclick="switchTab('tab-vote')">3. íˆ¬í‘œ ì§„í–‰</div>
                    <div class="step-item" onclick="switchTab('tab-result')">4. ê°œí‘œ ë° ê²°ê³¼</div>
                </div>

                <div id="tab-nomination" class="tab-content">
                    <h4>ğŸ“ í›„ë³´ì ê´€ë¦¬ & ê¸°í˜¸ ë¶€ì—¬</h4>
                    <p style="color:#666; font-size:0.9rem;">
                        ìƒíƒœê°€ <strong>NOMINATION</strong>ì¼ ë•Œë§Œ í›„ë³´ ë“±ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                        í›„ë³´ë¥¼ ìŠ¹ì¸í•˜ê³  ê¸°í˜¸ë¥¼ ë¶€ì—¬í•œ ë’¤ 'ì €ì¥'í•˜ì„¸ìš”.
                    </p>
                    <div style="margin-bottom:1rem;">
                        <button onclick="changeStatus('NOMINATION')" class="btn-modal" style="background:var(--primary-blue); color:white;">â–¶ í›„ë³´ ë“±ë¡ ì‹œì‘ (NOMINATION)</button>
                    </div>
                    
                    <table class="cand-table">
                        <thead>
                            <tr>
                                <th>ì„ ê±°êµ¬</th>
                                <th>ì´ë¦„</th>
                                <th>ìƒíƒœ</th>
                                <th>ê¸°í˜¸(ìˆ«ì)</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="candidate-list-body">
                            </tbody>
                    </table>
                    <button onclick="saveSymbols()" style="margin-top:1rem; width:100%; padding:0.8rem; background:var(--success-green); color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ’¾ ê¸°í˜¸ ì¼ê´„ ì €ì¥</button>
                </div>

                <div id="tab-ready" class="tab-content" style="display:none;">
                    <h4>ğŸ“¢ í›„ë³´ì í™•ì • ë° ê³µí¬</h4>
                    <p>ê¸°í˜¸ ë¶€ì—¬ê°€ ëë‚¬ìœ¼ë©´ ì„ ê±° ì¤€ë¹„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½í•©ë‹ˆë‹¤.<br>ì´ë•Œë¶€í„° ìœ ê¶Œìë“¤ì€ í›„ë³´ì ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <button onclick="changeStatus('READY')" style="padding:1rem 2rem; font-size:1.1rem; background:var(--warning-yellow); color:white; border:none; border-radius:6px; cursor:pointer;">
                        ğŸš€ ì„ ê±° ì¤€ë¹„ ì™„ë£Œ (READY)ë¡œ ë³€ê²½
                    </button>
                </div>

                <div id="tab-vote" class="tab-content" style="display:none;">
                    <h4>ğŸ—³ï¸ íˆ¬í‘œì†Œ ìš´ì˜</h4>
                    <div style="display:flex; gap:1rem; margin-bottom:2rem;">
                        <button onclick="changeStatus('OPEN')" style="flex:1; padding:1rem; background:var(--success-green); color:white; border:none; border-radius:6px; cursor:pointer; font-size:1.1rem;">
                            â–¶ íˆ¬í‘œ ì‹œì‘ (OPEN)
                        </button>
                        <button onclick="changeStatus('PAUSED')" style="flex:1; padding:1rem; background:var(--warning-yellow); color:white; border:none; border-radius:6px; cursor:pointer; font-size:1.1rem;">
                            â¸ ì¼ì‹œ ì •ì§€ (PAUSED)
                        </button>
                        <button onclick="changeStatus('CLOSED')" style="flex:1; padding:1rem; background:var(--danger-red); color:white; border:none; border-radius:6px; cursor:pointer; font-size:1.1rem;">
                            â¹ íˆ¬í‘œ ì¢…ë£Œ (CLOSED)
                        </button>
                    </div>
                    
                    <div style="background:#f9f9f9; padding:1rem; border-radius:8px;">
                        <h5>ì‹¤ì‹œê°„ íˆ¬í‘œ í˜„í™© (5ì´ˆë§ˆë‹¤ ê°±ì‹ )</h5>
                        <h2 id="live-turnout" style="text-align:center; font-size:2rem; color:var(--primary-blue);">0%</h2>
                        <p style="text-align:center; color:#666;">ì°¸ì—¬ <span id="live-votes">0</span> / ì´ì› <span id="live-total">0</span></p>
                    </div>
                </div>

                <div id="tab-result" class="tab-content" style="display:none;">
                    <h4>ğŸ† ê°œí‘œ ë° ê²°ê³¼ ë°œí‘œ</h4>
                    <p style="color:red;">* íˆ¬í‘œê°€ ì™„ì „íˆ ì¢…ë£Œ(CLOSED)ëœ í›„ì—ë§Œ ê°œí‘œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    
                    <div id="result-control">
                        <button onclick="openBallotBox()" style="padding:1rem; background:#374151; color:white; border:none; border-radius:6px; cursor:pointer;">
                            ğŸ” ê°œí‘œí•¨ ì—´ê¸° (ê²°ê³¼ í™•ì¸)
                        </button>
                    </div>

                    <div id="result-display" style="display:none; margin-top:1rem;">
                        <div id="result-chart"></div>
                        
                        <hr style="margin:2rem 0;">
                        <button onclick="changeStatus('PUBLISHED')" style="width:100%; padding:1rem; background:var(--primary-blue); color:white; border:none; border-radius:6px; cursor:pointer; font-size:1.2rem;">
                            ğŸ“¢ ê²°ê³¼ ìµœì¢… ê³µí¬ (PUBLISHED)
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <div class="side-panel">
            <div class="card" style="position:sticky; top:20px;">
                <h3>ğŸ“œ ìš´ì˜ ë¡œê·¸ (Audit)</h3>
                <div id="audit-log-container" class="log-window">
                    <div class="log-entry">ë¡œê·¸ ë¡œë”© ì¤‘...</div>
                </div>
                <button onclick="loadLogs()" style="width:100%; margin-top:0.5rem; padding:0.5rem; cursor:pointer;">ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { AdminService } from './AdminService.js';
        
        const service = new AdminService();
        let currentElectionId = null;

        // [ì´ˆê¸°í™”]
        async function init() {
            // 1. ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
            if (!await service.isAdmin()) {
                alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                window.close();
                return;
            }

            // 2. ì„ ê±° ID íŒŒì‹± (URL íŒŒë¼ë¯¸í„° ìš°ì„ , ì—†ìœ¼ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€)
            const urlParams = new URLSearchParams(window.location.search);
            currentElectionId = urlParams.get('id') || localStorage.getItem('target_election_id');

            if (!currentElectionId) {
                alert('ì„ íƒëœ ì„ ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                window.close();
                return;
            }

            // 3. ë°ì´í„° ë¡œë“œ
            loadElectionInfo();
            loadCandidates(); // í›„ë³´ íƒ­ìš©
            loadLogs(); // ë¡œê·¸
            
            // í´ë§ (íˆ¬í‘œìœ¨ ì‹¤ì‹œê°„ ê°±ì‹ )
            setInterval(updateLiveStats, 5000);
        }

        // [ì •ë³´ ë¡œë“œ] ì„ ê±° ê°œìš”
        async function loadElectionInfo() {
            try {
                const data = await service.getElectionInfo(currentElectionId);
                document.getElementById('election-title').innerText = data.title;
                document.getElementById('election-period').innerText = 
                    `${new Date(data.start_at).toLocaleString()} ~ ${new Date(data.end_at).toLocaleString()}`;
                
                // ìƒíƒœ ë±ƒì§€ ì—…ë°ì´íŠ¸
                updateStatusBadge(data.status);

            } catch (e) {
                console.error(e);
            }
        }

        function updateStatusBadge(status) {
            const el = document.getElementById('election-status');
            el.innerText = status;
            
            let color = '#999';
            if(status === 'OPEN') color = 'var(--success-green)';
            else if(status === 'CLOSED') color = 'var(--danger-red)';
            else if(status === 'PUBLISHED') color = 'var(--primary-blue)';
            else if(status === 'NOMINATION') color = '#ec4899'; // pink
            
            el.style.backgroundColor = color;
        }

        // [íƒ­ ì „í™˜]
        window.switchTab = (tabId) => {
            // ëª¨ë“  íƒ­ ë‚´ìš© ìˆ¨ê¹€
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ ë³´ì„
            document.getElementById(tabId).style.display = 'block';
            
            // ìŠ¤í… í•˜ì´ë¼ì´íŠ¸ (ì´ë²¤íŠ¸ íƒ€ê²Ÿ ì°¾ê¸° ì–´ë ¤ìš°ë‹ˆ ë‹¨ìˆœ ë§¤í•‘)
            const map = { 'tab-nomination':0, 'tab-ready':1, 'tab-vote':2, 'tab-result':3 };
            document.querySelectorAll('.step-item')[map[tabId]].classList.add('active');
        };
        // ì´ˆê¸° íƒ­ ì„¤ì •
        switchTab('tab-nomination');

        // [í›„ë³´ì ë¡œë“œ & ë Œë”ë§]
        async function loadCandidates() {
            const list = await service.getCandidates(currentElectionId);
            const tbody = document.getElementById('candidate-list-body');
            tbody.innerHTML = '';

            list.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.districts.name}</td>
                    <td>${c.name}</td>
                    <td>
                        ${c.status === 'PENDING' ? 
                          `<button onclick="reviewCand('${c.id}', 'APPROVED', '${c.name}')" style="color:blue;">ìŠ¹ì¸</button> 
                           <button onclick="reviewCand('${c.id}', 'REJECTED', '${c.name}')" style="color:red;">ë°˜ë ¤</button>` 
                          : c.status}
                    </td>
                    <td>
                        <input type="text" class="input-symbol" data-id="${c.id}" value="${c.symbol || ''}" placeholder="1">
                    </td>
                    <td>-</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // [Action] í›„ë³´ ìŠ¹ì¸/ë°˜ë ¤
        window.reviewCand = async (id, decision, name) => {
            if(!confirm(`${name} í›„ë³´ë¥¼ ${decision} í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            await service.reviewCandidate(id, decision);
            await service.logAction(currentElectionId, 'CANDIDATE_REVIEW', `${name} í›„ë³´ ${decision}`);
            loadCandidates();
            loadLogs();
        };

        // [Action] ê¸°í˜¸ ì €ì¥
        window.saveSymbols = async () => {
            const inputs = document.querySelectorAll('.input-symbol');
            try {
                for (const input of inputs) {
                    const id = input.dataset.id;
                    const val = input.value;
                    if (val) await service.updateSymbol(id, val);
                }
                alert('ê¸°í˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await service.logAction(currentElectionId, 'SYMBOL_UPDATE', 'í›„ë³´ì ê¸°í˜¸ ì €ì¥ ì™„ë£Œ');
                loadLogs();
            } catch(e) { alert(e.message); }
        };

        // [Action] ìƒíƒœ ë³€ê²½ (ê³µí†µ)
        window.changeStatus = async (status) => {
            if(!confirm(`ì •ë§ ì„ ê±° ìƒíƒœë¥¼ '${status}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            try {
                await service.updateStatus(currentElectionId, status);
                loadElectionInfo();
                loadLogs();
                alert('ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch(e) { alert(e.message); }
        };

        // [Action] ë¡œê·¸ ë¡œë“œ
        window.loadLogs = async () => {
            const logs = await service.getLogs(currentElectionId);
            const container = document.getElementById('audit-log-container');
            container.innerHTML = '';
            
            logs.forEach(log => {
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.innerHTML = `
                    <span class="log-time">[${new Date(log.created_at).toLocaleTimeString()}]</span>
                    <strong>${log.action_type}</strong><br>
                    ${log.details} <span style="font-size:0.7rem; color:#666;">by ${log.admin_email}</span>
                `;
                container.appendChild(div);
            });
        };

        // [Action] íˆ¬í‘œìœ¨ ê°±ì‹ 
        async function updateLiveStats() {
            if(!currentElectionId) return;
            // ì„œë¹„ìŠ¤ì— getTurnoutStats í•¨ìˆ˜ê°€ ìˆë‹¤ê³  ê°€ì • (Monitor.htmlì—ì„œ ì”€)
            const stats = await service.getTurnoutStats(currentElectionId);
            document.getElementById('live-turnout').innerText = `${stats.percent}%`;
            document.getElementById('live-votes').innerText = stats.current;
            document.getElementById('live-total').innerText = stats.total;
        }
        
        // [Action] ê°œí‘œí•¨ ì—´ê¸°
        window.openBallotBox = async () => {
             // ë³´ì•ˆìƒ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œë²ˆ ë” ë¬»ëŠ” ê²ƒë„ ì¢‹ìŒ
             const pwd = prompt("ê´€ë¦¬ì ë³´ì•ˆ í™•ì¸: 'ê°œí‘œ'ë¼ê³  ì…ë ¥í•˜ì„¸ìš”.");
             if(pwd !== 'ê°œí‘œ') return alert('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
             
             document.getElementById('result-display').style.display = 'block';
             
             // ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ì„œ ë Œë”ë§ (ê°„ë‹¨ í…ìŠ¤íŠ¸ ë²„ì „)
             const ballots = await service.getResults(currentElectionId);
             const chart = document.getElementById('result-chart');
             chart.innerHTML = `<p>ì´ ${ballots.length}í‘œê°€ ì§‘ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. (ìƒì„¸ ê·¸ë˜í”„ëŠ” Monitor í˜ì´ì§€ ê¶Œì¥)</p>`;
             
             await service.logAction(currentElectionId, 'OPEN_BALLOT', 'ê°œí‘œí•¨ ì—´ëŒ ë° ê²°ê³¼ í™•ì¸');
             loadLogs();
        };

        // ì‹¤í–‰
        init();
    </script>
</body>
</html>
