<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í†µí•© ì„ ê±° ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        /* [í†¤ì•¤ë§¤ë„ˆ] ìƒ‰ìƒ ë³€ìˆ˜ */
        :root {
            --admin-bg: #f8f9fa;
            --card-bg: #ffffff;
            --primary-blue: #2563eb;
            --primary-light: #eff6ff;
            --success-green: #16a34a;
            --warning-yellow: #ca8a04;
            --danger-red: #dc2626;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --border-color: #e5e7eb;
        }

        body { 
            background-color: var(--admin-bg); 
            color: var(--text-dark); 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-center h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-blue);
            font-weight: 800;
        }

        /* ë ˆì´ì•„ì›ƒ */
        .admin-container { 
            max-width: 1400px; /* ë„“ê²Œ í™•ì¥ */
            margin: 0 auto; 
            padding: 2rem; 
            display: grid; 
            grid-template-columns: 3fr 1fr; /* ë©”ì¸ 3 : ì‚¬ì´ë“œ 1 */
            gap: 2rem; 
        }
        @media (max-width: 900px) { .admin-container { grid-template-columns: 1fr; } }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            border: 1px solid var(--border-color); 
        }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .wizard-steps { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; }
        .step-item { 
            flex: 1; text-align: center; padding: 1rem; cursor: pointer; 
            color: var(--text-gray); font-weight: 600; 
            border-bottom: 3px solid transparent; 
            transition: all 0.2s;
        }
        .step-item.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); background: var(--primary-light); }
        .step-item:hover { background-color: #f9fafb; }

        /* ìƒíƒœ ë±ƒì§€ */
        .status-badge { padding: 6px 14px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.85rem; letter-spacing: 0.5px; }
        
        /* ë¡œê·¸ ì°½ */
        .log-window { height: 300px; overflow-y: auto; background: #1e293b; color: #10b981; padding: 1rem; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.85rem; }
        .log-entry { margin-bottom: 0.5rem; border-bottom: 1px solid #334155; padding-bottom: 0.2rem; }
        .log-time { color: #94a3b8; margin-right: 0.5rem; }

        /* ìœ ê¶Œì ë¦¬ìŠ¤íŠ¸ (ì‚¬ì´ë“œë°”) */
        .voter-group-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;
        }
        .voter-group-item:hover { background-color: #f3f4f6; }
        .voter-count-badge { background: #e5e7eb; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }

        /* í…Œì´ë¸” */
        .cand-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .cand-table th { background: #f3f4f6; color: var(--text-dark); font-weight: 600; text-align: left; padding: 1rem; border-bottom: 2px solid var(--border-color); }
        .cand-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .input-symbol { width: 60px; text-align: center; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-weight: bold; font-size: 1rem; }
        
        /* ë²„íŠ¼ ê³µí†µ */
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; font-size: 0.95rem; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-success { background: var(--success-green); color: white; }
        .btn-warning { background: var(--warning-yellow); color: white; }
        .btn-danger { background: var(--danger-red); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-dark); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 4px; }

        /* í†µê³„ ëŒ€ì‹œë³´ë“œ ë°•ìŠ¤ */
        .stats-box {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;
            background: var(--primary-light); padding: 1.5rem; border-radius: 8px; border: 1px solid #bfdbfe;
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary-blue); }
        .stat-label { font-size: 0.9rem; color: var(--text-gray); }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center; max-height: 80vh; overflow-y: auto;
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; display: block;}
        .modal-body { margin-bottom: 2rem; color: #4b5563; line-height: 1.5; text-align: left;}
        .modal-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;}
        
        /* ìœ ê¶Œì ë¯¸ë¦¬ë³´ê¸° ë° ëª…ë‹¨ í…Œì´ë¸” */
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: left; padding: 10px;}
        .voter-card-mock { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem; }
        .mock-symbol { width: 40px; height: 40px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; flex-shrink: 0;}
        
        .voter-list-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .voter-list-table th, .voter-list-table td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <span style="font-weight:bold; color:#4b5563;">ADMIN CONSOLE</span>
    </div>
    <div class="header-center">
        <h2 id="header-election-title">ì„ ê±° ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
    </div>
    <div class="header-right">
        <span id="admin-email" style="font-weight:600; color:#374151; margin-right:15px; font-size:0.9rem;"></span>
        <button class="btn btn-outline btn-sm" onclick="openElectionGateway()">
            ğŸ”„ ë‹¤ë¥¸ ì„ ê±° ì„ íƒ
        </button>
    </div>
</header>

<div class="admin-container">
    
    <div class="main-panel">
        
<div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:0.85rem; color:var(--text-gray); margin-bottom:4px;">í˜„ì¬ ê´€ë¦¬ ì¤‘ì¸ ì„ ê±°</span>
                    <h3 id="election-title" style="margin:0; font-size:1.8rem;">ë¡œë”© ì¤‘...</h3>
                </div>
                <span id="election-status" class="status-badge" style="background:#999;">-</span>
            </div>
            
            <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; border: 1px solid #e9ecef;">
                <h5 style="margin: 0 0 10px 0; color: #495057;">ğŸ“… ì„ ê±° ì¼ì • ìƒì„¸</h5>
                <div id="election-period-detail" style="font-size: 0.95rem; color: #343a40; line-height: 1.8;">
                    ë¡œë”© ì¤‘...
                </div>
            </div>
        </div>

        <div class="card">
            <div class="wizard-steps">
                <div class="step-item" onclick="switchTab('tab-nomination')">1. í›„ë³´ ë“±ë¡/ê¸°í˜¸</div>
                <div class="step-item" onclick="switchTab('tab-ready')">2. í™•ì • ë° ê³µí¬</div>
                <div class="step-item" onclick="switchTab('tab-vote')">3. íˆ¬í‘œ ì§„í–‰</div>
                <div class="step-item" onclick="switchTab('tab-result')">4. ê°œí‘œ ë° ê²°ê³¼</div>
            </div>

            <div id="tab-nomination" class="tab-content">
                <h4>ğŸ“ í›„ë³´ì ë“±ë¡ í˜„í™©</h4>
                <div class="stats-box">
                    <div class="stat-item"><div class="stat-value" id="stat-total">0</div><div class="stat-label">ì „ì²´</div></div>
                    <div class="stat-item"><div class="stat-value" style="color:var(--warning-yellow)" id="stat-pending">0</div><div class="stat-label">ëŒ€ê¸°</div></div>
                    <div class="stat-item"><div class="stat-value" style="color:var(--success-green)" id="stat-approved">0</div><div class="stat-label">ìŠ¹ì¸</div></div>
                    <div class="stat-item"><div class="stat-value" style="color:var(--danger-red)" id="stat-rejected">0</div><div class="stat-label">ë°˜ë ¤</div></div>
                </div>

                <div style="margin-bottom:1rem;">
                    <button onclick="confirmAction('NOMINATION', 'í›„ë³´ ë“±ë¡ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="btn btn-primary">â–¶ í›„ë³´ ë“±ë¡ ì‹œì‘</button>
                </div>
                
                <table class="cand-table">
                    <thead><tr><th>ì„ ê±°êµ¬</th><th>ì´ë¦„</th><th>ìƒíƒœ</th><th>ê¸°í˜¸</th></tr></thead>
                    <tbody id="candidate-list-body"></tbody>
                </table>
               <div style="margin-top: 1.5rem; display: flex; gap: 10px;">
                   <button onclick="assignRandomSymbols()" class="btn btn-warning" style="margin-right: 5px;">
    ğŸ² ê¸°í˜¸ ìë™ ì¶”ì²¨ (ë¯¸ë¦¬ë³´ê¸°)
</button>
    <button onclick="saveSymbols()" class="btn btn-success" style="flex: 1;">ğŸ’¾ ê¸°í˜¸ ì €ì¥</button>
    
    <button onclick="finalizeNomination()" class="btn btn-primary" style="flex: 1; background-color: #4f46e5;">
        ğŸš€ í›„ë³´ í™•ì • ë° ë‹¤ìŒ ë‹¨ê³„ë¡œ
    </button>
</div>
            </div>

            <div id="tab-ready" class="tab-content" style="display:none;">
                <h4>ğŸ“¢ í›„ë³´ì í™•ì • ë° ê³µí¬</h4>
                <div style="background: #fff3cd; border: 1px solid #ffeeba; padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <button onclick="openVoterPreview()" class="btn btn-outline" style="margin-bottom: 1rem;">ğŸ‘ï¸ ìœ ê¶Œì í™”ë©´ ë¯¸ë¦¬ë³´ê¸°</button>
                    <br>
                    <button onclick="confirmAction('READY', 'ì„ ê±° ì¤€ë¹„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="btn btn-warning">ğŸš€ ì„ ê±° ì¤€ë¹„ ì™„ë£Œ (READY)</button>
                </div>
            </div>

            <div id="tab-vote" class="tab-content" style="display:none;">
                <h4>ğŸ—³ï¸ íˆ¬í‘œì†Œ ìš´ì˜</h4>
                <div style="display:flex; gap:1rem; margin-bottom:2rem;">
                    <button onclick="confirmAction('OPEN', 'íˆ¬í‘œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.')" class="btn btn-success" style="flex:1;">â–¶ íˆ¬í‘œ ì‹œì‘</button>
                    <button onclick="confirmAction('PAUSED', 'íˆ¬í‘œë¥¼ ì¼ì‹œ ì •ì§€í•©ë‹ˆë‹¤.')" class="btn btn-warning" style="flex:1;">â¸ ì¼ì‹œ ì •ì§€</button>
                    <button onclick="confirmAction('CLOSED', 'íˆ¬í‘œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.')" class="btn btn-danger" style="flex:1;">â¹ íˆ¬í‘œ ì¢…ë£Œ</button>
                </div>
                
                <div style="background:#f9fafb; padding:2rem; border-radius:12px; border:1px solid #eee; text-align: center;">
                    <h5 style="margin:0; color:#6b7280;">ì‹¤ì‹œê°„ íˆ¬í‘œìœ¨ (5ì´ˆ ì£¼ê¸°)</h5>
                    <h2 id="live-turnout" style="margin: 10px 0; font-size:3.5rem; color:var(--primary-blue); font-weight: 800;">0%</h2>
                    <div style="font-size: 1.1rem; color: #374151;">
                        ì°¸ì—¬ <strong id="live-votes">0</strong>ëª… / ì´ì› <span id="live-total">0</span>ëª…
                    </div>
                </div>
            </div>

            <div id="tab-result" class="tab-content" style="display:none;">
                <h4>ğŸ† ê°œí‘œ ë° ê²°ê³¼</h4>
                <div id="result-control">
                    <button onclick="openBallotBox()" class="btn" style="padding:1rem; background:#374151; color:white; width: 100%;">ğŸ” ê°œí‘œí•¨ ì—´ê¸°</button>
                </div>
                <div id="result-display" style="display:none; margin-top:2rem;">
                    <div id="result-chart" style="padding: 1rem; background: #f3f4f6; border-radius: 8px;"></div>
                    <hr style="margin:2rem 0; border:0; border-top:1px solid #ddd;">
                    <button onclick="confirmAction('PUBLISHED', 'ìµœì¢… ê²°ê³¼ë¥¼ ê³µí¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="btn btn-primary" style="width:100%;">ğŸ“¢ ê²°ê³¼ ìµœì¢… ê³µí¬</button>
                </div>
            </div>
        </div>
    </div>

    <div class="side-panel">
<div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">ğŸ‘¥ ìœ ê¶Œì í˜„í™©</h3>
                <div>
                    <button onclick="openAddVoterModal()" class="btn btn-sm btn-success" style="font-size:0.7rem; margin-right: 5px;">+ ì¶”ê°€</button>
                    <button onclick="loadVoterStats()" class="btn btn-sm btn-outline" style="font-size:0.7rem;">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
            <div id="voter-stats-list" style="max-height:300px; overflow-y:auto;">
                <p style="color:#999; font-size:0.8rem;">ë¡œë”© ì¤‘...</p>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">ğŸ“œ ìš´ì˜ ë¡œê·¸</h3>
                <button onclick="loadLogs()" class="btn btn-sm btn-outline" style="font-size:0.7rem;">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="audit-log-container" class="log-window">
                <div class="log-entry">ë¡œê·¸ ë¡œë”© ì¤‘...</div>
            </div>
            <p style="font-size:0.7rem; color:#999; margin-top:5px;">* ë¡œê·¸ê°€ ì•ˆ ë³´ì´ë©´ DBì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
    </div>
</div>

<div id="common-modal" class="modal-overlay">
    <div class="modal-content">
        <span id="modal-title" class="modal-title">ì•Œë¦¼</span>
        <div id="modal-body" class="modal-body"></div>
        <div id="modal-actions" class="modal-actions">
            <button onclick="closeModal()" class="btn btn-outline">ë‹«ê¸°</button>
        </div>
    </div>
</div>

    <div id="voter-detail-modal" class="modal-overlay">
    <div class="modal-content" style="text-align: left;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <span class="modal-title">ğŸ‘¤ ìœ ê¶Œì ìƒì„¸ ì •ë³´</span>
            <button onclick="closeVoterDetailModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;">âœ•</button>
        </div>
        
        <div id="voter-detail-body" style="margin-bottom: 2rem;">
            </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 1rem 0;">

        <div style="display:flex; flex-direction:column; gap:10px;">
            <label style="font-weight:600; font-size:0.9rem;">ì„ ê±°êµ¬ ë³€ê²½</label>
            <div style="display:flex; gap: 10px;">
                <select id="detail-district-select" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
                    </select>
                <button id="btn-update-district" class="btn btn-primary btn-sm">ë³€ê²½ ì €ì¥</button>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button id="btn-delete-voter" class="btn btn-danger btn-sm">â›” ëª…ë¶€ì—ì„œ ì œì™¸ (ì‚­ì œ)</button>
            </div>
        </div>
    </div>
</div>

<div id="add-voter-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-title">â• ìœ ê¶Œì ì¶”ê°€ (ëª…ë¶€ ë“±ì¬)</span>
        <p style="font-size:0.85rem; color:#666; margin-bottom:1rem;">
            ì „ì²´ ì¡°í•©ì› ì¤‘ì—ì„œ ê²€ìƒ‰í•˜ì—¬ ì„ ê±°ì¸ ëª…ë¶€ì— ì¶”ê°€í•©ë‹ˆë‹¤.<br>
            (ì´ë¯¸ ë“±ë¡ëœ ì‚¬ëŒì€ ê²€ìƒ‰ë˜ì§€ ì•Šê±°ë‚˜ í‘œì‹œë©ë‹ˆë‹¤.)
        </p>
        
        <div style="display:flex; gap:10px; margin-bottom:1rem;">
            <input type="text" id="search-member-input" placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ ë’·ìë¦¬" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:4px;" onkeyup="if(window.event.keyCode==13){searchMembers()}">
            <button onclick="searchMembers()" class="btn btn-primary">ê²€ìƒ‰</button>
        </div>

        <div id="search-result-area" style="height: 200px; overflow-y: auto; border:1px solid #eee; background:#f9fafb; padding:10px; text-align:left; margin-bottom:1rem;">
            <div style="color:#999; text-align:center; padding-top:20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>

        <div style="text-align:left; margin-bottom:1rem;">
            <label style="font-weight:600; font-size:0.9rem;">ë°°ì •í•  ì„ ê±°êµ¬ ì„ íƒ</label>
            <select id="add-voter-district-select" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-top:5px;">
                <option value="">-- ì„ ê±°êµ¬ ì„ íƒ --</option>
                </select>
        </div>

        <div class="modal-actions">
            <button onclick="closeAddVoterModal()" class="btn btn-outline">ë‹«ê¸°</button>
        </div>
    </div>
</div>
    
<div id="candidate-detail-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; text-align: left; max-height: 90vh; overflow-y: auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <span class="modal-title">ğŸ‘¤ í›„ë³´ì ìƒì„¸ ì •ë³´</span>
            <button onclick="closeCandidateDetail()" style="border:none; background:none; cursor:pointer; font-size:1.5rem;">&times;</button>
        </div>

        <div id="cand-detail-body">
            </div>

        <div id="cand-action-area" class="modal-actions" style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
            </div>
    </div>
</div>

<div id="reject-reason-modal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 500px;">
        <h3 class="modal-title" style="color:var(--danger-red);">â›” ìŠ¹ì¸ ë°˜ë ¤</h3>
        <p style="color:#666; font-size:0.9rem; margin-bottom:10px;">í›„ë³´ìì—ê²Œ ì „ë‹¬ë  ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        
        <textarea id="reject-reason-input" rows="4" 
            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; resize:vertical;" 
            placeholder="ì˜ˆ: ì¦ë¹™ ì„œë¥˜ ì‹ë³„ ë¶ˆê°€, ê²½ë ¥ ì‚¬í•­ ê¸°ì¬ ì˜¤ë¥˜ ë“±"></textarea>
            
        <div class="modal-actions">
            <button onclick="closeRejectModal()" class="btn btn-outline">ì·¨ì†Œ</button>
            <button id="btn-confirm-reject" class="btn btn-danger">ë°˜ë ¤ í™•ì •</button>
        </div>
    </div>
</div>
<script type="module">
    import { AdminService } from './AdminService.js';
    import { supabase } from './ElectionService.js';
    
    const service = new AdminService();
    let currentElectionId = null;
    let currentElectionData = null; 
    let cachedDistricts = {}; 
    let districtList = []; // [ì‹ ê·œ] ì„ ê±°êµ¬ ì „ì²´ ì •ë³´(is_common í¬í•¨) ì €ì¥ìš© ë°°ì—´
    let currentUserEmail = ''; // [ì‹ ê·œ] í˜„ì¬ ì‘ì—…ì ì´ë©”ì¼ ì €ì¥ìš©

    // -----------------------------------------------------------
    // [1] ëª¨ë‹¬ & ìœ í‹¸ë¦¬í‹° (ê¸°ì¡´ ìœ ì§€)
    // -----------------------------------------------------------
    window.showModal = (title, contentHtml, onConfirm = null, showCancel = true) => {
        const modal = document.getElementById('common-modal');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = contentHtml;
        const actionDiv = document.getElementById('modal-actions');
        actionDiv.innerHTML = ''; 

        if (showCancel) {
            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn btn-outline';
            closeBtn.innerText = onConfirm ? 'ì·¨ì†Œ' : 'ë‹«ê¸°';
            closeBtn.onclick = window.closeModal;
            actionDiv.appendChild(closeBtn);
        }

        if (onConfirm) {
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'btn btn-primary';
            confirmBtn.innerText = 'í™•ì¸';
            confirmBtn.onclick = () => { onConfirm(); if(showCancel) window.closeModal(); };
            actionDiv.appendChild(confirmBtn);
        }
        modal.style.display = 'flex';
    };

    window.closeModal = () => { document.getElementById('common-modal').style.display = 'none'; };

// [ìˆ˜ì •ëœ init í•¨ìˆ˜] ê´€ë¦¬ì ë° ì„ ê´€ìœ„ì› ê¶Œí•œ ê²€ì¦ ë¡œì§
    async function init() {
        // [ë³´ì•ˆ] ê²€ì¦ ì‹œì‘ ì „ê¹Œì§€ í™”ë©´ ìˆ¨ê¹€ (CSSê°€ ì—†ì–´ë„ JSë¡œ ê°•ì œ ì ìš©)
        document.body.style.display = 'none';

        try {
            // 1. ìœ ì € ì •ë³´ íšë“
            const { data: { user }, error: authError } = await supabase.auth.getUser();
            
            if (authError || !user || !user.email) {
                throw new Error("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }

            const userEmail = user.email;
            
            // [ìˆ˜ì •] ì „ì—­ ë³€ìˆ˜ì— í˜„ì¬ ì‘ì—…ì ì´ë©”ì¼ ì €ì¥ (ë¡œê·¸ ê¸°ë¡ì„ ìœ„í•´)
            currentUserEmail = userEmail;

            // í™”ë©´ì— ì´ë©”ì¼ í‘œì‹œ (ì—˜ë¦¬ë¨¼íŠ¸ê°€ ìˆì„ ë•Œë§Œ)
            const emailEl = document.getElementById('admin-email');
            if (emailEl) emailEl.innerText = userEmail;

            // 2. ê¶Œí•œ ê²€ì¦ (DB ì¡°íšŒ 2ë‹¨ê³„)
            let isAuthorized = false;
            let roleName = '';

            // 2-1. ê´€ë¦¬ì(admin) ì²´í¬ (coop_members í…Œì´ë¸”)
            const { data: memberData, error: memberError } = await supabase
                .from('coop_members')
                .select('role, member_id')
                .eq('email', userEmail)
                .maybeSingle();

            if (memberError) console.error("Member DB Error:", memberError);

            if (memberData) {
                // ê´€ë¦¬ìë¼ë©´ ì¦‰ì‹œ í†µê³¼
                if (memberData.role === 'admin') {
                    isAuthorized = true;
                    roleName = 'ê´€ë¦¬ì';
                } 
                // ê´€ë¦¬ìê°€ ì•„ë‹ˆê³  member_idê°€ ìˆë‹¤ë©´ ì„ ê´€ìœ„ì› ì—¬ë¶€ ì²´í¬
                else if (memberData.member_id) {
                    // 2-2. ì„ ê´€ìœ„ì›(election_comm) ì²´í¬ (coop_officials í…Œì´ë¸”)
                    // ì¡°ê±´: member_id ì¼ì¹˜ AND category='election_comm' AND status='active'
                    const { data: officialData, error: officialError } = await supabase
                        .from('coop_officials')
                        .select('id')
                        .eq('member_id', memberData.member_id)
                        .eq('category', 'election_comm')
                        .eq('status', 'active')
                        .maybeSingle();

                    if (officialData) {
                        isAuthorized = true;
                        roleName = 'ì„ ê±°ê´€ë¦¬ìœ„ì›';
                    }
                }
            }

            // 3. ê²°ê³¼ ì²˜ë¦¬
            if (isAuthorized) {
                // [ì„±ê³µ] í™”ë©´ ê³µê°œ
                console.log(`âœ… ì ‘ì† í—ˆìš©: ${roleName} (${currentUserEmail})`);
                document.body.style.display = 'block'; 
                
                // URL íŒŒë¼ë¯¸í„° í™•ì¸ í›„ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
                const urlParams = new URLSearchParams(window.location.search);
                let targetId = urlParams.get('id');
                if (targetId) {
                    currentElectionId = targetId;
                    await startDashboard();
                } else {
                    await openElectionGateway();
                }

            } else {
                // [ì‹¤íŒ¨] ë‚´ìš© íŒŒê¸° ë° ê²½ê³  í›„ ë‚´ë³´ë‚´ê¸°
                document.body.innerHTML = ''; // ë³´ì•ˆì„ ìœ„í•´ DOM ë‚´ìš© ì‚­ì œ
                alert("ğŸš« ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\n(ê´€ë¦¬ì ë˜ëŠ” í™œì„± ì„ ê´€ìœ„ì›ë§Œ ì ‘ì† ê°€ëŠ¥í•©ë‹ˆë‹¤)");
                window.location.href = 'index.html'; 
            }

        } catch (e) {
            console.error("Critical Auth Error:", e);
            document.body.innerHTML = '';
            alert("ì¸ì¦ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            window.location.href = 'index.html';
        }
    }

    // -----------------------------------------------------------
    // [3] ì„ ê±° ì„ íƒ (ìˆ˜ì •: ë§ë¨¸ë¦¬ ë¡œì§ ë³µêµ¬)
    // -----------------------------------------------------------
// [ìˆ˜ì •] ì„ ê±° ì„ íƒ ì°½ (DRAFT ìƒíƒœëŠ” ë³´ì´ì§€ë§Œ ì„ íƒ ë¶ˆê°€ ì²˜ë¦¬)
window.openElectionGateway = async () => {
    try {
        // 1. ëª¨ë“  ì„ ê±° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const elections = await service.getAllElections();
        
        // ì„ ê±°ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
        if (!elections || elections.length === 0) {
            alert("ìƒì„±ëœ ì„ ê±°ê°€ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            window.location.href = 'admin_setup.html'; 
            return;
        }
        
        // 2. ì„ íƒ ë°•ìŠ¤ HTML ìƒì„±
        let html = '<p style="margin-bottom:10px;">ê´€ë¦¬í•  ì„ ê±°ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>';
        html += '<select id="gateway-select" style="width:100%; padding:10px; font-size:1rem; border:1px solid #ddd; border-radius:6px;">';
        
        // [ê¸°ë³¸ê°’] ì„ íƒ ìœ ë„ìš© (ëª¨ë“  í•­ëª©ì´ DRAFTì¼ ë•Œ ìë™ ì„ íƒ ë°©ì§€)
        html += '<option value="" selected disabled>-- ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” --</option>';

        elections.forEach(el => {
            // ë³€ìˆ˜ ì¤€ë¹„
            let prefix = '';
            let isDisabled = false;
            let extraText = '';

            // ìƒíƒœë³„ ë¶„ê¸° ì²˜ë¦¬
            if (el.status === 'DRAFT') {
                prefix = 'ğŸ“ [ì‘ì„±ì¤‘] ';
                isDisabled = true; // ì„ íƒ ë¶ˆê°€ ì„¤ì •
                extraText = ' (ì„¤ì • ì™„ë£Œ í•„ìš”)';
            } else if (['CLOSED', 'PUBLISHED', 'ENDED'].includes(el.status)) {
                prefix = 'ğŸ [ì¢…ë£Œ] ';
            } else if (el.status === 'OPEN') {
                prefix = 'ğŸŸ¢ [ì§„í–‰ì¤‘] ';
            } else {
                prefix = `[${el.status}] `;
            }
            
            const startStr = el.start_at ? new Date(el.start_at).toLocaleDateString() : 'ë¯¸ì •';
            
            // [í•µì‹¬] disabled ì†ì„± ì£¼ì…
            // HTML ë ˆë²¨ì—ì„œ ì„ íƒì„ ë§‰ìŠµë‹ˆë‹¤. (íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œë¨)
            html += `<option value="${el.id}" ${isDisabled ? 'disabled' : ''}>
                        ${prefix}${el.title} (${startStr}~)${extraText}
                     </option>`;
        });
        html += '</select>';
        
        // 3. ëª¨ë‹¬ ë„ìš°ê¸°
        window.showModal('ğŸ—³ï¸ ì„ ê±° ì„ íƒ', html, async () => {
            const selectEl = document.getElementById('gateway-select');
            const selectedId = selectEl.value;

            // [ë°©ì–´] ì„ íƒëœ ê°’ì´ ì—†ìœ¼ë©´(DRAFTë§Œ ìˆê±°ë‚˜ ì„ íƒ ì•ˆ í•¨) ì§„ì… ì°¨ë‹¨
            if (!selectedId) {
                alert("ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ì„ ê±°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.\n(ì‘ì„± ì¤‘ì¸ ì„ ê±°ëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)");
                return;
            }

            // ì •ìƒ ì§„ì… ë¡œì§
            currentElectionId = selectedId;
            const newUrl = `${window.location.pathname}?id=${selectedId}`;
            window.history.replaceState(null, '', newUrl);
            
            await startDashboard();
            window.closeModal(); 
        }, false); 

    } catch (e) { 
        console.error("ì„ ê±° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", e);
        alert("ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }
};

    // -----------------------------------------------------------
    // [4] ëŒ€ì‹œë³´ë“œ ë¡œë“œ
    // -----------------------------------------------------------
    async function startDashboard() {
        localStorage.setItem('target_election_id', currentElectionId);
        try {
            await loadDistrictsMap(); // ì„ ê±°êµ¬ ë§¤í•‘ ì¤€ë¹„
            await loadElectionInfo(); // ì„ ê±° ì •ë³´
            
            loadCandidates();
            loadVoterStats(); 
            loadLogs();
            
            updateWorkflowUI(); // UI ìƒíƒœ ì œì–´

            // ìë™ ì¢…ë£Œ ì²´í¬ ì‹œì‘ (5ì´ˆ ì£¼ê¸°)
            if (window.timerInterval) clearInterval(window.timerInterval);
            window.timerInterval = setInterval(checkAutoSchedule, 5000);

        } catch (e) { console.error(e); }
    }

// [ìˆ˜ì •ë¨] ì„ ê±° ì •ë³´ ë¡œë“œ ë° ìƒì„¸ ì¼ì • í‘œì‹œ
    async function loadElectionInfo() {
        const data = await service.getElectionInfo(currentElectionId);
        currentElectionData = data; 
        
        // 1. ê¸°ë³¸ íƒ€ì´í‹€ ë° ìƒíƒœ
        document.getElementById('header-election-title').innerText = data.title;
        document.getElementById('election-title').innerText = data.title;
        
        const statusEl = document.getElementById('election-status');
        statusEl.innerText = translateStatus(data.status);
        
        // ìƒíƒœ ë±ƒì§€ ìƒ‰ìƒ
        if(data.status === 'OPEN') statusEl.style.background = 'var(--success-green)';
        else if(data.status === 'CLOSED') statusEl.style.background = 'var(--danger-red)';
        else if(data.status === 'READY') statusEl.style.background = 'var(--warning-yellow)';
        else statusEl.style.background = '#999';

        // 2. ë‚ ì§œ í¬ë§·íŒ… í—¬í¼ í•¨ìˆ˜
        const fmt = (ts) => ts ? new Date(ts).toLocaleString() : '<span style="color:#aaa;">ë¯¸ì •</span>';
        const fmtDate = (ts) => ts ? new Date(ts).toLocaleDateString() : 'ë¯¸ì •';

        // 3. ê¸°ê°„ ê³„ì‚°
        // (1) í›„ë³´ ë“±ë¡ ê¸°ê°„
        const candStart = data.candidacy_start_at;
        const candEnd = data.candidacy_end_at;
        
        // (2) ê³µê³  ë° ì„ ê±°ìš´ë™ ê¸°ê°„ (í›„ë³´ ë“±ë¡ ë§ˆê° ~ íˆ¬í‘œ ì‹œì‘ ì „)
        const campStart = candEnd; // í›„ë³´ ë“±ë¡ ë§ˆê° ì‹œì ë¶€í„°
        const voteStart = data.vote_start_at;
        
        // (3) íˆ¬í‘œ ê¸°ê°„
        const voteEnd = data.vote_end_at;
        
        // (4) ì „ì²´ ê¸°ê°„ (DBìƒ start_at / end_at)
        const totalStart = data.start_at || candStart;
        const totalEnd = data.end_at || voteEnd;

        // 4. ìƒì„¸ ì¼ì • HTML ìƒì„±
        let scheduleHtml = `
            <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                <tr style="border-bottom: 1px solid #eee;">
                    <th style="text-align:left; padding:6px; color:#666; width:120px;">ğŸ“… ì „ì²´ ì¼ì •</th>
                    <td style="padding:6px; font-weight:bold;">${fmtDate(totalStart)} ~ ${fmtDate(totalEnd)}</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee; background-color: #fffcf5;">
                    <th style="text-align:left; padding:6px; color:#d97706;">1. í›„ë³´ ë“±ë¡</th>
                    <td style="padding:6px;">${fmt(candStart)} ~ ${fmt(candEnd)}</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <th style="text-align:left; padding:6px; color:#4b5563;">2. í›„ë³´ ê³µê³ </th>
                    <td style="padding:6px;">
                        ${candEnd ? fmt(candEnd) : 'ë¯¸ì •'} ~ ${voteStart ? fmt(voteStart) : 'ë¯¸ì •'}
                        <span style="font-size:0.8rem; color:#999;">(ë“±ë¡ë§ˆê° ì§í›„ ~ íˆ¬í‘œì‹œì‘ ì „)</span>
                    </td>
                </tr>
                <tr style="background-color: #f0fdf4;">
                    <th style="text-align:left; padding:6px; color:#15803d;">3. íˆ¬í‘œ ê¸°ê°„</th>
                    <td style="padding:6px; font-weight:bold; color:#15803d;">${fmt(voteStart)} ~ ${fmt(voteEnd)}</td>
                </tr>
            </table>
        `;

        document.getElementById('election-period-detail').innerHTML = scheduleHtml;
    }

    // [ì‹ ê·œ] ìƒíƒœë³„ íƒ­ ì œì–´ (Workflow)
// [ìˆ˜ì •] ì›Œí¬í”Œë¡œìš° UI ì œì–´ (ìˆœì°¨ ì§„í–‰ ê°•ì œí™”)
    function updateWorkflowUI() {
        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
        if (!currentElectionData) return;
        
        const status = currentElectionData.status;

        // 1. ëª¨ë“  íƒ­ ë‚´ìš© ìˆ¨ê¸°ê¸° (ì´ˆê¸°í™”)
        document.querySelectorAll('.tab-content').forEach(el => {
            el.style.display = 'none';
        });

        // 2. ìƒë‹¨ ë‹¨ê³„(Step) ë²„íŠ¼ ì´ˆê¸°í™” (ë¹„í™œì„±í™”)
        document.querySelectorAll('.step-item').forEach(el => {
            el.classList.remove('active');
            el.style.pointerEvents = 'none'; // í´ë¦­ ë°©ì§€ (ê±´ë„ˆë›°ê¸° ê¸ˆì§€)
            el.style.opacity = '0.5';        // íë¦¿í•˜ê²Œ í‘œì‹œ
            el.style.cursor = 'not-allowed';
        });

        // 3. í˜„ì¬ ìƒíƒœì— ë”°ë¥¸ í™œì„± íƒ­ ê²°ì • (Strict Mode)
        let activeTabId = '';
        
        // ìƒíƒœë³„ë¡œ ë³´ì—¬ì¤„ íƒ­ ë§¤í•‘
        switch (status) {
            case 'PREPARE':      // ì¤€ë¹„ ì¤‘
            case 'NOMINATION':   // í›„ë³´ ë“±ë¡
                activeTabId = 'tab-nomination';
                break;
                
            case 'READY':        // ì¤€ë¹„ ì™„ë£Œ (ê³µí¬)
                activeTabId = 'tab-ready';
                break;
                
            case 'OPEN':         // íˆ¬í‘œ ì¤‘
            case 'PAUSED':       // ì¼ì‹œ ì •ì§€
                activeTabId = 'tab-vote';
                break;
                
            case 'CLOSED':       // íˆ¬í‘œ ë§ˆê°
            case 'PUBLISHED':    // ê²°ê³¼ ê³µí¬
            case 'ENDED':        // ì™„ì „ ì¢…ë£Œ
                activeTabId = 'tab-result';
                break;
                
            default:
                activeTabId = 'tab-nomination'; // ê¸°ë³¸ê°’
        }

        // 4. ê²°ì •ëœ íƒ­ë§Œ í™”ë©´ì— í‘œì‹œ
        if (activeTabId) {
            const targetTab = document.getElementById(activeTabId);
            if (targetTab) targetTab.style.display = 'block';
            
            // ìƒë‹¨ ìŠ¤í…ë°” í•´ë‹¹ ë‹¨ê³„ í•˜ì´ë¼ì´íŠ¸
            const map = { 'tab-nomination':0, 'tab-ready':1, 'tab-vote':2, 'tab-result':3 };
            const stepIndex = map[activeTabId];
            
            if (stepIndex !== undefined) {
                const stepEl = document.querySelectorAll('.step-item')[stepIndex];
                stepEl.classList.add('active'); // ìƒ‰ìƒ í™œì„±í™”
                stepEl.style.opacity = '1';     // ë¶ˆíˆ¬ëª…
                // stepEl.style.pointerEvents = 'auto'; // (í•„ìš” ì‹œ ì£¼ì„ í•´ì œ: í˜„ì¬ ë‹¨ê³„ë§Œ í´ë¦­ í—ˆìš©)
            }
        }
    }

// [ìˆ˜ì •] ìë™ ìŠ¤ì¼€ì¤„ëŸ¬ (íˆ¬í‘œ ìë™ ì¢…ë£Œ ê°ì§€)
    async function checkAutoSchedule() {
        // ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì„ ê±° IDê°€ ì—†ìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
        if (!currentElectionData || !currentElectionId) return;
        
        const now = new Date();
        const voteEnd = new Date(currentElectionData.vote_end_at);
        const status = currentElectionData.status;

        // 1. ìë™ ì¢…ë£Œ ë¡œì§
        // ì¡°ê±´: í˜„ì¬ 'íˆ¬í‘œ ì¤‘(OPEN)' ìƒíƒœì´ê³ , ì¢…ë£Œ ì‹œê°„ì´ ì§€ë‚¬ì„ ë•Œ
        if (status === 'OPEN' && now >= voteEnd) {
            console.log(`â° [Auto Close] íˆ¬í‘œ ì¢…ë£Œ ì‹œê°„(${voteEnd.toLocaleString()}) ë„ë‹¬.`);
            
            try {
                // DB ìƒíƒœ ì—…ë°ì´íŠ¸ (CLOSED)
                await service.updateStatus(currentElectionId, 'CLOSED');
                
                // ë¡œê·¸ ê¸°ë¡
                await service.logAction(currentElectionId, 'AUTO_END', 'íˆ¬í‘œ ì‹œê°„ ì¢…ë£Œë¡œ ì‹œìŠ¤í…œ ìë™ ë§ˆê°');
                
                // UI ì¦‰ì‹œ ê°±ì‹  (ì •ë³´ ë‹¤ì‹œ ë¡œë“œ -> ì›Œí¬í”Œë¡œìš° UI ë°˜ì˜)
                await loadElectionInfo();
                updateWorkflowUI();
                
                // ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼
                alert("ì•½ì†ëœ íˆ¬í‘œ ì¢…ë£Œ ì‹œê°„ì´ ë˜ì–´\nì‹œìŠ¤í…œì´ íˆ¬í‘œë¥¼ ìë™ìœ¼ë¡œ ë§ˆê°í–ˆìŠµë‹ˆë‹¤.");
                
            } catch (e) {
                console.error("ìë™ ì¢…ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", e);
            }
        }

        // 2. ì‹¤ì‹œê°„ íˆ¬í‘œìœ¨ ê°±ì‹  (íˆ¬í‘œ ì¤‘ì¼ ë•Œë§Œ ì‘ë™)
        if (status === 'OPEN') {
            // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ (ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš©)
            updateLiveStats();
        }
    }

    // -----------------------------------------------------------
    // [5] ë°ì´í„° ë¡œë”© (ìˆ˜ì •: ìœ ê¶Œì ë¡œë“œ ì—ëŸ¬ ë°©ì§€)
    // -----------------------------------------------------------
    


    // [ìˆ˜ì •ë¨] ì„ ê±°êµ¬ ë§¤í•‘ ì •ë³´ ë¡œë“œ (is_common í¬í•¨)
    async function loadDistrictsMap() {
        // ê¸°ì¡´: select('id, name') -> ìˆ˜ì •: select('id, name, is_common')
        const { data } = await supabase
            .from('districts')
            .select('id, name, is_common')
            .eq('election_id', currentElectionId);
            
        if (data) {
            districtList = data; // ì „ì²´ ë°ì´í„° ì €ì¥ (ë¡œì§ íŒë‹¨ìš©)
            
            // ê¸°ì¡´ ìºì‹œ (id -> name ë§¤í•‘) ìœ ì§€ (í™”ë©´ í‘œì‹œìš© í˜¸í™˜ì„±)
            cachedDistricts = {}; 
            data.forEach(d => {
                cachedDistricts[d.id] = d.name;
            });
        }
    }

// [ìˆ˜ì •ë¨] ìœ ê¶Œì í˜„í™© ë¡œë“œ (district_id ëˆ„ë½ ìˆ˜ì •)
    window.loadVoterStats = async () => {
        const container = document.getElementById('voter-stats-list');
        container.innerHTML = '<p style="font-size:0.8rem;">ë°ì´í„° ë¡œë”© ì¤‘...</p>';
        
        try {
            // 1. ìœ ê¶Œì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            // [ì¤‘ìš”] ì—¬ê¸°ì„œ district_idë¥¼ ê°€ì ¸ì˜¤ì§€ë§Œ, ì•„ë˜ grouped ë£¨í”„ì—ì„œ ì‚¬ìš©ì„ ì•ˆ í•´ì„œ ëˆ„ë½ëì—ˆìŠµë‹ˆë‹¤.
            const { data: voters, error: voterError } = await supabase
                .from('election_voters')
                .select('member_no, district_id') 
                .eq('election_id', currentElectionId);

            if(voterError) throw voterError;

            if(!voters || voters.length === 0) {
                container.innerHTML = '<p style="padding:10px; color:#999;">ë“±ë¡ëœ ìœ ê¶Œìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // 2. ì¡°í•©ì› ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const memberNos = voters.map(v => v.member_no);
            
            const { data: members, error: memberError } = await supabase
                .from('coop_members')
                .select('member_id, name, phone')
                .in('member_id', memberNos);

            if(memberError) throw memberError;

            // 3. ë°ì´í„° ë§¤í•‘
            const memberMap = {};
            if(members) {
                members.forEach(m => {
                    memberMap[m.member_id] = m;
                });
            }

            // 4. ë°ì´í„° ì¡°ë¦½ ë° ë Œë”ë§
            const grouped = {};
            voters.forEach(v => {
                const dName = cachedDistricts[v.district_id] || 'ë¯¸ì§€ì •';
                const memInfo = memberMap[v.member_no] || { name: 'ì •ë³´ì—†ìŒ', phone: '-' };

                // [ìˆ˜ì •ëœ ë¶€ë¶„] district_idë¥¼ ëª…ì‹œì ìœ¼ë¡œ ê°ì²´ì— ë‹´ìŠµë‹ˆë‹¤.
                // ê·¸ë˜ì•¼ í´ë¦­í–ˆì„ ë•Œ openVoterInfo í•¨ìˆ˜ë¡œ ì´ ê°’ì´ ì „ë‹¬ë©ë‹ˆë‹¤.
                const combinedData = {
                    member_no: v.member_no,
                    district_id: v.district_id, // <--- ì—¬ê¸°ê°€ ë¹„ì–´ìˆì–´ì„œ ì—ëŸ¬ê°€ ë‚¬ìŠµë‹ˆë‹¤.
                    _view_name: memInfo.name,
                    _view_phone: memInfo.phone
                };

                if(!grouped[dName]) grouped[dName] = [];
                grouped[dName].push(combinedData);
            });

            container.innerHTML = '';
            for(const [dName, list] of Object.entries(grouped)) {
                const div = document.createElement('div');
                div.className = 'voter-group-item';
                div.onclick = () => showVoterDetail(dName, list);
                div.innerHTML = `<span style="font-weight:600;">${dName}</span> <span class="voter-count-badge">${list.length}ëª…</span>`;
                container.appendChild(div);
            }

        } catch(e) {
            console.error("ìœ ê¶Œì ë¡œë“œ ì—ëŸ¬:", e);
            container.innerHTML = `<p style="color:red; font-size:0.8rem;">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</p>`;
        }
    };
    window.closeAddVoterModal = () => {
        document.getElementById('add-voter-modal').style.display = 'none';
    };

// [ìˆ˜ì •ë¨] ì„ ê±°êµ¬ë³„ ìœ ê¶Œì ëª©ë¡ ë³´ê¸° (ë‚´ë¶€ ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€)
    window.showVoterDetail = (dName, list) => {
        // ëª¨ë‹¬ ë‚´ë¶€ HTML êµ¬ì„±
        let html = `
            <div style="padding:10px; background:#f3f4f6; margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <strong>${dName}</strong> ëª…ë¶€ (${list.length}ëª…)
                </div>
                <input type="text" id="voter-list-search" placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ ê²€ìƒ‰..." 
                       onkeyup="filterVoterList()" 
                       style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:0.9rem;">
                <div style="font-size:0.75rem; color:#666; margin-top:4px;">* ì´ë¦„ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ ì¡°íšŒ ë° ì´ë™ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
            </div>
            
            <div style="max-height:300px; overflow-y:auto;">
                <table class="voter-list-table" id="voter-table-body">
                    <thead>
                        <tr>
                            <th style="width:50px;">ë²ˆí˜¸</th>
                            <th>ì´ë¦„</th>
                            <th>ì „í™”</th>
                            <th style="width:50px;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        list.forEach(v => {
            // ê²€ìƒ‰ í•„í„°ë§ì„ ìœ„í•´ data-search ì†ì„±ì— ê²€ìƒ‰ í‚¤ì›Œë“œ(ì´ë¦„+ì „í™”ë²ˆí˜¸) ì‹¬ì–´ë‘ 
            const searchKey = `${v._view_name}|${v._view_phone}`.toLowerCase();
            
            html += `
                <tr class="voter-row" data-search="${searchKey}" style="cursor:pointer;" onclick="openVoterInfo('${v.member_no}', '${v.district_id}')">
                    <td>${v.member_no}</td>
                    <td style="font-weight:bold; color:var(--primary-blue);">${v._view_name}</td>
                    <td>${v._view_phone || '-'}</td>
                    <td><button class="btn btn-sm btn-outline" style="padding:2px 6px; font-size:0.7rem;">ê´€ë¦¬</button></td>
                </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        window.showModal(`${dName} ìœ ê¶Œì ëª…ë¶€`, html, null, true);
    };

    // [ì‹ ê·œ] ëª…ë¶€ ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ í•„í„°ë§ í•¨ìˆ˜
    window.filterVoterList = () => {
        const input = document.getElementById('voter-list-search');
        if(!input) return;
        
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll('.voter-row');

        rows.forEach(row => {
            const key = row.getAttribute('data-search');
            if (key.includes(filter)) {
                row.style.display = ''; // ë³´ì´ê¸°
            } else {
                row.style.display = 'none'; // ìˆ¨ê¸°ê¸°
            }
        });
    };
// -----------------------------------------------------------
    // [ì‹ ê·œ] ìœ ê¶Œì ìƒì„¸ ê´€ë¦¬ ë° CRUD (ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ) ë¡œì§
    // -----------------------------------------------------------

// [ë³€ìˆ˜ ì„ ì–¸ë¶€ ìˆ˜ì •] ê¸°ì¡´ targetVoterMemberId ëŒ€ì‹  ì´ê±¸ ì‚¬ìš©í•©ë‹ˆë‹¤.
    let targetVoterState = { 
        memberNo: null, 
        currentDistrictId: null 
    };
window.openVoterInfo = async (memberNo, currentDistrictId) => {
        // [í•µì‹¬] í˜„ì¬ ìˆ˜ì •í•˜ë ¤ëŠ” ëŒ€ìƒì˜ IDì™€ 'í˜„ì¬ ì„ ê±°êµ¬ ID'ë¥¼ ê°™ì´ ì €ì¥
        targetVoterState = { memberNo: memberNo, currentDistrictId: currentDistrictId };

        const modal = document.getElementById('voter-detail-modal');
        const body = document.getElementById('voter-detail-body');
        const distSelect = document.getElementById('detail-district-select');
        
        body.innerHTML = 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        modal.style.display = 'flex';

        try {
            // 1. ì¡°í•©ì› ìƒì„¸ ì •ë³´ ì¡°íšŒ
            const { data: member, error } = await supabase
                .from('coop_members')
                .select('*')
                .eq('member_id', memberNo)
                .single();

            if (error) throw error;

            // 2. ì •ë³´ í‘œì‹œ
            body.innerHTML = `
                <table style="width:100%; border-collapse:collapse;">
                    <tr><td style="color:#666; width:80px;">ì´ë¦„</td> <td><strong>${member.name}</strong></td></tr>
                    <tr><td style="color:#666;">ì—°ë½ì²˜</td> <td>${member.phone}</td></tr>
                    <tr><td style="color:#666;">ì£¼ì†Œ</td> <td>${member.address || '(ì •ë³´ ì—†ìŒ)'}</td></tr>
                    <tr><td style="color:#666;">ìƒíƒœ</td> <td><span class="status-badge" style="background:${member.status === 'active' ? 'green' : 'gray'}">${member.status}</span></td></tr>
                </table>
            `;

            // 3. ì„ ê±°êµ¬ Select ì˜µì…˜ ìƒì„± (ë¹„ë¡€ëŒ€í‘œëŠ” ë³€ê²½ ëŒ€ìƒì—ì„œ ì œì™¸)
            distSelect.innerHTML = '';
            districtList.forEach(d => {
                // ë¹„ë¡€ëŒ€í‘œ(is_common)ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•˜ê±°ë‚˜ ë°”ê¿€ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ìˆ¨ê¹€
                if (d.is_common) return;

                const opt = document.createElement('option');
                opt.value = d.id;
                opt.text = d.name;
                
                // í˜„ì¬ ì„ ê±°êµ¬ì™€ ì¼ì¹˜í•˜ë©´ ì„ íƒë¨
                if (String(d.id) === String(currentDistrictId)) opt.selected = true;
                distSelect.appendChild(opt);
            });

            // 4. ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
            document.getElementById('btn-update-district').onclick = updateVoterDistrict;
            document.getElementById('btn-delete-voter').onclick = deleteVoter;

        } catch (e) {
            console.error(e);
            body.innerHTML = `<p style="color:red;">ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</p>`;
        }
    };

    window.closeVoterDetailModal = () => {
        document.getElementById('voter-detail-modal').style.display = 'none';
        targetVoterMemberId = null;
    };

// [ìˆ˜ì •ë¨] ì„ ê±°êµ¬ ë³€ê²½ (Update Conflict í•´ê²° ë° ì´ë©”ì¼ ë¡œê¹…)
    async function updateVoterDistrict() {
        // ì €ì¥í•´ë‘” ìƒíƒœê°’ ê°€ì ¸ì˜¤ê¸°
        const { memberNo, currentDistrictId } = targetVoterState;
        
        if (!memberNo || !currentDistrictId) {
            alert("ìˆ˜ì •í•  ëŒ€ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const newDistrictId = document.getElementById('detail-district-select').value;
        
        // ë³€ê²½ëœ ê²Œ ì—†ìœ¼ë©´ ì¤‘ë‹¨
        if (String(newDistrictId) === String(currentDistrictId)) {
            alert("ë³€ê²½ëœ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        if (!confirm('ì„ ê±°êµ¬ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            // [í•µì‹¬] district_id ì¡°ê±´ ì¶”ê°€ (ë™ëª…ì´ì¸ì´ë‚˜ ì¤‘ë³µ ë°ì´í„° ë°©ì§€)
            const { error } = await supabase
                .from('election_voters')
                .update({ district_id: newDistrictId })
                .eq('election_id', currentElectionId)
                .eq('member_no', memberNo)
                .eq('district_id', currentDistrictId); 

            if (error) throw error;

            alert('ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ëª¨ë‹¬ ë‹«ê¸° ë° ì´ˆê¸°í™”
            document.getElementById('voter-detail-modal').style.display = 'none';
            window.closeModal(); // ë’¤ì— ìˆëŠ” ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ë„ ë‹«ê¸°
            loadVoterStats(); // ì „ì²´ ëª…ë¶€ ìƒˆë¡œê³ ì¹¨
            
            // [ìˆ˜ì •] ë¡œê·¸ì— ì‘ì—…ì ì´ë©”ì¼ í¬í•¨
            await service.logAction(currentElectionId, 'VOTER_UPDATE', `ìœ ê¶Œì(${memberNo}) ì„ ê±°êµ¬ ë³€ê²½ (ì‘ì—…ì: ${currentUserEmail})`);
            loadLogs();

        } catch (e) {
            console.error(e);
            alert('ë³€ê²½ ì‹¤íŒ¨: ' + e.message);
        }
    }

// [ìˆ˜ì •ë¨] ëª…ë¶€ ì‚­ì œ (ë¹„ë¡€ í¬í•¨ ì „ì²´ ì‚­ì œ ë° ì´ë©”ì¼ ë¡œê¹…)
    async function deleteVoter() {
        const { memberNo } = targetVoterState;
        if (!memberNo) return;

        if (!confirm('ì •ë§ ì´ ìœ ê¶Œìë¥¼ ëª…ë¶€ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì§€ì—­êµ¬ ë° ë¹„ë¡€ëŒ€í‘œ íˆ¬í‘œê¶Œì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.)')) return;

        try {
            // í•´ë‹¹ ì„ ê±°ì—ì„œ ì´ ì‚¬ëŒì˜ ëª¨ë“  í‘œ(ì§€ì—­+ë¹„ë¡€)ë¥¼ ì‚­ì œ
            const { error } = await supabase
                .from('election_voters')
                .delete()
                .eq('election_id', currentElectionId)
                .eq('member_no', memberNo);

            if (error) throw error;

            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            document.getElementById('voter-detail-modal').style.display = 'none';
            window.closeModal();
            loadVoterStats();

            // [ìˆ˜ì •] ë¡œê·¸ì— ì‘ì—…ì ì´ë©”ì¼ í¬í•¨
            await service.logAction(currentElectionId, 'VOTER_DELETE', `ìœ ê¶Œì(${memberNo}) ëª…ë¶€ ì‚­ì œ (ì‘ì—…ì: ${currentUserEmail})`);
            loadLogs();

        } catch (e) {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
        }
    }

window.openAddVoterModal = () => {
        const modal = document.getElementById('add-voter-modal');
        const distSelect = document.getElementById('add-voter-district-select');
        const resultArea = document.getElementById('search-result-area');
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.getElementById('search-member-input').value = '';
        resultArea.innerHTML = '<div style="color:#999; text-align:center; padding-top:20px;">ì´ë¦„ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰í•˜ì„¸ìš”.</div>';
        
        // ì„ ê±°êµ¬ ì˜µì…˜ ì±„ìš°ê¸° (ë¹„ë¡€ëŒ€í‘œëŠ” ì œì™¸)
        distSelect.innerHTML = '<option value="">-- ì„ ê±°êµ¬ ì„ íƒ --</option>';
        districtList.forEach(d => {
            if (d.is_common) return; // ë¹„ë¡€ëŠ” ìë™ ì¶”ê°€ë˜ë¯€ë¡œ ì„ íƒì§€ì—ì„œ ì œì™¸

            const opt = document.createElement('option');
            opt.value = d.id;
            opt.text = d.name;
            distSelect.appendChild(opt);
        });

        modal.style.display = 'flex';
    };

window.searchMembers = async () => {
        const keyword = document.getElementById('search-member-input').value.trim();
        const resultArea = document.getElementById('search-result-area');

        if (keyword.length < 2) {
            alert("ê²€ìƒ‰ì–´ë¥¼ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        resultArea.innerHTML = 'ê²€ìƒ‰ ì¤‘...';

        try {
            // [í•µì‹¬ ìˆ˜ì •] selectì— 'id' (UUID)ë¥¼ ë°˜ë“œì‹œ í¬í•¨
            const { data: members, error } = await supabase
                .from('coop_members')
                .select('member_id, id, name, phone, address') 
                .or(`name.ilike.%${keyword}%,phone.ilike.%${keyword}%`)
                .limit(20);

            if (error) throw error;

            if (!members || members.length === 0) {
                resultArea.innerHTML = '<p style="text-align:center; color:#666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ê²€ìƒ‰ëœ ì‚¬ëŒë“¤ì˜ í˜„ì¬ ë“±ë¡ ìƒíƒœ í™•ì¸
            const searchedMemberNos = members.map(m => m.member_id);
            const { data: registeredData } = await supabase
                .from('election_voters')
                .select('member_no, district_id')
                .eq('election_id', currentElectionId)
                .in('member_no', searchedMemberNos);

            // ë“±ë¡ëœ ì •ë³´ë¥¼ ë§µí•‘ (ì´ë¯¸ ë“±ë¡ëœ ì‚¬ëŒì€ ì„ ê±°êµ¬ ì´ë¦„ í‘œì‹œ)
            const regMap = {};
            if(registeredData) {
                registeredData.forEach(r => {
                    const dInfo = districtList.find(d => d.id === r.district_id);
                    // ë¹„ë¡€ê°€ ì•„ë‹Œ ì§€ì—­êµ¬ ì´ë¦„ì„ ìš°ì„ ì ìœ¼ë¡œ í‘œì‹œ
                    if(dInfo && !dInfo.is_common) regMap[r.member_no] = dInfo.name;
                    else if(!regMap[r.member_no]) regMap[r.member_no] = '(ë¹„ë¡€/ê¸°íƒ€)';
                });
            }

            // ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ HTML ìƒì„±
            let html = '<ul style="list-style:none; padding:0; margin:0;">';
            
            members.forEach(m => {
                const registeredDistrict = regMap[m.member_id];
                const isRegistered = !!registeredDistrict;
                
                // [í•µì‹¬ ìˆ˜ì •] addVoterToElection í•¨ìˆ˜ì— m.id (UUID)ë¥¼ 3ë²ˆì§¸ ì¸ìë¡œ ì „ë‹¬
                html += `
                    <li style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:${isRegistered ? '#f9fafb' : 'white'};">
                        <div style="opacity:${isRegistered ? 0.6 : 1}">
                            <strong>${m.name}</strong> <span style="font-size:0.8rem; color:#666;">(${m.phone || 'ì „í™”ì—†ìŒ'})</span><br>
                            <span style="font-size:0.75rem; color:#999;">${m.address || 'ì£¼ì†Œì—†ìŒ'}</span>
                        </div>
                        <div>
                            ${isRegistered 
                                ? `<span class="status-badge" style="background:#6b7280; font-size:0.75rem;">${registeredDistrict} ë“±ë¡ë¨</span>` 
                                : `<button onclick="addVoterToElection('${m.member_id}', '${m.name}', '${m.id}')" class="btn btn-sm btn-primary">ì„ íƒ</button>`
                            }
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            resultArea.innerHTML = html;

        } catch (e) {
            console.error(e);
            resultArea.innerHTML = `<p style="color:red;">ì˜¤ë¥˜: ${e.message}</p>`;
        }
    };

// [ìˆ˜ì •ë¨] ëª…ë¶€ ë“±ì¬ ì‹¤í–‰ (UUID í¬í•¨ Insert ë° ì´ë©”ì¼ ë¡œê¹…)
    window.addVoterToElection = async (memberNo, memberName, memberUuid) => {
        const distSelect = document.getElementById('add-voter-district-select');
        const districtId = distSelect.value;

        if (!districtId) {
            alert("ë¨¼ì € í•˜ë‹¨ì˜ [ë°°ì •í•  ì„ ê±°êµ¬]ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            distSelect.focus();
            return;
        }

        // UUID í™•ì¸ (ì—†ìœ¼ë©´ ì—ëŸ¬)
        // [ë°©ì–´ì½”ë“œ] ìë°”ìŠ¤í¬ë¦½íŠ¸ undefined ë¬¸ìì—´ ì²´í¬ ì¶”ê°€
        if (!memberUuid || memberUuid === 'undefined' || memberUuid === 'null') {
            alert("ì‹œìŠ¤í…œ ì˜¤ë¥˜: íšŒì›ì˜ ê³ ìœ  ID(UUID)ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }

        // ë¹„ë¡€ëŒ€í‘œ ì„ ê±°êµ¬ ìë™ ì°¾ê¸°
        const commonDistrict = districtList.find(d => d.is_common === true);
        
        const confirmMsg = commonDistrict
            ? `[${memberName}] ë‹˜ì„ ì„ íƒí•œ ì„ ê±°êµ¬ë¡œ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê³µí†µ ì„ ê±°êµ¬ '${commonDistrict.name}'ë„ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤)`
            : `[${memberName}] ë‹˜ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

        if (!confirm(confirmMsg)) return;

        try {
            const rowsToInsert = [];

            // 1. ì§€ì—­êµ¬ í–‰ ì¶”ê°€ (member_uuid í¬í•¨)
            rowsToInsert.push({
                election_id: currentElectionId,
                member_no: memberNo,
                district_id: districtId,
                member_uuid: memberUuid 
            });

            // 2. ë¹„ë¡€ëŒ€í‘œ í–‰ ìë™ ì¶”ê°€ (member_uuid í¬í•¨)
            if (commonDistrict) {
                rowsToInsert.push({
                    election_id: currentElectionId,
                    member_no: memberNo,
                    district_id: commonDistrict.id,
                    member_uuid: memberUuid
                });
            }

            // DB ì…ë ¥ ì‹¤í–‰
            const { error } = await supabase
                .from('election_voters')
                .insert(rowsToInsert);

            if (error) {
                // ì¤‘ë³µ ì—ëŸ¬ ì²˜ë¦¬
                if (error.code === '23505') alert("ì´ë¯¸ ë“±ë¡ëœ ì¡°í•©ì›ì…ë‹ˆë‹¤.");
                else throw error;
                return;
            }

            // ì„±ê³µ ì²˜ë¦¬
            alert(`${memberName} ë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            window.closeAddVoterModal(); // ëª¨ë‹¬ ë‹«ê¸°
            loadVoterStats(); // ëª…ë¶€ ìƒˆë¡œê³ ì¹¨
            
            // [ìˆ˜ì •] ë¡œê·¸ì— ì‘ì—…ì ì´ë©”ì¼ í¬í•¨
            await service.logAction(currentElectionId, 'VOTER_ADD', `ìœ ê¶Œì ì¶”ê°€: ${memberName}(${memberNo}) (ì‘ì—…ì: ${currentUserEmail})`);
            loadLogs(); // ë¡œê·¸ ê°±ì‹ 

        } catch (e) {
            console.error(e);
            alert("ì¶”ê°€ ì‹¤íŒ¨: " + e.message);
        }
    };
    
    // -----------------------------------------------------------
    // [6] ê¸°íƒ€ ê¸°ì¡´ í•¨ìˆ˜ (í›„ë³´, ì‹¬ì‚¬, ê¸°í˜¸ ë“± - ìœ ì§€)
    // -----------------------------------------------------------
async function loadCandidates() {
        const list = await service.getCandidates(currentElectionId);
        
        // í†µê³„ ê°±ì‹ 
        const stats = { total: list.length, pending: 0, approved: 0, rejected: 0 };
        list.forEach(c => {
             if (c.status === 'PENDING') stats.pending++;
             else if (c.status === 'APPROVED') stats.approved++;
             else if (c.status === 'REJECTED') stats.rejected++;
        });
        document.getElementById('stat-total').innerText = stats.total;
        document.getElementById('stat-pending').innerText = stats.pending;
        document.getElementById('stat-approved').innerText = stats.approved;
        document.getElementById('stat-rejected').innerText = stats.rejected;

        const tbody = document.getElementById('candidate-list-body');
        tbody.innerHTML = '';
        
        list.forEach(c => {
            const dName = cachedDistricts[c.district_id] || c.districts?.name || '-';
            
            // ìƒíƒœë³„ ë±ƒì§€ ìŠ¤íƒ€ì¼
            let statusBadge = `<span class="status-badge" style="background:#999">${c.status}</span>`;
            if(c.status === 'PENDING') statusBadge = `<span class="status-badge" style="background:var(--warning-yellow)">ëŒ€ê¸°ì¤‘</span>`;
            if(c.status === 'APPROVED') statusBadge = `<span class="status-badge" style="background:var(--success-green)">ìŠ¹ì¸ë¨</span>`;
            if(c.status === 'REJECTED') statusBadge = `<span class="status-badge" style="background:var(--danger-red)">ë°˜ë ¤ë¨</span>`;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${dName}</td>
                <td>
                    <a href="#" onclick="openCandidateDetail('${c.id}'); return false;" 
                       style="font-weight:bold; color:var(--primary-blue); text-decoration:underline;">
                       ${c.name}
                    </a>
                </td>
                <td>${statusBadge}</td>
                <td>${c.status === 'APPROVED' ? `<input type="text" class="input-symbol" data-id="${c.id}" value="${c.symbol || ''}" style="width:50px; text-align:center;">` : '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

// [ìˆ˜ì •ë¨] í›„ë³´ì ìƒì„¸ ëª¨ë‹¬ ì—´ê¸° (íŒŒì¼ URL ìƒì„± ë¡œì§ ì¶”ê°€)
    window.openCandidateDetail = async (candidateId) => {
        const modal = document.getElementById('candidate-detail-modal');
        const body = document.getElementById('cand-detail-body');
        const actionArea = document.getElementById('cand-action-area');
        
        body.innerHTML = '<div style="text-align:center; padding:2rem;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        modal.style.display = 'flex';

        try {
            // 1. í›„ë³´ì ì •ë³´ ì¡°íšŒ
            const { data: c, error } = await supabase
                .from('candidates')
                .select('*')
                .eq('id', candidateId)
                .single();

            if (error) throw error;

            // -----------------------------------------------------------
            // [í•µì‹¬ ìˆ˜ì •] íŒŒì¼ ê²½ë¡œ -> ì‹¤ì œ ì ‘ì† ê°€ëŠ¥í•œ URL(Signed URL)ë¡œ ë³€í™˜
            // -----------------------------------------------------------
            
            // âš ï¸ ì£¼ì˜: 'uploads'ëŠ” Supabase Storageì˜ ë²„í‚· ì´ë¦„ì…ë‹ˆë‹¤. ì‹¤ì œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.
            // ì˜ˆ: 'candidate_files', 'images' ë“±
            const BUCKET_NAME = 'candidate_proofs'; 

            let photoSrc = 'https://via.placeholder.com/150?text=No+Photo';
            let proofLink = '<span style="color:#999;">ì œì¶œëœ ì„œë¥˜ ì—†ìŒ</span>';

            // (1) ì‚¬ì§„ URL ë³€í™˜
            if (c.photo_url) {
                // ë§Œì•½ DBì— ì´ë¯¸ httpë¡œ ì‹œì‘í•˜ëŠ” ì „ì²´ ì£¼ì†Œê°€ ë“¤ì–´ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                if (c.photo_url.startsWith('http')) {
                    photoSrc = c.photo_url;
                } else {
                    // ê²½ë¡œë§Œ ìˆë‹¤ë©´ ì„œëª…ëœ URL ìƒì„± (ìœ íš¨ì‹œê°„ 1ì‹œê°„)
                    const { data: photoData } = await supabase
                        .storage
                        .from(BUCKET_NAME)
                        .createSignedUrl(c.photo_url, 3600);
                    if (photoData) photoSrc = photoData.signedUrl;
                }
            }

            // (2) ì¦ë¹™ì„œë¥˜ URL ë³€í™˜
            if (c.proof_url) {
                let finalProofUrl = '';
                if (c.proof_url.startsWith('http')) {
                    finalProofUrl = c.proof_url;
                } else {
                    const { data: proofData } = await supabase
                        .storage
                        .from(BUCKET_NAME)
                        .createSignedUrl(c.proof_url, 3600);
                    if (proofData) finalProofUrl = proofData.signedUrl;
                }

                if (finalProofUrl) {
                    proofLink = `<a href="${finalProofUrl}" target="_blank" class="btn btn-sm btn-outline">ğŸ“‚ ì¦ë¹™ì„œë¥˜</a>`;
                }
            }
            // -----------------------------------------------------------

            // HTML êµ¬ì„±
            body.innerHTML = `
                <div style="display:flex; gap:2rem; flex-wrap:wrap;">
                    <div style="flex:0 0 150px; text-align:center;">
                        <img src="${photoSrc}" style="width:150px; height:150px; object-fit:cover; border-radius:12px; border:1px solid #ddd; margin-bottom:10px;">
                        <div>${proofLink}</div>
                    </div>
                    <div style="flex:1;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.95rem;">
                            <tr style="border-bottom:1px solid #eee;"><td style="padding:8px; color:#666; width:80px;">ì„±ëª…</td><td style="font-weight:bold;">${c.name}</td></tr>
                            <tr style="border-bottom:1px solid #eee;"><td style="padding:8px; color:#666;">ìƒë…„ì›”ì¼</td><td>${c.birth_date || '-'}</td></tr>
                            <tr style="border-bottom:1px solid #eee;"><td style="padding:8px; color:#666;">ì—°ë½ì²˜</td><td>${c.contact || '-'}</td></tr>
                            <tr style="border-bottom:1px solid #eee;"><td style="padding:8px; color:#666;">ì£¼ì†Œ</td><td>${c.address || '-'}</td></tr>
                            <tr><td style="padding:8px; color:#666;">ë“±ë¡ì¼</td><td>${new Date(c.created_at).toLocaleString()}</td></tr>
                        </table>
                    </div>
                </div>

                <div style="margin-top:1.5rem;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">ëŒ€í‘œ ì´ë ¥</label>
                    <div style="background:#f9fafb; padding:10px; border-radius:6px; border:1px solid #eee; white-space:pre-wrap;">${c.career || 'ë‚´ìš© ì—†ìŒ'}</div>
                </div>

                <div style="margin-top:1rem;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">ê³µì•½ ë° ì¶œë§ˆì˜ ë³€</label>
                    <div style="background:#f9fafb; padding:10px; border-radius:6px; border:1px solid #eee; white-space:pre-wrap;">${c.manifesto || 'ë‚´ìš© ì—†ìŒ'}</div>
                </div>

                ${c.status === 'REJECTED' ? `
                    <div style="margin-top:1rem; padding:10px; background:#fef2f2; border:1px solid #fecaca; border-radius:6px; color:#dc2626;">
                        <strong>â›” ë°˜ë ¤ ì‚¬ìœ :</strong> ${c.rejection_reason || 'ì‚¬ìœ  ë¯¸ê¸°ì¬'}
                    </div>
                ` : ''}
            `;

            // í•˜ë‹¨ ë²„íŠ¼ êµ¬ì„± (ìƒíƒœì— ë”°ë¼ ë‹¤ë¥´ê²Œ)
            if (c.status === 'PENDING') {
                actionArea.innerHTML = `
                    <button onclick="confirmApprove('${c.id}', '${c.name}')" class="btn btn-primary" style="flex:1;">âœ… ìŠ¹ì¸í•˜ê¸°</button>
                    <button onclick="openRejectModal('${c.id}', '${c.name}')" class="btn btn-danger" style="flex:1;">â›” ë°˜ë ¤í•˜ê¸°</button>
                `;
            } else if (c.status === 'APPROVED') {
                actionArea.innerHTML = `
                    <button onclick="openRejectModal('${c.id}', '${c.name}')" class="btn btn-danger" style="width:100%;">â›” ìŠ¹ì¸ ì·¨ì†Œ ë° ë°˜ë ¤</button>
                `;
            } else { // REJECTED
                actionArea.innerHTML = `
                    <button onclick="confirmApprove('${c.id}', '${c.name}')" class="btn btn-primary" style="width:100%;">ğŸ”„ ì¬ì‹¬ì‚¬ (ìŠ¹ì¸ ì²˜ë¦¬)</button>
                `;
            }

        } catch (e) {
            console.error(e);
            body.innerHTML = `<p style="color:red;">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${e.message}</p>`;
        }
    };

    window.closeCandidateDetail = () => {
        document.getElementById('candidate-detail-modal').style.display = 'none';
    };
// [ì‹ ê·œ] ê¸°í˜¸ ëœë¤ ì¶”ì²¨ ë° í™”ë©´ ë°˜ì˜ í•¨ìˆ˜ (DB ì €ì¥ ì•ˆí•¨, í”„ë¦¬ë·° ìš©ë„)
window.assignRandomSymbols = async () => {
    // 1. ì‚¬ì „ ê²½ê³ 
    if (!confirm("ë¹„ë¡€ëŒ€í‘œ(ì°¬/ë°˜)ë¥¼ ì œì™¸í•œ ëª¨ë“  ì§€ì—­êµ¬ í›„ë³´ì˜ ê¸°í˜¸ë¥¼\në¬´ì‘ìœ„ë¡œ ì¶”ì²¨í•˜ì—¬ í™”ë©´ì— í‘œì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì£¼ì˜: ê¸°ì¡´ì— ì…ë ¥ëœ ê¸°í˜¸ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ì €ì¥ì€ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)")) {
        return;
    }

    try {
        // 2. í˜„ì¬ ë“±ë¡ëœ í›„ë³´ì ì „ì²´ ê°€ì ¸ì˜¤ê¸° (ë°ì´í„° ì •í™•ì„±ì„ ìœ„í•´ ì¬ì¡°íšŒ)
        const candidates = await service.getCandidates(currentElectionId);

        // 3. ë¹„ë¡€ëŒ€í‘œ(is_common=true) ì„ ê±°êµ¬ ID ì°¾ê¸°
        // (districtListëŠ” init í•¨ìˆ˜ ì‹¤í–‰ ì‹œ ë¡œë“œëœ ì „ì—­ ë³€ìˆ˜ë¥¼ í™œìš©)
        const commonDistrictIds = districtList
            .filter(d => d.is_common === true)
            .map(d => d.id);

        // 4. ì§€ì—­êµ¬ë³„ë¡œ í›„ë³´ì ê·¸ë£¹í™” (Grouping)
        const groups = {};
        
        candidates.forEach(c => {
            // (1) ìŠ¹ì¸ëœ í›„ë³´ë§Œ ëŒ€ìƒ
            if (c.status !== 'APPROVED') return;
            // (2) ë¹„ë¡€ëŒ€í‘œ ì„ ê±°êµ¬ ì†Œì†ì´ë©´ ì œì™¸
            if (commonDistrictIds.includes(c.district_id)) return;

            if (!groups[c.district_id]) {
                groups[c.district_id] = [];
            }
            groups[c.district_id].push(c);
        });

        // 5. ê·¸ë£¹ë³„ ì…”í”Œ ë° ë²ˆí˜¸ ë¶€ì—¬ (Fisher-Yates Shuffle)
        let totalAssigned = 0;

        for (const [distId, list] of Object.entries(groups)) {
            // ë¬´ì‘ìœ„ ì„ê¸°
            for (let i = list.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [list[i], list[j]] = [list[j], list[i]];
            }

            // ì„ì¸ ìˆœì„œëŒ€ë¡œ í™”ë©´ì˜ input ê°’ ë³€ê²½
            list.forEach((c, index) => {
                const symbolNum = index + 1; // 1ë²ˆë¶€í„° ì‹œì‘
                
                // í™”ë©´ì— ìˆëŠ” í•´ë‹¹ í›„ë³´ì˜ ì…ë ¥ì°½ ì°¾ê¸° (data-id ì†ì„± í™œìš©)
                const inputEl = document.querySelector(`.input-symbol[data-id="${c.id}"]`);
                
                if (inputEl) {
                    inputEl.value = symbolNum;
                    // ë³€ê²½ë¨ì„ ì‹œê°ì ìœ¼ë¡œ ì•Œë¦¼ (ë…¸ë€ìƒ‰ ë°°ê²½ ê¹œë¹¡ì„ íš¨ê³¼ ë“±)
                    inputEl.style.backgroundColor = '#fff3cd'; 
                    inputEl.style.transition = 'background 0.5s';
                    totalAssigned++;
                }
            });
        }

        alert(`ì´ ${totalAssigned}ëª…ì˜ í›„ë³´ì—ê²Œ ëœë¤ ê¸°í˜¸ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ë°˜ë“œì‹œ [ê¸°í˜¸ ì €ì¥] ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì •í•´ì£¼ì„¸ìš”.`);

    } catch (e) {
        console.error(e);
        alert("ê¸°í˜¸ ì¶”ì²¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
    }
}; // End of assignRandomSymbols
    
    // [ì‹ ê·œ] ìŠ¹ì¸ ì²˜ë¦¬ ë¡œì§ (ì§ì ‘ DB ì—…ë°ì´íŠ¸)
    window.confirmApprove = async (id, name) => {
        if(!confirm(`[${name}] í›„ë³´ë¥¼ ì •ì‹ í›„ë³´ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const { error } = await supabase
                .from('candidates')
                .update({ 
                    status: 'APPROVED',
                    rejection_reason: null // ìŠ¹ì¸ ì‹œ ë°˜ë ¤ ì‚¬ìœ  ì´ˆê¸°í™”
                })
                .eq('id', id);

            if(error) throw error;

            alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeCandidateDetail();
            loadCandidates(); // ëª©ë¡ ê°±ì‹ 
            
            // ë¡œê·¸ ê¸°ë¡
            await service.logAction(currentElectionId, 'CANDIDATE_APPROVE', `í›„ë³´ ìŠ¹ì¸: ${name} (ì‘ì—…ì: ${currentUserEmail})`);
            loadLogs();

        } catch(e) {
            alert('ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message);
        }
    };

    // [ì‹ ê·œ] ë°˜ë ¤ ëª¨ë‹¬ ì—´ê¸°
    let targetRejectId = null;
    let targetRejectName = null;

    window.openRejectModal = (id, name) => {
        targetRejectId = id;
        targetRejectName = name;
        document.getElementById('reject-reason-input').value = ''; // ì´ˆê¸°í™”
        document.getElementById('reject-reason-modal').style.display = 'flex';
    };

    window.closeRejectModal = () => {
        document.getElementById('reject-reason-modal').style.display = 'none';
        targetRejectId = null;
    };

    // [ì‹ ê·œ] ë°˜ë ¤ í™•ì • ë¡œì§ (ì‚¬ìœ  í¬í•¨)
    document.getElementById('btn-confirm-reject').onclick = async () => {
        const reason = document.getElementById('reject-reason-input').value.trim();
        
        if(!reason) {
            alert('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if(!confirm(`[${targetRejectName}] í›„ë³´ë¥¼ ë°˜ë ¤ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const { error } = await supabase
                .from('candidates')
                .update({ 
                    status: 'REJECTED',
                    rejection_reason: reason 
                })
                .eq('id', targetRejectId);

            if(error) throw error;

            alert('ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeRejectModal();
            closeCandidateDetail(); // ìƒì„¸ ì°½ë„ ë‹«ê¸°
            loadCandidates(); // ëª©ë¡ ê°±ì‹ 

            // ë¡œê·¸ ê¸°ë¡
            await service.logAction(currentElectionId, 'CANDIDATE_REJECT', `í›„ë³´ ë°˜ë ¤: ${targetRejectName} / ì‚¬ìœ : ${reason} (ì‘ì—…ì: ${currentUserEmail})`);
            loadLogs();

        } catch(e) {
            alert('ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message);
        }
    };

window.reviewCand = async (id, decision, name) => {
        if(confirm(`${name} -> ${decision} ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
            await service.reviewCandidate(id, decision);
            
            // [ìˆ˜ì •] ë¡œê·¸ì— ì‘ì—…ì ì´ë©”ì¼ ì¶”ê°€
            await service.logAction(currentElectionId, 'CANDIDATE_REVIEW', `${name} ${decision} ì²˜ë¦¬ (ì‘ì—…ì: ${currentUserEmail})`);
            
            loadCandidates(); 
            loadLogs();
        }
    };

window.saveSymbols = async () => {
        const inputs = document.querySelectorAll('.input-symbol');
        let count = 0;
        for (const input of inputs) {
            if (input.value) {
                await service.updateSymbol(input.dataset.id, input.value);
                count++;
            }
        }
        alert(`${count}ê±´ ì €ì¥ ì™„ë£Œ`);
        
        // [ìˆ˜ì •] ë¡œê·¸ì— ì‘ì—…ì ì´ë©”ì¼ ì¶”ê°€
        await service.logAction(currentElectionId, 'SYMBOL_UPDATE', `ê¸°í˜¸ ${count}ê±´ ì €ì¥ (ì‘ì—…ì: ${currentUserEmail})`);
        
        loadCandidates();
        loadLogs(); // ë¡œê·¸ ì¦‰ì‹œ ê°±ì‹ ì„ ìœ„í•´ ì¶”ê°€
    };
// [ì‹ ê·œ] í›„ë³´ í™•ì • ë° ë‹¤ìŒ ë‹¨ê³„(READY) ì´ë™ ë¡œì§
window.finalizeNomination = async () => {
    // 1. ì•ˆì „ì¥ì¹˜: ëŒ€ê¸° ì¤‘ì¸ í›„ë³´ê°€ ìˆëŠ”ì§€ í†µê³„ ê°’ìœ¼ë¡œ í™•ì¸
    const pendingCount = parseInt(document.getElementById('stat-pending').innerText || '0');
    
    if (pendingCount > 0) {
        alert("âš ï¸ ì•„ì§ ìŠ¹ì¸ ëŒ€ê¸°(PENDING) ìƒíƒœì¸ í›„ë³´ê°€ ìˆìŠµë‹ˆë‹¤.\n\nëª¨ë“  í›„ë³´ë¥¼ 'ìŠ¹ì¸'í•˜ê±°ë‚˜ 'ë°˜ë ¤' ì²˜ë¦¬í•œ ë’¤ì—ë§Œ\në‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
    }

    // 2. ê²½ê³  ë©”ì‹œì§€ êµ¬ì„± (HTML)
    const warningMsg = `
        <div style="text-align: left; background: #fff1f2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca;">
            <p style="color: #dc2626; font-weight: 800; font-size: 1.1rem; margin-top: 0;">â›” ì£¼ì˜: ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</p>
            <p style="margin-bottom: 5px;">í˜„ì¬ ë“±ë¡ëœ í›„ë³´ìì™€ ê¸°í˜¸ ë²ˆí˜¸ë¥¼ ìµœì¢… í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <ul style="font-size: 0.9rem; color: #4b5563; padding-left: 20px;">
                <li>í™•ì¸ ì‹œ <strong>[READY: ì¤€ë¹„ ì™„ë£Œ]</strong> ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</li>
                <li>ì´í›„ì—ëŠ” <strong>í›„ë³´ ì¶”ê°€, ê¸°í˜¸ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥</strong>í•©ë‹ˆë‹¤.</li>
                <li>ìœ ê¶Œìì—ê²Œ í›„ë³´ì ëª…ë‹¨ì´ ê³µê°œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            </ul>
        </div>
        <p style="text-align: center; margin-top: 15px; font-weight: bold;">ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    `;

    // 3. ëª¨ë‹¬ í˜¸ì¶œ ë° ì‹¤í–‰
    window.showModal('ğŸš€ í›„ë³´ í™•ì • ë° ë‹¨ê³„ ì´ë™', warningMsg, async () => {
        try {
            // ìƒíƒœ ì—…ë°ì´íŠ¸: READY
            await service.updateStatus(currentElectionId, 'READY');
            
            // ë¡œê·¸ ê¸°ë¡
            await service.logAction(
                currentElectionId, 
                'PHASE_CHANGE', 
                `ë‹¨ê³„ ë³€ê²½: í›„ë³´í™•ì •(NOMINATION) -> ì¤€ë¹„ì™„ë£Œ(READY) (ì‘ì—…ì: ${currentUserEmail})`
            );

            alert("âœ… í›„ë³´ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ìŒ íƒ­(í™•ì • ë° ê³µí¬)ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");

            // ë°ì´í„° ê°±ì‹  ë° UI íƒ­ ì „í™˜
            await loadElectionInfo();
            updateWorkflowUI();

        } catch (e) {
            console.error(e);
            alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: " + e.message);
        }
    });
}; // End of finalizeNomination
// [ìˆ˜ì •] ì•¡ì…˜ í™•ì¸ ë° ì‹¤í–‰ (ì‹œê°„ ì²´í¬ ê¸°ëŠ¥ í¬í•¨ + ì´ë©”ì¼ ë¡œê¹…)
    window.confirmAction = (nextStatus, msg) => {
        // 1. íˆ¬í‘œ ì‹œì‘(OPEN) ì‹œë„ ì‹œ ì‹œê°„ ì²´í¬ ë¡œì§
        if (nextStatus === 'OPEN') {
            // ì‹œì‘ ì‹œê°„ì´ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (!currentElectionData.vote_start_at) {
                alert("ì˜¤ë¥˜: íˆ¬í‘œ ì‹œì‘ ì‹œê°„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const now = new Date();
            const startAt = new Date(currentElectionData.vote_start_at);

            // í˜„ì¬ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì´ì „ì¸ ê²½ìš° (ì•„ì§ ë•Œê°€ ì•„ë‹˜)
            if (now < startAt) {
                // ë‚¨ì€ ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
                const diffMin = Math.ceil((startAt - now) / (1000 * 60));
                
                // ê²½ê³  ë° í™•ì¸ (ê°•ì œ ì§„í–‰ ì—¬ë¶€ ë¬»ê¸°)
                const userConfirmed = confirm(
                    `âš ï¸ ì£¼ì˜: ì•„ì§ íˆ¬í‘œ ì‹œì‘ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.\n` +
                    `ì„¤ì •ëœ ì‹œì‘ ì‹œê°„: ${startAt.toLocaleString()}\n` +
                    `ì•½ ${diffMin}ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤.\n\n` +
                    `ê·¸ë˜ë„ ì§€ê¸ˆ ê°•ì œë¡œ íˆ¬í‘œë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                );
                
                // ì·¨ì†Œí•˜ë©´ ì¤‘ë‹¨
                if (!userConfirmed) return;
            }
        }

        // 2. ìƒíƒœ ë³€ê²½ ì‹¤í–‰ (ëª¨ë‹¬ ë„ìš°ê¸°)
        window.showModal('ìƒíƒœ ë³€ê²½ í™•ì¸', msg, async () => {
            try {
                // ìƒíƒœ ì—…ë°ì´íŠ¸ ìš”ì²­
                await service.updateStatus(currentElectionId, nextStatus);
                
                // ë°ì´í„° ê°±ì‹ 
                await loadElectionInfo(); // ì„ ê±° ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
                updateWorkflowUI();       // íƒ­/UI ìƒíƒœ ë³€ê²½
                
                // [ìˆ˜ì •] ë¡œê·¸ ê¸°ë¡ ì‹œ ì‘ì—…ì ì´ë©”ì¼ í¬í•¨
                await service.logAction(currentElectionId, 'STATUS_CHANGE', `ìƒíƒœ ë³€ê²½: ${nextStatus} (ì‘ì—…ì: ${currentUserEmail})`);
                
                loadLogs(); // ë¡œê·¸ ê°±ì‹ 
                
                // ëª¨ë‹¬ ë‹«ê¸°ëŠ” showModal ë‚´ë¶€ ì½œë°±ì—ì„œ ì²˜ë¦¬ë¨
            } catch (e) {
                console.error("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:", e);
                alert("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            }
        });
    };
    
    window.openVoterPreview = () => {
        window.open(`vote_login.html?id=${currentElectionId}`, '_blank');
    };

    window.loadLogs = async () => {
        const logs = await service.getLogs(currentElectionId);
        const container = document.getElementById('audit-log-container');
        container.innerHTML = '';
        logs.forEach(log => {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="log-time">${new Date(log.created_at).toLocaleTimeString()}</span> <strong>${log.action_type}</strong> ${log.details}`;
            container.appendChild(div);
        });
    };

    async function updateLiveStats() {
        if(!currentElectionId) return;
        try {
            const stats = await service.getTurnoutStats(currentElectionId);
            document.getElementById('live-turnout').innerText = `${stats.percent}%`;
            document.getElementById('live-votes').innerText = stats.current;
            document.getElementById('live-total').innerText = stats.total;
        } catch(e) {}
    }

    window.openBallotBox = () => {
         const pwd = prompt("ğŸ” ë³´ì•ˆ í™•ì¸: 'ê°œí‘œ' ì…ë ¥");
         if(pwd !== 'ê°œí‘œ') return alert('ì·¨ì†Œ');
         document.getElementById('result-display').style.display = 'block';
         alert("ê°œí‘œí•¨ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.");
         // ì—¬ê¸°ì— ì‹¤ì œ ê°œí‘œ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë¡œì§(service.getResults)ì„ ì—°ê²°í•˜ë©´ ë©ë‹ˆë‹¤.
    };
    
    // ë‹¨ìˆœ íƒ­ ì „í™˜ (ë©”ë‰´ í´ë¦­ìš©)
    window.switchTab = (tabId) => {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).style.display = 'block';
        
        const map = { 'tab-nomination':0, 'tab-ready':1, 'tab-vote':2, 'tab-result':3 };
        if(map[tabId] !== undefined) document.querySelectorAll('.step-item')[map[tabId]].classList.add('active');
    };

    function translateStatus(s) {
        const map = {
            'PREPARE': 'ì¤€ë¹„ ì¤‘', 'NOMINATION': 'í›„ë³´ ë“±ë¡', 'READY': 'ì¤€ë¹„ ì™„ë£Œ',
            'OPEN': 'íˆ¬í‘œ ì¤‘', 'PAUSED': 'ì¼ì‹œ ì •ì§€', 'CLOSED': 'íˆ¬í‘œ ë§ˆê°', 'PUBLISHED': 'ê²°ê³¼ ê³µí¬', 'ENDED': 'ì¢…ë£Œë¨'
        };
        return map[s] || s;
    }
window.init = init; // module scope export
    init();
</script>
</body>
</html>
