<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í†µí•© ì„ ê±° ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        /* [í†¤ì•¤ë§¤ë„ˆ] ìƒ‰ìƒ ë³€ìˆ˜ */
        :root {
            --admin-bg: #f8f9fa;
            --card-bg: #ffffff;
            --primary-blue: #2563eb;
            --primary-light: #eff6ff;
            --success-green: #16a34a;
            --warning-yellow: #ca8a04;
            --danger-red: #dc2626;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --border-color: #e5e7eb;
        }
 
        body { 
            background-color: var(--admin-bg); 
            color: var(--text-dark); 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* 1. ê°œì„ ëœ í—¤ë” ìŠ¤íƒ€ì¼ */
        header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* 3ë¶„í• ì„ ìœ„í•´ space-between ìœ ì§€í•˜ë˜ ê°€ìš´ë° ì •ë ¬ ê¸°ë²• ì‚¬ìš© */
            padding: 0 2rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-left { width: 200px; } /* ê· í˜•ì„ ìœ„í•œ ë¹ˆ ê³µê°„ */
        .header-center { 
            flex-grow: 1; 
            text-align: center; 
        }
        .header-center h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-blue);
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        .header-right { 
            width: 200px; 
            text-align: right; 
            display: flex; 
            justify-content: flex-end; 
            align-items: center; 
            gap: 10px;
        }

        /* ë ˆì´ì•„ì›ƒ */
        .admin-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 2rem; 
            display: grid; 
            grid-template-columns: 3fr 1fr; 
            gap: 2rem; 
        }
        @media (max-width: 768px) { .admin-container { grid-template-columns: 1fr; } }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .wizard-steps { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; }
        .step-item { 
            flex: 1; text-align: center; padding: 1rem; cursor: pointer; 
            color: var(--text-gray); font-weight: 600; 
            border-bottom: 3px solid transparent; 
            transition: all 0.2s;
        }
        .step-item.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); background: var(--primary-light); }
        .step-item:hover { background-color: #f9fafb; }

        /* ìƒíƒœ ë±ƒì§€ */
        .status-badge { padding: 6px 14px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.85rem; letter-spacing: 0.5px; }
        
        /* ë¡œê·¸ ì°½ */
        .log-window { height: 400px; overflow-y: auto; background: #1e293b; color: #10b981; padding: 1rem; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.85rem; }
        .log-entry { margin-bottom: 0.5rem; border-bottom: 1px solid #334155; padding-bottom: 0.2rem; }
        .log-time { color: #94a3b8; margin-right: 0.5rem; }

        /* í…Œì´ë¸” */
        .cand-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .cand-table th { background: #f3f4f6; color: var(--text-dark); font-weight: 600; text-align: left; padding: 1rem; border-bottom: 2px solid var(--border-color); }
        .cand-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .input-symbol { width: 60px; text-align: center; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-weight: bold; font-size: 1rem; }
        
        /* ë²„íŠ¼ ê³µí†µ */
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; font-size: 1rem; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-success { background: var(--success-green); color: white; }
        .btn-warning { background: var(--warning-yellow); color: white; }
        .btn-danger { background: var(--danger-red); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-dark); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 4px; }

        /* í†µê³„ ëŒ€ì‹œë³´ë“œ ë°•ìŠ¤ */
        .stats-box {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;
            background: var(--primary-light); padding: 1.5rem; border-radius: 8px; border: 1px solid #bfdbfe;
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary-blue); }
        .stat-label { font-size: 0.9rem; color: var(--text-gray); }

        /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ (Alert ëŒ€ì²´ìš©) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; display: block;}
        .modal-body { margin-bottom: 2rem; color: #4b5563; line-height: 1.5;}
        .modal-actions { display: flex; justify-content: center; gap: 1rem; }
        
        /* ìœ ê¶Œì ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ (Mockup) */
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: left; max-height: 400px; overflow-y: auto; padding: 10px;}
        .voter-card-mock { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem; }
        .mock-symbol { width: 40px; height: 40px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; flex-shrink: 0;}
    </style>
</head>
<body>

<header>
    <div class="header-left">
        </div>
    <div class="header-center" style="display:flex; flex-direction:column; align-items:center;">
        <span style="font-size:0.8rem; color:#666; margin-bottom:4px;">í˜„ì¬ ê´€ë¦¬ ì¤‘ì¸ ì„ ê±°</span>
        
        <select id="election-selector" onchange="changeElection(this.value)" 
                style="font-size:1.2rem; font-weight:bold; padding:5px 10px; border:1px solid #ddd; border-radius:8px; color:var(--primary-blue); cursor:pointer;">
            <option value="" disabled>ì„ ê±°ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
    </div>
    <div class="header-right">
        <span id="admin-email" style="font-weight:600; color:#374151;">ê´€ë¦¬ìë‹˜</span>
        <button class="btn btn-outline btn-sm" onclick="window.close()">ë‚˜ê°€ê¸°</button>
    </div>
</header>

    <div class="admin-container">
        
        <div class="main-panel">
            
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.5rem;">
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-size:0.85rem; color:var(--text-gray); margin-bottom:4px;">í˜„ì¬ ê´€ë¦¬ ì¤‘ì¸ ì„ ê±°</span>
                        <h3 id="election-title" style="margin:0; font-size:1.8rem;">ì„ ê±° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
                    </div>
                    <span id="election-status" class="status-badge" style="background:#999;">Loading</span>
                </div>
                <div style="color:var(--text-gray); font-size: 0.95rem;">
                    ğŸ“… ì „ì²´ ì¼ì •: <strong id="election-period">-</strong>
                </div>
            </div>

            <div class="card">
                <div class="wizard-steps">
                    <div class="step-item" onclick="switchTab('tab-nomination')">1. í›„ë³´ ë“±ë¡/ê¸°í˜¸</div>
                    <div class="step-item" onclick="switchTab('tab-ready')">2. í™•ì • ë° ê³µí¬</div>
                    <div class="step-item" onclick="switchTab('tab-vote')">3. íˆ¬í‘œ ì§„í–‰</div>
                    <div class="step-item" onclick="switchTab('tab-result')">4. ê°œí‘œ ë° ê²°ê³¼</div>
                </div>

                <div id="tab-nomination" class="tab-content">
                    <h4>ğŸ“ í›„ë³´ì ë“±ë¡ í˜„í™©</h4>
                    <p style="color:#666; font-size:0.9rem; margin-bottom: 1.5rem;">
                        í›„ë³´ ë“±ë¡ ìƒíƒœ(NOMINATION)ì¼ ë•Œ í›„ë³´ë“¤ì´ ì§€ì›ì„œë¥¼ ì œì¶œí•©ë‹ˆë‹¤.<br>
                        í›„ë³´ë¥¼ ìŠ¹ì¸í•˜ê³  ê¸°í˜¸ë¥¼ ë¶€ì—¬í•œ ë’¤ 'ì €ì¥'í•˜ì„¸ìš”.
                    </p>

                    <div class="stats-box">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-total">0</div>
                            <div class="stat-label">ì „ì²´ ì§€ì›ì</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color:var(--warning-yellow)" id="stat-pending">0</div>
                            <div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color:var(--success-green)" id="stat-approved">0</div>
                            <div class="stat-label">ìŠ¹ì¸ ì™„ë£Œ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color:var(--danger-red)" id="stat-rejected">0</div>
                            <div class="stat-label">ë°˜ë ¤ë¨</div>
                        </div>
                    </div>

                    <div style="margin-bottom:1rem; display: flex; gap: 10px;">
                        <button onclick="confirmAction('NOMINATION', 'í›„ë³´ ë“±ë¡ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ì œë¶€í„° ì…í›„ë³´ ì‹ ì²­ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.')" class="btn btn-primary">
                            â–¶ í›„ë³´ ë“±ë¡ ì‹œì‘ (NOMINATION)
                        </button>
                    </div>
                    
                    <table class="cand-table">
                        <thead>
                            <tr>
                                <th>ì„ ê±°êµ¬</th>
                                <th>ì´ë¦„</th>
                                <th>ìƒíƒœ</th>
                                <th>ê¸°í˜¸(ìˆ«ì)</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="candidate-list-body"></tbody>
                    </table>
                    <button onclick="saveSymbols()" class="btn btn-success" style="width:100%; margin-top:1.5rem;">ğŸ’¾ ê¸°í˜¸ ì¼ê´„ ì €ì¥</button>
                </div>

                <div id="tab-ready" class="tab-content" style="display:none;">
                    <h4>ğŸ“¢ í›„ë³´ì í™•ì • ë° ê³µí¬</h4>
                    <p style="color:var(--text-gray); line-height: 1.6;">
                        ëª¨ë“  í›„ë³´ì˜ ê¸°í˜¸ ë¶€ì—¬ê°€ ëë‚¬ìŠµë‹ˆê¹Œ?<br>
                        'ì¤€ë¹„ ì™„ë£Œ' ìƒíƒœê°€ ë˜ë©´ ìœ ê¶Œìë“¤ì—ê²Œ í›„ë³´ì ëª…ë¶€ê°€ ê³µê°œë©ë‹ˆë‹¤.<br>
                        <strong>ë°˜ë“œì‹œ 'ë¯¸ë¦¬ë³´ê¸°'ë¥¼ í†µí•´ ìœ ê¶Œìì—ê²Œ ì–´ë–»ê²Œ ë³´ì¼ì§€ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”.</strong>
                    </p>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeeba; padding: 1.5rem; border-radius: 8px; text-align: center;">
                        <button onclick="openVoterPreview()" class="btn btn-outline" style="margin-bottom: 1rem; border-color: #aaa;">
                            ğŸ‘ï¸ ìœ ê¶Œì í™”ë©´ ë¯¸ë¦¬ë³´ê¸° (í•„ìˆ˜)
                        </button>
                        <br>
                        <button onclick="confirmAction('READY', 'ì„ ê±° ì¤€ë¹„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ì œ ìœ ê¶Œìë“¤ì´ í›„ë³´ì ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')" class="btn btn-warning" style="padding: 1rem 2rem; font-size: 1.1rem;">
                            ğŸš€ ì„ ê±° ì¤€ë¹„ ì™„ë£Œ (READY)ë¡œ ë³€ê²½
                        </button>
                    </div>
                </div>

                <div id="tab-vote" class="tab-content" style="display:none;">
                    <h4>ğŸ—³ï¸ íˆ¬í‘œì†Œ ìš´ì˜</h4>
                    <p style="color:var(--text-gray);">ì‹¤ì œ íˆ¬í‘œë¥¼ ì‹œì‘í•˜ê±°ë‚˜ ì¢…ë£Œí•©ë‹ˆë‹¤.</p>
                    <div style="display:flex; gap:1rem; margin-bottom:2rem;">
                        <button onclick="confirmAction('OPEN', 'íˆ¬í‘œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')" class="btn btn-success" style="flex:1;">
                            â–¶ íˆ¬í‘œ ì‹œì‘ (OPEN)
                        </button>
                        <button onclick="confirmAction('PAUSED', 'íˆ¬í‘œë¥¼ ì¼ì‹œ ì •ì§€í•©ë‹ˆë‹¤.')" class="btn btn-warning" style="flex:1;">
                            â¸ ì¼ì‹œ ì •ì§€ (PAUSED)
                        </button>
                        <button onclick="confirmAction('CLOSED', 'íˆ¬í‘œë¥¼ ì™„ì „íˆ ì¢…ë£Œí•©ë‹ˆë‹¤.\nì¢…ë£Œ í›„ì—ëŠ” ë” ì´ìƒ íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')" class="btn btn-danger" style="flex:1;">
                            â¹ íˆ¬í‘œ ì¢…ë£Œ (CLOSED)
                        </button>
                    </div>
                    
                    <div style="background:#f9fafb; padding:2rem; border-radius:12px; border:1px solid #eee; text-align: center;">
                        <h5 style="margin:0; color:#6b7280;">ì‹¤ì‹œê°„ íˆ¬í‘œìœ¨ (5ì´ˆ ì£¼ê¸°)</h5>
                        <h2 id="live-turnout" style="margin: 10px 0; font-size:3.5rem; color:var(--primary-blue); font-weight: 800;">0%</h2>
                        <div style="font-size: 1.1rem; color: #374151;">
                            ì°¸ì—¬ <strong id="live-votes">0</strong>ëª… / ì´ì› <span id="live-total">0</span>ëª…
                        </div>
                    </div>
                </div>

                <div id="tab-result" class="tab-content" style="display:none;">
                    <h4>ğŸ† ê°œí‘œ ë° ê²°ê³¼ ë°œí‘œ</h4>
                    <p style="color:var(--danger-red);">* íˆ¬í‘œê°€ ì™„ì „íˆ ì¢…ë£Œ(CLOSED)ëœ í›„ì—ë§Œ ê°œí‘œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    
                    <div id="result-control">
                        <button onclick="openBallotBox()" class="btn" style="padding:1rem; background:#374151; color:white; width: 100%;">
                            ğŸ” ê°œí‘œí•¨ ì—´ê¸° (ë³´ì•ˆ í™•ì¸ í•„ìš”)
                        </button>
                    </div>

                    <div id="result-display" style="display:none; margin-top:2rem;">
                        <div id="result-chart" style="padding: 1rem; background: #f3f4f6; border-radius: 8px;"></div>
                        <hr style="margin:2rem 0; border:0; border-top:1px solid #ddd;">
                        <button onclick="confirmAction('PUBLISHED', 'ìµœì¢… ê²°ê³¼ë¥¼ ê³µí¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ìœ ê¶Œìê°€ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.')" class="btn btn-primary" style="width:100%; padding:1rem; font-size:1.2rem;">
                            ğŸ“¢ ê²°ê³¼ ìµœì¢… ê³µí¬ (PUBLISHED)
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <div class="side-panel">
            <div class="card" style="position:sticky; top:90px;">
                <h3 style="margin-top:0;">ğŸ“œ ìš´ì˜ ë¡œê·¸ (Audit)</h3>
                <div id="audit-log-container" class="log-window">
                    <div class="log-entry">ë¡œê·¸ ë¡œë”© ì¤‘...</div>
                </div>
                <button onclick="loadLogs()" class="btn btn-outline btn-sm" style="width:100%; margin-top:0.5rem;">ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>
    </div>

    <div id="common-modal" class="modal-overlay">
        <div class="modal-content">
            <span id="modal-title" class="modal-title">ì•Œë¦¼</span>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-actions" class="modal-actions">
                <button onclick="closeModal()" class="btn btn-outline">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { AdminService } from './AdminService.js';.
        import { supabase } from './ElectionService.js';
        
        const service = new AdminService();
        let currentElectionId = null;
        let cachedCandidates = []; // ë¯¸ë¦¬ë³´ê¸° ë° í†µê³„ìš© ìºì‹œ

        // [ëª¨ë‹¬ ìœ í‹¸ë¦¬í‹°]
        window.showModal = (title, contentHtml, onConfirm = null) => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = contentHtml;
            const actionDiv = document.getElementById('modal-actions');
            actionDiv.innerHTML = ''; // ì´ˆê¸°í™”

            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn btn-outline';
            closeBtn.innerText = onConfirm ? 'ì·¨ì†Œ' : 'í™•ì¸';
            closeBtn.onclick = window.closeModal;
            actionDiv.appendChild(closeBtn);

            if (onConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn btn-primary';
                confirmBtn.innerText = 'í™•ì¸';
                confirmBtn.onclick = () => { onConfirm(); window.closeModal(); };
                actionDiv.appendChild(confirmBtn);
            }
            
            document.getElementById('common-modal').style.display = 'flex';
        };

        window.closeModal = () => {
            document.getElementById('common-modal').style.display = 'none';
        };

        // 1. ì„ ê±° ë³€ê²½ í•¸ë“¤ëŸ¬ (ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ ì‹¤í–‰)
window.changeElection = async (newId) => {
    if (!newId) return;

    // ì„ íƒëœ IDë¡œ ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
    currentElectionId = newId;
    localStorage.setItem('target_election_id', newId);

    // URLë„ ë³´ê¸° ì¢‹ê²Œ ë³€ê²½ (í˜ì´ì§€ ë¦¬ë¡œë“œëŠ” ì•ˆ í•¨)
    const newUrl = `${window.location.pathname}?id=${newId}`;
    window.history.pushState({ path: newUrl }, '', newUrl);

    // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (í™”ë©´ ê°±ì‹ )
    await Promise.all([
        loadElectionInfo(),
        loadCandidates(),
        loadLogs()
    ]);
    
    // ì•Œë¦¼
    console.log(`âœ… ì„ ê±° ì „í™˜ ì™„ë£Œ: ID ${newId}`);
};

// 2. ì„ ê±° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë“œë¡­ë‹¤ìš´ ì„¸íŒ… í•¨ìˆ˜
async function loadElectionSelector() {
    try {
        // ëª¨ë“  ì„ ê±° ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (AdminServiceì— getAllElectionsê°€ ìˆì–´ì•¼ í•¨)
        const elections = await service.getAllElections(); 
        const selector = document.getElementById('election-selector');
        
        selector.innerHTML = ''; // ì´ˆê¸°í™”

        elections.forEach(el => {
            const option = document.createElement('option');
            option.value = el.id;
            
            // í…ìŠ¤íŠ¸: [ìƒíƒœ] ì„ ê±°ì œëª© (ê¸°ê°„)
            // ë‚ ì§œê°€ ì—†ìœ¼ë©´ 'ë¯¸ì •' ì²˜ë¦¬
            const start = el.start_at ? new Date(el.start_at).toLocaleDateString() : 'ë‚ ì§œë¯¸ì •';
            option.text = `[${el.status}] ${el.title} (${start}~)`;
            
            selector.appendChild(option);
        });

        // í˜„ì¬ ì„ íƒëœ ì„ ê±°ë¥¼ ë“œë¡­ë‹¤ìš´ì—ì„œë„ ì„ íƒ ìƒíƒœë¡œ ë§Œë“¦
        if (currentElectionId) {
            selector.value = currentElectionId;
        }
    } catch (e) {
        console.error("ì„ ê±° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", e);
    }
}

// [ìˆ˜ì •ëœ init í•¨ìˆ˜ ì „ì²´]
    async function init() {
        // 1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        if (!await service.isAdmin()) {
            window.showModal('ì ‘ê·¼ ê±°ë¶€', 'ê´€ë¦¬ì ê¶Œí•œì´ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', () => window.close());
            return;
        }

        // 2. [ìš”ì²­ì‚¬í•­ ë°˜ì˜] í—¤ë”ì— ì´ë©”ì¼ í‘œì‹œ
        try {
            // import { supabase } ... ê°€ ìƒë‹¨ì— ìˆì–´ì•¼ í•¨
            const { data: { user } } = await supabase.auth.getUser();
            if (user && user.email) {
                const emailEl = document.getElementById('admin-email');
                if(emailEl) emailEl.innerText = user.email; // "ê´€ë¦¬ìë‹˜" ëŒ€ì‹  ì´ë©”ì¼ í‘œì‹œ
            }
        } catch (e) {
            console.warn("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", e);
        }

        // 3. ì„ ê±° ID ì‹ë³„ (URL -> ìŠ¤í† ë¦¬ì§€ -> ì„œë²„ ìµœì‹ ìˆœ)
        const urlParams = new URLSearchParams(window.location.search);
        let targetId = urlParams.get('id') || localStorage.getItem('target_election_id');

        // IDê°€ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ìµœì‹  ì„ ê±° ìë™ íƒìƒ‰
        if (!targetId) {
            try {
                const elections = await service.getAllElections();
                if (elections && elections.length > 0) {
                    targetId = elections[0].id; // ê°€ì¥ ìµœì‹  ì„ ê±°
                    console.log(`âœ… ìµœì‹  ì„ ê±° ìë™ ì„ íƒ: ${targetId}`);
                }
            } catch (e) {
                console.warn("ì„ ê±° ëª©ë¡ ìë™ ì¡°íšŒ ì‹¤íŒ¨:", e);
            }
        }

        // 4. ìµœì¢… ê²€ì¦
        if (!targetId) {
            window.showModal(
                'ë°ì´í„° ì—†ìŒ', 
                'ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ì„ ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆ ì„ ê±°ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 
                () => window.close()
            );
            return;
        }

        // 5. ì „ì—­ ë³€ìˆ˜ ì„¤ì • ë° ì €ì¥
        currentElectionId = targetId;
        localStorage.setItem('target_election_id', targetId);

        // 6. ë°ì´í„° ë³‘ë ¬ ë¡œë“œ (ë“œë¡­ë‹¤ìš´ -> ì •ë³´ -> í›„ë³´ -> ë¡œê·¸)
        await loadElectionSelector(); // ë“œë¡­ë‹¤ìš´ ë¨¼ì € êµ¬ì„±
        await Promise.all([
            loadElectionInfo(),
            loadCandidates(),
            loadLogs()
        ]);
        
        // 7. ì‹¤ì‹œê°„ í†µê³„ ì‹œì‘
        setInterval(updateLiveStats, 5000);
    }

        // [ì •ë³´ ë¡œë“œ]
        async function loadElectionInfo() {
            try {
                const data = await service.getElectionInfo(currentElectionId);
                document.getElementById('election-title').innerText = data.title;
                document.getElementById('election-period').innerText = 
                    `${new Date(data.start_at).toLocaleString()} ~ ${new Date(data.end_at).toLocaleString()}`;
                updateStatusBadge(data.status);
            } catch (e) { console.error(e); }
        }

        function updateStatusBadge(status) {
            const el = document.getElementById('election-status');
            el.innerText = status;
            let color = '#999';
            if(status === 'OPEN') color = 'var(--success-green)';
            else if(status === 'CLOSED') color = 'var(--danger-red)';
            else if(status === 'PUBLISHED') color = 'var(--primary-blue)';
            else if(status === 'NOMINATION') color = '#ec4899';
            el.style.backgroundColor = color;
        }

        // [íƒ­ ì „í™˜]
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            
            const map = { 'tab-nomination':0, 'tab-ready':1, 'tab-vote':2, 'tab-result':3 };
            if(map[tabId] !== undefined) document.querySelectorAll('.step-item')[map[tabId]].classList.add('active');
        };
        switchTab('tab-nomination');

        // [í›„ë³´ì ë¡œë“œ & í†µê³„ & ë Œë”ë§]
        async function loadCandidates() {
            const list = await service.getCandidates(currentElectionId);
            cachedCandidates = list; // ìºì‹± (ë¯¸ë¦¬ë³´ê¸°ìš©)
            
            // í†µê³„ ê³„ì‚°
            const stats = { total: list.length, pending: 0, approved: 0, rejected: 0 };
            list.forEach(c => {
                if (c.status === 'PENDING') stats.pending++;
                else if (c.status === 'APPROVED') stats.approved++;
                else if (c.status === 'REJECTED') stats.rejected++;
            });

            // í†µê³„ UI ì—…ë°ì´íŠ¸
            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-pending').innerText = stats.pending;
            document.getElementById('stat-approved').innerText = stats.approved;
            document.getElementById('stat-rejected').innerText = stats.rejected;

            // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            const tbody = document.getElementById('candidate-list-body');
            tbody.innerHTML = '';
            list.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.districts.name}</td>
                    <td>${c.name}</td>
                    <td>
                        ${c.status === 'PENDING' ? 
                          `<button onclick="reviewCand('${c.id}', 'APPROVED', '${c.name}')" class="btn btn-sm btn-outline" style="color:blue; border-color:blue;">ìŠ¹ì¸</button> 
                           <button onclick="reviewCand('${c.id}', 'REJECTED', '${c.name}')" class="btn btn-sm btn-outline" style="color:red; border-color:red;">ë°˜ë ¤</button>` 
                          : `<span class="status-badge" style="background:${c.status === 'APPROVED' ? 'green' : 'gray'}">${c.status}</span>`}
                    </td>
                    <td>
                        ${c.status === 'APPROVED' ? 
                            `<input type="text" class="input-symbol" data-id="${c.id}" value="${c.symbol || ''}" placeholder="ë²ˆí˜¸">` : 
                            '-'}
                    </td>
                    <td>-</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // [ìœ ê¶Œì í™”ë©´ ë¯¸ë¦¬ë³´ê¸°] - í•µì‹¬ ì¶”ê°€ ê¸°ëŠ¥
        window.openVoterPreview = () => {
            const approvedCands = cachedCandidates.filter(c => c.status === 'APPROVED');
            if(approvedCands.length === 0) {
                window.showModal('ì•Œë¦¼', 'ìŠ¹ì¸ëœ í›„ë³´ìê°€ ì—†ìŠµë‹ˆë‹¤. í›„ë³´ë¥¼ ë¨¼ì € ìŠ¹ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê¸°í˜¸ ìˆœ ì •ë ¬
            approvedCands.sort((a, b) => (parseInt(a.symbol)||999) - (parseInt(b.symbol)||999));

            let html = '<div class="preview-grid">';
            approvedCands.forEach(c => {
                const symbol = c.symbol ? c.symbol : '?';
                html += `
                    <div class="voter-card-mock">
                        <div class="mock-symbol">${symbol}</div>
                        <div>
                            <div style="font-size:0.8rem; color:#666;">${c.districts.name}</div>
                            <div style="font-weight:bold; font-size:1.1rem;">${c.name}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div><p style="margin-top:1rem; font-size:0.8rem; color:red;">* ì‹¤ì œ ìœ ê¶Œì í™”ë©´ê³¼ ë””ìì¸ì€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‚˜ ë°ì´í„°ëŠ” ìœ„ì™€ ê°™ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
            
            window.showModal('ğŸ“± ìœ ê¶Œì íˆ¬í‘œ í™”ë©´ ë¯¸ë¦¬ë³´ê¸°', html);
        };

        // [Action] í›„ë³´ ìŠ¹ì¸/ë°˜ë ¤ (With Modal)
        window.reviewCand = (id, decision, name) => {
            window.showModal(
                'ì‹¬ì‚¬ í™•ì¸', 
                `${name} í›„ë³´ë¥¼ <strong>${decision}</strong> ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                async () => {
                    await service.reviewCandidate(id, decision);
                    await service.logAction(currentElectionId, 'CANDIDATE_REVIEW', `${name} í›„ë³´ ${decision}`);
                    loadCandidates();
                    loadLogs();
                }
            );
        };

        // [Action] ê¸°í˜¸ ì €ì¥ (With Modal)
        window.saveSymbols = async () => {
            const inputs = document.querySelectorAll('.input-symbol');
            window.showModal('ì €ì¥ í™•ì¸', `ì´ ${inputs.length}ëª…ì˜ ê¸°í˜¸ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
                try {
                    for (const input of inputs) {
                        const id = input.dataset.id;
                        const val = input.value;
                        if (val) await service.updateSymbol(id, val);
                    }
                    window.showModal('ì™„ë£Œ', 'ê¸°í˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await service.logAction(currentElectionId, 'SYMBOL_UPDATE', 'í›„ë³´ì ê¸°í˜¸ ì €ì¥ ì™„ë£Œ');
                    loadLogs();
                    loadCandidates(); // ì¬ë¡œë”©í•˜ì—¬ ì •ë ¬ ë“± ë°˜ì˜
                } catch(e) { window.showModal('ì—ëŸ¬', e.message); }
            });
        };

        // [Action] ìƒíƒœ ë³€ê²½ ê³µí†µ (confirmAction ë˜í¼)
        window.confirmAction = (status, message) => {
            window.showModal('ìƒíƒœ ë³€ê²½ í™•ì¸', message, async () => {
                try {
                    await service.updateStatus(currentElectionId, status);
                    loadElectionInfo();
                    loadLogs();
                } catch(e) { window.showModal('ì—ëŸ¬', e.message); }
            });
        };

        // [Action] ë¡œê·¸ ë¡œë“œ
        window.loadLogs = async () => {
            const logs = await service.getLogs(currentElectionId);
            const container = document.getElementById('audit-log-container');
            container.innerHTML = '';
            logs.forEach(log => {
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.innerHTML = `
                    <span class="log-time">[${new Date(log.created_at).toLocaleTimeString()}]</span>
                    <strong>${log.action_type}</strong><br>
                    ${log.details} <span style="font-size:0.7rem; color:#666;">by ${log.admin_email}</span>
                `;
                container.appendChild(div);
            });
        };

        // [Action] íˆ¬í‘œìœ¨ ê°±ì‹ 
        async function updateLiveStats() {
            if(!currentElectionId) return;
            const stats = await service.getTurnoutStats(currentElectionId);
            document.getElementById('live-turnout').innerText = `${stats.percent}%`;
            document.getElementById('live-votes').innerText = stats.current;
            document.getElementById('live-total').innerText = stats.total;
        }
        
        // [Action] ê°œí‘œ
        window.openBallotBox = () => {
             // promptëŠ” Modal ì‹œìŠ¤í…œìƒ êµ¬í˜„ì´ ë³µì¡í•˜ë¯€ë¡œ ê°„ë‹¨íˆ window.prompt ì‚¬ìš©í•˜ê±°ë‚˜, ì¶”í›„ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì „ìš© ëª¨ë‹¬ ê°œë°œ í•„ìš”.
             // ì—¬ê¸°ì„œëŠ” ê°„ëµíˆ prompt ìœ ì§€í•˜ë˜, UX íë¦„ìƒ ì„¤ëª… ì¶”ê°€.
             const pwd = prompt("ğŸ” ë³´ì•ˆ í™•ì¸: ê°œí‘œí•¨ ì—´ëŒì„ ìœ„í•´ 'ê°œí‘œ'ë¼ê³  ì…ë ¥í•˜ì„¸ìš”.");
             if(pwd !== 'ê°œí‘œ') return alert('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'); // ëª¨ë‹¬ë¡œ ëŒ€ì²´í•˜ë©´ ì¢‹ìœ¼ë‚˜ ì½”ë“œ ë³µì¡ë„ìƒ ìœ ì§€
             
             (async () => {
                document.getElementById('result-display').style.display = 'block';
                const ballots = await service.getResults(currentElectionId);
                const chart = document.getElementById('result-chart');
                chart.innerHTML = `<p><strong>ì´ ${ballots.length}í‘œ</strong>ê°€ ì„±ê³µì ìœ¼ë¡œ ì•”í˜¸í™” í•´ì œ ë° ì§‘ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
                
                await service.logAction(currentElectionId, 'OPEN_BALLOT', 'ê°œí‘œí•¨ ì—´ëŒ ë° ê²°ê³¼ í™•ì¸');
                loadLogs();
             })();
        };

        init();
    </script>
</body>
</html>
